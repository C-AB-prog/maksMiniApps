<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Growth Assistant</title>
  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --ink:#0f172a;
      --ink-2:#475569;
      --ink-3:#64748b;
      --brand:#3b82f6;
      --brand-2:#6366f1;
      --ok:#10b981;
      --warn:#f59e0b;
      --danger:#ef4444;
      --ring: rgba(59,130,246,.25);
      --shadow: 0 6px 16px rgba(15,23,42,.06), 0 1px 0 rgba(15,23,42,.04) inset;
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 80% -200px, #e9f0ff 0%, transparent 60%),
        radial-gradient(800px 600px at -100px 10%, #eff8ff 0%, transparent 65%),
        var(--bg);
      color:var(--ink);
      font:16px/1.45 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    .container{
      max-width: 980px;
      margin-inline:auto;
      padding: 16px env(safe-area-inset-right) 110px env(safe-area-inset-left);
    }

    /* header */
    .brand{
      display:flex; align-items:center; gap:12px;
      padding:8px 12px; border-radius:14px;
      background:linear-gradient(135deg,#eef5ff,#fff);
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }
    .brand .logo{
      width:40px;height:40px; display:grid; place-items:center;
      border-radius:12px; background:linear-gradient(135deg,#6ea8ff,#7c6cff);
      color:#fff; font-weight:700; box-shadow: 0 8px 20px rgba(99,102,241,.25);
      user-select:none;
    }
    .brand .title{
      font-weight:800; letter-spacing:.2px;
    }
    .brand .subtitle{
      color:var(--ink-3); font-size:13px; margin-top:-2px;
    }
    .net-badge{
      display:inline-block; margin-left:8px; padding:4px 8px;
      border-radius:999px; font-weight:800; font-size:12px;
      background:#fee2e2; color:#991b1b; vertical-align:middle;
    }
    .net-badge.online{ background:#dcfce7; color:#065f46; }

    /* sections */
    h2{
      margin:18px 6px 8px; font-size:22px; letter-spacing:.2px;
    }
    .card{
      background:var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      margin:10px 0 16px;
    }

    .row{display:flex; gap:12px; align-items:center}
    .grow{flex:1}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:12px;
      background:#f1f5ff; color:#1e3a8a; font-weight:600; font-size:13px;
    }

    input[type="text"], input[type="date"], input[type="time"]{
      width:100%; background:#f8fafc; color:var(--ink);
      border:1px solid #e5e7eb; padding:12px 14px; border-radius:12px;
      outline:none; transition:border-color .2s, box-shadow .2s;
    }
    input:focus{
      border-color: var(--brand);
      box-shadow: 0 0 0 4px var(--ring);
    }

    .btn{
      appearance:none; border:0; cursor:pointer; user-select:none;
      padding:12px 16px; border-radius:12px; font-weight:700;
      color:#fff;
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      box-shadow: 0 6px 16px rgba(59,130,246,.28);
      transition: transform .05s ease, box-shadow .2s ease, opacity .2s ease;
    }
    .btn:active{transform: translateY(1px)}
    .btn[disabled]{ opacity:.6; pointer-events:none; }
    .btn.secondary{ background:#e2e8f0; color:#0f172a; box-shadow:none }
    .btn.ok{ background: linear-gradient(135deg,#34d399,#10b981) }

    .icon-btn{
      appearance:none; border:1px solid #e5e7eb; background:#f8fafc; color:var(--ink-2);
      width:42px; height:42px; border-radius:12px; display:grid; place-items:center; cursor:pointer;
      transition: border-color .2s, box-shadow .2s;
    }
    .icon-btn:focus{ outline:none; border-color:var(--brand); box-shadow:0 0 0 4px var(--ring) }

    .muted{color:var(--ink-3); font-size:13px}
    .hint{font-size:12px; color:var(--ink-3)}

    /* tasks */
    .task{
      background:#fff; border-radius:14px; padding:14px 12px;
      display:flex; align-items:center; gap:12px;
      box-shadow: var(--shadow); margin:10px 0;
    }
    .task .dot{
      width:26px;height:26px; border-radius:999px;
      background:linear-gradient(135deg,#89cffb,#6da8ff);
      display:grid; place-items:center; color:#fff; font-size:14px; font-weight:800;
      flex:0 0 26px;
      user-select:none;
    }
    .task.done{ opacity:.6 }
    .task .title{ font-weight:700 }
    .task .sub{ font-size:13px; color:var(--ink-3) }
    .task .actions{ margin-left:auto; display:flex; gap:8px }

    .toggle{
      display:inline-grid; place-items:center;
      width:36px;height:36px; border-radius:10px;
      background:#ecfeff; color:#0891b2; border:1px solid #cffafe;
      cursor:pointer;
    }

    .empty{
      text-align:center; color:var(--ink-3); padding:16px; border:1px dashed #e5e7eb;
      border-radius:12px; background:#fafafa; margin-top:8px;
    }

    /* chat button */
    .chat-cta{
      position:fixed; left:16px; right:16px; bottom:86px;
      border-radius:18px; padding:14px 18px; font-weight:800; color:#fff;
      background:linear-gradient(135deg,#5aa3ff,#4f46e5);
      display:flex; align-items:center; justify-content:center; gap:8px;
      box-shadow: 0 16px 40px rgba(59,130,246,.35);
      z-index: 20;
    }

    /* bottom nav */
    nav{
      position:fixed; left:0; right:0; bottom:0;
      background:#fff; box-shadow: 0 -6px 20px rgba(15,23,42,.08);
      border-top-left-radius: 16px; border-top-right-radius: 16px;
      padding: 8px calc(12px + env(safe-area-inset-right)) calc(8px + env(safe-area-inset-bottom)) calc(12px + env(safe-area-inset-left));
      display:flex; gap:8px; justify-content:space-between; z-index:30;
    }
    .tab{
      flex:1; border-radius:12px; padding:10px 6px; text-align:center;
      color:var(--ink-3); font-weight:700; cursor:pointer; user-select:none;
    }
    .tab.active{
      background:linear-gradient(135deg,#eef4ff,#ffffff);
      color:var(--ink);
      box-shadow: var(--shadow);
    }

    /* views */
    .view{ display:none }
    .view.active{ display:block }

    /* modal chat */
    .modal{
      position:fixed; inset:0; display:none; z-index:40;
    }
    .modal.open{ display:block }
    .scrim{ position:absolute; inset:0; background:rgba(2,6,23,.48); backdrop-filter: blur(8px); }
    .sheet{
      position:absolute; left:0; right:0; bottom:0;
      background:#fff; border-top-left-radius:20px; border-top-right-radius:20px;
      box-shadow: 0 -20px 40px rgba(2,6,23,.35);
      max-height: 78vh; display:flex; flex-direction:column;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .sheet .hdr{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #eef2f7; }
    .messages{ padding:12px 16px; overflow:auto; min-height:180px; }
    .bubble{ max-width:86%; margin:10px 0; padding:10px 12px; border-radius:14px; box-shadow: var(--shadow); }
    .bubble.me{ background:#ecfeff; color:#042f2e; margin-left:auto }
    .bubble.ai{ background:#f8fafc }
    .composer{ display:flex; gap:8px; padding:12px 16px; border-top:1px solid #eef2f7 }
    .composer input{ flex:1 }
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: calc(86px + 62px); background:#0f172a; color:#fff;
      border-radius:12px; padding:10px 14px; font-weight:700; z-index:50;
      display:none;
    }
    .toast.show{ display:block }
  </style>
</head>
<body>
  <div class="container">
    <div class="brand">
      <div class="logo" title="Growth Assistant">GA</div>
      <div>
        <div class="title">Growth Assistant</div>
        <div class="subtitle">
          –ú–∏–Ω–∏-–ø–æ–º–æ—â–Ω–∏–∫ –≤ Telegram
          <span id="net-badge" class="net-badge" aria-live="polite">OFFLINE</span>
        </div>
      </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω–∞—è -->
    <section id="view-home" class="view active">
      <h2>–°–µ–≥–æ–¥–Ω—è</h2>

      <div class="card">
        <div class="row" style="margin-bottom:10px">
          <div class="chip">–§–æ–∫—É—Å –¥–Ω—è</div>
        </div>
        <div class="row">
          <input class="grow" id="focus-input" type="text" placeholder="–°–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ —Å–µ–≥–æ–¥–Ω—è‚Ä¶">
          <button class="icon-btn" id="focus-edit" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ–∫—É—Å" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
          <button class="btn" id="focus-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div class="hint" id="focus-hint"></div>
      </div>

      <div class="card">
        <div class="row" style="margin-bottom:10px">
          <div class="chip">–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</div>
        </div>
        <input id="task-title" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
        <div class="row" style="margin-top:10px">
          <button class="btn secondary" data-scope="today" id="scope-today" aria-label="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –æ–±–ª–∞—Å—Ç—å –°–µ–≥–æ–¥–Ω—è">–°–µ–≥–æ–¥–Ω—è</button>
          <button class="btn secondary" data-scope="week" id="scope-week" aria-label="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –æ–±–ª–∞—Å—Ç—å –ù–µ–¥–µ–ª—è">–ù–µ–¥–µ–ª—è</button>
          <button class="btn secondary" data-scope="backlog" id="scope-backlog" aria-label="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –æ–±–ª–∞—Å—Ç—å –ë—ç–∫–ª–æ–≥">–ë—ç–∫–ª–æ–≥</button>
          <span class="grow"></span>
        </div>
        <div class="row" style="margin-top:10px">
          <input id="task-date" type="date" style="max-width:180px">
          <input id="task-time" type="time" style="max-width:140px">
          <button class="btn" id="task-add">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <h2>–ó–∞–¥–∞—á–∏</h2>
      <div id="tasks"></div>
    </section>

    <!-- –ü–ª–∞–Ω -->
    <section id="view-plan" class="view">
      <h2>–ü–ª–∞–Ω</h2>
      <div class="card">
        <div class="muted">–°–∫–æ—Ä–æ —Ç—É—Ç –ø–æ—è–≤–∏—Ç—Å—è —Å–ø—Ä–∏–Ω—Ç-–ø–ª–∞–Ω –∏ HADI-—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã.</div>
      </div>
    </section>

    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
    <section id="view-calendar" class="view">
      <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
      <div class="card">
        <div class="muted">–ö–∞–ª–µ–Ω–¥–∞—Ä—å —á–∏—Ç–∞–µ—Ç –∑–∞–¥–∞—á–∏ –∏ –¥–µ–¥–ª–∞–π–Ω—ã ‚Äî —Å–µ–π—á–∞—Å –≤ —Ä–µ–∂–∏–º–µ —á—Ç–µ–Ω–∏—è.</div>
      </div>
    </section>

    <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
    <section id="view-profile" class="view">
      <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
      <div class="card">
        <div class="muted">–í–µ—Ä—Å–∏—è –º–∏–Ω–∏-–∞–ø–ø–∞. –í—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ, –ø—Ä–∏–≤–∞—Ç–Ω–æ –∏ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∫–Ω–æ–ø–æ–∫.</div>
      </div>
    </section>
  </div>

  <button class="chat-cta" id="chat-open">üí¨ –ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</button>

  <nav>
    <div class="tab active" data-view="home">–ì–ª–∞–≤–Ω–∞—è</div>
    <div class="tab" data-view="plan">–ü–ª–∞–Ω</div>
    <div class="tab" data-view="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
    <div class="tab" data-view="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
  </nav>

  <!-- Chat Modal -->
  <div class="modal" id="chat">
    <div class="scrim" id="chat-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç"></div>
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="chat-title">
      <div class="hdr">
        <strong id="chat-title">–ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</strong>
        <button class="btn secondary" id="chat-x">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="messages" id="messages"></div>
      <div class="composer">
        <input id="chat-input" type="text" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–æ –ø–ª–∞–Ω, HADI –∏–ª–∏ –∑–∞–¥–∞—á–∏‚Ä¶" />
        <button class="btn" id="chat-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ---------- Helpers ----------
    const tg = window.Telegram?.WebApp;
    if (tg?.expand) try{ tg.expand() }catch(e){}

    const viewIds = ["home","plan","calendar","profile"];
    const tabs = [...document.querySelectorAll('.tab')];

    // –ë–∞–∑–æ–≤—ã–π API-–∫–ª–∏–µ–Ω—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ ONLINE-—Ä–µ–∂–∏–º–µ)
    const API = (path, opt={}) => {
      const proto = window.location.protocol;
      // –ï—Å–ª–∏ —Ñ–∞–π–ª –æ—Ç–∫—Ä—ã—Ç –ª–æ–∫–∞–ª—å–Ω–æ (file://) ‚Äî —Å—Ä–∞–∑—É —É—Ö–æ–¥–∏–º –≤ –æ—Ñ—Ñ–ª–∞–π–Ω.
      if (proto === 'file:') return Promise.reject(new Error('offline'));
      const base = window.location.origin;
      const initData = tg?.initData || '';
      const headers = Object.assign({
        'Content-Type':'application/json',
        'x-telegram-init-data': initData
      }, (opt.headers || {}));
      return fetch(`${base}/api${path}`, Object.assign({}, opt, {headers}))
        .then(async r=>{
          if(!r.ok){
            let msg = `${r.status}`;
            try{ const j = await r.json(); msg = j.error || msg }catch(_){}
            throw new Error(msg);
          }
          // –¥–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
          return r.status===204 ? {} : (r.json().catch(()=> ({})));
        });
    };

    const toast = (msg, ms=2400)=>{
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), ms);
    };

    const scopeButtons = {
      today: document.getElementById('scope-today'),
      week: document.getElementById('scope-week'),
      backlog: document.getElementById('scope-backlog'),
    };
    let currentScope = 'today';
    Object.values(scopeButtons).forEach(b=>{
      b.addEventListener('click', ()=>{
        currentScope = b.dataset.scope;
        Object.values(scopeButtons).forEach(x=> x.classList.remove('ok'));
        b.classList.add('ok');
      });
    });
    scopeButtons.today.classList.add('ok');

    // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ç–µ–∫—Å—Ç
    const escapeHTML = (s='') => s
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'",'&#39;');

    // –õ–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–∞—Ç—ã (–±–µ–∑ Safari-–±–∞–≥–æ–≤)
    function buildLocalDate(dateStr, timeStr){
      if(!dateStr && !timeStr) return null;
      if(!dateStr){ // —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è ‚Üí —Å–µ–≥–æ–¥–Ω—è
        const now = new Date();
        const [hh='00', mm='00'] = String(timeStr||'').split(':');
        return new Date(now.getFullYear(), now.getMonth(), now.getDate(), +hh, +mm, 0, 0);
      }
      const [y,m,d] = dateStr.split('-').map(Number);
      const [hh='00', mm='00'] = String(timeStr||'').split(':');
      return new Date(y, (m-1), d, +hh, +mm, 0, 0);
    }
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è UI
    function fmtDateTime(dt){
      return dt.toLocaleString(undefined, {
        year:'numeric', month:'short', day:'2-digit',
        hour:'2-digit', minute:'2-digit'
      });
    }

    // –ü—Ä–æ—Å—Ç–æ–π sleep –¥–ª—è —Ä–µ—Ç—Ä–∞–µ–≤
    const wait = (ms)=> new Promise(r=> setTimeout(r, ms));

    // ---------- Network status & Store ----------
    const badge = ()=> document.getElementById('net-badge');

    async function probeAPI(){
      // –µ—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–µ—Ç –∏–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –æ—Ñ–ª–∞–π–Ω
      if (!navigator.onLine || window.location.protocol === 'file:') return false;
      try{
        // –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–∞–π–º-–∞—É—Ç
        const ctrl = new AbortController();
        const t = setTimeout(()=> ctrl.abort(), 1800);
        await fetch(`${window.location.origin}/api/health`, {signal: ctrl.signal});
        clearTimeout(t);
        return true;
      }catch(_){ return false; }
    }

    const LS = {
      focus: 'ga.focus.v1',
      tasks: 'ga.tasks.v1'
    };

    // –û—Ñ—Ñ–ª–∞–π–Ω store (LocalStorage)
    const offlineStore = {
      async getFocus(){
        try{ return JSON.parse(localStorage.getItem(LS.focus) || 'null') || {text:'', updated_at:null}; }
        catch(_){ return {text:'', updated_at:null}; }
      },
      async setFocus(text){
        const obj = { text, updated_at: new Date().toISOString() };
        localStorage.setItem(LS.focus, JSON.stringify(obj));
        return obj;
      },
      async listTasks(){
        try{ return JSON.parse(localStorage.getItem(LS.tasks) || '[]'); }
        catch(_){ return []; }
      },
      async saveTasks(list){
        localStorage.setItem(LS.tasks, JSON.stringify(list));
        return list;
      },
      async addTask(t){
        const list = await this.listTasks();
        list.unshift(t);
        return this.saveTasks(list);
      },
      async updateTask(id, patch){
        const list = await this.listTasks();
        const i = list.findIndex(x=> x.id===id);
        if(i>=0){ list[i] = {...list[i], ...patch}; }
        return this.saveTasks(list);
      },
      async removeTask(id){
        const list = await this.listTasks();
        return this.saveTasks(list.filter(x=> x.id!==id));
      }
    };

    // –û–Ω–ª–∞–π–Ω store (—á–µ—Ä–µ–∑ backend API)
    const onlineStore = {
      async getFocus(){ return API('/focus'); },
      async setFocus(text){ return API('/focus', {method:'PUT', body:JSON.stringify({text})}); },
      async listTasks(){ return API('/tasks'); }, // –æ–∂–∏–¥–∞–µ—Ç {tasks:[...]}
      async addTask(payload){ return API('/tasks', {method:'POST', body:JSON.stringify(payload)}); },
      async updateTask(id, patch){ return API(`/tasks/${id}`, {method:'PUT', body:JSON.stringify(patch)}); },
      async removeTask(id){ return API(`/tasks/${id}`, {method:'DELETE'}); },
    };

    const store = {
      mode: 'offline',
      async detect(){
        this.mode = (await probeAPI()) ? 'online' : 'offline';
        const b = badge(); if(b){ b.textContent = this.mode==='online' ? 'ONLINE' : 'OFFLINE'; b.classList.toggle('online', this.mode==='online'); }
      },
      get use(){ return this.mode==='online' ? onlineStore : offlineStore; }
    };

    // ---------- Focus ----------
    async function loadFocus(){
      try{
        const data = await store.use.getFocus();
        const input = document.getElementById('focus-input');
        const hint  = document.getElementById('focus-hint');
        input.value = data?.text || '';
        hint.textContent = data?.updated_at ? `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${fmtDateTime(new Date(data.updated_at))}` : '';
      }catch(e){ /* noop */ }
    }
    async function saveFocus(){
      const text = document.getElementById('focus-input').value.trim();
      if(!text) return toast('–í–≤–µ–¥–∏—Ç–µ —Ñ–æ–∫—É—Å –¥–Ω—è');
      try{
        await store.use.setFocus(text);
        toast('–§–æ–∫—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úÖ');
        loadFocus();
      }catch(e){ toast('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ–∫—É—Å'); }
    }
    document.getElementById('focus-save').onclick = saveFocus;
    document.getElementById('focus-input').addEventListener('keydown', (e)=>{
      if(e.key==='Enter') saveFocus();
    });
    document.getElementById('focus-edit').addEventListener('click', ()=>{
      const el = document.getElementById('focus-input');
      el.focus(); el.select();
    });

    // ---------- Tasks ----------
    const tasksEl = document.getElementById('tasks');

    function renderEmpty(){
      const d = document.createElement('div');
      d.className = 'empty';
      d.textContent = '–ü–æ–∫–∞ –∑–∞–¥–∞—á –Ω–µ—Ç ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é üëá';
      tasksEl.appendChild(d);
    }

    function taskRow(t){
      const row = document.createElement('div'); row.className='task'+(t.done?' done':'');
      // –ª–µ–≤–∞—è —Ç–æ—á–∫–∞
      const dot = document.createElement('div'); dot.className='dot'; dot.textContent = '‚Ä¢';
      // –∫–æ–Ω—Ç–µ–Ω—Ç
      const grow = document.createElement('div'); grow.className='grow';
      const ttl = document.createElement('div'); ttl.className='title'; ttl.textContent = t.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      grow.appendChild(ttl);
      if(t.due_at){
        const sub = document.createElement('div'); sub.className='sub';
        sub.textContent = `–î–µ–¥–ª–∞–π–Ω: ${fmtDateTime(new Date(t.due_at))}`;
        grow.appendChild(sub);
      }
      // –¥–µ–π—Å—Ç–≤–∏—è
      const actions = document.createElement('div'); actions.className='actions';
      const btnToggle = document.createElement('button'); btnToggle.className='toggle'; btnToggle.setAttribute('aria-label','–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å'); btnToggle.title='–ì–æ—Ç–æ–≤–æ'; btnToggle.textContent='‚úì';
      const btnDel = document.createElement('button'); btnDel.className='toggle'; btnDel.setAttribute('aria-label','–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É'); btnDel.title='–£–¥–∞–ª–∏—Ç—å'; btnDel.textContent='‚úï';
      btnToggle.onclick = ()=> toggleTask(t.id, !t.done);
      btnDel.onclick = ()=> removeTask(t.id);
      actions.append(btnToggle, btnDel);

      row.append(dot, grow, actions);
      return row;
    }

    async function loadTasks(){
      tasksEl.innerHTML = '';
      try{
        const data = await store.use.listTasks();
        const list = Array.isArray(data?.tasks) ? data.tasks : Array.isArray(data) ? data : [];
        if(!list.length){ renderEmpty(); return; }
        list.forEach(t=> tasksEl.appendChild(taskRow(t)));
      }catch(e){
        renderEmpty();
      }
    }

    async function addTask(){
      const titleEl = document.getElementById('task-title');
      const date = document.getElementById('task-date').value;
      const time = document.getElementById('task-time').value;
      const title = titleEl.value.trim();
      if(!title) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');

      const due = buildLocalDate(date, time);
      const payload = {
        id: (crypto?.randomUUID?.() || ('t_'+Date.now())),
        title, scope: currentScope,
        // —Ö—Ä–∞–Ω–∏–º –∫–∞–∫ ISO –≤ UTC
        due_at: due ? new Date(due.getTime() - due.getTimezoneOffset()*60000).toISOString() : null,
        done: false
      };

      const btn = document.getElementById('task-add');
      btn.disabled = true;
      try{
        if(store.mode==='online'){
          await store.use.addTask({ title: payload.title, scope: payload.scope, due_at: payload.due_at });
        }else{
          await offlineStore.addTask(payload);
        }
        titleEl.value='';
        toast('–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ ‚úÖ');
        await loadTasks();
      }catch(e){
        toast('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É');
      }finally{
        btn.disabled = false;
      }
    }
    document.getElementById('task-add').onclick = addTask;
    document.getElementById('task-title').addEventListener('keydown', (e)=>{
      if(e.key==='Enter') addTask();
    });

    async function toggleTask(id, done){
      try{
        if(store.mode==='online'){
          await store.use.updateTask(id, {done});
        }else{
          await offlineStore.updateTask(id, {done});
        }
        await loadTasks();
      }catch(e){ toast('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å'); }
    }
    async function removeTask(id){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;
      try{
        await store.use.removeTask(id);
        await loadTasks();
      }catch(e){ toast('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å'); }
    }

    // ---------- Chat ----------
    const chat = {
      modal: document.getElementById('chat'),
      openBtn: document.getElementById('chat-open'),
      closeBtn: document.getElementById('chat-x'),
      scrim: document.getElementById('chat-close'),
      list: document.getElementById('messages'),
      input: document.getElementById('chat-input'),
      send: document.getElementById('chat-send'),
    };
    const openChat = ()=> { chat.modal.classList.add('open'); setTimeout(()=> chat.input?.focus(), 10); };
    const closeChat = ()=> chat.modal.classList.remove('open');
    chat.openBtn.onclick = openChat; chat.closeBtn.onclick = closeChat; chat.scrim.onclick = closeChat;

    function pushBubble(text, me=false){
      const b = document.createElement('div');
      b.className = 'bubble '+(me?'me':'ai');
      b.textContent = text; chat.list.appendChild(b);
      chat.list.scrollTop = chat.list.scrollHeight;
    }

    // –ü—Ä–æ—Å—Ç–µ–π—à–∏–π –æ—Ñ–ª–∞–π–Ω-–æ—Ç–≤–µ—Ç (—ç–≤—Ä–∏—Å—Ç–∏–∫–∞)
    function localAI(q){
      const s = q.toLowerCase();
      if(s.includes('—Ñ–æ–∫—É—Å')) return '–°–æ–≤–µ—Ç: —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ —Ñ–æ–∫—É—Å –∫–∞–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (‚Äú–ó–∞–∫—Ä—ã—Ç—å –ª–µ–Ω–¥–∏–Ω–≥‚Äù, ‚Äú–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ –≤ 15:00‚Äù). –ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –¥–µ–¥–ª–∞–π–Ω –∏ –¥–æ–±–∞–≤–∏—Ç—å 3‚Äì5 –∫–ª—é—á–µ–≤—ã—Ö –∑–∞–¥–∞—á.';
      if(s.includes('hadi')) return 'HADI: –ì–∏–ø–æ—Ç–µ–∑–∞ ‚Üí –î–µ–π—Å—Ç–≤–∏–µ ‚Üí –î–∞–Ω–Ω—ã–µ ‚Üí –ò–Ω—Å–∞–π—Ç. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å? 1) –£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏—é —Ñ–æ—Ä–º—ã; 2) –°–æ–∫—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞; 3) –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–µ –£–¢–ü.';
      if(s.includes('–ø–ª–∞–Ω')||s.includes('—Å–ø—Ä–∏–Ω—Ç')) return '–°–ø—Ä–∏–Ω—Ç-–ø–ª–∞–Ω: –≤—ã–±–µ—Ä–∏—Ç–µ 3 –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –Ω–∞ –Ω–µ–¥–µ–ª—é, —Ä–∞–∑–Ω–µ—Å–∏—Ç–µ –ø–æ –¥–Ω—è–º –∏ –¥–æ–±–∞–≤—å—Ç–µ –¥–µ–¥–ª–∞–π–Ω—ã. –Ø –º–æ–≥—É —Ä–∞–∑–ª–æ–∂–∏—Ç—å –∏—Ö –Ω–∞ –∑–∞–¥–∞—á–∏.';
      if(s.includes('–∑–∞–¥–∞—á')) return '–î–æ–±–∞–≤–ª—è–π—Ç–µ –∑–∞–¥–∞—á–∏ —Å –¥–∞—Ç–æ–π/–≤—Ä–µ–º–µ–Ω–µ–º ‚Äî –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ. –ù–∞–∂–º–∏—Ç–µ ‚úì, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π.';
      return '–Ø –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ –∏ –æ—Ç–≤–µ—á–∞—é –ª–æ–∫–∞–ª—å–Ω–æ. –°–ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–æ —Ñ–æ–∫—É—Å, –∑–∞–¥–∞—á–∏, HADI –∏–ª–∏ –ø–ª–∞–Ω ‚Äî –ø–æ–¥—Å–∫–∞–∂—É.';
    }

    async function sendChat(){
      const q = chat.input.value.trim(); if(!q) return;
      pushBubble(q, true); chat.input.value='';
      try{
        if(store.mode==='online'){
          const r = await API('/chat', {method:'POST', body:JSON.stringify({q})});
          pushBubble(r?.a || '‚Ä¶');
        }else{
          pushBubble(localAI(q));
        }
      }catch(e){
        pushBubble(`–û—à–∏–±–∫–∞: ${String(e.message||e)}`);
      }
    }
    chat.send.onclick = sendChat;
    chat.input.onkeydown = (e)=> (e.key==='Enter') && sendChat();

    // ---------- Tabs ----------
    function showView(id){
      document.querySelectorAll('.view').forEach(v=> v.classList.remove('active'));
      document.getElementById('view-'+id).classList.add('active');
      tabs.forEach(t=> t.classList.toggle('active', t.dataset.view===id));
    }
    tabs.forEach(t=> t.addEventListener('click', ()=> showView(t.dataset.view)));

    // ---------- Init ----------
    async function init(){
      await store.detect();                // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º online/offline + –æ–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂
      await Promise.all([loadFocus(), loadTasks()]);
    }
    init();
  </script>
</body>
</html>
