<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Growth Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#eaf2ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#5b6b86;
      --brand:#3b82f6;
      --brand-2:#60a5fa;
      --ok:#22c55e;
      --danger:#ef4444;
      --ring:rgba(59,130,246,.25);
      --shadow: 0 10px 30px rgba(15,23,42,.10);
      --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 80% -10%, #dce9ff 20%, transparent 70%),
        radial-gradient(900px 700px at -10% 110%, #dbe7ff 10%, transparent 70%),
        var(--bg);
    }

    /* phone canvas */
    .shell{
      max-width: 440px;
      margin: 0 auto;
      min-height: 100%;
      display:flex; flex-direction:column;
      padding: env(safe-area-inset-top) 14px calc(86px + env(safe-area-inset-bottom));
    }

    header{
      display:flex; align-items:center; justify-content:space-between;
      padding: 8px 6px 4px;
    }
    .h-left h1{
      margin: 8px 0 2px;
      font-size: 28px; font-weight:800; letter-spacing:.2px;
    }
    .h-left .sub{ color:var(--muted); font-weight:600; }
    .avatar{
      width:56px;height:56px;border-radius:50%;
      display:grid;place-items:center;
      background:linear-gradient(135deg,#e8f1ff,#ffffff 70%);
      border:6px solid rgba(255,255,255,.8);
      box-shadow: var(--shadow);
    }
    .avatar svg{width:26px;height:26px;fill:var(--brand)}

    .card{
      background:var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 16px;
    }
    .card + .card{ margin-top:14px }

    .section-title{
      display:flex;align-items:center;gap:10px;
      font-weight:800; letter-spacing:.3px; margin:2px 0 12px;
    }
    .section-title .pill{
      font-size:12px; color:var(--brand); font-weight:700;
      background:rgba(59,130,246,.10);
      border:1px solid rgba(59,130,246,.20);
      padding:4px 10px; border-radius:999px;
    }

    /* Focus */
    .focus-title{
      display:flex; align-items:center; justify-content:space-between;
      color:var(--brand); font-weight:800; letter-spacing:.3px; margin-bottom:10px;
    }
    .edit-btn{
      appearance:none; border:0; background:transparent; color:var(--brand);
      font-weight:700; padding:6px 10px; border-radius:12px; cursor:pointer;
    }
    .edit-btn:active{ transform:translateY(1px) }

    .focus-main{
      font-size:20px; font-weight:700; line-height:1.35; margin-bottom:12px;
    }
    .focus-sub{ color:var(--muted); font-weight:600; font-size:14px; margin-bottom:10px }

    .progress{
      height:8px; background:#edf2ff; border-radius:99px; overflow:hidden; position:relative;
    }
    .progress > i{
      position:absolute; left:0; top:0; bottom:0;
      width:40%; background:linear-gradient(90deg,var(--brand),var(--brand-2));
      border-radius: 99px;
    }

    /* Tasks list */
    .task{
      display:grid; grid-template-columns:auto 1fr auto; align-items:center;
      gap:12px; padding:12px 4px; border-bottom:1px solid #f2f4fb;
    }
    .task:last-child{ border-bottom:0 }
    .t-ico{
      width:36px;height:36px; border-radius:12px;
      display:grid; place-items:center; background:#eef5ff; color:var(--brand);
      border:1px solid rgba(59,130,246,.18);
      font-weight:800;
    }
    .t-name{ font-weight:700 }
    .t-name small{ display:block; color:var(--muted); font-size:12px; font-weight:600 }
    .t-act{
      display:flex; gap:8px;
    }
    .chip{
      width:34px;height:34px; border-radius:12px; display:grid;place-items:center;
      border:1px solid #e9efff; background:#fff; cursor:pointer;
    }
    .chip.ok{ background:#eaffe7; border-color:#c8f5c8; color:#059669 }
    .chip.x { background:#fff0f0; border-color:#ffd7d7; color:#e11d48 }

    .add-row{
      display:flex; gap:10px; align-items:center; margin-top:10px;
      background:#f7faff;border:1px dashed rgba(59,130,246,.35);
      border-radius:16px; padding:10px 12px;
    }
    .add-row input{
      flex:1; border:0; outline:0; background:transparent; font:600 14px Inter;
    }
    .add-row .seg{
      display:flex; gap:8px; background:#fff; border:1px solid #edf2ff; padding:4px; border-radius:999px;
    }
    .seg button{
      border:0; background:#fff; padding:6px 10px; border-radius:999px; font-weight:700; color:var(--muted); cursor:pointer;
    }
    .seg button.active{ background:#eaf2ff; color:var(--brand) }
    .add-btn{
      border:0; background:linear-gradient(180deg,var(--brand),#2563eb);
      color:#fff; font-weight:800; border-radius:14px; padding:10px 14px; cursor:pointer;
      box-shadow: 0 8px 18px rgba(37,99,235,.25);
    }

    .show-all{
      display:flex; justify-content:space-between; align-items:center;
      padding-top:12px; margin-top:10px; border-top:1px solid #f1f3fb; color:var(--muted); font-weight:700;
    }
    .show-all a{ color:var(--brand); text-decoration:none; font-weight:800 }

    /* Big chat CTA */
    .chat-cta{
      margin-top:16px;
      border-radius: 18px;
      background:linear-gradient(180deg,var(--brand),#2563eb);
      color:#fff; font-weight:800; font-size:18px;
      padding:16px 20px; text-align:center; box-shadow: 0 14px 28px rgba(59,130,246,.35);
      cursor:pointer; user-select:none;
    }

    /* Bottom nav */
    .nav{
      position: fixed; left:0; right:0; bottom:0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.8);
      backdrop-filter: blur(16px);
      border-top:1px solid #e8eefc;
    }
    .tabs{
      max-width: 440px; margin:0 auto; display:grid; grid-template-columns:repeat(5,1fr); gap:8px;
      align-items:stretch;
    }
    .tab{
      display:grid; justify-items:center; gap:6px; padding:8px 0; border-radius:14px; color:#53627f; font-weight:700; text-decoration:none;
    }
    .tab svg{ width:22px; height:22px }
    .tab.active{ color:var(--brand); background:#eef5ff; border:1px solid rgba(59,130,246,.25) }

    /* Chat drawer */
    .chat{
      position: fixed; inset:auto 0 82px 0;
      display:none;
    }
    .chat.open{ display:block }
    .chat-box{
      max-width:440px; margin:0 auto; background:#ffffff; border:1px solid #eaf0ff;
      border-bottom-left-radius:18px; border-bottom-right-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden; display:flex; flex-direction:column; height: 55vh;
    }
    .chat-head{ padding:10px 14px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eef3ff; background:linear-gradient(180deg,#f9fbff,#ffffff) }
    .chat-body{ padding:12px; gap:10px; display:flex; flex-direction:column; overflow:auto }
    .msg{ max-width:80%; padding:10px 12px; border-radius:14px; font-weight:600; line-height:1.35 }
    .msg.u{ margin-left:auto; background:#eaf2ff; border:1px solid #dbe9ff }
    .msg.a{ margin-right:auto; background:#f6f8ff; border:1px solid #eef2ff }
    .chat-input{ display:flex; gap:8px; padding:10px; border-top:1px solid #eef3ff; }
    .chat-input input{ flex:1; border:1px solid #e8eefc; background:#fbfdff; border-radius:12px; padding:10px 12px; font:600 14px Inter; outline-color:var(--ring) }
    .chat-input button{ border:0; background:linear-gradient(180deg,var(--brand),#2563eb); color:#fff; font-weight:800; padding:10px 14px; border-radius:12px }

    /* Toast */
    .toast{
      position: fixed; left:50%; transform:translateX(-50%);
      bottom: calc(82px + env(safe-area-inset-bottom) + 10px);
      background:#111827; color:#fff; padding:10px 14px; border-radius:12px; font-weight:700;
      box-shadow:0 10px 20px rgba(0,0,0,.25); opacity:0; pointer-events:none; transition:.25s;
      max-width: 92vw;
    }
    .toast.show{ opacity:1 }
  </style>
</head>
<body>
  <div class="shell" id="page-home">
    <header>
      <div class="h-left">
        <div class="sub">Growth Assistant</div>
        <h1>Главная</h1>
      </div>
      <div class="avatar" title="Профиль">
        <svg viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.33 0-8 2.17-8 5v1h16v-1c0-2.83-3.67-5-8-5Z"/></svg>
      </div>
    </header>

    <!-- Focus -->
    <section class="card" id="focus-card">
      <div class="focus-title">
        <span>Фокус дня</span>
        <button class="edit-btn" id="focus-edit">✎ Изменить</button>
      </div>
      <div class="focus-main" id="focus-text">Самое главное сегодня…</div>
      <div class="focus-sub" id="focus-sub">Осталось: 0 подзадач, срок не задан</div>
      <div class="progress"><i id="focus-progress" style="width:0%"></i></div>
    </section>

    <!-- Tasks -->
    <section class="card">
      <div class="section-title"><span>Задачи</span><span class="pill" id="tasks-pill">Сегодня</span></div>
      <div id="tasks-list"></div>

      <!-- add row -->
      <div class="add-row" style="margin-top:12px">
        <div class="t-ico" aria-hidden="true">+</div>
        <input id="task-input" placeholder="Название задачи" />
        <div class="seg" id="seg">
          <button data-scope="today" class="active">Сегодня</button>
          <button data-scope="week">Неделя</button>
          <button data-scope="backlog">Бэклог</button>
        </div>
        <button class="add-btn" id="task-add">Добавить</button>
      </div>

      <div class="show-all">
        <span>Это только верхушка айсберга</span>
        <a href="#" id="toggle-all">Показать всё</a>
      </div>
    </section>

    <!-- Big Chat CTA -->
    <div class="chat-cta" id="open-chat">Чат с ассистентом</div>
  </div>

  <!-- Chat drawer -->
  <div class="chat" id="chat">
    <div class="chat-box">
      <div class="chat-head">
        <strong>Ассистент</strong>
        <button class="edit-btn" id="close-chat">Закрыть</button>
      </div>
      <div class="chat-body" id="chat-body">
        <div class="msg a">Привет! Чем помочь сейчас?</div>
      </div>
      <div class="chat-input">
        <input id="chat-input" placeholder="Попроси меня спланировать, HADI, дедлайны…" />
        <button id="chat-send">Отправить</button>
      </div>
    </div>
  </div>

  <!-- Bottom nav -->
  <nav class="nav">
    <div class="tabs">
      <a class="tab active" href="#" data-tab="home" title="Главная">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M5 20v-8.5l7-5.25 7 5.25V20h-5v-6H10v6Z"/></svg>
        <div>Главная</div>
      </a>
      <a class="tab" href="#" data-tab="plan">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M4 6h16v2H4V6Zm0 5h16v2H4v-2Zm0 5h10v2H4v-2Z"/></svg>
        <div>План</div>
      </a>
      <a class="tab" href="#" data-tab="calendar">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 3h2v2h6V3h2v2h3v16H4V5h3V3Zm12 8H5v8h14v-8Z"/></svg>
        <div>Календарь</div>
      </a>
      <a class="tab" href="#" data-tab="hadi">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm1 14h-2v-2h2Zm0-4h-2V6h2Z"/></svg>
        <div>Hadi</div>
      </a>
      <a class="tab" href="#" data-tab="profile">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.33 0-8 2.17-8 5v1h16v-1c0-2.83-3.67-5-8-5Z"/></svg>
        <div>Профиль</div>
      </a>
    </div>
  </nav>

  <div class="toast" id="toast"></div>

  <script>
    // ====== Helpers ======
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const toast = (m, t=2400) => {
      const el = $('#toast');
      el.textContent = m;
      el.classList.add('show');
      clearTimeout(el._t);
      el._t = setTimeout(()=>el.classList.remove('show'), t);
    };

    // ========== Minimal state ==========
    const state = {
      tg_id: null,               // подставится из Telegram WebApp, если есть
      scope: 'today',
      showAll: false,
      tasks: [],                 // {id, title, done, scope}
      focusText: '',
      focusProgress: 0,          // 0..100
    };

    // Попытка забрать tg_id из Telegram WebApp (если открыто там)
    try {
      if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe?.user) {
        state.tg_id = String(Telegram.WebApp.initDataUnsafe.user.id);
      }
    } catch(_) {}

    // Если tg_id не пришёл – используем локальный "demo"
    if (!state.tg_id) state.tg_id = 'demo-' + (localStorage.getItem('ga_demo_uid') || (localStorage.setItem('ga_demo_uid', crypto.randomUUID()), localStorage.getItem('ga_demo_uid')));

    const API = {
      base: location.origin,
      async getFocus(){
        const r = await fetch(`${this.base}/api/focus?tg_id=${encodeURIComponent(state.tg_id)}`);
        if(!r.ok) throw new Error('focus load');
        return r.json();
      },
      async setFocus(text){
        const r = await fetch(`${this.base}/api/focus`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ tg_id: state.tg_id, text })
        });
        if(!r.ok) throw new Error('focus save');
        return r.json();
      },
      async getTasks(scope, all=false){
        const r = await fetch(`${this.base}/api/tasks?scope=${scope}&all=${all?'1':'0'}&tg_id=${encodeURIComponent(state.tg_id)}`);
        if(!r.ok) throw new Error('tasks load');
        return r.json();
      },
      async addTask(title, scope){
        const r = await fetch(`${this.base}/api/tasks`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ tg_id: state.tg_id, title, scope })
        });
        if(!r.ok) throw new Error('task add');
        return r.json();
      },
      async toggleTask(id, done){
        const r = await fetch(`${this.base}/api/tasks/${encodeURIComponent(id)}`,{
          method:'PATCH', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ tg_id: state.tg_id, done })
        });
        if(!r.ok) throw new Error('task toggle');
        return r.json();
      },
      async removeTask(id){
        const r = await fetch(`${this.base}/api/tasks/${encodeURIComponent(id)}`,{ method:'DELETE' });
        if(!r.ok) throw new Error('task remove');
        return r.json();
      },
      async chat(msg){
        const r = await fetch(`${this.base}/api/chat`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ tg_id: state.tg_id, message: msg })
        });
        if(!r.ok) throw new Error('chat');
        return r.json();
      }
    };

    // ====== UI bindings ======
    function renderFocus(){
      $('#focus-text').textContent = state.focusText || 'Самое главное сегодня…';
      const w = Math.max(0, Math.min(100, state.focusProgress|0));
      $('#focus-progress').style.width = w + '%';
      $('#focus-sub').textContent = w>0 ? `Прогресс: ${w}%` : 'Осталось: 0 подзадач, срок не задан';
    }

    function taskRow(t){
      const wrap = document.createElement('div');
      wrap.className = 'task';
      wrap.dataset.id = t.id;

      const ico = document.createElement('div'); ico.className='t-ico'; ico.textContent='•';
      const name = document.createElement('div'); name.className='t-name'; name.innerHTML = t.title + (t.due ? `<small>до ${t.due}</small>` : '');
      const act = document.createElement('div'); act.className='t-act';

      const ok = document.createElement('button'); ok.className='chip'; ok.title='Готово';
      ok.innerHTML = '✓'; if (t.done) ok.classList.add('ok');
      ok.onclick = async () => {
        const next = !t.done;
        ok.classList.toggle('ok', next);
        name.style.opacity = next? .55 : 1;
        try{
          await API.toggleTask(t.id, next);
          t.done = next;
        }catch(e){
          // откат
          ok.classList.toggle('ok', !next);
          name.style.opacity = !next? .55 : 1;
          toast('Не удалось обновить задачу');
        }
      };

      const del = document.createElement('button'); del.className='chip x'; del.title='Удалить'; del.textContent='✕';
      del.onclick = async ()=>{
        const hold = wrap;
        hold.style.opacity = .5;
        try{
          // быстрый визуальный эффект
          hold.style.transition = 'transform .15s ease, opacity .15s';
          hold.style.transform = 'translateX(-12px)';
          await API.removeTask(t.id);
          hold.remove();
        }catch(e){
          hold.style.opacity = 1; hold.style.transform='none';
          toast('Не удалось удалить');
        }
      };

      act.append(ok, del);
      wrap.append(ico, name, act);
      if (t.done) name.style.opacity = .55;
      return wrap;
    }

    function renderTasks(){
      const box = $('#tasks-list');
      box.innerHTML = '';
      state.tasks.forEach(t => box.append(taskRow(t)));
      $('#tasks-pill').textContent = state.scope==='today'?'Сегодня':(state.scope==='week'?'Неделя':'Бэклог');
      $('#toggle-all').textContent = state.showAll? 'Скрыть лишнее' : 'Показать всё';
    }

    // ====== Events ======
    $('#focus-edit').onclick = async ()=>{
      const t = prompt('Новый фокус дня', state.focusText || '');
      if (t == null) return;
      const old = state.focusText;
      state.focusText = t.trim();
      renderFocus();
      try{
        await API.setFocus(state.focusText);
        toast('Фокус сохранён');
      }catch(e){
        state.focusText = old; renderFocus();
        toast('Не удалось сохранить фокус');
      }
    };

    // scope switch
    $$('#seg button').forEach(btn=>{
      btn.onclick = async ()=>{
        $$('#seg button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        state.scope = btn.dataset.scope;
        await loadTasks();
      };
    });

    $('#task-add').onclick = async ()=>{
      const title = $('#task-input').value.trim();
      if (!title) { toast('Введите название задачи'); return; }
      $('#task-input').value = '';
      // оптимистично добавим
      const temp = { id:'tmp-'+crypto.randomUUID(), title, done:false, scope: state.scope };
      state.tasks.unshift(temp); renderTasks();
      try{
        const r = await API.addTask(title, state.scope);
        // заменить временный id
        temp.id = r?.id ?? temp.id;
        temp.title = r?.title ?? title;
      }catch(e){
        // откат
        state.tasks = state.tasks.filter(x=>x!==temp); renderTasks();
        toast('Не удалось добавить задачу');
      }
    };

    $('#toggle-all').onclick = async (e)=>{ e.preventDefault(); state.showAll = !state.showAll; await loadTasks(); };

    // Chat
    $('#open-chat').onclick = ()=> $('#chat').classList.add('open');
    $('#close-chat').onclick = ()=> $('#chat').classList.remove('open');
    $('#chat-send').onclick = async ()=>{
      const inp = $('#chat-input'); const msg = inp.value.trim(); if(!msg) return;
      inp.value = '';
      pushMsg('u', msg);
      try{
        const r = await API.chat(msg);
        const text = r?.reply || 'Готово.';
        pushMsg('a', text);
      }catch(e){
        pushMsg('a', 'Я не дотянулся до сервера 😔 Но идея понятна — давай пока просто добавлю это в список дел?');
      }
    };
    function pushMsg(who, text){
      const bubble = document.createElement('div');
      bubble.className = 'msg '+who; bubble.textContent = text;
      const body = $('#chat-body'); body.append(bubble); body.scrollTop = body.scrollHeight;
    }

    // ====== Load data ======
    async function loadFocus(){
      try{
        const r = await API.getFocus();
        state.focusText = (r?.text ?? '').trim();
        state.focusProgress = r?.progress ?? 0;
      }catch(e){
        // тихий fallback
      }
      renderFocus();
    }
    async function loadTasks(){
      try{
        const r = await API.getTasks(state.scope, state.showAll);
        state.tasks = Array.isArray(r?.items) ? r.items : [];
      }catch(e){
        // если бэкенд не отвечает — не рушим интерфейс
        if (state.tasks.length === 0){
          state.tasks = [
            {id:'demo1', title:'Перезвонить клиенту', done:false},
            {id:'demo2', title:'Подготовить презентацию', done:false},
            {id:'demo3', title:'Запланировать встречу', done:true},
          ];
        }
      }
      renderTasks();
    }

    // kick
    (async function init(){
      await Promise.all([loadFocus(), loadTasks()]);
    })();

    // Навигация (пока заглушки — один файл)
    $$('.tab').forEach(t => {
      t.onclick = (e)=> {
        e.preventDefault();
        $$('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const name = t.dataset.tab;
        if (name!=='home') toast('Раздел скоро будет доступен');
        if (name==='home') window.scrollTo({top:0,behavior:'smooth'});
      };
    });
  </script>
</body>
</html>
