<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Growth Assistant</title>
  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --ink:#0f172a;
      --ink-2:#475569;
      --ink-3:#64748b;
      --brand:#3b82f6;
      --brand-2:#6366f1;
      --ok:#10b981;
      --warn:#f59e0b;
      --danger:#ef4444;
      --ring: rgba(59,130,246,.25);
      --shadow: 0 6px 16px rgba(15,23,42,.06), 0 1px 0 rgba(15,23,42,.04) inset;
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 80% -200px, #e9f0ff 0%, transparent 60%),
        radial-gradient(800px 600px at -100px 10%, #eff8ff 0%, transparent 65%),
        var(--bg);
      color:var(--ink);
      font:16px/1.45 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .container{ max-width: 980px; margin-inline:auto; padding: 16px env(safe-area-inset-right) 110px env(safe-area-inset-left); }

    .brand{ display:flex; align-items:center; gap:12px; padding:8px 12px; border-radius:14px; background:linear-gradient(135deg,#eef5ff,#fff); box-shadow: var(--shadow); margin-bottom: 16px; }
    .brand .logo{ width:40px;height:40px; display:grid; place-items:center; border-radius:12px; background:linear-gradient(135deg,#6ea8ff,#7c6cff); color:#fff; font-weight:700; box-shadow: 0 8px 20px rgba(99,102,241,.25); }
    .brand .title{ font-weight:800; letter-spacing:.2px; }
    .brand .subtitle{ color:var(--ink-3); font-size:13px; margin-top:-2px; }

    h2{ margin:18px 6px 8px; font-size:22px; letter-spacing:.2px; }
    .card{ background:var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding:16px; margin:10px 0 16px; }

    .row{display:flex; gap:12px; align-items:center}
    .grow{flex:1}
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; background:#f1f5ff; color:#1e3a8a; font-weight:600; font-size:13px; }

    input[type="text"], input[type="date"], input[type="time"]{
      width:100%; background:#f8fafc; color:var(--ink);
      border:1px solid #e5e7eb; padding:12px 14px; border-radius:12px;
      outline:none; transition:border-color .2s, box-shadow .2s;
    }
    input:focus{ border-color: var(--brand); box-shadow: 0 0 0 4px var(--ring); }

    .btn{ appearance:none; border:0; cursor:pointer; user-select:none; padding:12px 16px; border-radius:12px; font-weight:700; color:#fff;
      background:linear-gradient(135deg,var(--brand),var(--brand-2)); box-shadow: 0 6px 16px rgba(59,130,246,.28);
      transition: transform .05s ease, box-shadow .2s ease, opacity .2s ease; }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{ background:#e2e8f0; color:#0f172a; box-shadow:none }
    .btn.ok{ background: linear-gradient(135deg,#34d399,#10b981) }

    .muted{color:var(--ink-3); font-size:13px}
    .hint{font-size:12px; color:var(--ink-3)}

    /* tasks */
    .task{ background:#fff; border-radius:14px; padding:14px 12px; display:flex; align-items:center; gap:12px; box-shadow: var(--shadow); margin:10px 0; }
    .task .dot{ width:26px;height:26px; border-radius:999px; background:linear-gradient(135deg,#89cffb,#6da8ff); display:grid; place-items:center; color:#fff; font-size:14px; font-weight:800; flex:0 0 26px; }
    .task.done{ opacity:.6 }
    .task .title{ font-weight:700 }
    .task .sub{ font-size:13px; color:var(--ink-3) }
    .task .actions{ margin-left:auto; display:flex; gap:8px }
    .toggle{ display:inline-grid; place-items:center; width:36px;height:36px; border-radius:10px; background:#ecfeff; color:#0891b2; border:1px solid #cffafe; cursor:pointer; }
    .toggle.ok{ background:#ecfdf5; color:#047857; border-color:#bbf7d0 }
    .toggle.danger{ background:#fff1f2; color:#be123c; border-color:#fecdd3 }

    .chat-cta{ position:fixed; left:16px; right:16px; bottom:86px; border-radius:18px; padding:14px 18px; font-weight:800; color:#fff;
      background:linear-gradient(135deg,#5aa3ff,#4f46e5); display:flex; align-items:center; justify-content:center; gap:8px; box-shadow: 0 16px 40px rgba(59,130,246,.35); z-index: 20; }

    nav{ position:fixed; left:0; right:0; bottom:0; background:#fff; box-shadow: 0 -6px 20px rgba(15,23,42,.08); border-top-left-radius: 16px; border-top-right-radius: 16px;
      padding: 8px calc(12px + env(safe-area-inset-right)) calc(8px + env(safe-area-inset-bottom)) calc(12px + env(safe-area-inset-left));
      display:flex; gap:8px; justify-content:space-between; z-index:30; }
    .tab{ flex:1; border-radius:12px; padding:10px 6px; text-align:center; color:var(--ink-3); font-weight:700; cursor:pointer; user-select:none; }
    .tab.active{ background:linear-gradient(135deg,#eef4ff,#ffffff); color:var(--ink); box-shadow: var(--shadow); }

    .view{ display:none } .view.active{ display:block }

    .modal{ position:fixed; inset:0; display:none; z-index:40; }
    .modal.open{ display:block }
    .scrim{ position:absolute; inset:0; background:rgba(2,6,23,.48); backdrop-filter: blur(8px); }
    .sheet{ position:absolute; left:0; right:0; bottom:0; background:#fff; border-top-left-radius:20px; border-top-right-radius:20px; box-shadow: 0 -20px 40px rgba(2,6,23,.35);
      max-height: 78vh; display:flex; flex-direction:column; padding-bottom: env(safe-area-inset-bottom); }
    .sheet .hdr{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #eef2f7; }
    .messages{ padding:12px 16px; overflow:auto; min-height:180px; }
    .bubble{ max-width:86%; margin:10px 0; padding:10px 12px; border-radius:14px; box-shadow: var(--shadow); }
    .bubble.me{ background:#ecfeff; color:#042f2e; margin-left:auto }
    .bubble.ai{ background:#f8fafc }
    .composer{ display:flex; gap:8px; padding:12px 16px; border-top:1px solid #eef2f7 }
    .composer input{ flex:1 }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom: calc(86px + 62px); background:#0f172a; color:#fff; border-radius:12px; padding:10px 14px; font-weight:700; z-index:50; display:none; }
    .toast.show{ display:block }

    .pill{ font-size:12px; color:var(--ink-3); margin-left:8px }
  </style>
</head>
<body>
  <div class="container">
    <div class="brand">
      <div class="logo">GA</div>
      <div>
        <div class="title">Growth Assistant</div>
        <div class="subtitle">–ú–∏–Ω–∏-–ø–æ–º–æ—â–Ω–∏–∫ –≤ Telegram</div>
      </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω–∞—è -->
    <section id="view-home" class="view active">
      <h2>–°–µ–≥–æ–¥–Ω—è</h2>

      <div class="card">
        <div class="row" style="margin-bottom:10px"><div class="chip">–§–æ–∫—É—Å –¥–Ω—è</div></div>
        <div class="row">
          <input class="grow" id="focus-input" type="text" placeholder="–°–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ —Å–µ–≥–æ–¥–Ω—è‚Ä¶">
          <button class="btn" id="focus-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div class="hint" id="focus-hint"></div>
      </div>

      <div class="card">
        <div class="row" style="margin-bottom:10px"><div class="chip">–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</div></div>
        <input id="task-title" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
        <div class="row" style="margin-top:10px">
          <button class="btn secondary" data-scope="today" id="scope-today">–°–µ–≥–æ–¥–Ω—è</button>
          <button class="btn secondary" data-scope="week" id="scope-week">–ù–µ–¥–µ–ª—è</button>
          <button class="btn secondary" data-scope="backlog" id="scope-backlog">–ë—ç–∫–ª–æ–≥</button>
          <span class="grow"></span>
        </div>
        <div class="row" style="margin-top:10px">
          <input id="task-date" type="date" style="max-width:180px">
          <input id="task-time" type="time" style="max-width:140px">
          <button class="btn" id="task-add">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <h2>–ó–∞–¥–∞—á–∏ <span class="pill" id="sync-pill"></span></h2>
      <div id="tasks"></div>
    </section>

    <!-- –ü–ª–∞–Ω -->
    <section id="view-plan" class="view">
      <h2>–ü–ª–∞–Ω</h2>
      <div class="card"><div class="muted">–°–∫–æ—Ä–æ —Ç—É—Ç –ø–æ—è–≤–∏—Ç—Å—è —Å–ø—Ä–∏–Ω—Ç-–ø–ª–∞–Ω –∏ HADI-—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã.</div></div>
    </section>

    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
    <section id="view-calendar" class="view">
      <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
      <div class="card"><div class="muted">–ö–∞–ª–µ–Ω–¥–∞—Ä—å —á–∏—Ç–∞–µ—Ç –∑–∞–¥–∞—á–∏ –∏ –¥–µ–¥–ª–∞–π–Ω—ã ‚Äî —Å–µ–π—á–∞—Å –≤ —Ä–µ–∂–∏–º–µ —á—Ç–µ–Ω–∏—è.</div></div>
    </section>

    <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
    <section id="view-profile" class="view">
      <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
      <div class="card"><div class="muted">–í—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ –∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ.</div></div>
    </section>
  </div>

  <button class="chat-cta" id="chat-open">üí¨ –ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</button>

  <nav>
    <div class="tab active" data-view="home">–ì–ª–∞–≤–Ω–∞—è</div>
    <div class="tab" data-view="plan">–ü–ª–∞–Ω</div>
    <div class="tab" data-view="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
    <div class="tab" data-view="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
  </nav>

  <!-- Chat Modal -->
  <div class="modal" id="chat">
    <div class="scrim" id="chat-close"></div>
    <div class="sheet">
      <div class="hdr">
        <strong>–ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</strong>
        <button class="btn secondary" id="chat-x">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="messages" id="messages"></div>
      <div class="composer">
        <input id="chat-input" type="text" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–æ –ø–ª–∞–Ω, HADI –∏–ª–∏ –∑–∞–¥–∞—á–∏‚Ä¶" />
        <button class="btn" id="chat-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ---------- Helpers ----------
    const tg = window.Telegram?.WebApp;
    if (tg?.expand) { try{ tg.expand() }catch(e){} }

    const tabs = [...document.querySelectorAll('.tab')];
    const toast = (msg, ms=2400)=>{
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), ms);
    };

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π API: –¥–æ–±–∞–≤–ª—è–µ–º initData, –ø—Ä–æ–±—É–µ–º –ø–∞—Ä–æ—á–∫—É –º–∞—Ä—à—Ä—É—Ç–æ–≤ –ø—Ä–∏ 404
    const API = async (path, opt={})=>{
      const base = window.location.origin;
      const initData = tg?.initData || '';
      const headers = Object.assign({ 'Content-Type':'application/json', 'x-telegram-init-data': initData }, (opt.headers || {}));
      const doFetch = (p) => fetch(`${base}/api${p}`, Object.assign({}, opt, {headers}));
      const r1 = await doFetch(path);
      if (r1.status !== 404) {
        if (!r1.ok) { let m = `${r1.status}`; try{ m = (await r1.json()).error || m }catch{}; throw new Error(m); }
        return r1.json().catch(()=> ({}));
      }
      // fallback: –µ—Å–ª–∏ /tasks?id= –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º /tasks/:id
      if (/^\/tasks\?id=/.test(path)) {
        const id = new URLSearchParams(path.split('?')[1]).get('id');
        const r2 = await doFetch(`/tasks/${id}${opt.method==='DELETE'?'':' '}`.trim());
        if (r2.ok) return r2.json().catch(()=> ({}));
      }
      // –≤—Ç–æ—Ä–æ–π fallback: —à–ª—ë–º –≤ body id
      try{
        const body = opt.body ? JSON.parse(opt.body) : {};
        if (body.id) {
          const r3 = await doFetch(`/tasks`);
          if (r3.ok) return r3.json().catch(()=> ({}));
        }
      }catch{}
      // –µ—Å–ª–∏ –ø—Ä—è–º —Å–æ–≤—Å–µ–º 404 ‚Äî –≤–µ—Ä–Ω—ë–º –æ—Ç–≤–µ—Ç –∫–∞–∫ –µ—Å—Ç—å
      throw new Error('404');
    };

    const scopeButtons = {
      today: document.getElementById('scope-today'),
      week: document.getElementById('scope-week'),
      backlog: document.getElementById('scope-backlog'),
    };
    let currentScope = 'today';
    Object.values(scopeButtons).forEach(b=>{
      b.addEventListener('click', ()=>{
        currentScope = b.dataset.scope;
        Object.values(scopeButtons).forEach(x=> x.classList.remove('ok'));
        b.classList.add('ok');
      });
    });
    scopeButtons.today.classList.add('ok');

    // ---------- Focus ----------
    async function loadFocus(){
      try{
        const data = await API('/focus');
        const input = document.getElementById('focus-input');
        const hint  = document.getElementById('focus-hint');
        input.value = data?.text || '';
        hint.textContent = data?.updated_at ? `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(data.updated_at).toLocaleString()}` : '';
      }catch(e){ /* ignore */ }
    }
    async function saveFocus(){
      const text = document.getElementById('focus-input').value.trim();
      if(!text) return toast('–í–≤–µ–¥–∏—Ç–µ —Ñ–æ–∫—É—Å –¥–Ω—è');
      try{
        await API('/focus', {method:'PUT', body:JSON.stringify({text})});
        toast('–§–æ–∫—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úÖ');
        loadFocus();
      }catch(e){ toast('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (focus)') }
    }
    document.getElementById('focus-save').onclick = saveFocus;

    // ---------- Tasks ----------
    const tasksEl = document.getElementById('tasks');
    const syncPill = document.getElementById('sync-pill');

    function taskRow(t){
      const row = document.createElement('div'); row.className='task'+(t.done?' done':''); row.dataset.id = t.id;
      row.innerHTML = `
        <div class="dot">‚Ä¢</div>
        <div class="grow">
          <div class="title">${escapeHtml(t.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
          ${t.due_at ? `<div class="sub">–î–µ–¥–ª–∞–π–Ω: ${new Date(t.due_at).toLocaleString()}</div>`:''}
        </div>
        <div class="actions">
          <button class="toggle ok" data-action="toggle" title="–ì–æ—Ç–æ–≤–æ">‚úì</button>
          <button class="toggle danger" data-action="delete" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
        </div>`;
      row.querySelector('[data-action="toggle"]').onclick = ()=> toggleTaskUI(t.id, !t.done, row);
      row.querySelector('[data-action="delete"]').onclick = ()=> removeTaskUI(t.id, row);
      return row;
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    async function loadTasks(){
      tasksEl.innerHTML = '';
      try{
        const data = await API('/tasks');
        (data.tasks || []).forEach(t=> tasksEl.appendChild(taskRow(t)));
      }catch(e){}
    }

    // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
    async function toggleTaskUI(id, done, row){
      // 1) –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ –º–µ–Ω—è–µ–º UI
      try{
        if (row) row.classList.toggle('done', done);
        syncPill.textContent = '—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º‚Ä¶';

        // 2) —à–ª—ë–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä ‚Äî —Å–Ω–∞—á–∞–ª–∞ query, –∑–∞—Ç–µ–º fallback
        try{
          await API(`/tasks?id=${id}`, {method:'PUT', body: JSON.stringify({done})});
          syncPill.textContent = '';
        }catch(err){
          // –Ω–µ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º UI; –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—Å—Ç
          toast(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (toggle): ${err.message||err}`);
          syncPill.textContent = '';
        }
      }catch(e){ /* ignore */ }
    }

    // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
    async function removeTaskUI(id, row){
      // 1) –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º
      if (row){
        row.style.transition='opacity .2s, transform .2s';
        row.style.opacity='0'; row.style.transform='translateY(4px)';
        setTimeout(()=> row.remove(), 220);
      }
      syncPill.textContent = '—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º‚Ä¶';
      try{
        await API(`/tasks?id=${id}`, {method:'DELETE'});
        syncPill.textContent = '';
      }catch(err){
        toast(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (delete): ${err.message||err}`);
        syncPill.textContent = '';
      }
    }

    async function addTask(){
      const title = document.getElementById('task-title').value.trim();
      const date = document.getElementById('task-date').value;
      const time = document.getElementById('task-time').value;
      if(!title) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
      const due_at = (date || time) ? new Date(`${date||''} ${time||'00:00'}`) : null;
      try{
        await API('/tasks',{method:'POST', body:JSON.stringify({
          title, scope: currentScope, due_at: due_at? due_at.toISOString(): null
        })});
        document.getElementById('task-title').value='';
        toast('–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ ‚úÖ');
        loadTasks();
      }catch(e){ toast(`API: ${String(e.message||e).toUpperCase()}`) }
    }
    document.getElementById('task-add').onclick = addTask;

    // ---------- Chat ----------
    const chat = {
      modal: document.getElementById('chat'),
      openBtn: document.getElementById('chat-open'),
      closeBtn: document.getElementById('chat-x'),
      scrim: document.getElementById('chat-close'),
      list: document.getElementById('messages'),
      input: document.getElementById('chat-input'),
      send: document.getElementById('chat-send'),
    };
    const openChat = ()=> { chat.modal.classList.add('open'); setTimeout(()=> chat.input?.focus(), 80); };
    const closeChat = ()=> chat.modal.classList.remove('open');
    chat.openBtn.onclick = openChat; chat.closeBtn.onclick = closeChat; chat.scrim.onclick = closeChat;

    function pushBubble(text, me=false){
      const b = document.createElement('div');
      b.className = 'bubble '+(me?'me':'ai');
      b.textContent = text; chat.list.appendChild(b);
      chat.list.scrollTop = chat.list.scrollHeight;
    }
    async function sendChat(){
      const q = chat.input.value.trim(); if(!q) return;
      pushBubble(q, true); chat.input.value='';
      try{
        const r = await API('/chat', {method:'POST', body:JSON.stringify({q})});
        pushBubble(r?.a || '‚Ä¶');
      }catch(e){ pushBubble(`–û—à–∏–±–∫–∞: ${String(e.message||e)}`); }
    }
    chat.send.onclick = sendChat;
    chat.input.onkeydown = (e)=> (e.key==='Enter') && sendChat();

    // ---------- Tabs ----------
    function showView(id){
      document.querySelectorAll('.view').forEach(v=> v.classList.remove('active'));
      document.getElementById('view-'+id).classList.add('active');
      tabs.forEach(t=> t.classList.toggle('active', t.dataset.view===id));
    }
    tabs.forEach(t=> t.addEventListener('click', ()=> showView(t.dataset.view)));

    // ---------- Init ----------
    async function init(){ await Promise.all([loadFocus(), loadTasks()]); }
    init();
  </script>
</body>
</html>
