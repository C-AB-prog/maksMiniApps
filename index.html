<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Growth Assistant</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* ============ Design tokens ============ */
:root{
  --bg: #F5F7FB;
  --card: #FFFFFF;
  --ink: #0E1220;
  --muted:#6B7280;
  --line:#E8ECF3;
  --brand:#5B6CFF;
  --brand-2:#7F6BFF;
  --ok:#10B981;
  --warn:#F59E0B;
  --danger:#EF4444;
  --r: 18px;
  --shadow: 0 10px 28px rgba(17,24,39,.10);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-top: env(safe-area-inset-top, 0px);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial}
button{font:inherit}
a{color:var(--brand);text-decoration:none}

/* App bar */
.appbar{
  position:sticky; top:0; z-index:20;
  padding: calc(10px + var(--safe-top)) 16px 12px;
  background: linear-gradient(180deg, #F3F6FF 0%, rgba(243,246,255,.75) 100%);
  border-bottom:1px solid var(--line);
}
.appbar h1{margin:0; font-size:20px; font-weight:800; letter-spacing:.2px}
.appbar .sub{color:var(--muted); font-size:12px}

/* Layout */
.container{max-width:840px;margin:0 auto;padding:16px 14px 96px}
.card{
  background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); padding:14px;
}
h3{margin:0 0 10px 0; font-size:16px}

/* Inputs / buttons */
label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
.input, input[type="text"], input[type="datetime-local"]{
  width:100%; background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px 12px; outline:none;
}
.input:focus, input[type="text"]:focus, input[type="datetime-local"]:focus{border-color:var(--brand)}
.btn{
  appearance:none; border:none; padding:12px 14px; border-radius:12px; background:var(--brand); color:#fff; cursor:pointer; font-weight:700;
  box-shadow:0 10px 26px rgba(91,108,255,.28);
}
.btn.secondary{background:#fff;color:var(--ink); border:1px solid var(--line); box-shadow:none}
.btn.ghost{background:rgba(91,108,255,.08); color:var(--brand); box-shadow:none}
.btn.icon{padding:8px 10px; border-radius:10px}

/* Segmented */
.seg{display:flex;gap:8px;flex-wrap:wrap}
.seg .chip{
  padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:#fff; cursor:pointer
}
.seg .chip.active{background:var(--brand); color:#fff; border-color:var(--brand); box-shadow:0 6px 18px rgba(91,108,255,.28)}

/* Lists */
.list{display:flex;flex-direction:column;gap:10px}
.task{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}
.task.done{opacity:.7}
.task .ttl{flex:1}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted)}
.badge.ok{color:#065f46;border-color:#10b981;background:#ecfdf5}
.badge.due{color:#7c2d12;border-color:#f59e0b;background:#fffbeb}
.badge.dead{color:#991b1b;border-color:#ef4444;background:#fef2f2}

/* Calendar */
.cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:6px;color:var(--muted);font-size:12px}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.day{background:#fff;border:1px solid var(--line);padding:10px;border-radius:12px;min-height:68px;position:relative}
.day .n{font-weight:800}
.dot{width:8px;height:8px;border-radius:50%;background:var(--brand);position:absolute;right:8px;bottom:8px}
.count{position:absolute;left:8px;bottom:6px}

/* Chat */
.chat{display:flex;flex-direction:column;height:300px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
.chat-body{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px;background:#FAFBFF}
.bubble{max-width:82%;padding:10px 12px;border-radius:14px}
.me{align-self:flex-end;background:linear-gradient(135deg, var(--brand), var(--brand-2));color:#fff;border-bottom-right-radius:4px}
.bot{align-self:flex-start;background:#fff;border:1px solid var(--line);border-bottom-left-radius:4px}
.chat-foot{display:flex;gap:8px;padding:8px;border-top:1px solid var(--line);background:#fff}

/* Bottom nav */
.nav{
  position:fixed; left:0; right:0; bottom:0; z-index:25;
  padding:8px 10px calc(8px + var(--safe-bottom));
  background:#fff; border-top:1px solid var(--line); box-shadow:0 -8px 20px rgba(17,24,39,.08);
  display:flex; justify-content:space-around
}
.nav .item{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:64px;color:var(--muted);font-size:12px}
.nav .item svg{opacity:.6}
.nav .item.active{color:var(--brand)}
.nav .item.active svg{opacity:1; filter: drop-shadow(0 4px 8px rgba(91,108,255,.45))}

/* Sections */
section{display:none;gap:14px}
section.active{display:grid}
.grid-2{grid-template-columns:1.15fr .85fr}

/* Toast */
.toast{position:fixed;left:50%;bottom:calc(70px + var(--safe-bottom));transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 20px rgba(0,0,0,.2);z-index:999}
.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
.muted{color:var(--muted)}
</style>
</head>
<body>

<!-- Top bar -->
<div class="appbar">
  <h1>Growth Assistant</h1>
  <div class="sub">Фокус дня • задачи • календарь • HADI</div>
</div>

<div class="container">

  <!-- Главная (чат на экране) -->
  <section id="screen-home" class="active grid-2">
    <div class="card">
      <h3>Чат с ассистентом</h3>
      <div class="chat">
        <div id="chat-body" class="chat-body">
          <div class="bubble bot">Привет! Напиши, что нужно сделать — помогу разбить по шагам и добавить в задачи.</div>
        </div>
        <div class="chat-foot">
          <input id="chat-input" class="input" type="text" placeholder="Спросите про план, HADI или задачу…" />
          <button id="chat-send" class="btn">➤</button>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">Если сервер чата не подключён — отвечу подсказкой, интерфейс не ломается.</div>
    </div>

    <div class="card">
      <h3>Фокус дня</h3>
      <label>Самое главное сегодня</label>
      <div style="display:flex; gap:10px">
        <input id="focus-input" class="input" type="text" placeholder="Например: закрыть отчёт" />
        <button id="focus-save" class="btn">Сохранить</button>
      </div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">Быстрое добавление</h3>
        <div class="seg">
          <div class="chip" data-prio="today">Сегодня</div>
          <div class="chip" data-prio="week">Неделя</div>
          <div class="chip" data-prio="backlog">Бэклог</div>
        </div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <input id="quick-title" class="input" type="text" placeholder="Название задачи" style="flex:1 1 320px" />
        <input id="quick-due" class="input" type="datetime-local" style="width:220px" />
        <button id="quick-add" class="btn">Добавить</button>
      </div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <h3>Задачи на сегодня</h3>
      <div id="tasks-today" class="list"></div>
    </div>
  </section>

  <!-- План -->
  <section id="screen-plan" class="grid">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">План</h3>
        <div class="seg">
          <div id="f-week" class="chip active">Неделя</div>
          <div id="f-backlog" class="chip">Бэклог</div>
          <div id="f-all" class="chip">Все</div>
        </div>
      </div>
      <div id="tasks-plan" class="list"></div>
    </div>
  </section>

  <!-- Календарь -->
  <section id="screen-calendar" class="grid grid-2">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Календарь</h3>
        <div style="display:flex;gap:8px">
          <button id="m-prev" class="btn ghost icon">‹</button>
          <button id="m-next" class="btn ghost icon">›</button>
        </div>
      </div>
      <div id="cal-head" class="cal-head" style="margin-top:10px"></div>
      <div id="calendar" class="calendar"></div>
    </div>
    <div class="card">
      <h3>Задачи выбранного дня</h3>
      <div id="tasks-day" class="list"></div>
    </div>
  </section>

  <!-- Профиль/HADI -->
  <section id="screen-profile" class="grid grid-2">
    <div class="card">
      <h3>HADI — метрики</h3>
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:6px">
        <div class="card" style="flex:1;min-width:180px"><label>Всего задач</label><div id="m-total" style="font-size:22px;font-weight:800">0</div></div>
        <div class="card" style="flex:1;min-width:180px"><label>Выполнено</label><div id="m-done" style="font-size:22px;font-weight:800;color:var(--ok)">0</div></div>
        <div class="card" style="flex:1;min-width:180px"><label>Успех (Done/All)</label><div id="m-rate" style="font-size:22px;font-weight:800">0%</div></div>
        <div class="card" style="flex:1;min-width:180px"><label>Просрочено</label><div id="m-over" style="font-size:22px;font-weight:800;color:var(--danger)">0</div></div>
      </div>
      <p class="muted" style="margin-top:8px">
        <b>H</b>ypothesis: «Если фиксировать задачи и ставить дедлайны, завершу ≥70% вовремя».<br/>
        <b>A</b>ction: добавляй/закрывай задачи вовремя. <b>D</b>ata: метрики справа. <b>I</b>nsight: держи ≥70%.
      </p>
    </div>
    <div class="card">
      <h3>Профиль</h3>
      <div class="muted">Telegram ID: <span id="profile-id" class="mono">–</span></div>
      <div class="muted">Регион сервера: <span id="profile-region" class="mono">–</span></div>
    </div>
  </section>
</div>

<!-- Bottom navigation -->
<nav class="nav">
  <div class="item active" data-go="home">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 7v10a1 1 0 0 1-1 1h-6v-6H10v6H4a1 1 0 0 1-1-1V10l9-7z"/></svg>
    Главная
  </div>
  <div class="item" data-go="plan">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M4 5h16v2H4zM4 11h16v2H4zM4 17h10v2H4z"/></svg>
    План
  </div>
  <div class="item" data-go="calendar">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2h2v2h6V2h2v2h3v18H4V4h3V2zm13 8H4v10h16V10z"/></svg>
    Календарь
  </div>
  <div class="item" data-go="profile">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.42 0-8 2.24-8 5v3h16v-3c0-2.76-3.58-5-8-5z"/></svg>
    Профиль
  </div>
</nav>

<div id="toast" class="toast" style="display:none"></div>

<script>
/* ====== helpers ====== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const showToast = (t) => { const el = $('#toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',1800); }
const fmt = ts => new Date(ts).toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
const startOfDay = d => { const x = new Date(d); x.setHours(0,0,0,0); return x; }
const endOfDay = d => { const x = new Date(d); x.setHours(23,59,59,999); return x; }
const addDays = (d,n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x;}

/* ====== telegram id ====== */
let tgId = 0;
try {
  const qid = new URLSearchParams(location.search).get('tg_id');
  if (qid) tgId = Number(qid);
  if (!tgId && window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
    tgId = Number(window.Telegram.WebApp.initDataUnsafe.user.id);
  }
} catch {}
$('#profile-id').textContent = tgId || '–';

const HEADERS = () => tgId ? { 'Content-Type':'application/json', 'X-TG-ID': String(tgId) } : { 'Content-Type':'application/json' };
async function api(path, method='GET', body=null) {
  const opt = { method, headers: HEADERS() };
  if (body) opt.body = JSON.stringify(body);
  const r = await fetch(path, opt);
  const ct = r.headers.get('content-type')||'';
  if (!ct.includes('application/json')) throw new Error('not-json');
  const data = await r.json();
  if (!r.ok || data.ok===false) throw new Error(data.error||('HTTP '+r.status));
  return data;
}

/* ====== nav ====== */
const screens = {
  home: $('#screen-home'),
  plan: $('#screen-plan'),
  calendar: $('#screen-calendar'),
  profile: $('#screen-profile'),
};
$$('.nav .item').forEach(it=>{
  it.onclick = ()=>{
    $$('.nav .item').forEach(x=>x.classList.remove('active'));
    it.classList.add('active');
    const to = it.dataset.go;
    Object.values(screens).forEach(s=>s.classList.remove('active'));
    screens[to].classList.add('active');
    if (to==='calendar') renderCalendar();
  };
});

/* ====== state ====== */
let tasks = [];
let focus = null;
let quickPrio = 'today';
let currentMonth = new Date();

/* ====== init UI ====== */
const segChips = $$('.seg .chip[data-prio], .seg .chip#f-week, .seg .chip#f-backlog, .seg .chip#f-all');
/* quick prio */
$$('.seg .chip[data-prio]').forEach(ch=>{
  ch.onclick = ()=>{
    $$('.seg .chip[data-prio]').forEach(x=>x.classList.remove('active'));
    ch.classList.add('active');
    quickPrio = ch.dataset.prio;
  };
});
$$('.seg .chip[data-prio]')[0].classList.add('active');

/* план фильтр */
let planFilter='week';
$('#f-week').onclick=()=>{planFilter='week'; updPlanBtns(); renderPlan();}
$('#f-backlog').onclick=()=>{planFilter='backlog'; updPlanBtns(); renderPlan();}
$('#f-all').onclick=()=>{planFilter='all'; updPlanBtns(); renderPlan();}
function updPlanBtns(){
  $('#f-week').classList.toggle('active', planFilter==='week');
  $('#f-backlog').classList.toggle('active', planFilter==='backlog');
  $('#f-all').classList.toggle('active', planFilter==='all');
}

/* ====== load ====== */
async function loadAll(){
  try{
    const h = await api('/api/health');
    $('#profile-region').textContent = h.region || '–';
  }catch{ $('#profile-region').textContent = '–'; }
  try{
    const f = await api('/api/focus');
    focus = f.focus||null;
    $('#focus-input').value = focus?.text || '';
  }catch{}
  try{
    const t = await api('/api/tasks');
    tasks = t.items||[];
  }catch{}
  renderHome(); renderPlan(); renderCalendar(); renderHADI();
}
loadAll();

/* ====== focus ====== */
$('#focus-save').onclick = async ()=>{
  const text = $('#focus-input').value.trim();
  if (!text) return showToast('Пустой фокус');
  try{
    const r = await api('/api/focus','POST',{ text });
    focus = r.focus;
    showToast('Фокус сохранён');
  }catch(e){ showToast('Ошибка сервера (focus)'); }
};

/* ====== quick add ====== */
$('#quick-add').onclick = async ()=>{
  const title = $('#quick-title').value.trim();
  const dueStr = $('#quick-due').value;
  if (!title) return showToast('Введите название');
  let due_ts = null;
  if (dueStr){ const ms = Date.parse(dueStr); if (!isNaN(ms)) due_ts = ms; }
  else{
    if (quickPrio==='today') due_ts = endOfDay(new Date()).getTime();
    else if (quickPrio==='week') due_ts = endOfDay(addDays(new Date(),7)).getTime();
    else due_ts = null;
  }
  try{
    const r = await api('/api/tasks','POST',{ title, due_ts });
    tasks.unshift(r.task);
  }catch(e){
    // офлайн-видимость: добавим локально
    const fake = { id: 'tmp_'+Date.now(), title, due_ts, is_done:false };
    tasks.unshift(fake);
  }
  $('#quick-title').value=''; $('#quick-due').value='';
  renderHome(); renderPlan(); renderCalendar(); renderHADI();
  showToast('Добавлено');
};

/* ====== render: tasks ====== */
function rowTask(t){
  const el = document.createElement('div'); el.className='task'+(t.is_done?' done':'');
  const chk = document.createElement('button'); chk.className='btn icon'; chk.textContent = t.is_done?'✓':'○';
  chk.onclick = async ()=>{
    // оптимистично
    t.is_done = !t.is_done; renderHome(); renderPlan(); renderCalendar(); renderHADI();
    try{ await api('/api/tasks/toggle?id='+t.id,'POST',{}); }
    catch(e){ /* если 404 — оставим как есть для видимости */ }
  };
  const ttl = document.createElement('div'); ttl.className='ttl'; ttl.textContent = t.title;
  const badge = document.createElement('div');
  if (t.due_ts==null){ badge.className='badge'; badge.textContent='бэклог'; }
  else{
    const past = t.due_ts < Date.now();
    badge.className = 'badge ' + (past ? (t.is_done?'ok':'dead') : 'due');
    badge.textContent = (t.is_done?'сделано • ':'до ') + fmt(t.due_ts);
  }
  const del = document.createElement('button'); del.className='btn secondary icon'; del.textContent='✕';
  del.onclick = async ()=>{
    const old = tasks.slice();
    tasks = tasks.filter(x=>x.id!==t.id);
    renderHome(); renderPlan(); renderCalendar(); renderHADI();
    try{ await api('/api/tasks/delete?id='+t.id,'POST',{}); }
    catch(e){ /* если ошибка — оставим удалённым, создаём видимость */ }
  };
  el.append(chk, ttl, badge, del);
  return el;
}

function renderHome(){
  const s = startOfDay(new Date()).getTime();
  const e = endOfDay(new Date()).getTime();
  const today = tasks.filter(t => t.due_ts!=null && t.due_ts>=s && t.due_ts<=e)
    .sort((a,b)=>(a.is_done-b.is_done)||((a.due_ts||0)-(b.due_ts||0)));
  const box = $('#tasks-today'); box.innerHTML='';
  if (!today.length){ box.innerHTML='<div class="muted">На сегодня нет задач.</div>'; return; }
  today.forEach(t=> box.appendChild(rowTask(t)));
}

function renderPlan(){
  let arr = tasks.slice();
  const now = new Date();
  const weekEnd = endOfDay(addDays(now,7)).getTime();
  if (planFilter==='week') arr = arr.filter(t=> t.due_ts!=null && t.due_ts<=weekEnd);
  if (planFilter==='backlog') arr = arr.filter(t=> t.due_ts==null);
  arr.sort((a,b)=>(a.is_done-b.is_done)||((a.due_ts||1e20)-(b.due_ts||1e20)));
  const box = $('#tasks-plan'); box.innerHTML='';
  if (!arr.length){ box.innerHTML='<div class="muted">Пусто.</div>'; return; }
  arr.forEach(t=> box.appendChild(rowTask(t)));
}

/* ====== calendar ====== */
let currentDate = new Date();
function metaMonth(d){ const y=d.getFullYear(), m=d.getMonth(); const first=new Date(y,m,1), last=new Date(y,m+1,0); return {first,last,days:last.getDate()}; }
function renderCalendar(){
  const head=$('#cal-head'); head.innerHTML=''; 'Пн Вт Ср Чт Пт Сб Вс'.split(' ').forEach(n=>{ const s=document.createElement('div'); s.textContent=n; head.appendChild(s); });
  const wrap=$('#calendar'); wrap.innerHTML='';
  const {first,days} = metaMonth(currentDate);
  const off = (first.getDay()+6)%7;
  for (let i=0;i<off;i++){ wrap.appendChild(document.createElement('div')); }
  for (let d=1; d<=days; d++){
    const dt = new Date(first.getFullYear(), first.getMonth(), d);
    const cell=document.createElement('div'); cell.className='day'; cell.innerHTML=`<div class="n">${d}</div>`;
    const st=startOfDay(dt).getTime(), en=endOfDay(dt).getTime();
    const cnt = tasks.filter(t=> t.due_ts!=null && t.due_ts>=st && t.due_ts<=en).length;
    if (cnt>0){ const dot=document.createElement('div'); dot.className='dot'; cell.appendChild(dot);
      const c=document.createElement('div'); c.className='badge count'; c.textContent=cnt; cell.appendChild(c);
    }
    cell.onclick=()=> renderDay(dt);
    wrap.appendChild(cell);
  }
  renderDay(new Date());
}
function renderDay(dt){
  const st=startOfDay(dt).getTime(), en=endOfDay(dt).getTime();
  const day=tasks.filter(t=> t.due_ts!=null && t.due_ts>=st && t.due_ts<=en).sort((a,b)=>(a.is_done-b.is_done)||(a.due_ts-b.due_ts));
  const box = $('#tasks-day'); box.innerHTML='';
  if (!day.length){ box.innerHTML='<div class="muted">На выбранный день задач нет.</div>'; return; }
  day.forEach(t=> box.appendChild(rowTask(t)));
}
$('#m-prev').onclick=()=>{ currentDate = addDays(currentDate,-15); currentDate.setDate(1); renderCalendar(); }
$('#m-next').onclick=()=>{ currentDate = addDays(currentDate, 40); currentDate.setDate(1); renderCalendar(); }

/* ====== HADI ====== */
function renderHADI(){
  const total = tasks.length;
  const done = tasks.filter(t=>t.is_done).length;
  const overdue = tasks.filter(t=>!t.is_done && t.due_ts!=null && t.due_ts < Date.now()).length;
  const rate = total ? Math.round(done*100/total) : 0;
  $('#m-total').textContent = total;
  $('#m-done').textContent  = done;
  $('#m-rate').textContent  = rate+'%';
  $('#m-over').textContent  = overdue;
}

/* ====== chat ====== */
function pushChat(text, me=false){
  const b=document.createElement('div'); b.className='bubble ' + (me?'me':'bot'); b.textContent=text;
  $('#chat-body').appendChild(b); $('#chat-body').scrollTop=1e9;
}
$('#chat-send').onclick = async ()=>{
  const text = $('#chat-input').value.trim(); if (!text) return;
  $('#chat-input').value=''; pushChat(text,true);
  try{
    const r = await api('/api/chat','POST',{ text });
    pushChat(r.reply || 'Ок!');
  }catch(e){
    // Подсказка вместо ответа
    const hint = `Чтобы я помог лучше:
— Сформулируй цель и срок: «Сделай X до 21:00»
— Добавлю подзадачи и распланирую по дням.`;
    pushChat(hint);
  }
};
$('#chat-input').addEventListener('keydown',e=>{ if (e.key==='Enter') $('#chat-send').click(); });
</script>
</body>
</html>
