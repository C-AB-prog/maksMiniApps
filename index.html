<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <title>Growth Assistant ¬∑ Mini App</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --accent:#3B82F6; --accent-2:#60A5FA; --accent-3:#8AB6FF;
      --mint:#22C55E; --amber:#F59E0B; --rose:#F43F5E; --violet:#7C3AED;
      --bg:#F7FAFF; --surface:#FFFFFF; --line:#E7ECF6;
      --text:#0F172A; --muted:#667085; --muted-2:#6B7280;
      --r-lg:16px; --r-xl:20px; --sh-card:0 1px 2px rgba(15,23,42,.05), 0 12px 32px rgba(59,130,246,.07);
      --h1:clamp(18px,4vw,22px); --h2:clamp(15px,3.4vw,17px); --body:15px; --cap:12px;
      --sp-2:10px; --sp-3:12px; --sp-4:16px;
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:var(--body); color:var(--text);
      background:
        radial-gradient(1200px 700px at 90% -20%, rgba(96,165,250,.18), transparent 60%),
        radial-gradient(1200px 700px at -10% 100%, rgba(124,58,237,.12), transparent 60%),
        linear-gradient(#FAFCFF,#F6F9FF);
    }

    .app{min-height:100%; display:flex; flex-direction:column}
    header{position:sticky; top:0; z-index:20; background:rgba(255,255,255,.9); backdrop-filter:saturate(140%) blur(10px); border-bottom:1px solid var(--line)}
    .topbar{display:flex; align-items:center; gap:12px; padding:10px 12px; max-width:960px; margin:0 auto}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:26px;height:26px;border-radius:10px; display:grid; place-items:center;
      background:conic-gradient(from 210deg, #2563EB, #60A5FA, #A78BFA, #2563EB);
      box-shadow:0 6px 16px rgba(37,99,235,.25);}
    .logo svg{width:16px;height:16px;color:white}
    .title{font-weight:800; letter-spacing:.2px}
    .actions{margin-left:auto; display:flex; align-items:center; gap:8px}
    .mini-chip{font-size:12px; padding:6px 10px; border-radius:999px; background:linear-gradient(180deg,#F4F7FF,#FFFFFF); color:#1D4ED8; border:1px solid var(--line)}

    main{flex:1; padding:0 12px calc(210px + env(safe-area-inset-bottom)); max-width:960px; margin:0 auto}

    .card{background:linear-gradient(180deg, #FFF 0%, #FDFEFF 100%); border:1px solid var(--line); border-radius:var(--r-xl); padding:14px; box-shadow:var(--sh-card)}
    .card + .card{margin-top:12px}
    h1{font-size:var(--h1); margin:12px 2px 10px}
    h2{font-size:var(--h2); margin:0 0 10px 0; display:flex; align-items:center; gap:8px}
    .sub{color:var(--muted); font-size:var(--cap)}

    .row{display:flex; gap:10px; align-items:center}
    .input{height:44px; padding:0 14px; width:100%; border-radius:12px; border:1px solid var(--line); background:#fff; outline:none}
    .input:focus{border-color:#C7D2FE; box-shadow:0 0 0 4px rgba(99,102,241,.12)}
    .input.readonly{background:#F3F6FB; color:#374151}
    .btn{height:44px; padding:0 16px; border-radius:14px; border:0; background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff; font-weight:800; letter-spacing:.2px; box-shadow:0 12px 28px rgba(59,130,246,.28); cursor:pointer}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .btn.ghost{background:linear-gradient(180deg,#fff,#FBFDFF); color:#0F172A; border:1px solid var(--line); font-weight:700}
    .chip{height:34px; padding:0 12px; border-radius:999px; border:1px solid var(--line); background:linear-gradient(180deg,#fff,#F8FAFF); font-size:12px; color:#111827; cursor:pointer}
    .chip.active{border-color:transparent; color:#0B4DD9; background:linear-gradient(135deg,#EEF2FF,#E0EAFF)}

    .list{display:flex; flex-direction:column; gap:8px}
    .item{display:grid; grid-template-columns:auto 1fr auto auto; align-items:center; gap:10px; padding:12px; background:linear-gradient(180deg,#fff,#FBFDFF); border:1px solid var(--line); border-radius:14px; min-width:0}
    .emblem{width:28px;height:28px;border-radius:10px; display:grid; place-items:center; color:white; background:linear-gradient(135deg,#2563EB,#60A5FA); box-shadow:0 6px 14px rgba(37,99,235,.25)}
    .emblem.week{background:linear-gradient(135deg,#7C3AED,#A78BFA)}
    .emblem.backlog{background:linear-gradient(135deg,#0EA5E9,#67E8F9)}
    .emblem svg{width:16px;height:16px}
    .check{appearance:none; width:20px; height:20px; border-radius:6px; border:1px solid var(--line); background:#fff; cursor:pointer}
    .check:checked{background:var(--mint); border-color:var(--mint)}
    .body{min-width:0}
    .title{font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .hint{color:#667085; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .tag{font-size:11px; color:#0F766E; background:linear-gradient(180deg,#ECFDF5,#F6FFFB); border:1px solid #A7F3D0; padding:4px 8px; border-radius:999px; white-space:nowrap}

    .plan-tabs{display:flex; gap:6px; overflow:auto; padding-bottom:6px; margin-bottom:10px}
    .plan-tab{height:34px; padding:0 12px; border-radius:999px; border:1px solid var(--line); background:linear-gradient(180deg,#fff,#F8FAFF); cursor:pointer}
    .plan-tab.active{border-color:transparent; background:linear-gradient(135deg,#EEF2FF,#E0EAFF); color:#0B4DD9}

    .agenda{display:grid; grid-template-columns:60px 1fr; border:1px solid var(--line); border-radius:14px; overflow:hidden; background:linear-gradient(180deg,#fff,#F8FAFF)}
    .hour{height:40px; padding:6px 6px; font-size:12px; color:#6B7280; border-bottom:1px dashed #E5E7EB}
    .slot{height:40px; border-bottom:1px dashed #E5E7EB; position:relative}
    .event{position:absolute; left:6px; right:6px; background:linear-gradient(135deg,#E3F2FD,#F0F7FF); color:#0B4DD9; border:1px solid #BFDBFE; border-radius:10px; padding:6px; font-size:12px}
    .allDay{margin-top:10px; display:flex; flex-wrap:wrap; gap:8px}
    .allDay .pill{font-size:12px; border:1px solid var(--line); border-radius:999px; padding:6px 10px; background:linear-gradient(180deg,#fff,#F8FAFF)}

    .chatbar{position:fixed; left:50%; transform:translateX(-50%); bottom:calc(12px + 72px + env(safe-area-inset-bottom)); z-index:55; width:min(560px,94%); pointer-events:none}
    .btn-chat{pointer-events:auto; display:block; width:100%; height:56px; border-radius:16px; border:0; font-weight:900; letter-spacing:.2px; color:#fff; background:linear-gradient(90deg,#2563EB 0%, #60A5FA 60%, #A78BFA 100%); box-shadow:0 16px 40px rgba(37,99,235,.35), inset 0 -2px 0 rgba(255,255,255,.25); cursor:pointer}

    .dock{position:fixed; left:50%; bottom:12px; transform:translateX(-50%); z-index:50; width:min(560px,94%); padding-bottom:env(safe-area-inset-bottom); pointer-events:none}
    .dock-inner{display:grid; grid-template-columns:repeat(4,1fr); gap:6px; background:rgba(255,255,255,.9); backdrop-filter:saturate(140%) blur(12px); border:1px solid var(--line); border-radius:18px; padding:10px; box-shadow:0 10px 28px rgba(15,23,42,.14); pointer-events:auto}
    .dock-item{height:52px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:3px; border-radius:12px; color:#667085; font-size:12px; border:none; background:transparent; cursor:pointer}
    .dock-item svg{width:22px;height:22px}
    .dock-item.active{background:linear-gradient(180deg,#F6F7FA,#EFF3FF); color:#0F172A; font-weight:700}

    .sheet{position:fixed; inset:0; z-index:60} .sheet[hidden]{display:none}
    .sheet-backdrop{position:absolute; inset:0; background:rgba(15,23,42,.35); backdrop-filter:blur(3px)}
    .sheet-panel{position:absolute; left:0; right:0; bottom:0; background:#fff; border-top-left-radius:18px; border-top-right-radius:18px; box-shadow:0 -18px 44px rgba(0,0,0,.22); border:1px solid var(--line)}
    .sheet-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--line)}
    .sheet-body{max-height:50vh; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:10px}
    .sheet-input{display:flex; gap:10px; padding:12px; border-top:1px solid var(--line)}
    .bubble{max-width:85%; padding:10px 12px; border:1px solid var(--line); border-radius:12px}
    .bubble.me{align-self:flex-end; background:#EEF2FF; border-color:#CBD5E1}
    .bubble.bot{align-self:flex-start; background:#F8FAFC}

    .warn-banner{position:sticky; top:0; z-index:30; background:#FEF3C7; color:#92400E; border:1px solid #FCD34D; padding:8px 12px; border-radius:8px; margin:8px}
  </style>
</head>
<body>
<svg width="0" height="0" style="position:absolute;visibility:hidden">
  <symbol id="i-bolt" viewBox="0 0 24 24" fill="currentColor"><path d="M13 2L3 14h7l-1 8 10-12h-7l1-8z"/></symbol>
  <symbol id="i-plus" viewBox="0 0 24 24" fill="currentColor"><path d="M11 5h2v14h-2z"/><path d="M5 11h14v2H5z"/></symbol>
  <symbol id="i-home" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M3 10l9-7 9 7"/><path d="M9 22V12h6v10"/></symbol>
  <symbol id="i-plan" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M3 6l7-2 7 2 4-1v13l-4 1-7-2-7 2-3-1V5z"/></symbol>
  <symbol id="i-cal" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></symbol>
  <symbol id="i-user" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M6 20c0-3.314 2.686-6 6-6s6 2.686 6 6"/></symbol>
  <symbol id="i-check" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M20 6L9 17l-5-5"/></symbol>
  <symbol id="i-week" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M7 3v4M17 3v4M3 10h18"/></symbol>
  <symbol id="i-backlog" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="7" width="18" height="13" rx="2"/><path d="M7 3h10v4H7z"/></symbol>
  <symbol id="i-send" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></symbol>
  <symbol id="i-edit" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></symbol>
  <symbol id="i-clock" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/></symbol>
</svg>

<div class="app">
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo"><svg><use href="#i-bolt"/></svg></div>
        <div class="title">Growth Assistant</div>
      </div>
      <div class="actions"><span id="focusChip" class="mini-chip" hidden>–§–æ–∫—É—Å: ‚Äî</span></div>
    </div>
  </header>

  <main>
    <div id="notInTg" class="warn-banner" style="display:none">–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ –º–µ–Ω—é Telegram-–±–æ—Ç–∞. –ò–Ω–∞—á–µ —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø—Ä–∏–º–µ—Ç –∑–∞–ø—Ä–æ—Å—ã.</div>

    <section id="screen-today" class="screen">
      <h1>–°–µ–≥–æ–¥–Ω—è</h1>

      <div class="card">
        <h2><span class="emblem"><svg><use href="#i-bolt"/></svg></span>–§–æ–∫—É—Å –¥–Ω—è</h2>
        <div class="row">
          <input id="focus" class="input" placeholder="–°–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ —Å–µ–≥–æ–¥–Ω—è‚Ä¶">
          <button class="btn" data-action="saveFocus" id="saveFocusBtn"><svg style="width:16px;height:16px;margin-right:6px"><use href="#i-check"/></svg>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn ghost" data-action="editFocus" id="editFocusBtn" style="display:none"><svg style="width:16px;height:16px;margin-right:6px"><use href="#i-edit"/></svg>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>

      <div class="card">
        <h2><span class="emblem" style="background:linear-gradient(135deg,#22C55E,#86EFAC)"><svg><use href="#i-plus"/></svg></span>–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</h2>
        <div class="row" style="flex-wrap:wrap">
          <input id="add" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" style="flex:1 1 100%">
          <button class="btn" data-action="quickAdd" id="quickBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="row" style="flex-wrap:wrap; margin-top:8px">
          <span class="sub">–°–ø–∏—Å–æ–∫:</span>
          <button class="chip active" data-list="today"><span class="emblem" style="width:20px;height:20px;border-radius:6px;margin-right:6px"><svg style="width:12px;height:12px"><use href="#i-home"/></svg></span>–°–µ–≥–æ–¥–Ω—è</button>
          <button class="chip" data-list="week"><span class="emblem week" style="width:20px;height:20px;border-radius:6px;margin-right:6px"><svg style="width:12px;height:12px"><use href="#i-week"/></svg></span>–ù–µ–¥–µ–ª—è</button>
          <button class="chip" data-list="backlog"><span class="emblem backlog" style="width:20px;height:20px;border-radius:6px;margin-right:6px"><svg style="width:12px;height:12px"><use href="#i-backlog"/></svg></span>–ë—ç–∫–ª–æ–≥</button>

          <span class="sub" style="margin-left:auto">–î–µ–¥–ª–∞–π–Ω:</span>
          <input id="dueDate" class="input" type="date" style="max-width:150px">
          <input id="dueTime" class="input" type="time" style="max-width:120px">
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h2><span class="emblem" style="background:linear-gradient(135deg,#F59E0B,#FCD34D)"><svg><use href="#i-clock"/></svg></span>–ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
          <button class="btn ghost" data-action="toggleAll" id="toggleBtn">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë</button>
        </div>
        <div id="todayList" class="list"></div>
      </div>
    </section>

    <section id="screen-plan" class="screen" hidden>
      <h1>–ü–ª–∞–Ω</h1>
      <div class="plan-tabs" role="tablist">
        <button class="plan-tab active" data-view="lists">–°–ø–∏—Å–∫–∏</button>
        <button class="plan-tab" data-view="hadi">HADI</button>
        <button class="plan-tab" data-view="metrics">–ú–µ—Ç—Ä–∏–∫–∏</button>
      </div>
      <div id="plan-view-lists">
        <div class="card"><h2><span class="emblem"><svg><use href="#i-home"/></svg></span>–°–µ–≥–æ–¥–Ω—è</h2><div id="list-today" class="list"></div></div>
        <div class="card"><h2><span class="emblem week"><svg><use href="#i-week"/></svg></span>–ù–∞ –Ω–µ–¥–µ–ª–µ</h2><div id="list-week" class="list"></div></div>
        <div class="card"><h2><span class="emblem backlog"><svg><use href="#i-backlog"/></svg></span>–ë—ç–∫–ª–æ–≥</h2><div id="list-backlog" class="list"></div></div>
      </div>
      <div id="plan-view-hadi" hidden><div class="card"><div class="sub">–°–∫–æ—Ä–æ‚Ä¶</div></div></div>
      <div id="plan-view-metrics" hidden><div class="card"><div class="sub">–°–∫–æ—Ä–æ‚Ä¶</div></div></div>
    </section>

    <section id="screen-calendar" class="screen" hidden>
      <h1>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h1>
      <div class="card" style="margin-bottom:10px">
        <div class="row" style="flex-wrap:wrap">
          <span class="sub">–î–µ–Ω—å:</span>
          <input id="calDate" type="date" class="input" style="max-width:170px">
          <span class="sub" style="margin-left:auto">–ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∑–∞–¥–∞—á–∏ —Å –¥–µ–¥–ª–∞–π–Ω–æ–º</span>
        </div>
      </div>

      <div class="agenda">
        <div class="hours" id="hours"></div>
        <div class="slots" id="slots"></div>
      </div>
      <div class="card" id="allDayBox" style="margin-top:10px; display:none">
        <div class="sub" style="margin-bottom:6px">–ë–µ–∑ –≤—Ä–µ–º–µ–Ω–∏</div>
        <div class="allDay" id="allDay"></div>
      </div>
    </section>

    <section id="screen-settings" class="screen" hidden>
      <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
      <div class="card"><div class="sub">–¢–∞–π–º–∑–æ–Ω–∞: Europe/Helsinki ¬∑ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –≤–∫–ª</div></div>
    </section>
  </main>

  <div class="chatbar"><button class="btn-chat" data-action="openChat">üí¨ –ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</button></div>

  <nav class="dock" role="navigation" aria-label="–ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
    <div class="dock-inner">
      <button class="dock-item active" data-target="today"><svg><use href="#i-home"/></svg><span>–°–µ–≥–æ–¥–Ω—è</span></button>
      <button class="dock-item" data-target="plan"><svg><use href="#i-plan"/></svg><span>–ü–ª–∞–Ω</span></button>
      <button class="dock-item" data-target="calendar"><svg><use href="#i-cal"/></svg><span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
      <button class="dock-item" data-target="settings"><svg><use href="#i-user"/></svg><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
    </div>
  </nav>

  <div class="sheet" id="chatSheet" hidden>
    <div class="sheet-backdrop" data-action="closeChat"></div>
    <div class="sheet-panel">
      <div class="sheet-head"><strong>–ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</strong><button class="btn ghost" data-action="closeChat">–ó–∞–∫—Ä—ã—Ç—å</button></div>
      <div class="sheet-body" id="chatBox"></div>
      <div class="sheet-input">
        <input id="chatInput" class="input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–æ –ø–ª–∞–Ω, HADI –∏–ª–∏ –∑–∞–¥–∞—á–∏‚Ä¶">
        <button class="btn" data-action="chatSend"><svg style="width:16px;height:16px;margin-right:6px"><use href="#i-send"/></svg>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –õ–∏–ø–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ -->
<div id="debugOverlay" onclick="this.style.display='none'"
     style="position:fixed;left:50%;transform:translateX(-50%);bottom:92px;max-width:94%;z-index:9999;background:#111827;color:#fff;padding:10px 12px;border-radius:10px;display:none"></div>

<script>
  function showSticky(msg){
    const box=document.getElementById('debugOverlay');
    box.textContent=String(msg||'–û—à–∏–±–∫–∞');
    box.style.display='block';
    console.error('[UI]', msg);
  }
  function toast(msg){
    var t=document.createElement('div');
    t.textContent=msg;
    t.style.cssText='position:fixed;bottom:140px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.15);opacity:.98;z-index:99';
    document.body.appendChild(t);
    setTimeout(function(){t.style.transition="opacity .4s"; t.style.opacity='0'; setTimeout(function(){t.remove()},400)},1000);
  }
</script>

<script>
(function(){
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg) { try { tg.ready(); tg.expand(); } catch(e){} }
  window.__TG_INIT_DATA__ = tg && tg.initData ? tg.initData : '';
  if (!window.__TG_INIT_DATA__) { const w = document.getElementById('notInTg'); if (w) w.style.display = 'block'; }

  // fetch —Å —Ç–∞–π–º–∞—É—Ç–æ–º + –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏
  window.authFetch = async function(url, opts, timeoutMs = 8000){
    const controller = new AbortController();
    const timer = setTimeout(()=>controller.abort('timeout'), timeoutMs);
    try{
      const res = await fetch(url, {
        ...(opts||{}),
        headers: { ...(opts?.headers||{}), 'x-telegram-init': window.__TG_INIT_DATA__ || '' },
        signal: controller.signal
      });
      clearTimeout(timer);
      if(!res.ok){
        let detail = `${res.status} ${res.statusText}`;
        try{ const j = await res.clone().json(); if (j?.error) detail = j.error; }catch{ try{ detail = await res.text(); }catch{} }
        showSticky('API: ' + detail);
      }
      return res;
    }catch(e){
      clearTimeout(timer);
      showSticky('API: ' + (e?.name==='AbortError' ? 'timeout' : (e?.message || 'network error')));
      throw e;
    }
  };
})();
</script>

<script>
(async function(){
  const q = s=>document.querySelector(s), qa=s=>document.querySelectorAll(s);
  const todayStr = () => new Date().toISOString().slice(0,10);
  const ddmm = d => d ? (d.split('-')[2]+'.'+d.split('-')[1]) : '‚Äî';
  const esc = s => String(s||'').replace(/[&<>\"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));

  let lists={today:[],week:[],backlog:[]}, calItems=[], focusText='', showAll=false, picked='today', currentDate=todayStr();

  function lockFocusUI(lock){
    const input=q('#focus'), save=q('#saveFocusBtn'), edit=q('#editFocusBtn');
    if(lock){ input.readOnly=true; input.classList.add('readonly'); save.style.display='none'; edit.style.display='inline-block' }
    else    { input.readOnly=false; input.classList.remove('readonly'); save.style.display='inline-block'; edit.style.display='none'; setTimeout(()=>input.focus(),0) }
  }
  function updateFocusChip(){
    const chip=q('#focusChip');
    if(focusText){ chip.textContent='–§–æ–∫—É—Å: '+(focusText.length>28?focusText.slice(0,27)+'‚Ä¶':focusText); chip.hidden=false } else chip.hidden=true;
  }

  const apiGET   = url    => authFetch(url).then(r=>r.json()).catch(()=>({}));
  const apiPOST  = (u,b)  => authFetch(u,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(b)}).then(r=>r.json()).catch(()=>({}));
  const apiPUT   = (u,b)  => authFetch(u,{method:'PUT', headers:{'content-type':'application/json'},body:JSON.stringify(b)}).then(r=>r.json()).catch(()=>({}));
  const apiPATCH = (u,b)  => authFetch(u,{method:'PATCH',headers:{'content-type':'application/json'},body:JSON.stringify(b)}).then(r=>r.json()).catch(()=>({}));

  function iconForList(list){
    if(list==='week') return '<span class="emblem week"><svg><use href="#i-week"/></svg></span>';
    if(list==='backlog') return '<span class="emblem backlog"><svg><use href="#i-backlog"/></svg></span>';
    return '<span class="emblem"><svg><use href="#i-home"/></svg></span>';
  }
  function taskRow(t){
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=
      iconForList(t.list) +
      '<input type="checkbox" class="check" '+(t.done?'checked':'')+' data-id="'+t.id+'">' +
      '<div class="body"><div class="title">'+esc(t.title)+'</div><div class="hint">'+esc(t.hint||'')+'</div></div>' +
      '<span class="tag">'+esc(t.due_date ? ddmm(t.due_date)+(t.due_time?(' '+t.due_time.slice(0,5)):'') : '‚Äî')+'</span>';
    return el;
  }
  function renderToday(){
    const box=q('#todayList'); box.innerHTML='';
    const items = lists.today || [];
    const shows = showAll ? items : items.slice(0,3);
    if(!shows.length){ box.innerHTML='<div class="sub">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>'; return }
    shows.forEach(t=>box.appendChild(taskRow(t)));
  }
  function renderPlan(){
    ['today','week','backlog'].forEach(k=>{
      const box=q('#list-'+k); if(!box) return; box.innerHTML='';
      (lists[k]||[]).forEach(t=>box.appendChild(taskRow(t)));
    });
  }

  function renderAgenda(){
    const hours=q('#hours'), slots=q('#slots'), allDayWrap=q('#allDay'), allDayBox=q('#allDayBox');
    hours.innerHTML=''; slots.innerHTML=''; allDayWrap.innerHTML='';
    for(let h=8;h<=20;h++){
      const hr=document.createElement('div'); hr.className='hour'; hr.textContent=(h<10?'0':'')+h+':00'; hours.appendChild(hr);
      const sl=document.createElement('div'); sl.className='slot'; slots.appendChild(sl);
    }
    const timed=(calItems||[]).filter(x=>x.due_time);
    const alld =(calItems||[]).filter(x=>!x.due_time);
    timed.forEach(ev=>{
      const [hh,mm]=(ev.due_time||'00:00').split(':');
      const top=((parseInt(hh,10)-8)*40) + (parseInt(mm,10)/60)*40 + 6;
      const e=document.createElement('div'); e.className='event'; e.style.top=Math.max(6,top)+'px'; e.style.height='28px';
      e.textContent=ev.title+' ¬∑ '+ev.due_time.slice(0,5);
      slots.appendChild(e);
    });
    if(alld.length){ allDayBox.style.display='block'; alld.forEach(t=>{ const p=document.createElement('span'); p.className='pill'; p.textContent=t.title; allDayWrap.appendChild(p) }) }
    else { allDayBox.style.display='none'; }
  }
  async function loadCalendar(day){
    const r = await apiGET('/api/calendar?day='+encodeURIComponent(day));
    calItems = r.items || []; renderAgenda();
  }

  async function saveFocus(){
    const btn=q('#saveFocusBtn'); const input=q('#focus'); const v=(input.value||'').trim(); if(!v){ showSticky('–í–≤–µ–¥–∏—Ç–µ —Ñ–æ–∫—É—Å –¥–Ω—è'); return }
    btn.disabled=true; const old=btn.textContent; btn.textContent='–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶';
    try{
      const resp = await apiPUT('/api/focus', { day: todayStr(), text: v });
      if (resp && resp.text){ focusText=v; lockFocusUI(true); updateFocusChip(); toast('–§–æ–∫—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); }
      else { showSticky(resp?.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (focus)'); }
    } finally { btn.disabled=false; btn.textContent=old; }
  }
  function editFocus(){ lockFocusUI(false) }

  async function quickAdd(){
    const btn=q('#quickBtn'); const input=q('#add'); const title=(input.value||'').trim(); if(!title){ showSticky('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return }
    const d=q('#dueDate').value||null; const t=q('#dueTime').value||null;
    btn.disabled=true; const old=btn.textContent; btn.textContent='–î–æ–±–∞–≤–ª—è—é‚Ä¶';
    try{
      const created = await apiPOST('/api/tasks', { title, list:picked, due_date:d, due_time:t });
      if(created && created.id){
        lists[picked].unshift(created);
        input.value=''; q('#dueDate').value=''; q('#dueTime').value='';
        renderToday(); renderPlan(); toast('–î–æ–±–∞–≤–ª–µ–Ω–æ');
        if(created.due_date===currentDate){ calItems.unshift(created); renderAgenda(); }
      } else { showSticky(created?.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (task)'); }
    } finally { btn.disabled=false; btn.textContent=old; }
  }
  async function toggleAll(){ showAll=!showAll; q('#toggleBtn').textContent = showAll? '–°–∫—Ä—ã—Ç—å –ª–∏—à–Ω–µ–µ' : '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë'; renderToday() }

  function appendMsg(who, text){
    const box=document.getElementById('chatBox');
    const b=document.createElement('div'); b.className='bubble '+(who==='me'?'me':'bot'); b.textContent=text; box.appendChild(b); box.scrollTop=box.scrollHeight;
  }
  function openChat(){ document.getElementById('chatSheet').hidden=false }
  function closeChat(){ document.getElementById('chatSheet').hidden=true }
  async function chatSend(){
    const inp=document.getElementById('chatInput'); const v=(inp.value||'').trim(); if(!v) return;
    appendMsg('me', v); inp.value='';
    try {
      const res = await authFetch('/api/chat', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ message: v }) });
      const data = await res.json().catch(()=>({}));
      if (res.ok && data.reply) appendMsg('bot', data.reply);
      else appendMsg('bot', '–û—à–∏–±–∫–∞: ' + (data.error || res.status + ' ' + res.statusText));
    } catch { appendMsg('bot','–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'); }
  }

  document.addEventListener('click', async function(e){
    let el=e.target; while(el&&el!==document){ if(el.dataset.action || el.dataset.target || el.dataset.list || (el.classList && [...el.classList].includes('plan-tab'))) break; el=el.parentNode }
    if(!el||el===document) return;
    const act=el.dataset.action;
    if(act==='saveFocus'){ e.preventDefault(); await saveFocus(); return }
    if(act==='editFocus'){ e.preventDefault(); editFocus(); return }
    if(act==='quickAdd'){ e.preventDefault(); await quickAdd(); return }
    if(act==='toggleAll'){ e.preventDefault(); await toggleAll(); return }
    if(act==='chatSend'){ e.preventDefault(); chatSend(); return }
    if(act==='openChat'){ e.preventDefault(); openChat(); return }
    if(act==='closeChat'){ e.preventDefault(); closeChat(); return }
    if(el.dataset.list){ qa('.card .chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); picked=el.dataset.list; e.preventDefault(); return }
    if(el.classList && el.classList.contains('plan-tab')){
      const v=el.dataset.view; qa('.plan-tab').forEach(t=>t.classList.remove('active')); el.classList.add('active');
      ['lists','hadi','metrics'].forEach(k=>{ const n=q('#plan-view-'+k); if(n) n.hidden=(k!==v) }); e.preventDefault(); return
    }
    if(el.dataset.target){
      qa('.dock-item').forEach(b=>b.classList.remove('active')); el.classList.add('active');
      qa('.screen').forEach(s=>s.hidden=true); const scr=q('#screen-'+el.dataset.target); if(scr) scr.hidden=false; window.scrollTo(0,0);
      e.preventDefault(); return
    }
  });

  document.addEventListener('change', async function(e){
    const el=e.target;
    if(el && el.classList.contains('check')){
      const id = el.getAttribute('data-id');
      const r = await apiPATCH('/api/tasks/'+encodeURIComponent(id), { done: el.checked });
      if (r && r.error) showSticky(r.error);
      ['today','week','backlog'].forEach(k=>{ lists[k] = (lists[k]||[]).map(t=>{ if(String(t.id)===String(id)) t.done=el.checked; return t }); });
    }
    if(el && el.id==='calDate'){ currentDate=el.value; await loadCalendar(currentDate); }
  });

  async function loadTasks(){
    const [t,w,b] = await Promise.all([
      apiGET('/api/tasks?list=today'),
      apiGET('/api/tasks?list=week'),
      apiGET('/api/tasks?list=backlog'),
    ]);
    lists.today=t.items||[]; lists.week=w.items||[]; lists.backlog=b.items||[];
  }
  async function loadFocus(day){
    const f = await apiGET('/api/focus?day='+encodeURIComponent(day));
    focusText = f && f.text ? f.text : '';
    const input=q('#focus'); if(input) input.value=focusText||'';
    lockFocusUI(!!focusText); updateFocusChip();
  }

  async function selfHealthCheck(){
    try {
      const res = await authFetch('/api/health');
      let body = {};
      try { body = await res.clone().json(); } catch {}
      if (res.status === 404) return showSticky('HEALTH: /api/health 404');
      if (!res.ok || !body || typeof body !== 'object') return showSticky(`HEALTH: bad response (${res.status})`);
      if (!body.ok) showSticky(`HEALTH: tg=${body.telegram_signature_ok} db=${body.db_ok} env.pg=${body?.env?.has_POSTGRES_URL}`);
    } catch { showSticky('HEALTH: network error'); }
  }

  async function init(){
    q('#calDate').value = todayStr();
    await Promise.all([ loadTasks(), loadFocus(todayStr()), loadCalendar(todayStr()) ]);
    renderToday(); renderPlan(); renderAgenda();
  }

  await selfHealthCheck();
  await init();
})();
</script>
</body>
</html>
