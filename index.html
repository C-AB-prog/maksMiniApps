<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Growth Assistant</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
/* ====== —Å—Ç–∏–ª–∏ –∫–∞–∫ —É —Ç–µ–±—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ====== */
/* ... –í–ï–°–¨ –¢–í–û–ô CSS –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */
</style>
</head>
<body>

<!-- ====== –í–ï–°–¨ –¢–í–û–ô HTML (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–∞–∑–º–µ—Ç–∫–∏) ====== -->
<!-- Top bar -->
<div class="appbar">
  <h1>Growth Assistant</h1>
  <div class="sub">–§–æ–∫—É—Å –¥–Ω—è ‚Ä¢ –∑–∞–¥–∞—á–∏ ‚Ä¢ –ø–ª–∞–Ω ‚Ä¢ —á–∞—Ç ‚Ä¢ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
  <div class="appbar-badges">
    <span id="badge" class="badge off">offline</span>
    <span id="who" class="badge info">tg_id: ‚Äî</span>
  </div>
</div>

<div class="container">
  <!-- –ì–ª–∞–≤–Ω–∞—è -->
  <section id="screen-home" class="active grid-2">
    <div class="card account-setup">
      <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞</h3>
      <div class="form-grid">
        <div><input id="tgInput" class="input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID" /></div>
        <button id="saveTg" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <div class="small-text">–í Telegram WebApp user.id –±–µ—Ä—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –í –±—Ä–∞—É–∑–µ—Ä–µ –Ω–∞ –ü–ö ‚Äî –∏–∑ –ø–æ–ª—è –∏–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ?tg_id=.</div>
      </div>
    </div>

    <div class="card">
      <h3>–§–æ–∫—É—Å –¥–Ω—è</h3>
      <label>–°–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ —Å–µ–≥–æ–¥–Ω—è</label>
      <div style="display:flex; gap:10px">
        <input id="focusInput" class="input" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∑–∞–∫—Ä—ã—Ç—å –æ—Ç—á—ë—Ç" />
        <button id="saveFocus" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>

    <div class="card">
      <h3>–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</h3>
      <div class="seg">
        <div class="chip" data-prio="today">–°–µ–≥–æ–¥–Ω—è</div>
        <div class="chip" data-prio="week">–ù–µ–¥–µ–ª—è</div>
        <div class="chip" data-prio="month">–ú–µ—Å—è—Ü</div>
        <div class="chip" data-prio="team">–ö–æ–º–∞–Ω–¥–∞</div>
      </div>
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
        <input id="taskTitle" class="input" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" />
        <input id="taskDue" class="input" type="datetime-local" />
        <button id="addTask" class="btn">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
      </div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <h3>–ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
      <div id="tasks-today" class="list"></div>
    </div>
  </section>

  <!-- –ü–ª–∞–Ω -->
  <section id="screen-plan" class="grid">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">–ü–ª–∞–Ω –∑–∞–¥–∞—á</h3>
        <div class="seg">
          <div id="f-today" class="chip active">–°–µ–≥–æ–¥–Ω—è</div>
          <div id="f-week" class="chip">–ù–µ–¥–µ–ª—è</div>
          <div id="f-month" class="chip">–ú–µ—Å—è—Ü</div>
          <div id="f-team" class="chip">–ö–æ–º–∞–Ω–¥–∞</div>
        </div>
      </div>
      <div id="tasks-plan" class="list"></div>
    </div>
  </section>

  <!-- –ß–∞—Ç -->
  <section id="screen-chat" class="grid">
    <div class="card">
      <h3>–ú–æ–∏ —á–∞—Ç—ã —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</h3>
      <div class="chat-container">
        <div id="chat-list" class="chat-list"></div>
        <div id="no-chats-message" style="text-align: center; padding: 40px 20px;">
          <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">üí¨</div>
          <h3 style="margin: 0 0 8px 0;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</h3>
          <p class="muted">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</p>
          <button class="btn" id="create-first-chat" style="margin-top: 16px;">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
        </div>
      </div>
    </div>
  </section>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <section id="screen-stats" class="grid grid-2">
    <div class="card">
      <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
      <div class="stats-grid">
        <div class="stat-card"><div id="m-total" class="stat-value">0</div><div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div></div>
        <div class="stat-card"><div id="m-done" class="stat-value" style="color:var(--ok)">0</div><div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div></div>
        <div class="stat-card"><div id="m-rate" class="stat-value">0%</div><div class="stat-label">–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞</div></div>
        <div class="stat-card"><div id="m-over" class="stat-value" style="color:var(--danger)">0</div><div class="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div></div>
      </div>
      <p class="muted" style="margin-top:12px"><b>–ì–∏–ø–æ—Ç–µ–∑–∞:</b> ¬´–ï—Å–ª–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –∏ —Å—Ç–∞–≤–∏—Ç—å –¥–µ–¥–ª–∞–π–Ω—ã, –∑–∞–≤–µ—Ä—à—É ‚â•70% –≤–æ–≤—Ä–µ–º—è¬ª.<br/><b>–î–µ–π—Å—Ç–≤–∏–µ:</b> –¥–æ–±–∞–≤–ª—è–π/–∑–∞–∫—Ä—ã–≤–∞–π –∑–∞–¥–∞—á–∏ –≤–æ–≤—Ä–µ–º—è. <b>–î–∞–Ω–Ω—ã–µ:</b> –º–µ—Ç—Ä–∏–∫–∏ –≤—ã—à–µ. <b>–ò–Ω—Å–∞–π—Ç:</b> –¥–µ—Ä–∂–∏ ‚â•70%.</p>
    </div>
    <div class="card">
      <h3>–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
      <div id="week-chart" class="week-chart"></div>
    </div>
  </section>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
  <section id="screen-profile" class="grid">
    <div class="card">
      <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
      <div class="muted" style="margin-bottom:16px">Telegram ID: <span id="profile-id" class="mono">‚Äì</span></div>
      <div class="profile-section">
        <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
        <label>–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</label>
        <div class="lang-switch">
          <div class="lang-btn active" data-lang="ru">–†—É—Å—Å–∫–∏–π</div>
          <div class="lang-btn" data-lang="en">English</div>
        </div>
      </div>
      <div class="profile-section">
        <h4>–ê–∫–∫–∞—É–Ω—Ç</h4>
        <div class="profile-actions">
          <div class="profile-btn" id="btn-tariff"><span>–¢–∞—Ä–∏—Ñ</span><span style="color:var(--brand);font-weight:600">–ü—Ä–æ–±–Ω—ã–π</span></div>
        </div>
      </div>
      <div class="profile-section">
        <h4>–ü–æ–º–æ—â—å</h4>
        <div class="profile-actions">
          <div class="profile-btn" id="btn-help"><span>–ü–æ–º–æ—â—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞</span><span class="arrow">‚Ä∫</span></div>
          <div class="profile-btn" id="btn-guide"><span>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</span><span class="arrow">‚Ä∫</span></div>
          <div class="profile-btn" id="btn-consult"><span>–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</span><span class="arrow">‚Ä∫</span></div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —á–∞—Ç (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞) -->
<div id="chat-fullscreen" class="chat-fullscreen">
  <div class="chat-header">
    <div class="chat-header-title" id="current-chat-title">–ß–∞—Ç</div>
    <div class="chat-header-actions"><button class="btn ghost icon" id="close-chat">‚úï</button></div>
  </div>
  <div id="chatLog" class="chat-body"></div>
  <div class="chat-foot">
    <input id="msg" class="input" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
    <button id="send" class="btn" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
  </div>
</div>

<!-- Modal –¥–ª—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ -->
<div id="new-chat-modal" class="modal">
  <div class="modal-content">
    <h3 class="modal-title">–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞</h3>
    <input type="text" id="new-chat-title" class="input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" style="margin-bottom: 20px;">
    <div style="display: flex; gap: 10px;">
      <button class="btn secondary" id="cancel-new-chat" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn" id="confirm-new-chat" style="flex: 1;">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- Bottom navigation -->
<nav class="nav" id="bottom-nav">
  <div class="item active" data-go="home">‚Ä¶ –ì–ª–∞–≤–Ω–∞—è ‚Ä¶</div>
  <div class="item" data-go="plan">‚Ä¶ –ü–ª–∞–Ω ‚Ä¶</div>
  <div class="item" data-go="chat">‚Ä¶ –ß–∞—Ç ‚Ä¶</div>
  <div class="item" data-go="stats">‚Ä¶ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Ä¶</div>
  <div class="item" data-go="profile">‚Ä¶ –ü—Ä–æ—Ñ–∏–ª—å ‚Ä¶</div>
</nav>

<div id="toast" class="toast" style="display:none"></div>

<script>
/* ================= helpers ================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const showToast = (t)=>{const el=$('#toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',1800);};

/* ============== TG ID ====================== */
let tgId = 0;
function readTgId(){
  try{ const wa=window.Telegram?.WebApp?.initDataUnsafe; const uid=wa?.user?.id; if(uid&&/^\d+$/.test(String(uid))) return Number(uid);}catch{}
  const qid=new URLSearchParams(location.search).get('tg_id'); if(qid&&/^\d+$/.test(qid)) return Number(qid);
  const ls=localStorage.getItem('tg_id'); if(ls&&/^\d+$/.test(ls)) return Number(ls);
  return 0;
}
function saveTgIdLocal(id){
  if(id&&/^\d+$/.test(String(id))){ localStorage.setItem('tg_id', String(id)); tgId = Number(id); updateTgIdDisplay(); }
}
function updateTgIdDisplay(){
  const w=$('#who'); if(w) w.textContent=`tg_id: ${tgId||'‚Äî'}`;
  const p=$('#profile-id'); if(p) p.textContent=tgId||'‚Äì';
}

/* ============== ONLINE ===================== */
async function ping(){
  try{
    const r=await fetch('/api/ping',{headers:tgId?{'X-TG-ID':String(tgId)}:{}});
    const ok=(await r.json())?.ok;
    const b=$('#badge'); if(b){ b.textContent=ok?'online':'offline'; b.className='badge '+(ok?'ok':'off'); }
    return !!ok;
  }catch{
    const b=$('#badge'); if(b){ b.textContent='offline'; b.className='badge off'; }
    return false;
  }
}

/* ============== CHAT ======================= */
/** –õ–æ–∫–∞–ª—å–Ω—ã–µ —Å–µ—Å—Å–∏–∏ ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ (–∫–∞—Ä—Ç–æ—á–∫–∏).
 *  –°–µ—Ä–≤–µ—Ä–Ω—ã–π —á–∞—Ç ‚Äî –æ–±—â–∏–π –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏, –±–µ–∑ ¬´–æ—Å–æ–±–æ–≥–æ¬ª –Ω–∞–∑–≤–∞–Ω–∏—è –∏ –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è ¬´–æ—Å–Ω–æ–≤–Ω–æ–≥–æ —á–∞—Ç–∞¬ª.
 */
let chats = [];            // –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–µ—Å—Å–∏–∏
let currentChatId = null;  // –µ—Å–ª–∏ null ‚Äî —Ä–∞–±–æ—Ç–∞–µ–º –≤ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º —Ä–µ–∂–∏–º–µ
let isTyping = false;
let serverMessages = [];   // –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –ª–µ–Ω—Ç–∞

function loadChats(){
  try{ const saved=localStorage.getItem('growth_assistant_chats'); chats = saved?JSON.parse(saved):[]; }catch{ chats=[]; }
  renderChatList();
}
function saveChats(){
  try{ localStorage.setItem('growth_assistant_chats', JSON.stringify(chats)); }catch{}
}

function createNewChat(title='–ù–æ–≤—ã–π —á–∞—Ç'){
  const id='chat_'+Date.now();
  chats.unshift({ id, title, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(), messages: []});
  saveChats(); renderChatList(); return id;
}
function deleteChat(chatId){
  chats = chats.filter(c=>c.id!==chatId);
  if(currentChatId===chatId){ closeChat(); }
  saveChats(); renderChatList();
}
function openChat(chatId){
  const chat=chats.find(c=>c.id===chatId);
  if(!chat) return;
  currentChatId = chatId;            // –ª–æ–∫–∞–ª—å–Ω–∞—è —Å–µ—Å—Å–∏—è
  $('#current-chat-title').textContent = chat.title;
  $('#bottom-nav').classList.add('hidden');
  $('#chat-fullscreen').classList.add('active');
  renderLocalMessages(chat.messages);
  setTimeout(()=>$('#msg').focus(), 300);
}
function openServerChat(){
  currentChatId = null;              // —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Ä–µ–∂–∏–º
  $('#current-chat-title').textContent = '–ß–∞—Ç';
  $('#bottom-nav').classList.add('hidden');
  $('#chat-fullscreen').classList.add('active');
  renderServerMessages();
  setTimeout(()=>$('#msg').focus(), 300);
}
function closeChat(){
  const fs=$('#chat-fullscreen');
  fs.classList.add('slide-out');
  setTimeout(()=>{
    fs.classList.remove('active','slide-out');
    $('#bottom-nav').classList.remove('hidden');
    $('#chatLog').innerHTML='';
  },300);
}
function renderChatList(){
  const box=$('#chat-list'); box.innerHTML='';
  chats.forEach((c,i)=>{
    const el=document.createElement('div');
    el.className='chat-item'; el.style.animationDelay=`${i*0.06}s`;
    el.innerHTML=`
      <button class="chat-delete" onclick="event.stopPropagation(); deleteChat('${c.id}')">√ó</button>
      <div class="chat-icon">üí¨</div>
      <div class="chat-title">${c.title}</div>
      <div class="chat-date">${new Date(c.updatedAt).toLocaleDateString('ru-RU')}</div>
    `;
    el.onclick=()=>openChat(c.id);
    box.appendChild(el);
  });
  const newEl=document.createElement('div');
  newEl.className='chat-item new'; newEl.innerHTML=`<div class="chat-icon">+</div><div class="chat-title">–ù–æ–≤—ã–π —á–∞—Ç</div>`;
  newEl.onclick=()=>$('#new-chat-modal').classList.add('active');
  box.appendChild(newEl);
  $('#no-chats-message').style.display = chats.length? 'none':'block';
}

/* –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Å—Å–∏–∏ */
function renderLocalMessages(messages){
  const box=$('#chatLog'); box.innerHTML='';
  messages.forEach((m,idx)=>{
    const b=document.createElement('div'); b.className=`msg ${m.role||'assistant'}`; b.textContent=m.content||''; b.style.animationDelay=`${idx*0.03}s`;
    box.appendChild(b);
  });
  box.scrollTop = box.scrollHeight;
}

/* –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –ª–µ–Ω—Ç—ã */
function renderServerMessages(){
  const box=$('#chatLog'); box.innerHTML='';
  (serverMessages||[]).forEach((m,idx)=>{
    const b=document.createElement('div'); b.className=`msg ${m.role||'assistant'}`; b.textContent=m.content||''; b.style.animationDelay=`${idx*0.03}s`;
    box.appendChild(b);
  });
  box.scrollTop = box.scrollHeight;
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ */
function showTyping(){ if(isTyping) return; isTyping=true;
  const box=$('#chatLog'); const t=document.createElement('div'); t.className='typing-indicator'; t.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
  box.appendChild(t); box.scrollTop=box.scrollHeight;
}
function hideTyping(){ isTyping=false; $('.typing-indicator')?.remove(); }

/* –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ (–æ–±—â–µ–π) */
async function loadHistory(){
  if(!tgId) return;
  try{
    const r=await fetch(`/api/chat-history?tg_id=${tgId}`,{headers:{'X-TG-ID':String(tgId)}});
    const j=await r.json();
    if(j?.ok && Array.isArray(j.messages)){
      serverMessages = j.messages;
      if(currentChatId===null && $('#chat-fullscreen').classList.contains('active')) renderServerMessages();
    }
  }catch(e){ console.error('chat-history error', e); }
}

/* –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è */
async function sendMessage(){
  const inp=$('#msg'); const text=inp?.value?.trim(); if(!text) return; inp.value='';
  // –õ–æ–∫–∞–ª—å–Ω–∞—è —Å–µ—Å—Å–∏—è
  if(currentChatId){
    const chat=chats.find(c=>c.id===currentChatId); if(!chat) return;
    chat.messages.push({role:'user', content:text, timestamp:new Date().toISOString()});
    chat.updatedAt=new Date().toISOString(); saveChats(); renderLocalMessages(chat.messages);
  }else{
    // –°–µ—Ä–≤–µ—Ä–Ω—ã–π —Ä–µ–∂–∏–º ‚Äî —Å—Ä–∞–∑—É —Ä–∏—Å—É–µ–º ¬´–ø—É–∑—ã—Ä—å¬ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    serverMessages = [...serverMessages, {role:'user', content:text, timestamp:new Date().toISOString()}];
    renderServerMessages();
  }

  showTyping();
  try{
    const r=await fetch('/api/chat',{method:'POST', headers:{'Content-Type':'application/json', ...(tgId?{'X-TG-ID':String(tgId)}:{})}, body:JSON.stringify({message:text, tg_id:tgId})});
    await r.json().catch(()=>({}));
    await loadHistory(); // –ø–æ–¥—Ç—è–Ω—É—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (–µ–¥–∏–Ω—ã–π –Ω–∞ –ü–ö/—Ç–µ–ª)
    if(currentChatId){ // –ª–æ–∫–∞–ª—å–Ω–∞—è —Å–µ—Å—Å–∏—è: –¥–æ–±–∞–≤–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—Å–∫–∏–π –æ—Ç–≤–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      const last = serverMessages[serverMessages.length-1];
      if(last?.role==='assistant'){
        const chat=chats.find(c=>c.id===currentChatId);
        chat.messages.push({role:'assistant', content:last.content, timestamp:new Date().toISOString()});
        chat.updatedAt=new Date().toISOString(); saveChats(); renderLocalMessages(chat.messages);
      }
    }else{
      renderServerMessages();
    }
  }catch(e){
    if(!currentChatId){
      serverMessages = [...serverMessages, {role:'assistant', content:'–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ.', timestamp:new Date().toISOString()}];
      renderServerMessages();
    }else{
      const chat=chats.find(c=>c.id===currentChatId);
      chat.messages.push({role:'assistant', content:'–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ.', timestamp:new Date().toISOString()});
      chat.updatedAt=new Date().toISOString(); saveChats(); renderLocalMessages(chat.messages);
    }
  }finally{ hideTyping(); }
}

/* ============== TASKS ====================== */
let tasks = [];
let quickPrio = 'today';
const startOfDay=d=>{const x=new Date(d); x.setHours(0,0,0,0); return x;};
const endOfDay  =d=>{const x=new Date(d); x.setHours(23,59,59,999); return x;};
const addDays   =(d,n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x;};

function normalizeDue(v){
  if(v===null||v===undefined) return null;
  if(typeof v==='string' && v.trim().toLowerCase()==='null') return null;
  const num=Number(v); if(!Number.isNaN(num) && v!=='' && v!==true && v!==false){ return num<1e12? num*1000 : num; }
  const ms=Date.parse(v); if(!Number.isNaN(ms)) return ms;
  return null;
}
function normalizeTask(t){
  return { id:t.id, title:t.title||t.text||t.name||'', done:!!t.done, due_at:t.due_at ?? t.dueAt ?? null, due_ts: normalizeDue(t.due_at ?? t.dueAt ?? null) };
}
function fmt(ts){
  const ms=normalizeDue(ts);
  if(ms===null) return '‚Äî';
  const d=new Date(ms); if(Number.isNaN(d.getTime())) return '‚Äî';
  return d.toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
}

function rowTask(t){
  const el=document.createElement('div'); el.className='task'+(t.done?' done':'');
  const chk=document.createElement('button'); chk.className='btn icon'; chk.textContent=t.done?'‚úì':'‚óã';
  chk.onclick=()=>toggleTask(t.id,!t.done);
  const ttl=document.createElement('div'); ttl.className='ttl'; ttl.textContent=t.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
  const badge=document.createElement('div');
  if(t.due_ts==null){ badge.className='badge'; badge.textContent='–±–µ–∑ —Å—Ä–æ–∫–∞'; }
  else{
    const past = t.due_ts < Date.now();
    badge.className='badge '+(past? (t.done?'ok':'dead') : 'due');
    badge.textContent=(t.done?'—Å–¥–µ–ª–∞–Ω–æ ‚Ä¢ ':'–¥–æ ')+fmt(t.due_ts);
  }
  const del=document.createElement('button'); del.className='btn secondary icon'; del.textContent='‚úï'; del.onclick=()=>deleteTask(t.id);
  el.append(chk,ttl,badge,del); return el;
}

async function loadTasks(){
  if(!tgId) return;
  try{
    const r=await fetch(`/api/tasks?tg_id=${tgId}`,{headers:{'X-TG-ID':String(tgId)}});
    const j=await r.json();
    console.log('[tasks] GET payload:', j);
    const arr = Array.isArray(j?.items) ? j.items : (Array.isArray(j) ? j : []);
    tasks = arr.map(normalizeTask);
  }catch(e){
    console.error('Load tasks error', e);
  }finally{
    renderHome(); renderPlan(); renderStats();
  }
}
async function addTask(){
  const title=$('#taskTitle')?.value?.trim();
  const dueRaw=$('#taskDue')?.value;
  if(!title) return showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');

  // –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ –¥–æ–±–∞–≤–∏–º –≤ UI
  let due_ts=null;
  if(dueRaw){ const ms=Date.parse(dueRaw); if(!isNaN(ms)) due_ts=ms; }
  else{
    const now=new Date();
    if(quickPrio==='today') due_ts=endOfDay(now).getTime();
    else if(quickPrio==='week') due_ts=endOfDay(addDays(now,7)).getTime();
    else if(quickPrio==='month') due_ts=endOfDay(addDays(now,30)).getTime();
  }
  const tmpId='tmp_'+Date.now();
  const optimistic={id:tmpId, title, done:false, due_at: due_ts? new Date(due_ts).toISOString(): null, due_ts};
  tasks = [optimistic, ...tasks]; renderHome(); renderPlan(); renderStats();

  try{
    const r=await fetch('/api/tasks',{method:'POST', headers:{'Content-Type':'application/json', ...(tgId?{'X-TG-ID':String(tgId)}:{})}, body:JSON.stringify({ title, due_at: optimistic.due_at, tg_id: tgId })});
    const j=await r.json().catch(()=>({}));
    console.log('[tasks] POST payload:', j);
    // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å —Å–µ—Ä–≤–µ—Ä–∞, —á—Ç–æ–±—ã –∑–∞–º–µ–Ω–∏—Ç—å tmp –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å
    await loadTasks();
    showToast('–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
  }catch(e){
    console.error('Add task error', e);
    showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
  }finally{
    $('#taskTitle').value=''; if($('#taskDue')) $('#taskDue').value='';
  }
}
async function toggleTask(id, done){
  try{
    await fetch('/api/tasks',{method:'PATCH', headers:{'Content-Type':'application/json','X-TG-ID':String(tgId)}, body:JSON.stringify({id, done, tg_id:tgId})});
  }catch(e){ console.error('Toggle task error', e); }
  finally{ await loadTasks(); }
}
async function deleteTask(id){
  try{
    await fetch('/api/tasks',{method:'DELETE', headers:{'Content-Type':'application/json','X-TG-ID':String(tgId)}, body:JSON.stringify({id, tg_id:tgId})});
  }catch(e){ console.error('Delete task error', e); }
  finally{ await loadTasks(); }
}

function renderHome(){
  const s=startOfDay(new Date()).getTime(), e=endOfDay(new Date()).getTime();
  const today=tasks.filter(t=> t.due_ts==null || (t.due_ts>=s && t.due_ts<=e))
                   .sort((a,b)=>(a.done-b.done)||((a.due_ts??0)-(b.due_ts??0)));
  const box=$('#tasks-today'); if(!box) return; box.innerHTML='';
  if(!today.length){ box.innerHTML='<div class="muted">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –∑–∞–¥–∞—á.</div>'; return; }
  today.forEach(t=>box.appendChild(rowTask(t)));
}

let planFilter='today';
function renderPlan(){
  let arr=[...tasks]; const now=new Date();
  if(planFilter==='today'){
    const s=startOfDay(now).getTime(), e=endOfDay(now).getTime();
    arr=arr.filter(t=> t.due_ts==null || (t.due_ts>=s && t.due_ts<=e));
  }else if(planFilter==='week'){
    const e=endOfDay(addDays(now,7)).getTime();
    arr=arr.filter(t=> t.due_ts==null || t.due_ts<=e);
  }else if(planFilter==='month'){
    const e=endOfDay(addDays(now,30)).getTime();
    arr=arr.filter(t=> t.due_ts==null || t.due_ts<=e);
  }else if(planFilter==='team'){
    arr=arr.filter(t=> t.priority==='team');
  }
  arr.sort((a,b)=>(a.done-b.done)||((a.due_ts??1e20)-(b.due_ts??1e20)));
  const box=$('#tasks-plan'); if(!box) return; box.innerHTML='';
  if(!arr.length){ box.innerHTML='<div class="muted">–ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</div>'; return; }
  arr.forEach(t=>box.appendChild(rowTask(t)));
}

function renderStats(){
  const total=tasks.length;
  const done =tasks.filter(t=>t.done).length;
  const overdue=tasks.filter(t=>!t.done && t.due_ts!=null && t.due_ts<Date.now()).length;
  const rate=total? Math.round(done*100/total):0;
  $('#m-total').textContent=total;
  $('#m-done').textContent=done;
  $('#m-rate').textContent=rate+'%';
  $('#m-over').textContent=overdue;
  renderWeekChart();
}
function renderWeekChart(){
  const chart=$('#week-chart'); if(!chart) return; chart.innerHTML='';
  for(let i=6;i>=0;i--){
    const day=addDays(new Date(),-i);
    const s=startOfDay(day).getTime(), e=endOfDay(day).getTime();
    const dayTasks=tasks.filter(t=> t.due_ts!=null && t.due_ts>=s && t.due_ts<=e);
    const done=dayTasks.filter(t=>t.done).length, total=dayTasks.length;
    const h= total? (done/total)*100 : 10;
    const bar=document.createElement('div'); bar.className='chart-bar'; bar.style.height=`${h}%`;
    const label=document.createElement('div'); label.className='chart-label'; label.textContent=day.toLocaleDateString('ru-RU',{weekday:'short'});
    bar.appendChild(label); chart.appendChild(bar);
  }
}

/* ============== FOCUS ====================== */
async function loadFocus(){
  const i=$('#focusInput'); if(!i||!tgId) return;
  try{ const r=await fetch(`/api/focus?tg_id=${tgId}`,{headers:{'X-TG-ID':String(tgId)}}); const j=await r.json(); if(j?.ok) i.value=j.text||''; }catch{}
}
async function saveFocus(){
  const i=$('#focusInput'); if(!i||!tgId) return; const text=i.value||'';
  try{ await fetch('/api/focus',{method:'POST', headers:{'Content-Type':'application/json','X-TG-ID':String(tgId)}, body:JSON.stringify({text, tg_id:tgId})}); showToast('–§–æ–∫—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); }
  catch{ showToast('–§–æ–∫—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω (–æ—Ñ–ª–∞–π–Ω)'); }
}

/* ============== NAV ======================== */
const screens={ home:$('#screen-home'), plan:$('#screen-plan'), chat:$('#screen-chat'), stats:$('#screen-stats'), profile:$('#screen-profile') };
$$('.nav .item').forEach(it=>{
  it.onclick=()=>{
    $$('.nav .item').forEach(x=>x.classList.remove('active')); it.classList.add('active');
    const to=it.dataset.go; Object.values(screens).forEach(s=>s.classList.remove('active')); screens[to].classList.add('active');
    if(to==='chat'){ loadChats(); loadHistory(); openServerChat(); } // –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—É—é –ø–µ—Ä–µ–ø–∏—Å–∫—É —Å—Ä–∞–∑—É
  };
});

/* ============== UI/Events ================== */
function initUI(){
  // chips
  $$('.seg .chip[data-prio]').forEach(ch=>{
    ch.onclick=()=>{ $$('.seg .chip[data-prio]').forEach(x=>x.classList.remove('active')); ch.classList.add('active'); quickPrio=ch.dataset.prio; };
  }); $$('.seg .chip[data-prio]')[0]?.classList.add('active');

  // –ø–ª–∞–Ω-—Ñ–∏–ª—å—Ç—Ä—ã
  $('#f-today').onclick=()=>{planFilter='today'; upd();};
  $('#f-week').onclick =()=>{planFilter='week';  upd();};
  $('#f-month').onclick=()=>{planFilter='month'; upd();};
  $('#f-team').onclick =()=>{planFilter='team';  upd();};
  function upd(){ ['#f-today','#f-week','#f-month','#f-team'].forEach(sel=>$(sel).classList.remove('active')); $('#f-'+planFilter).classList.add('active'); renderPlan(); }

  // —á–∞—Ç
  $('#close-chat').onclick=closeChat;
  $('#create-first-chat').onclick=()=>$('#new-chat-modal').classList.add('active');
  $('#cancel-new-chat').onclick =()=>$('#new-chat-modal').classList.remove('active');
  $('#confirm-new-chat').onclick=()=>{
    const title=$('#new-chat-title').value.trim()||'–ù–æ–≤—ã–π —á–∞—Ç';
    const id=createNewChat(title);
    $('#new-chat-modal').classList.remove('active'); $('#new-chat-title').value=''; openChat(id); showToast('–ß–∞—Ç —Å–æ–∑–¥–∞–Ω');
  };

  // –ø—Ä–æ—Ñ–∏–ª—å
  $$('.lang-btn').forEach(btn=>{
    btn.onclick=()=>{ $$('.lang-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); const map={ru:'–†—É—Å—Å–∫–∏–π',en:'English'}; showToast(`–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${map[btn.dataset.lang]||btn.textContent}`); };
  });

  $('#btn-tariff').onclick = ()=>showToast('–†–∞–∑–¥–µ–ª "–¢–∞—Ä–∏—Ñ—ã" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
  $('#btn-help').onclick   = ()=>showToast('–†–∞–∑–¥–µ–ª "–ü–æ–º–æ—â—å" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
  $('#btn-guide').onclick  = ()=>showToast('–†–∞–∑–¥–µ–ª "–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
  $('#btn-consult').onclick= ()=>showToast('–†–∞–∑–¥–µ–ª "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');

  // –º–æ–¥–∞–ª –∫–ª–∏–∫ —Å–Ω–∞—Ä—É–∂–∏
  $('#new-chat-modal').onclick=(e)=>{ if(e.target===$('#new-chat-modal')) $('#new-chat-modal').classList.remove('active'); };
}
function setupEventListeners(){
  $('#saveTg')?.addEventListener('click', ()=>{
    const val=$('#tgInput')?.value?.trim();
    if(val&&/^\d+$/.test(val)){ saveTgIdLocal(val); ping(); loadFocus(); loadTasks(); loadHistory(); }
    else showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Telegram ID');
  });
  $('#send')?.addEventListener('click', sendMessage);
  $('#msg')?.addEventListener('keydown', e=> e.key==='Enter'? sendMessage():null );
  $('#addTask')?.addEventListener('click', addTask);
  $('#saveFocus')?.addEventListener('click', saveFocus);
}

/* ============== BOOT ======================= */
async function boot(){
  tgId=readTgId(); updateTgIdDisplay(); if(tgId&&$('#tgInput')) $('#tgInput').value=String(tgId);
  initUI(); setupEventListeners();
  await ping(); await loadFocus(); await loadTasks(); await loadHistory();
  // —Ñ–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
  setInterval(loadFocus,10000);
  setInterval(loadTasks,15000);
  setInterval(loadHistory,8000);
  setInterval(ping,30000);
}
boot();
</script>
</body>
</html>
