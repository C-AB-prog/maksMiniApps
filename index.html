<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Business / Growth Assistant</title>
<style>
  :root{
    --bg:#eaf3ff; --text:#0f172a; --muted:#657285; --brand:#2c7dfa;
    --card:rgba(255,255,255,.86); --card-border:rgba(255,255,255,.65);
    --shadow:0 14px 34px rgba(36,78,170,.15); --r-xl:22px; --r:16px; --ring:rgba(44,125,250,.35);
    --grad-hero: radial-gradient(1200px 600px at 100% -200px,#e7f1ff 0,transparent 60%),
                 radial-gradient(1000px 600px at -120px 100%,#e9fff5 0,transparent 60%),
                 linear-gradient(180deg,#fafdff 0%,#f2f7ff 100%);
    --grad-btn: linear-gradient(180deg,#57a5ff 0%,#2c7dfa 100%);
    --grad-pill: linear-gradient(180deg,#dff0ff 0%,#eef7ff 100%);
    --progress-bg:#dceefe; --progress-fill:#38a3ff;
  }
  html,body{height:100%} body{margin:0;font:15px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;color:var(--text);background:var(--grad-hero)}
  .app{max-width:940px;margin:0 auto;padding:18px 14px 120px}
  .top{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .logo{width:44px;height:44px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(180deg,#e6f2ff,#ffffff);box-shadow:var(--shadow);border:1px solid var(--card-border)}
  .brand h1{margin:0;font-size:22px;line-height:1.05;letter-spacing:.2px;font-weight:900}
  .bell{margin-left:auto;width:38px;height:38px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(180deg,#eef6ff,#ffffff);border:1px solid var(--card-border);box-shadow:var(--shadow);position:relative}
  .bell::after{content:'';position:absolute;right:6px;top:6px;width:8px;height:8px;background:#ff5959;border-radius:50%;box-shadow:0 0 0 2px #fff}
  h2{font-size:22px;font-weight:900;margin:18px 6px 10px;letter-spacing:.2px;color:#0e1d36}
  .card{background:var(--card);border:1px solid var(--card-border);backdrop-filter:saturate(180%) blur(8px);-webkit-backdrop-filter:saturate(180%) blur(8px);border-radius:var(--r-xl);box-shadow:var(--shadow);padding:16px;margin:12px 4px}
  .row{display:flex;gap:10px;align-items:center}
  .input{flex:1;background:#f7fbff;border:1px solid #e6eefb;border-radius:14px;padding:12px 14px;outline:none}
  .input:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
  .btn{border:0;color:#fff;border-radius:14px;padding:12px 16px;font-weight:900;cursor:pointer;background:var(--grad-btn);box-shadow:0 10px 24px rgba(44,125,250,.35)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .focus-inner{background:linear-gradient(180deg,#f5fbff,#ffffff);border:1px solid var(--card-border);border-radius:18px;padding:14px;box-shadow:inset 0 1px 0 rgba(255,255,255,.45);margin-top:10px}
  .focus-main{font-size:17px;font-weight:800;margin-bottom:8px}
  .focus-meta{color:var(--muted);font-size:14px;margin-bottom:12px}
  .progress{height:10px;border-radius:999px;background:var(--progress-bg);overflow:hidden;position:relative}
  .progress>span{position:absolute;left:0;top:0;bottom:0;width:45%;background:var(--progress-fill);border-radius:999px;transition:width .25s ease}

  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .chip{padding:8px 12px;background:var(--grad-pill);border:1px solid var(--card-border);border-radius:999px;color:#2f7efb;font-weight:700;cursor:pointer;user-select:none}
  .chip.active{background:#e6f1ff;border-color:#cfe4ff;color:#2c7dfa}

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .task{display:flex;gap:12px;align-items:flex-start;background:var(--card);border:1px solid var(--card-border);backdrop-filter:saturate(180%) blur(8px);border-radius:18px;padding:14px;box-shadow:var(--shadow);margin:10px 0}
  .task-ic{width:42px;height:42px;border-radius:14px;display:grid;place-items:center;background:var(--grad-pill);border:1px solid var(--card-border);color:#2f7efb;font-size:18px;font-weight:700}
  .task-mid{flex:1}
  .task-title{font-weight:900;font-size:17px;margin:2px 0 6px}
  .task-sub{color:var(--muted)}
  .task-ok{width:28px;height:28px;border-radius:10px;border:1px solid var(--card-border);display:grid;place-items:center;background:#fff;color:#2c7dfa;cursor:pointer}
  .link-more{text-align:center;margin:6px 0 2px;color:#2c7dfa;font-weight:800;cursor:pointer}

  .chatbar{position:fixed;left:16px;right:16px;bottom:92px;display:flex;justify-content:center}
  .chatbtn{width:100%;max-width:940px;border-radius:22px;border:1px solid #9fd0ff66;background:var(--grad-btn);color:#fff;font-weight:900;font-size:17px;padding:16px 18px;box-shadow:0 16px 36px rgba(44,125,250,.35)}

  .nav{position:fixed;left:0;right:0;bottom:0;padding:10px env(safe-area-inset-left) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-right);background:rgba(255,255,255,.86);border-top:1px solid var(--card-border);box-shadow:0 -10px 30px rgba(36,78,170,.10);display:flex;justify-content:space-around;gap:8px}
  .tab{display:flex;flex-direction:column;align-items:center;gap:6px;color:#6b7a90}.tab .ic{width:28px;height:28px;border-radius:12px;display:grid;place-items:center;background:#f2f6ff;border:1px solid #e6eefb}.tab.active{color:#2c7dfa}.tab.active .ic{background:#e6f1ff;color:#2c7dfa;border-color:#cfe4ff}

  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;max-width:92vw;box-shadow:var(--shadow);z-index:9999}
</style>
</head>
<body>
<div class="app">

  <!-- –®–∞–ø–∫–∞ -->
  <div class="top">
    <div class="logo">üòä</div>
    <div class="brand"><h1>Business<br/>Assistance</h1></div>
    <div class="bell">üîî</div>
  </div>

  <!-- –§–æ–∫—É—Å -->
  <h2>–§–æ–∫—É—Å –¥–Ω—è</h2>
  <section class="card">
    <div class="row" style="margin-bottom:12px">
      <input id="focusInput" class="input" type="text" placeholder="–°–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ —Å–µ–≥–æ–¥–Ω—è‚Ä¶" />
      <button id="focusSave" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div class="focus-inner" id="focusGlass" style="display:none">
      <div class="focus-main" id="focusMain">‚Ä¶</div>
      <div class="focus-meta" id="focusMeta">–°—Ä–æ–∫ –¥–æ 18:00</div>
      <div class="progress"><span id="focusProgress" style="width:40%"></span></div>
    </div>
  </section>

  <!-- –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ -->
  <h2>–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</h2>
  <section class="card">
    <input id="taskTitle" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"/>
    <div class="chips" id="chipGroup">
      <div class="chip active" data-list="today">–°–µ–≥–æ–¥–Ω—è</div>
      <div class="chip" data-list="week">–ù–µ–¥–µ–ª—è</div>
      <div class="chip" data-list="backlog">–ë—ç–∫–ª–æ–≥</div>
    </div>
    <div class="grid2">
      <input id="taskDate" class="input" type="date" />
      <input id="taskTime" class="input" type="time" />
    </div>
    <div class="row" style="margin-top:12px">
      <div style="flex:1"></div>
      <button id="taskAdd" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </section>

  <!-- –ó–∞–¥–∞—á–∏ -->
  <h2>–ó–∞–¥–∞—á–∏</h2>
  <section class="card" id="tasksBox">
    <div id="tasks"></div>
    <div class="link-more" id="showAll">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë</div>
  </section>

</div>

<!-- –ë–æ–ª—å—à–∞—è –∫–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ -->
<div class="chatbar"><button class="chatbtn" id="openChat">–ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º  üéôÔ∏è</button></div>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<nav class="nav">
  <div class="tab active"><div class="ic">üè†</div><div>–ì–ª–∞–≤–Ω–∞—è</div></div>
  <div class="tab"><div class="ic">üóìÔ∏è</div><div>–ü–ª–∞–Ω</div></div>
  <div class="tab"><div class="ic">üìÖ</div><div>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div></div>
  <div class="tab"><div class="ic">üìä</div><div>Hadi</div></div>
  <div class="tab"><div class="ic">üë§</div><div>–ü—Ä–æ—Ñ–∏–ª—å</div></div>
</nav>

<!-- –ú–æ–¥–∞–ª–∫–∞ —á–∞—Ç–∞ -->
<div id="chatModal" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,.45);backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px);z-index:50;align-items:flex-end">
  <div style="background:#fff;border-radius:18px 18px 0 0;box-shadow:0 -10px 30px rgba(0,0,0,.2);width:100%;max-height:80vh;overflow:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #eef0f6">
      <strong>–ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</strong>
      <button id="closeChat" class="btn" style="padding:8px 12px">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="msgs" style="display:flex;flex-direction:column;gap:8px;padding:10px 12px"></div>
    <div style="display:flex;gap:8px;padding:12px;border-top:1px solid #eef0f6;position:sticky;bottom:0;background:#fff">
      <input id="chatInput" class="input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–æ –ø–ª–∞–Ω, HADI –∏–ª–∏ –∑–∞–¥–∞—á–∏‚Ä¶" />
      <button id="sendMsg" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
/* ===== –ö–æ–Ω—Ñ–∏–≥ ===== */
const PROD_ORIGIN = 'https://maks-mini-apps.vercel.app';
const ORIGIN = (PROD_ORIGIN && PROD_ORIGIN.trim()) ? PROD_ORIGIN.trim().replace(/\/+$/,'') : window.location.origin;

/* ===== –¢–ì ===== */
const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
if(tg){ try{ tg.ready(); tg.expand(); }catch(e){} }
window.__TG_INIT_DATA__ = tg && tg.initData ? tg.initData : '';

/* ===== –¢–æ—Å—Ç—ã ===== */
let toastEl=null;
function toast(text){ if(toastEl){toastEl.remove()} toastEl=document.createElement('div');toastEl.className='toast';toastEl.textContent=text;document.body.appendChild(toastEl);setTimeout(()=>toastEl&&toastEl.remove(),3200) }

/* ===== fetch —Å –ø–æ–¥–ø–∏—Å—å—é/—Ç–∞–π–º–∞—É—Ç–æ–º/–ø–æ–≤—Ç–æ—Ä–æ–º ===== */
async function explain(url,res){
  let t='';try{t=await res.clone().text()}catch{} toast(`API: ${res.status} ${res.statusText}${t?` ‚Äî ${t.slice(0,120)}`:''}`);
}
async function authFetch(route,opts,timeout=20000){
  const url = `${ORIGIN}${route.startsWith('/')?route:`/${route}`}`;
  async function once(){
    const c=new AbortController(); const timer=setTimeout(()=>c.abort('timeout'),timeout);
    try{
      const res=await fetch(url,{...(opts||{}),headers:{...(opts?.headers||{}),'x-telegram-init':window.__TG_INIT_DATA__||''},signal:c.signal});
      clearTimeout(timer); if(!res.ok) await explain(url,res); return res;
    }catch(e){ clearTimeout(timer); throw e }
  }
  try{
    const r=await once(); if(r.ok) return r;
    if(r.status>=500){ await new Promise(r=>setTimeout(r,600)); return await once(); }
    return r;
  }catch(e){ toast('API: network error'); throw e }
}

/* ===== DOM ===== */
const elFocusInput  = document.getElementById('focusInput');
const elFocusSave   = document.getElementById('focusSave');
const elFocusGlass  = document.getElementById('focusGlass');
const elFocusMain   = document.getElementById('focusMain');
const elFocusMeta   = document.getElementById('focusMeta');
const elProgress    = document.getElementById('focusProgress');

const listEl        = document.getElementById('tasks');
const showAll       = document.getElementById('showAll');

const taskTitle     = document.getElementById('taskTitle');
const chipGroup     = document.getElementById('chipGroup');
const taskDate      = document.getElementById('taskDate');
const taskTime      = document.getElementById('taskTime');
const taskAdd       = document.getElementById('taskAdd');

const chatModal = document.getElementById('chatModal');
const openChat  = document.getElementById('openChat');
const closeChat = document.getElementById('closeChat');
const msgs      = document.getElementById('msgs');
const chatInput = document.getElementById('chatInput');
const sendMsg   = document.getElementById('sendMsg');

let todayTasks=[]; let currentList='today';

/* ===== Health ===== */
(async function health(){
  try{
    const r = await authFetch('/api/health');
    const j = await r.json().catch(()=>({}));
    if(!j.db_ok) toast('–ë–∞–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
  }catch(e){ /* –Ω–µ —à—É–º–∏–º –ª–∏—à–Ω–∏–π —Ä–∞–∑ */ }
})();

/* ===== Focus ===== */
async function loadFocus(){
  const day=new Date().toISOString().slice(0,10);
  try{
    const r=await authFetch(`/api/focus?day=${day}`);
    const j=await r.json().catch(()=>({}));
    const text=j.text||'';
    elFocusInput.value=text;
    if(text){
      elFocusMain.textContent=text;
      elFocusMeta.textContent=j.meta||'–°—Ä–æ–∫ –¥–æ 18:00';
      elProgress.style.width=(j.progressPct||45)+'%';
      elFocusGlass.style.display='block';
    }else elFocusGlass.style.display='none';
  }catch(e){}
}
async function saveFocus(){
  const text=(elFocusInput.value||'').trim(); if(!text) return toast('–í–≤–µ–¥–∏—Ç–µ —Ñ–æ–∫—É—Å –¥–Ω—è');
  const old=elFocusSave.textContent; elFocusSave.disabled=true; elFocusSave.textContent='–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶';
  try{
    const r=await authFetch('/api/focus',{method:'PUT',headers:{'content-type':'application/json'},body:JSON.stringify({day:new Date().toISOString().slice(0,10),text})});
    if(r.ok){ await loadFocus(); toast('–§–æ–∫—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω') }
  }catch(e){}
  elFocusSave.disabled=false; elFocusSave.textContent=old;
}
elFocusSave.onclick=saveFocus;

/* ===== Chips ===== */
chipGroup.addEventListener('click',e=>{
  const c=e.target.closest('.chip'); if(!c) return;
  chipGroup.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
  c.classList.add('active'); currentList=c.dataset.list||'today';
});

/* ===== Tasks ===== */
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))}
function renderTasks(items){
  if(!items.length){ listEl.innerHTML='<div style="text-align:center;color:#6b7a90;padding:10px">–ó–∞–¥–∞—á –Ω–µ—Ç</div>'; return; }
  listEl.innerHTML=items.map(t=>{
    const sub=t.note||t.subtitle||'';
    const ic=t.icon||'üß©';
    const ok=t.done?'‚úÖ':'‚úîÔ∏è';
    return `<div class="task" data-id="${t.id||''}" data-done="${!!t.done}">
      <div class="task-ic">${ic}</div>
      <div class="task-mid">
        <div class="task-title">${escapeHtml(t.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
        ${sub?`<div class="task-sub">${escapeHtml(sub)}</div>`:''}
      </div>
      <div class="task-ok" title="–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π">${ok}</div>
    </div>`;
  }).join('');
}
async function loadTasks(){
  try{
    const r=await authFetch('/api/tasks?list=today');
    const j=await r.json().catch(()=>({items:[]}));
    todayTasks=j.items||[]; renderTasks(todayTasks);
  }catch(e){}
}

/* toggle done */
listEl.addEventListener('click',async e=>{
  const ok=e.target.closest('.task-ok'); if(!ok) return;
  const task=e.target.closest('.task'); const id=task?.dataset?.id; if(!id) return;
  const wasDone=task.dataset.done==='true';
  // –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π –∞–ø–¥–µ–π—Ç
  task.dataset.done=(!wasDone).toString(); ok.textContent = wasDone ? '‚úîÔ∏è' : '‚úÖ';
  try{
    const r=await authFetch(`/api/tasks/${encodeURIComponent(id)}`,{method:'PUT',headers:{'content-type':'application/json'},body:JSON.stringify({done:!wasDone})});
    if(!r.ok) throw 0;
  }catch(e){
    // –æ—Ç–∫–∞—Ç
    task.dataset.done=wasDone.toString(); ok.textContent = wasDone ? '‚úÖ' : '‚úîÔ∏è';
    toast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É');
  }
});

/* add task */
function toISO(dateStr,timeStr){
  if(!dateStr && !timeStr) return null;
  let d = dateStr ? new Date(dateStr) : new Date();
  if(timeStr){ const [h,m]=timeStr.split(':'); d.setHours(+h||0, +m||0, 0, 0); }
  return d.toISOString();
}
taskAdd.onclick = async ()=>{
  const title=(taskTitle.value||'').trim(); if(!title) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
  const deadline=toISO(taskDate.value,taskTime.value);
  const payload={ title, list: currentList, deadline };
  const old=taskAdd.textContent; taskAdd.disabled=true; taskAdd.textContent='–î–æ–±–∞–≤–ª—è—é‚Ä¶';
  try{
    const r=await authFetch('/api/tasks',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
    if(r.ok){ taskTitle.value=''; taskDate.value=''; taskTime.value=''; toast('–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞'); await loadTasks(); }
  }catch(e){}
  taskAdd.disabled=false; taskAdd.textContent=old;
};

showAll.onclick = ()=> toast('–°–∫–æ—Ä–æ: —ç–∫—Ä–∞–Ω ¬´–í—Å–µ –∑–∞–¥–∞—á–∏¬ª');

/* ===== Chat ===== */
openChat.onclick = ()=>{ chatModal.style.display='flex'; chatInput.focus() };
closeChat.onclick = ()=>{ chatModal.style.display='none' };
function pushMsg(w,t){const b=document.createElement('div');b.style.cssText='padding:10px 12px;border-radius:12px;max-width:80%;margin:2px 0';b.textContent=t;if(w==='me'){b.style.marginLeft='auto';b.style.background='#eff6ff'}else{b.style.marginRight='auto';b.style.background='#f3f4f6'};msgs.appendChild(b);msgs.scrollTop=msgs.scrollHeight;}
async function sendChat(){
  const q=(chatInput.value||'').trim(); if(!q) return; pushMsg('me',q); chatInput.value='';
  try{
    const r=await authFetch('/api/chat',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({message:q})},22000);
    const j=await r.json().catch(()=>({})); (r.ok&&j.reply)?pushMsg('bot',j.reply):pushMsg('bot','[–æ—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞]');
  }catch(e){ pushMsg('bot','[network error]') }
}
sendMsg.onclick=sendChat; chatInput.addEventListener('keydown',e=>{ if(e.key==='Enter') sendChat() });

/* ===== Boot ===== */
(async function boot(){ await Promise.all([loadFocus(),loadTasks()]); })();
</script>
</body>
</html>
