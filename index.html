<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Growth Assistant</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{
  color-scheme: light;
  --ink:#0E1220; --muted:#6B7280; --line:#E7ECF5;
  --brand:#5B6CFF; --brand-2:#7F6BFF; --brand-3:#46C7F4;
  --ok:#10B981; --warn:#F59E0B; --danger:#EF4444;
  --bg:#F3F6FF;
  --bg-grad:
    radial-gradient(1200px 600px at 100% -10%, rgba(123,195,255,.20), transparent 60%),
    radial-gradient(900px 500px at -10% 0%, rgba(135,121,255,.18), transparent 55%),
    #F3F6FF;
  --card:rgba(255,255,255,.86); --card-blur:blur(10px);
  --r:18px; --shadow:0 10px 28px rgba(17,24,39,.10); --shadow-2:0 16px 40px rgba(91,108,255,.20);
  --safe-bottom:env(safe-area-inset-bottom,0px); --safe-top:env(safe-area-inset-top,0px);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  color:var(--ink)!important; background:var(--bg-grad)!important;
  font:15px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  -webkit-tap-highlight-color:transparent;
}

/* APP BAR */
.appbar{position:sticky;top:0;z-index:20;padding:calc(8px + var(--safe-top)) 18px 12px;
  background:linear-gradient(180deg,rgba(255,255,255,.75),rgba(255,255,255,.55));
  backdrop-filter:saturate(160%) blur(8px); border-bottom:1px solid var(--line);}
.appbar h1{margin:0;font-size:22px;font-weight:900;letter-spacing:.2px;
  background:linear-gradient(90deg,var(--brand),var(--brand-2));
  -webkit-background-clip:text;background-clip:text;color:transparent}
.appbar .sub{color:var(--muted);font-size:12px}

/* LAYOUT */
.container{max-width:940px;margin:0 auto;padding:16px 14px 110px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;backdrop-filter:var(--card-blur)}
h3{margin:0 0 12px 0;font-size:16px}
section{display:none;gap:14px}
section.active{display:grid}
.grid-2{grid-template-columns:1fr}
@media(min-width:860px){.grid-2{grid-template-columns:1.15fr .85fr}}

/* INPUTS / BUTTONS */
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
.input,input[type="text"],input[type="datetime-local"]{width:100%;background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px 14px;outline:none;transition:border-color .2s,box-shadow .2s}
.input:focus,input[type="text"]:focus,input[type="datetime-local"]:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(91,108,255,.12)}
.btn{appearance:none;border:none;padding:14px 16px;border-radius:14px;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;cursor:pointer;font-weight:800;letter-spacing:.2px;box-shadow:var(--shadow-2);transition:transform .06s ease-in-out,filter .2s}
.btn:active{transform:translateY(1px)}
.btn.secondary{background:#fff;color:var(--ink);border:1px solid var(--line);box-shadow:none;font-weight:700}
.btn.ghost{background:rgba(91,108,255,.10);color:var(--brand);box-shadow:none}
.btn.icon{padding:10px 12px;border-radius:12px}

/* CHIPS */
.seg{display:flex;gap:8px;flex-wrap:wrap}
.seg .chip{padding:9px 13px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600;transition:all .15s}
.seg .chip.active{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border-color:transparent;box-shadow:0 8px 22px rgba(91,108,255,.28)}

/* LISTS / TASKS */
.list{display:flex;flex-direction:column;gap:10px}
.task{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--line);border-radius:14px;background:#fff;transition:all .3s}
.task:hover{border-color:var(--brand);box-shadow:0 4px 12px rgba(91,108,255,.08)}
.task .ttl{flex:1}
.task.done{opacity:.7}
.task.done .ttl{text-decoration:line-through}
.badge.s{font-size:12px;padding:5px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted)}
.badge.s.ok{color:#065f46;border-color:#10b981;background:#ecfdf5}
.badge.s.due{color:#7c2d12;border-color:#f59e0b;background:#fffbeb}
.badge.s.dead{color:#991b1b;border-color:#ef4444;background:#fef2f2}

/* CHAT CARDS */
.chat-container{display:flex;flex-direction:column;gap:14px}
.chat-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-bottom:16px}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.chat-item{background:#fff;border:2px solid var(--line);border-radius:16px;padding:16px 12px;text-align:center;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1);min-height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;animation:slideUp .4s cubic-bezier(.4,0,.2,1)}
.chat-item:hover{border-color:var(--brand);transform:translateY(-4px) scale(1.02);box-shadow:0 12px 32px rgba(91,108,255,.15)}
.chat-item.active{border-color:var(--brand);background:linear-gradient(135deg,#f8faff,#f0f4ff);box-shadow:0 8px 25px rgba(91,108,255,.15);transform:translateY(-2px)}
.chat-item.new{border:2px dashed var(--muted);background:transparent}
.chat-icon{font-size:24px;margin-bottom:8px;opacity:.7}
.chat-title{font-weight:600;font-size:13px;line-height:1.3;margin-bottom:4px}
.chat-date{font-size:11px;color:var(--muted)}
.chat-delete{position:absolute;top:6px;right:6px;width:20px;height:20px;border-radius:50%;background:var(--danger);color:#fff;border:none;font-size:12px;cursor:pointer;opacity:0;transition:all .3s;display:flex;align-items:center;justify-content:center;transform:scale(.8)}
.chat-item:hover .chat-delete{opacity:1;transform:scale(1)}

/* FULLSCREEN CHAT */
.chat-fullscreen{display:none;position:fixed;inset:0;background:#fff;z-index:1000;flex-direction:column;transform:translateY(100%);transition:transform .4s cubic-bezier(.4,0,.2,1)}
.chat-fullscreen.active{display:flex;transform:translateY(0)}
.chat-fullscreen.slide-out{transform:translateY(100%)}
.chat-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--line);background:#fff;flex-shrink:0}
.chat-header-title{font-weight:600;font-size:18px;color:var(--ink)}
.chat-header-actions{display:flex;gap:8px}
.chat-body{flex:1;overflow:auto;padding:20px;display:flex;flex-direction:column;gap:16px;background:linear-gradient(180deg,#FAFBFF,#F7FAFF);scroll-behavior:smooth}
@keyframes messageSlide{from{opacity:0;transform:translateY(10px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}
.msg{max-width:85%;padding:14px 18px;border-radius:20px;font-size:15px;line-height:1.4;word-wrap:break-word;animation:messageSlide .3s cubic-bezier(.4,0,.2,1);transform-origin:center bottom}
.msg.user{align-self:flex-end;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border-bottom-right-radius:8px}
.msg.assistant{align-self:flex-start;background:#fff;border:1px solid var(--line);border-bottom-left-radius:8px}
.chat-foot{display:flex;gap:12px;padding:16px 20px;border-top:1px solid var(--line);background:#fff;flex-shrink:0}

/* NAV */
.nav{position:fixed;left:0;right:0;bottom:0;z-index:25;padding:10px 10px calc(10px + var(--safe-bottom));background:rgba(255,255,255,.9);border-top:1px solid var(--line);backdrop-filter:saturate(160%) blur(10px);box-shadow:0 -8px 24px rgba(17,24,39,.08);display:flex;justify-content:space-around;transition:transform .3s cubic-bezier(.4,0,.2,1)}
.nav.hidden{transform:translateY(100%)}
.nav .item{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:64px;color:var(--muted);font-size:12px}
.nav .item.active{color:var(--brand)}
.nav .item svg{opacity:.6}
.nav .item.active svg{opacity:1;filter:drop-shadow(0 4px 8px rgba(91,108,255,.35))}

/* TOAST */
.toast{position:fixed;left:50%;bottom:calc(78px + var(--safe-bottom));transform:translateX(-50%);background:#111827;color:#fff;padding:12px 18px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.3);z-index:999;display:none}

.muted{color:var(--muted)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin:16px 0}
.stat-card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;text-align:center}
.stat-value{font-size:24px;font-weight:800;margin-bottom:4px}
.stat-label{font-size:12px;color:var(--muted)}
.week-chart{height:200px;display:flex;align-items:end;gap:8px;margin-top:20px}
.chart-bar{flex:1;background:linear-gradient(to top,var(--brand),var(--brand-2));border-radius:4px 4px 0 0;position:relative;transition:height .5s}
.chart-label{position:absolute;bottom:-20px;left:0;right:0;text-align:center;font-size:10px;color:var(--muted)}
</style>
</head>
<body>

<!-- Top bar -->
<div class="appbar">
  <h1>Growth Assistant</h1>
  <div class="sub">Фокус дня • задачи • план • чат • статистика</div>
</div>

<div class="container">

  <!-- Главная -->
  <section id="screen-home" class="active grid-2">
    <div class="card">
      <h3>Фокус дня</h3>
      <label>Самое главное сегодня</label>
      <div style="display:flex; gap:10px">
        <input id="focusInput" class="input" type="text" placeholder="Например: закрыть отчёт" />
        <button id="saveFocus" class="btn">Сохранить</button>
      </div>
    </div>

    <div class="card">
      <h3>Быстрое добавление</h3>
      <div class="seg">
        <div class="chip" data-prio="today">Сегодня</div>
        <div class="chip" data-prio="week">Неделя</div>
        <div class="chip" data-prio="month">Месяц</div>
        <div class="chip" data-prio="team">Команда</div>
      </div>
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
        <input id="taskTitle" class="input" type="text" placeholder="Название задачи" />
        <input id="taskDue" class="input" type="datetime-local" />
        <button id="addTask" class="btn">Добавить задачу</button>
      </div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <h3>Задачи на сегодня</h3>
      <div id="tasks-today" class="list"></div>
    </div>
  </section>

  <!-- План -->
  <section id="screen-plan" class="grid">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">План задач</h3>
        <div class="seg">
          <div id="f-today" class="chip active">Сегодня</div>
          <div id="f-week" class="chip">Неделя</div>
          <div id="f-month" class="chip">Месяц</div>
          <div id="f-team" class="chip">Команда</div>
        </div>
      </div>
      <div id="tasks-plan" class="list"></div>
    </div>
  </section>

  <!-- Чат -->
  <section id="screen-chat" class="grid">
    <div class="card">
      <h3>Мои чаты с ассистентом</h3>
      <div class="chat-container">
        <div id="chat-list" class="chat-list"></div>
        <div id="no-chats-message" style="text-align:center;padding:40px 20px;display:none;">
          <div style="font-size:48px;margin-bottom:16px;opacity:.5;">💬</div>
          <h3 style="margin:0 0 8px 0;">Нет активных чатов</h3>
          <p class="muted">Создайте новый чат, чтобы начать общение с ассистентом</p>
          <button class="btn" id="create-first-chat" style="margin-top:16px;">Создать чат</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Статистика -->
  <section id="screen-stats" class="grid grid-2">
    <div class="card">
      <h3>Статистика продуктивности</h3>
      <div class="stats-grid">
        <div class="stat-card"><div id="m-total" class="stat-value">0</div><div class="stat-label">Всего задач</div></div>
        <div class="stat-card"><div id="m-done" class="stat-value" style="color:var(--ok)">0</div><div class="stat-label">Выполнено</div></div>
        <div class="stat-card"><div id="m-rate" class="stat-value">0%</div><div class="stat-label">Процент успеха</div></div>
        <div class="stat-card"><div id="m-over" class="stat-value" style="color:var(--danger)">0</div><div class="stat-label">Просрочено</div></div>
      </div>
      <p class="muted" style="margin-top:12px"><b>Гипотеза:</b> «Если фиксировать задачи и ставить дедлайны, завершу ≥70% вовремя».<br/><b>Действие:</b> добавляй/закрывай задачи вовремя. <b>Данные:</b> метрики выше. <b>Инсайт:</b> держи ≥70%.</p>
    </div>
    <div class="card">
      <h3>Прогресс за неделю</h3>
      <div id="week-chart" class="week-chart"></div>
    </div>
  </section>

  <!-- Профиль -->
  <section id="screen-profile" class="grid">
    <div class="card">
      <h3>Профиль</h3>
      <div class="muted" style="margin-bottom:16px">Telegram ID: <span id="profile-id">–</span></div>
    </div>
  </section>
</div>

<!-- FULLSCREEN CHAT -->
<div id="chat-fullscreen" class="chat-fullscreen">
  <div class="chat-header">
    <div class="chat-header-title" id="current-chat-title">Чат</div>
    <div class="chat-header-actions"><button class="btn ghost icon" id="close-chat">✕</button></div>
  </div>
  <div id="chatLog" class="chat-body"></div>
  <div class="chat-foot">
    <input id="msg" class="input" type="text" placeholder="Напишите сообщение..." />
    <button id="send" class="btn" aria-label="Отправить">➤</button>
  </div>
</div>

<!-- Modal -->
<div id="new-chat-modal" class="modal">
  <div class="modal-content">
    <h3 class="modal-title">Название чата</h3>
    <input type="text" id="new-chat-title" class="input" placeholder="Например: Планирование проекта" style="margin-bottom:20px;">
    <div style="display:flex;gap:10px;">
      <button class="btn secondary" id="cancel-new-chat" style="flex:1;">Отмена</button>
      <button class="btn" id="confirm-new-chat" style="flex:1;">Создать</button>
    </div>
  </div>
</div>

<!-- Bottom navigation -->
<nav class="nav" id="bottom-nav">
  <div class="item active" data-go="home">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 7v10a1 1 0 0 1-1 1h-6v-6H10v6H4a1 1 0 0 1-1-1V10l9-7z"/></svg>
    Главная
  </div>
  <div class="item" data-go="plan">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M4 5h16v2H4zM4 11h16v2H4zM4 17h10v2H4z"/></svg>
    План
  </div>
  <div class="item" data-go="chat">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
    Чат
  </div>
  <div class="item" data-go="stats">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/></svg>
    Статистика
  </div>
  <div class="item" data-go="profile">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.42 0-8 2.24-8 5v3h16v-3c0-2.76-3.58-5-8-5z"/></svg>
    Профиль
  </div>
</nav>

<div id="toast" class="toast"></div>

<script>
/* ===== helpers ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const showToast=t=>{const el=$('#toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',1600);};
const startOfDay=d=>{const x=new Date(d);x.setHours(0,0,0,0);return x;}
const endOfDay=d=>{const x=new Date(d);x.setHours(23,59,59,999);return x;}
const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x;}

/* ===== tg_id (без UI) ===== */
let tgId=0;
function readTgId(){
  try{const wa=window.Telegram?.WebApp?.initDataUnsafe; const uid=wa?.user?.id; if(uid&&/^\d+$/.test(String(uid))) return Number(uid);}catch{}
  const q=new URLSearchParams(location.search).get('tg_id'); if(q&&/^\d+$/.test(q)) return Number(q);
  const ls=localStorage.getItem('tg_id'); if(ls&&/^\d+$/.test(ls)) return Number(ls);
  return 0;
}
function updateProfile(){const p=$('#profile-id'); if(p) p.textContent=tgId||'–';}

/* ===== простая проверка онлайна (без бейджей) ===== */
async function ping(){try{const r=await fetch('/api/ping',{headers:tgId?{'X-TG-ID':String(tgId)}:{}});return !!(await r.json())?.ok;}catch{return false;}}

/* ===== утилиты разбора ответов ===== */
function pickArray(obj){
  if(Array.isArray(obj))return obj;
  if(!obj||typeof obj!=='object')return [];
  const keys=['items','data','rows','result','list','chats','sessions','messages'];
  for(const k of keys){
    const v=obj[k];
    if(Array.isArray(v)) return v;
    if(v && typeof v==='object'){
      for(const kk of keys){ if(Array.isArray(v[kk])) return v[kk]; }
    }
  }
  for(const v of Object.values(obj)){ if(Array.isArray(v)) return v; }
  return [];
}

/* ===================== TASKS ===================== */
let tasks=[], pendingTasks=[];
const pendingKey=()=>`ga_pending_${tgId}`;

function normalizeDue(v){
  if(v===null||v===undefined) return null;
  if(typeof v==='string' && v.trim().toLowerCase()==='null') return null;
  const n=Number(v); if(!Number.isNaN(n) && v!=='' && v!==true && v!==false){ return n<1e12? n*1000 : n; }
  const ms=Date.parse(v); if(!Number.isNaN(ms)) return ms; return null;
}
function normalizeTask(t){
  const dueRaw=t.due_at ?? t.dueAt ?? t.deadline ?? t.due ?? null;
  return { id:(t.id??t.task_id??t._id??`tmp_${Math.random().toString(36).slice(2)}`),
           title:(t.title??t.text??t.name??'Без названия'),
           done:!!(t.done??t.is_done??t.completed),
           due_at: dueRaw, due_ts: normalizeDue(dueRaw) };
}
function fmt(ts){const ms=normalizeDue(ts); if(ms===null) return '—'; const d=new Date(ms); if(Number.isNaN(d.getTime())) return '—'; return d.toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});}

function rowTask(t){
  const el=document.createElement('div'); el.className='task'+(t.done?' done':'');
  const chk=document.createElement('button'); chk.className='btn icon'; chk.textContent=t.done?'✓':'○'; chk.onclick=()=>toggleTask(t.id,!t.done);
  const ttl=document.createElement('div'); ttl.className='ttl'; ttl.textContent=t.title||'Без названия';
  const badge=document.createElement('div');
  if(t.due_ts==null){badge.className='badge s'; badge.textContent='без срока';}
  else{const past=t.due_ts < Date.now(); badge.className='badge s '+(past?(t.done?'ok':'dead'):'due'); badge.textContent=(t.done?'сделано • ':'до ')+fmt(t.due_ts);}
  const del=document.createElement('button'); del.className='btn secondary icon'; del.textContent='✕'; del.onclick=()=>deleteTask(t.id);
  el.append(chk,ttl,badge,del); return el;
}

function mergeTasks(server){
  // Слияние с локальными "ожидающими" по ключу title+due_at
  const key = t=>(t.title?.trim()||'')+'|'+(t.due_at||'');
  const map=new Map(server.map(t=>[key(t),t]));
  const stillPending=[];
  for(const p of pendingTasks){
    if(!map.has(key(p))) stillPending.push(p); // сервер ещё не отдал — показываем
  }
  return [...stillPending, ...server];
}

async function loadTasks(){
  if(!tgId) return;
  try{pendingTasks=JSON.parse(localStorage.getItem(pendingKey())||'[]').map(normalizeTask);}catch{pendingTasks=[];}
  try{
    const r=await fetch(`/api/tasks?tg_id=${tgId}`,{headers:{'X-TG-ID':String(tgId)}});
    const j=await r.json(); const arr=pickArray(j).map(normalizeTask);
    tasks=mergeTasks(arr);
  }catch(e){console.error('Load tasks error',e); tasks=[...pendingTasks];}
  renderHome(); renderPlan(); renderStats();
}

async function addTask(){
  const title=$('#taskTitle')?.value?.trim(); const dueRaw=$('#taskDue')?.value; if(!title) return showToast('Введите название');
  let due_ts=null;
  if(dueRaw){const ms=Date.parse(dueRaw); if(!isNaN(ms)) due_ts=ms;} else {const now=new Date(); const pr=$('.seg .chip.active')?.dataset?.prio||'today';
    if(pr==='today') due_ts=endOfDay(now).getTime(); else if(pr==='week') due_ts=endOfDay(addDays(now,7)).getTime(); else if(pr==='month') due_ts=endOfDay(addDays(now,30)).getTime();}
  const optimistic=normalizeTask({id:`tmp_${Date.now()}`,title,done:false,due_at: due_ts? new Date(due_ts).toISOString(): null});
  // кладём в pending и сразу рендерим (не исчезает)
  pendingTasks=[optimistic,...pendingTasks]; localStorage.setItem(pendingKey(), JSON.stringify(pendingTasks));
  await loadTasks();
  try{
    const resp=await fetch('/api/tasks',{method:'POST',headers:{'Content-Type':'application/json','X-TG-ID':String(tgId)},
      body:JSON.stringify({title, due_at:optimistic.due_at, tg_id:tgId})});
    await resp.json().catch(()=>{});
  }catch(e){console.error('Add task error',e);}
  // через короткую задержку подтянем сервер и удалим дубль
  setTimeout(loadTasks, 800);
  $('#taskTitle').value=''; if($('#taskDue')) $('#taskDue').value='';
  showToast('Задача добавлена');
}

async function toggleTask(id,done){
  try{await fetch('/api/tasks',{method:'PATCH',headers:{'Content-Type':'application/json','X-TG-ID':String(tgId)},body:JSON.stringify({id,done,tg_id:tgId})});}
  catch(e){console.error('Toggle task',e);}
  finally{setTimeout(loadTasks,300);}
}
async function deleteTask(id){
  // вычищаем и из pending, чтобы не «возвращалась»
  pendingTasks=pendingTasks.filter(t=>t.id!==id); localStorage.setItem(pendingKey(), JSON.stringify(pendingTasks));
  try{await fetch('/api/tasks',{method:'DELETE',headers:{'Content-Type':'application/json','X-TG-ID':String(tgId)},body:JSON.stringify({id,tg_id:tgId})});}
  catch(e){console.error('Delete task',e);}
  finally{setTimeout(loadTasks,300);}
}

function renderHome(){
  const s=startOfDay(new Date()).getTime(), e=endOfDay(new Date()).getTime();
  const today=tasks.filter(t=> t.due_ts==null || (t.due_ts>=s && t.due_ts<=e))
                   .sort((a,b)=>(a.done-b.done)||((a.due_ts??0)-(b.due_ts??0)));
  const box=$('#tasks-today'); box.innerHTML=''; if(!today.length){box.innerHTML='<div class="muted">На сегодня нет задач.</div>';return;}
  today.forEach(t=>box.appendChild(rowTask(t)));
}
let planFilter='today';
function renderPlan(){
  const now=new Date(); let arr=[...tasks];
  if(planFilter==='today'){const s=startOfDay(now).getTime(), e=endOfDay(now).getTime(); arr=arr.filter(t=> t.due_ts==null || (t.due_ts>=s && t.due_ts<=e));}
  else if(planFilter==='week'){const ee=endOfDay(addDays(now,7)).getTime(); arr=arr.filter(t=> t.due_ts==null || t.due_ts<=ee);}
  else if(planFilter==='month'){const ee=endOfDay(addDays(now,30)).getTime(); arr=arr.filter(t=> t.due_ts==null || t.due_ts<=ee);}
  else if(planFilter==='team'){arr=arr.filter(t=> t.priority==='team');}
  arr.sort((a,b)=>(a.done-b.done)||((a.due_ts??1e20)-(b.due_ts??1e20)));
  const box=$('#tasks-plan'); box.innerHTML=''; if(!arr.length){box.innerHTML='<div class="muted">Нет задач для отображения.</div>';return;}
  arr.forEach(t=>box.appendChild(rowTask(t)));
}
function renderStats(){
  const total=tasks.length, done=tasks.filter(t=>t.done).length, overdue=tasks.filter(t=>!t.done && t.due_ts!=null && t.due_ts<Date.now()).length;
  const rate=total?Math.round(done*100/total):0; $('#m-total').textContent=total; $('#m-done').textContent=done; $('#m-rate').textContent=rate+'%'; $('#m-over').textContent=overdue;
  renderWeekChart();
}
function renderWeekChart(){
  const chart=$('#week-chart'); chart.innerHTML='';
  for(let i=6;i>=0;i--){
    const day=addDays(new Date(),-i), s=startOfDay(day).getTime(), e=endOfDay(day).getTime();
    const dayTasks=tasks.filter(t=> t.due_ts!=null && t.due_ts>=s && t.due_ts<=e);
    const done=dayTasks.filter(t=>t.done).length, total=dayTasks.length; const h=total? (done/total)*100 : 10;
    const bar=document.createElement('div'); bar.className='chart-bar'; bar.style.height=`${h}%`;
    const label=document.createElement('div'); label.className='chart-label'; label.textContent=day.toLocaleDateString('ru-RU',{weekday:'short'});
    bar.appendChild(label); chart.appendChild(bar);
  }
}

/* ===================== FOCUS ===================== */
async function loadFocus(){ if(!tgId) return; try{const r=await fetch(`/api/focus?tg_id=${tgId}`,{headers:{'X-TG-ID':String(tgId)}}); const j=await r.json(); if(j?.ok||j?.text) $('#focusInput').value=j.text||'';}catch{} }
async function saveFocus(){ if(!tgId) return; const text=$('#focusInput').value||''; try{await fetch('/api/focus',{method:'POST',headers:{'Content-Type':'application/json','X-TG-ID':String(tgId)},body:JSON.stringify({text,tg_id:tgId})}); showToast('Фокус сохранён');}catch{showToast('Фокус сохранён (оффлайн)')}}

/* ===================== CHATS ===================== */
let sessions=[];   // {id,title,updatedAt}
let currentChatId=null;

function normMsg(m){return {role:(m.role||m.author||'assistant'), content:(m.content||m.text||''), timestamp:m.timestamp||m.createdAt||new Date().toISOString(), chat_id: m.chat_id||m.session_id||m.chatId||null, chat_title: m.chat_title||m.title||null};}
function normSession(c){return {id:String(c.id||c.chat_id||c._id), title:c.title||c.name||'Чат', updatedAt:c.updatedAt||c.updated_at||c.createdAt||new Date().toISOString()}}

async function fetchSessions(){
  sessions=[];
  if(!tgId) return;
  // 1) пробуем /api/chats
  try{
    const r=await fetch(`/api/chats?tg_id=${tgId}`,{headers:{'X-TG-ID':String(tgId)}});
    if(r.ok){
      const j=await r.json(); const arr=pickArray(j).map(normSession);
      if(arr.length){ sessions=arr; renderChatList(); return; }
    }
  }catch{}
  // 2) собираем из /api/chat-history (группировка по chat_id)
  try{
    const r=await fetch(`/api/chat-history?tg_id=${tgId}`,{headers:{'X-TG-ID':String(tgId)}});
    const j=await r.json(); const msgs=pickArray(j).map(normMsg);
    const groups=new Map();
    for(const m of msgs){
      const id=m.chat_id || 'default';
      if(!groups.has(id)) groups.set(id, {id, title: m.chat_title || (id==='default'?'Чат':('Чат '+id.slice(-4))), updatedAt:m.timestamp});
      else groups.get(id).updatedAt=m.timestamp;
    }
    sessions=[...groups.values()].sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));
  }catch{}
  renderChatList();
}
async function createSession(title){
  // пытаемся создать серверную сессию
  try{
    const r=await fetch('/api/chats',{method:'POST',headers:{'Content-Type':'application/json','X-TG-ID':String(tgId)},body:JSON.stringify({title,tg_id:tgId})});
    const j=await r.json().catch(()=>null);
    if(j?.id) return String(j.id);
  }catch{}
  // если эндпойнта нет — создаём клиентский chat_id, сервер начнёт его видеть когда начнутся сообщения с этим chat_id
  return 'c_'+Date.now();
}
async function deleteSession(id){
  try{
    await fetch('/api/chats',{method:'DELETE',headers:{'Content-Type':'application/json','X-TG-ID':String(tgId)},body:JSON.stringify({id,tg_id:tgId})});
  }catch{}
  sessions=sessions.filter(s=>s.id!==id); renderChatList();
}

function renderChatList(){
  const box=$('#chat-list'); box.innerHTML='';
  sessions.forEach((c,i)=>{
    const el=document.createElement('div');
    el.className='chat-item'; el.style.animationDelay=`${i*0.06}s`;
    el.innerHTML=`
      <button class="chat-delete" onclick="event.stopPropagation(); deleteSession('${c.id}')">×</button>
      <div class="chat-icon">💬</div>
      <div class="chat-title">${c.title}</div>
      <div class="chat-date">${new Date(c.updatedAt||Date.now()).toLocaleDateString('ru-RU')}</div>`;
    el.onclick=()=>openChat(c.id, c.title);
    box.appendChild(el);
  });
  const newEl=document.createElement('div'); newEl.className='chat-item new';
  newEl.innerHTML=`<div class="chat-icon">+</div><div class="chat-title">Новый чат</div>`;
  newEl.onclick=()=>$('#new-chat-modal').classList.add('active');
  box.appendChild(newEl);
  $('#no-chats-message').style.display = sessions.length? 'none':'block';
}

async function loadChatMessages(id){
  try{
    // если сервер поддерживает chat_id
    const r=await fetch(`/api/chat-history?tg_id=${tgId}&chat_id=${encodeURIComponent(id)}`,{headers:{'X-TG-ID':String(tgId)}});
    if(r.ok){ const j=await r.json(); return pickArray(j).map(normMsg); }
  }catch{}
  // иначе фильтруем всю историю по chat_id (если сервер её возвращает), иначе покажем общий поток
  try{
    const r=await fetch(`/api/chat-history?tg_id=${tgId}`,{headers:{'X-TG-ID':String(tgId)}});
    const j=await r.json(); const all=pickArray(j).map(normMsg);
    const filtered=all.filter(m=> (m.chat_id||'default')===id);
    return filtered.length? filtered : all;
  }catch{return []}
}
function renderMessages(messages){
  const box=$('#chatLog'); box.innerHTML='';
  (messages||[]).forEach((m,i)=>{const b=document.createElement('div'); b.className=`msg ${m.role||'assistant'}`; b.textContent=m.content||''; b.style.animationDelay=`${i*0.03}s`; box.appendChild(b);});
  box.scrollTop=box.scrollHeight;
}

async function openChat(id,title){
  currentChatId=id; $('#current-chat-title').textContent=title||'Чат';
  $('#bottom-nav').classList.add('hidden'); $('#chat-fullscreen').classList.add('active');
  const msgs=await loadChatMessages(id); renderMessages(msgs);
}
function closeChat(){const fs=$('#chat-fullscreen'); fs.classList.add('slide-out'); setTimeout(()=>{fs.classList.remove('active','slide-out'); $('#bottom-nav').classList.remove('hidden'); $('#chatLog').innerHTML=''; currentChatId=null;},300);}

async function sendMessage(){
  const inp=$('#msg'); const text=inp?.value?.trim(); if(!text || !currentChatId) return; inp.value='';
  renderMessages([...(Array.from($('#chatLog').children).map(n=>({role:n.classList.contains('user')?'user':'assistant',content:n.textContent}))), {role:'user',content:text}]);
  try{
    await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json','X-TG-ID':String(tgId)},
      body:JSON.stringify({message:text,tg_id:tgId,chat_id:currentChatId})});
  }catch{}
  setTimeout(async()=>{ const msgs=await loadChatMessages(currentChatId); renderMessages(msgs); await fetchSessions(); },500);
}

/* ===================== NAV / INIT ===================== */
const screens={home:$('#screen-home'),plan:$('#screen-plan'),chat:$('#screen-chat'),stats:$('#screen-stats'),profile:$('#screen-profile')};
$$('.nav .item').forEach(it=>{it.onclick=()=>{$$('.nav .item').forEach(x=>x.classList.remove('active')); it.classList.add('active'); const to=it.dataset.go; Object.values(screens).forEach(s=>s.classList.remove('active')); screens[to].classList.add('active'); if(to==='chat'){fetchSessions();}};});

function initUI(){
  $$('.seg .chip[data-prio]').forEach(ch=>{ch.onclick=()=>{$$('.seg .chip[data-prio]').forEach(x=>x.classList.remove('active')); ch.classList.add('active');};});
  $('#f-today').onclick=()=>{planFilter='today';renderPlan();}; $('#f-week').onclick=()=>{planFilter='week';renderPlan();}; $('#f-month').onclick=()=>{planFilter='month';renderPlan();}; $('#f-team').onclick=()=>{planFilter='team';renderPlan();};
  $('#close-chat').onclick=closeChat;
  $('#confirm-new-chat').onclick=async ()=>{const title=$('#new-chat-title').value.trim()||'Новый чат'; $('#new-chat-modal').classList.remove('active'); $('#new-chat-title').value=''; const id=await createSession(title); sessions=[{id,title,updatedAt:new Date().toISOString()},...sessions]; renderChatList(); openChat(id,title);};
  $('#cancel-new-chat').onclick=()=>$('#new-chat-modal').classList.remove('active');
  $('#send').onclick=sendMessage; $('#msg').addEventListener('keydown',e=> e.key==='Enter'?sendMessage():null);
  $('#addTask').onclick=addTask; $('#saveFocus').onclick=saveFocus;
}

async function boot(){
  tgId=readTgId(); updateProfile();
  initUI();
  await Promise.all([ping(), loadFocus(), loadTasks(), fetchSessions()]);
  setInterval(loadFocus,10000);
  setInterval(loadTasks,15000);
  setInterval(fetchSessions,12000);
}
boot();
</script>
</body>
</html>
