<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Growth Assistant — MVP</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --ink:#0e1220; --muted:#6b7280; --brand:#4f46e5;
      --brand-2:#6366f1; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --line:#e5e7eb;
      --radius:18px; --shadow:0 10px 24px rgba(17,24,39,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:14px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:var(--brand);text-decoration:none}
    .app{max-width:820px;margin:0 auto;padding:18px 14px 100px}
    header{
      position:sticky;top:0;z-index:5;margin:-18px -14px 18px;padding:20px 16px;background:linear-gradient(180deg,#eef0ff,rgba(238,240,255,.6));
      border-bottom:1px solid var(--line)
    }
    h1{margin:0;font-weight:800;letter-spacing:.2px}
    .tabs{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .tab.active{background:var(--brand);border-color:var(--brand);color:#fff;box-shadow:0 4px 16px rgba(79,70,229,.25)}
    .grid{display:grid;gap:14px}
    @media(min-width:860px){ .grid-2{grid-template-columns:1.2fr .8fr} }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:16px
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=text],input[type=datetime-local]{
      width:100%; padding:12px 12px; border:1px solid var(--line); border-radius:12px; outline:none; background:#fff;
    }
    input[type=text]:focus, input[type=datetime-local]:focus{border-color:var(--brand)}
    .btn{
      appearance:none; border:none; background:var(--brand); color:#fff; padding:12px 14px; border-radius:12px; cursor:pointer;
      box-shadow:0 8px 22px rgba(99,102,241,.25); font-weight:600
    }
    .btn.secondary{background:#fff;color:var(--ink);border:1px solid var(--line);box-shadow:none}
    .btn.ghost{background:rgba(79,70,229,.08);color:var(--brand);box-shadow:none}
    .btn.icon{padding:8px 10px;border-radius:10px}
    .seg{display:flex;gap:8px}
    .seg .btn{background:#fff;color:var(--ink);border:1px solid var(--line);box-shadow:none}
    .seg .btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .list{display:flex;flex-direction:column;gap:10px}
    .task{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}
    .task.done{opacity:.7}
    .task .ttl{flex:1}
    .chip{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted)}
    .chip.ok{color:#065f46;border-color:#10b981;background:#ecfdf5}
    .chip.due{color:#7c2d12;border-color:#f59e0b;background:#fffbeb}
    .chip.dead{color:#991b1b;border-color:#ef4444;background:#fef2f2}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:6px;color:var(--muted);font-size:12px}
    .day{background:#fff;border:1px solid var(--line);padding:10px;border-radius:10px;min-height:68px;position:relative}
    .day .n{font-weight:700}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--brand);position:absolute;right:8px;bottom:8px}
    .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 20px rgba(0,0,0,.2);z-index:999}
    /* Chat */
    .chat{display:flex;flex-direction:column;height:380px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
    .chat-body{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
    .bubble{max-width:80%;padding:10px 12px;border-radius:14px}
    .me{align-self:flex-end;background:var(--brand);color:#fff;border-bottom-right-radius:4px}
    .bot{align-self:flex-start;background:#f3f4f6;border:1px solid var(--line);border-bottom-left-radius:4px}
    .chat-foot{display:flex;gap:8px;padding:8px;border-top:1px solid var(--line);background:#fff}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body>
  <header>
    <h1>Growth Assistant</h1>
    <div class="tabs">
      <button class="tab active" data-tab="home">Главная</button>
      <button class="tab" data-tab="plan">План</button>
      <button class="tab" data-tab="calendar">Календарь</button>
      <button class="tab" data-tab="profile">HADI + Профиль</button>
    </div>
  </header>

  <div class="app">
    <!-- HOME -->
    <section id="tab-home" class="grid grid-2">
      <div class="card">
        <h3 style="margin:0 0 12px">Фокус дня</h3>
        <div class="row">
          <div style="flex:1">
            <label>Самое главное сегодня</label>
            <input id="focus-input" type="text" placeholder="Например: закрыть отчёт" />
          </div>
          <button id="focus-save" class="btn">Сохранить</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 12px">Быстрое добавление</h3>
        <div class="row">
          <div style="flex:1">
            <label>Название задачи</label>
            <input id="quick-title" type="text" placeholder="Что сделать?" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <label style="margin:0">Период</label>
          <div class="seg">
            <button class="btn" data-prio="today">Сегодня</button>
            <button class="btn" data-prio="week">Неделя</button>
            <button class="btn" data-prio="backlog">Бэклог</button>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <label>Дедлайн (необязательно)</label>
            <input id="quick-due" type="datetime-local">
          </div>
          <button id="quick-add" class="btn">Добавить</button>
        </div>
      </div>

      <div class="card" style="grid-column:1/-1">
        <h3 style="margin:0 0 8px">Задачи на сегодня</h3>
        <div id="tasks-today" class="list"></div>
      </div>
    </section>

    <!-- PLAN -->
    <section id="tab-plan" class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">План (неделя + бэклог)</h3>
          <span class="muted mono" id="counts-plan"></span>
        </div>
        <div class="row" style="margin:6px 0 12px">
          <div class="seg">
            <button class="btn active" id="f-week">Неделя</button>
            <button class="btn" id="f-backlog">Бэклог</button>
            <button class="btn" id="f-all">Все</button>
          </div>
        </div>
        <div id="tasks-plan" class="list"></div>
      </div>
    </section>

    <!-- CALENDAR -->
    <section id="tab-calendar" class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">Календарь</h3>
          <div class="row">
            <button class="btn ghost icon" id="m-prev">‹</button>
            <button class="btn ghost icon" id="m-next">›</button>
          </div>
        </div>
        <div id="cal-head" class="cal-head" style="margin-top:10px"></div>
        <div id="calendar" class="calendar"></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px">Задачи выбранного дня</h3>
        <div id="tasks-day" class="list"></div>
      </div>
    </section>

    <!-- PROFILE + HADI -->
    <section id="tab-profile" class="grid grid-2">
      <div class="card">
        <h3 style="margin:0 0 10px">HADI — метрики (минимум)</h3>
        <div class="row" style="gap:12px;flex-wrap:wrap">
          <div class="card" style="flex:1;min-width:190px">
            <label>Всего задач</label>
            <div id="m-total" style="font-size:22px;font-weight:800">0</div>
          </div>
          <div class="card" style="flex:1;min-width:190px">
            <label>Выполнено</label>
            <div id="m-done" style="font-size:22px;font-weight:800;color:var(--ok)">0</div>
          </div>
          <div class="card" style="flex:1;min-width:190px">
            <label>Успех (Done/All)</label>
            <div id="m-rate" style="font-size:22px;font-weight:800">0%</div>
          </div>
          <div class="card" style="flex:1;min-width:190px">
            <label>Просрочено</label>
            <div id="m-over" style="font-size:22px;font-weight:800;color:var(--danger)">0</div>
          </div>
        </div>
        <p class="muted" style="margin-top:10px">
          <b>H</b>ypothesis: «Если я буду фиксировать задачи и ставить дедлайны, я завершу ≥70% вовремя».<br/>
          <b>A</b>ction: добавляй задачи, закрывай их вовремя.<br/>
          <b>D</b>ata: метрики сверху — считаются из твоих задач.<br/>
          <b>I</b>nsight: удерживай зелёный показатель ≥70% — значит гипотеза подтверждается.
        </p>
      </div>

      <div class="card">
        <h3 style="margin:0 0 10px">Чат с ассистентом</h3>
        <div class="chat">
          <div id="chat-body" class="chat-body">
            <div class="bubble bot">Привет! Опиши задачу — помогу разбить и запланировать.</div>
          </div>
          <div class="chat-foot">
            <input id="chat-input" type="text" placeholder="Спросите про план, HADI или задачу…" style="flex:1;padding:10px;border:1px solid var(--line);border-radius:10px"/>
            <button id="chat-send" class="btn">Отправить</button>
          </div>
        </div>
        <div class="muted" style="margin-top:8px">
          Если сервер чата не настроен, покажу подсказку вместо ответа.
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

<script>
/* -------------------- helpers -------------------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmtDate = ts => new Date(ts).toLocaleString('ru-RU', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' });
const startOfDay = d => { const x = new Date(d); x.setHours(0,0,0,0); return x; }
const endOfDay   = d => { const x = new Date(d); x.setHours(23,59,59,999); return x; }
const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; }
const showToast = (t) => { const el = $('#toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',2000); }

let tgId = 0;
try{
  const qtg = new URLSearchParams(location.search).get('tg_id');
  if (qtg) tgId = Number(qtg);
  if (!tgId && window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
    tgId = Number(window.Telegram.WebApp.initDataUnsafe.user.id);
  }
}catch{}

/* -------------------- API -------------------- */
const HEADERS = () => tgId ? { 'Content-Type':'application/json', 'X-TG-ID': String(tgId) } : { 'Content-Type':'application/json' };

async function api(path, method='GET', body=null) {
  const opt = { method, headers: HEADERS() };
  if (body) opt.body = JSON.stringify(body);
  const r = await fetch(path, opt);
  const ct = r.headers.get('content-type')||'';
  if (!ct.includes('application/json')) throw new Error('Сервер вернул не JSON');
  const data = await r.json();
  if (!r.ok || data.ok===false) throw new Error(data.error||('HTTP '+r.status));
  return data;
}

/* -------------------- state -------------------- */
let tasks = []; // все задачи
let focus = null;
let currentMonth = new Date();

/* -------------------- init -------------------- */
const TABS = $$('.tab');
const SECTIONS = [$('#tab-home'), $('#tab-plan'), $('#tab-calendar'), $('#tab-profile')];
TABS.forEach(b=>{
  b.onclick = () => {
    TABS.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const id = b.dataset.tab;
    SECTIONS.forEach(s=>s.style.display='none');
    $('#tab-'+id).style.display='grid';
    if (id==='calendar') renderCalendar();
  };
});

async function loadAll() {
  try {
    await api('/api/health');
  } catch(e) {
    console.warn(e);
  }
  // focus
  try {
    const f = await api('/api/focus');
    focus = f.focus||null;
    $('#focus-input').value = focus?.text || '';
  } catch(e) { console.warn(e); }
  // tasks
  try {
    const t = await api('/api/tasks');
    tasks = t.items||[];
    renderHome();
    renderPlan('week');
    renderHADI();
    renderCalendar();
  } catch(e) {
    console.error(e);
    showToast('Не удалось загрузить задачи');
  }
}

/* -------------------- focus -------------------- */
$('#focus-save').onclick = async () => {
  const text = $('#focus-input').value.trim();
  if (!text) return showToast('Пустой фокус');
  try{
    const r = await api('/api/focus','POST',{ text });
    focus = r.focus;
    showToast('Фокус сохранён');
  }catch(e){ showToast('Ошибка сервера (focus)'); }
};

/* -------------------- quick add -------------------- */
let quickPrio='today';
$$('.seg .btn').forEach(b=>{
  if (b.dataset.prio) {
    b.onclick = ()=>{
      $$('.seg .btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); quickPrio=b.dataset.prio;
    };
    if (b.dataset.prio==='today') b.classList.add('active');
  }
});

$('#quick-add').onclick = async ()=>{
  const title = $('#quick-title').value.trim();
  const dueStr = $('#quick-due').value;
  if (!title) return showToast('Введите название');
  let due_ts = null;
  if (dueStr) {
    const ms = Date.parse(dueStr);
    if (!isNaN(ms)) due_ts = ms;
  } else {
    if (quickPrio==='today') due_ts = endOfDay(new Date()).getTime();
    else if (quickPrio==='week') due_ts = endOfDay(addDays(new Date(), 7)).getTime();
    else due_ts = null; // backlog
  }
  try{
    const r = await api('/api/tasks','POST',{ title, due_ts });
    tasks.unshift(r.task);
    $('#quick-title').value=''; $('#quick-due').value='';
    renderHome(); renderPlan(); renderHADI(); renderCalendar();
    showToast('Задача добавлена');
  }catch(e){ console.error(e); showToast('Ошибка сервера (tasks)'); }
};

/* -------------------- render: home -------------------- */
function renderHome(){
  const todayStart = startOfDay(new Date()).getTime();
  const todayEnd = endOfDay(new Date()).getTime();
  const today = tasks.filter(t=>{
    if (t.due_ts==null) return false;
    return t.due_ts>=todayStart && t.due_ts<=todayEnd;
  }).sort((a,b)=>(a.is_done-b.is_done)||(a.due_ts||0)-(b.due_ts||0));

  const box = $('#tasks-today'); box.innerHTML='';
  if (!today.length){ box.innerHTML='<div class="muted">На сегодня нет задач.</div>'; return; }
  today.forEach(t => box.appendChild(taskRow(t)));
}

/* -------------------- render: plan -------------------- */
let planFilter='week';
$('#f-week').onclick=()=>{planFilter='week'; updPlanBtns(); renderPlan();};
$('#f-backlog').onclick=()=>{planFilter='backlog'; updPlanBtns(); renderPlan();};
$('#f-all').onclick=()=>{planFilter='all'; updPlanBtns(); renderPlan();};
function updPlanBtns(){
  $('#f-week').classList.toggle('active', planFilter==='week');
  $('#f-backlog').classList.toggle('active', planFilter==='backlog');
  $('#f-all').classList.toggle('active', planFilter==='all');
}

function renderPlan(){
  const now = new Date();
  const weekEnd = endOfDay(addDays(now,7)).getTime();
  let filtered = tasks.slice();
  if (planFilter==='week') filtered = filtered.filter(t => (t.due_ts!=null && t.due_ts<=weekEnd));
  if (planFilter==='backlog') filtered = filtered.filter(t => (t.due_ts==null));
  const box = $('#tasks-plan'); box.innerHTML='';
  $('#counts-plan').textContent = `всего: ${filtered.length}`;
  if (!filtered.length){ box.innerHTML = '<div class="muted">Пусто.</div>'; return; }
  filtered.sort((a,b)=>(a.is_done-b.is_done)||((a.due_ts||1e20)-(b.due_ts||1e20)));
  filtered.forEach(t => box.appendChild(taskRow(t)));
}

/* -------------------- render: calendar -------------------- */
function monthMeta(d){
  const y=d.getFullYear(), m=d.getMonth();
  const first=new Date(y,m,1); const last=new Date(y,m+1,0);
  return { first, last, days:last.getDate() };
}
function renderCalendar(){
  const head = $('#cal-head'); head.innerHTML='';
  'Пн Вт Ср Чт Пт Сб Вс'.split(' ').forEach(n=>{const s=document.createElement('div'); s.textContent=n; head.appendChild(s);});
  const wrap = $('#calendar'); wrap.innerHTML='';
  const { first, days } = monthMeta(currentMonth);
  const startOffset = (first.getDay()+6)%7; // make Monday start
  for(let i=0;i<startOffset;i++){ const d=document.createElement('div'); wrap.appendChild(d); }

  const start = new Date(first);
  for(let day=1; day<=days; day++){
    const cell = document.createElement('div'); cell.className='day';
    const dt = new Date(first.getFullYear(), first.getMonth(), day);
    cell.innerHTML = `<div class="n">${day}</div>`;
    // count tasks by day
    const st = startOfDay(dt).getTime(), en=endOfDay(dt).getTime();
    const cnt = tasks.filter(t=> t.due_ts!=null && t.due_ts>=st && t.due_ts<=en).length;
    if (cnt>0){
      const dot=document.createElement('div'); dot.className='dot'; cell.appendChild(dot);
      const chip=document.createElement('div'); chip.className='chip'; chip.style.position='absolute';chip.style.left='8px';chip.style.bottom='6px';chip.textContent=cnt; cell.appendChild(chip);
    }
    cell.onclick = ()=> renderTasksDay(dt);
    wrap.appendChild(cell);
  }
  renderTasksDay(new Date());
}
$('#m-prev').onclick=()=>{ currentMonth = addDays(new Date(currentMonth), -15); currentMonth.setDate(1); renderCalendar(); }
$('#m-next').onclick=()=>{ currentMonth = addDays(new Date(currentMonth), 40); currentMonth.setDate(1); renderCalendar(); }

function renderTasksDay(dt){
  const st = startOfDay(dt).getTime(), en=endOfDay(dt).getTime();
  const day = tasks.filter(t => t.due_ts!=null && t.due_ts>=st && t.due_ts<=en).sort((a,b)=>(a.is_done-b.is_done)||(a.due_ts-b.due_ts));
  const box = $('#tasks-day'); box.innerHTML='';
  if (!day.length){ box.innerHTML='<div class="muted">На выбранный день задач нет.</div>'; return; }
  day.forEach(t => box.appendChild(taskRow(t)));
}

/* -------------------- HADI metrics -------------------- */
function renderHADI(){
  const total = tasks.length;
  const done = tasks.filter(t=>t.is_done).length;
  const overdue = tasks.filter(t => !t.is_done && t.due_ts!=null && t.due_ts < Date.now()).length;
  const rate = total ? Math.round(done*100/total) : 0;
  $('#m-total').textContent = total;
  $('#m-done').textContent  = done;
  $('#m-rate').textContent  = rate + '%';
  $('#m-over').textContent  = overdue;
}

/* -------------------- task row -------------------- */
function taskRow(t){
  const el = document.createElement('div'); el.className='task'+(t.is_done?' done':'');
  const chk = document.createElement('button'); chk.className='btn icon'; chk.textContent = t.is_done?'✓':'○';
  chk.onclick = async ()=>{
    try{
      await api('/api/tasks/toggle?id='+t.id,'POST',{});
      t.is_done = !t.is_done;
      renderHome(); renderPlan(); renderHADI(); renderCalendar();
    }catch(e){ showToast('Ошибка (toggle): 404/сервер'); }
  };
  const ttl = document.createElement('div'); ttl.className='ttl'; ttl.textContent = t.title;
  const tags = document.createElement('div'); tags.className='row';
  let chip = null;
  if (t.due_ts!=null){
    const past = t.due_ts < Date.now();
    chip = document.createElement('div'); chip.className='chip '+(past? (t.is_done?'ok':'dead') : 'due');
    chip.textContent = (t.is_done?'сделано • ':'до ') + fmtDate(t.due_ts);
  } else {
    chip = document.createElement('div'); chip.className='chip'; chip.textContent='бэклог';
  }
  tags.appendChild(chip);
  const del = document.createElement('button'); del.className='btn secondary icon'; del.textContent='✕';
  del.onclick = async ()=>{
    if (!confirm('Удалить задачу?')) return;
    try{
      await api('/api/tasks/delete?id='+t.id,'POST',{});
      tasks = tasks.filter(x=>x.id!==t.id);
      renderHome(); renderPlan(); renderHADI(); renderCalendar();
    }catch(e){ showToast('Ошибка (delete): 404/сервер'); }
  };
  el.append(chk, ttl, tags, del);
  return el;
}

/* -------------------- chat -------------------- */
function pushChat(text, me=false){
  const b = document.createElement('div');
  b.className = 'bubble ' + (me?'me':'bot');
  b.textContent = text;
  $('#chat-body').appendChild(b);
  $('#chat-body').scrollTop = 1e9;
}
$('#chat-send').onclick = async ()=>{
  const text = $('#chat-input').value.trim();
  if (!text) return;
  $('#chat-input').value='';
  pushChat(text,true);
  try{
    const r = await api('/api/chat','POST',{ text });
    pushChat(r.reply || 'Ок!');
  }catch(e){
    pushChat('Пока нет соединения с ассистентом. Подсказка: формулируй задачу как «Сделать X до 21:00, шаги: 1)…».');
  }
};
$('#chat-input').addEventListener('keydown',e=>{ if (e.key==='Enter') $('#chat-send').click(); });

/* -------------------- boot -------------------- */
SECTIONS.forEach((s,i)=> s.style.display = i? 'none':'grid');
loadAll();
</script>
</body>
</html>
