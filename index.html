<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Business Assistance</title>
<style>
  :root{
    --bg: #f5f8ff;
    --ink:#0e1b2b;
    --muted:#6a7890;
    --brand:#2c7dfa;
    --brand-2:#57a5ff;
    --card:#ffffffea;
    --card-br:#e9eef7;
    --ring: rgba(44,125,250,.35);
    --shadow: 0 10px 28px rgba(28,73,170,.14);
    --r-xl: 22px; --r:16px;
    --grad-hero: radial-gradient(1000px 600px at 100% -200px,#e9f2ff 0,transparent 60%),
                 radial-gradient(800px 520px at -120px 80%,#edfff6 0,transparent 60%),
                 linear-gradient(180deg,#fbfdff 0,#f0f5ff 100%);
    --grad-btn: linear-gradient(180deg,var(--brand-2) 0%, var(--brand) 100%);
    --pill: linear-gradient(180deg,#f7fbff 0,#ffffff 100%);
    --progress-bg:#e1efff; --progress:#38a3ff;
  }
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font: 15px/1.36 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
    background: var(--grad-hero);
  }

  /* layout */
  .app{max-width: 920px; margin:0 auto; padding: 18px 14px 150px;}

  /* header */
  .top{display:flex;align-items:center;gap:12px;margin:6px 4px 12px}
  .logo{width:46px;height:46px;border-radius:14px;background:linear-gradient(180deg,#eaf4ff,#fff);
        display:grid;place-items:center;border:1px solid var(--card-br);box-shadow:var(--shadow)}
  .brand{display:flex;flex-direction:column}
  .brand h1{margin:0;font-weight:900;letter-spacing:.2px;font-size:22px;line-height:1.05}
  .bell{margin-left:auto;width:38px;height:38px;border-radius:12px;background:linear-gradient(180deg,#eef6ff,#fff);
        border:1px solid var(--card-br);display:grid;place-items:center;position:relative}
  .bell::after{content:'';position:absolute;right:6px;top:6px;width:8px;height:8px;background:#ff5b5b;border-radius:50%;box-shadow:0 0 0 2px #fff}

  /* typography & cards */
  h2{font-size:22px;font-weight:900;letter-spacing:.2px;margin:18px 6px 10px;color:#0f213c}
  .card{background:var(--card);border:1px solid var(--card-br);
        backdrop-filter:saturate(180%) blur(8px);-webkit-backdrop-filter:saturate(180%) blur(8px);
        border-radius:var(--r-xl);box-shadow:var(--shadow);padding:16px;margin:10px 4px}
  .row{display:flex;gap:10px;align-items:center}

  /* inputs/buttons */
  .input{flex:1;border:1px solid #e6eefb;background:#f8fbff;border-radius:14px;padding:12px 14px;outline:none}
  .input:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
  .btn{border:0;border-radius:14px;background:var(--grad-btn);color:#fff;
       padding:12px 16px;font-weight:900;box-shadow:0 12px 26px rgba(44,125,250,.35);cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* focus */
  .focus-box{margin-top:10px;border:1px solid var(--card-br);border-radius:18px;padding:14px;background:linear-gradient(180deg,#f5fbff,#ffffff)}
  .focus-title{font-weight:900;font-size:17px;margin-bottom:8px}
  .focus-meta{color:var(--muted);font-size:14px;margin-bottom:12px}
  .progress{height:10px;border-radius:999px;background:var(--progress-bg);position:relative;overflow:hidden}
  .progress>span{position:absolute;left:0;top:0;bottom:0;background:var(--progress);width:45%;border-radius:999px;transition:width .25s}

  /* chips */
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .chip{padding:8px 12px;border-radius:999px;background:var(--pill);border:1px solid var(--card-br);
        color:#2e7efc;font-weight:800;cursor:pointer}
  .chip.active{background:#eaf3ff;border-color:#cfe4ff}

  /* grid */
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

  /* tasks */
  .task{display:flex;gap:12px;align-items:flex-start;background:var(--card);border:1px solid var(--card-br);
        border-radius:18px;padding:14px;box-shadow:var(--shadow);margin:10px 0}
  .task-ic{width:42px;height:42px;border-radius:14px;background:var(--pill);border:1px solid var(--card-br);
           display:grid;place-items:center;color:#2e7efc;font-size:18px;font-weight:800}
  .task-mid{flex:1}
  .task-title{font-weight:900;font-size:17px;margin:2px 0 6px}
  .task-sub{color:var(--muted)}
  .task-ok{min-width:28px;height:28px;border-radius:10px;border:1px solid var(--card-br);
           display:grid;place-items:center;background:#fff;color:#2c7dfa;cursor:pointer}

  .link-more{text-align:center;margin:6px 0 2px;color:#2c7dfa;font-weight:800;cursor:pointer}

  /* chat button (sticky above nav) */
  .chatbar{position:sticky;bottom:108px;margin:12px 4px -4px;display:flex;justify-content:center;z-index:40}
  .chatbtn{width:100%;max-width:920px;border-radius:20px;border:1px solid #9fd0ff66;background:var(--grad-btn);
           color:#fff;font-weight:900;font-size:17px;padding:16px 18px;box-shadow:0 16px 36px rgba(44,125,250,.35)}

  /* bottom nav */
  .nav{position:fixed;left:0;right:0;bottom:0;z-index:50;
       padding:10px env(safe-area-inset-left) calc(12px + env(safe-area-inset-bottom)) env(safe-area-inset-right);
       background:rgba(255,255,255,.9);border-top:1px solid var(--card-br);box-shadow:0 -10px 30px rgba(28,73,170,.12);
       display:flex;justify-content:space-around;gap:8px}
  .tab{display:flex;flex-direction:column;align-items:center;gap:6px;color:#6a7890;min-width:72px}
  .tab .ic{width:28px;height:28px;border-radius:12px;background:#f3f6ff;border:1px solid #e6eefb;display:grid;place-items:center}
  .tab.active{color:#2c7dfa}.tab.active .ic{background:#e9f2ff;border-color:#cfe4ff;color:#2c7dfa}

  /* toast */
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:#111827;color:#fff;
         padding:10px 14px;border-radius:12px;z-index:9999;max-width:92vw;box-shadow:var(--shadow)}

  /* screens */
  .screen{display:none;animation:fade .18s ease}
  .screen.active{display:block}
  @keyframes fade{from{opacity:.6;transform:translateY(4px)}to{opacity:1;transform:none}}
</style>
</head>
<body>
  <div class="app">

    <!-- header -->
    <div class="top">
      <div class="logo">üòä</div>
      <div class="brand"><h1>Business<br/>Assistance</h1></div>
      <div class="bell">üîî</div>
    </div>

    <!-- ==== Screens ==== -->

    <!-- TODAY -->
    <section id="screen-today" class="screen active">
      <h2>–§–æ–∫—É—Å –¥–Ω—è</h2>
      <div class="card">
        <div class="row" style="margin-bottom:12px">
          <input id="focusInput" class="input" placeholder="–°–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ —Å–µ–≥–æ–¥–Ω—è‚Ä¶" />
          <button id="focusSave" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div id="focusGlass" class="focus-box" style="display:none">
          <div id="focusMain" class="focus-title">‚Ä¶</div>
          <div id="focusMeta" class="focus-meta">–°—Ä–æ–∫ –¥–æ 18:00</div>
          <div class="progress"><span id="focusProgress" style="width:45%"></span></div>
        </div>
      </div>

      <h2>–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</h2>
      <div class="card">
        <input id="taskTitle" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" />
        <div id="chipGroup" class="chips">
          <div class="chip active" data-list="today">–°–µ–≥–æ–¥–Ω—è</div>
          <div class="chip" data-list="week">–ù–µ–¥–µ–ª—è</div>
          <div class="chip" data-list="backlog">–ë—ç–∫–ª–æ–≥</div>
        </div>
        <div class="grid2">
          <input id="taskDate" class="input" type="date" />
          <input id="taskTime" class="input" type="time" />
        </div>
        <div class="row" style="margin-top:12px">
          <div style="flex:1"></div>
          <button id="taskAdd" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <h2>–ó–∞–¥–∞—á–∏</h2>
      <div class="card">
        <div id="tasks"></div>
        <div id="showAll" class="link-more">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë</div>
      </div>

      <!-- chat button sits ABOVE bottom-nav, never overlaps it -->
      <div class="chatbar">
        <button id="openChat" class="chatbtn">–ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º  üéôÔ∏è</button>
      </div>
    </section>

    <!-- PLAN -->
    <section id="screen-plan" class="screen">
      <h2>–ü–ª–∞–Ω</h2>
      <div class="card">
        –ì–æ—Ç–æ–≤–æ –∫ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—é: –∑–¥–µ—Å—å –±—É–¥–µ—Ç –Ω–µ–¥–µ–ª—å–Ω—ã–π/–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞–Ω, —Å–≤–æ–¥–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ HADI-–±–ª–æ–∫–∏.
      </div>
    </section>

    <!-- CALENDAR -->
    <section id="screen-calendar" class="screen">
      <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
      <div class="card">
        –ú–∏–Ω–∏-–∫–∞–ª–µ–Ω–¥–∞—Ä—å –∏ —Å–æ–±—ã—Ç–∏—è (–ø–æ–∑–∂–µ –ø–æ–¥–∫–∏–Ω–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ –∑–∞–¥–∞—á).
      </div>
    </section>

    <!-- PROFILE -->
    <section id="screen-profile" class="screen">
      <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
      <div class="card">
        –ò–º—è, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–æ–∫—É—Å–∞ –¥–Ω—è, –±—ã—Å—Ç—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –≤—ã—Ö–æ–¥.
      </div>
    </section>

  </div>

  <!-- bottom nav -->
  <nav class="nav" id="nav">
    <div class="tab active" data-target="today"><div class="ic">üè†</div><div>–ì–ª–∞–≤–Ω–∞—è</div></div>
    <div class="tab" data-target="plan"><div class="ic">üóìÔ∏è</div><div>–ü–ª–∞–Ω</div></div>
    <div class="tab" data-target="calendar"><div class="ic">üìÖ</div><div>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div></div>
    <div class="tab" data-target="profile"><div class="ic">üë§</div><div>–ü—Ä–æ—Ñ–∏–ª—å</div></div>
  </nav>

  <!-- chat modal -->
  <div id="chatModal" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,.45);backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px);z-index:60;align-items:flex-end">
    <div style="background:#fff;border-radius:18px 18px 0 0;box-shadow:0 -10px 30px rgba(0,0,0,.18);width:100%;max-height:80vh;overflow:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #eef0f6">
        <strong>–ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</strong>
        <button id="closeChat" class="btn" style="padding:8px 12px">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="msgs" style="display:flex;flex-direction:column;gap:8px;padding:10px 12px"></div>
      <div style="display:flex;gap:8px;padding:12px;border-top:1px solid #eef0f6;position:sticky;bottom:0;background:#fff">
        <input id="chatInput" class="input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–æ –ø–ª–∞–Ω, HADI –∏–ª–∏ –∑–∞–¥–∞—á–∏‚Ä¶" />
        <button id="sendMsg" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- TG SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    /* ===== CONFIG ===== */
    const PROD_ORIGIN = 'https://maks-mini-apps.vercel.app';
    const ORIGIN = (PROD_ORIGIN && PROD_ORIGIN.trim()) ? PROD_ORIGIN.trim().replace(/\/+$/,'') : window.location.origin;

    /* ===== TG ===== */
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if(tg){ try{ tg.ready(); tg.expand(); }catch(e){} }
    window.__TG_INIT_DATA__ = tg && tg.initData ? tg.initData : '';

    /* ===== TOAST ===== */
    let toastEl=null;
    function toast(text){ if(toastEl) toastEl.remove(); toastEl=document.createElement('div'); toastEl.className='toast'; toastEl.textContent=text; document.body.appendChild(toastEl); setTimeout(()=>toastEl&&toastEl.remove(),3000); }

    /* ===== FETCH w/ auth, timeout, retry ===== */
    async function explain(url,res){ let t=''; try{ t = await res.clone().text() }catch{} toast(`API: ${res.status} ${res.statusText}`) }
    async function authFetch(route,opts,timeout=20000){
      const url = `${ORIGIN}${route.startsWith('/')?route:`/${route}`}`;
      async function once(){
        const ctrl=new AbortController(); const timer=setTimeout(()=>ctrl.abort('timeout'),timeout);
        try{
          const res = await fetch(url,{...(opts||{}),headers:{...(opts?.headers||{}),'x-telegram-init':window.__TG_INIT_DATA__||''},signal:ctrl.signal});
          clearTimeout(timer); if(!res.ok) await explain(url,res); return res;
        }catch(e){ clearTimeout(timer); throw e; }
      }
      try{
        const r=await once(); if(r.ok) return r;
        if(r.status>=500){ await new Promise(r=>setTimeout(r,600)); return await once(); }
        return r;
      }catch(e){ toast('API: network error'); throw e; }
    }

    /* ===== NAVIGATION ===== */
    const screens = {
      today:   document.getElementById('screen-today'),
      plan:    document.getElementById('screen-plan'),
      calendar:document.getElementById('screen-calendar'),
      profile: document.getElementById('screen-profile'),
    };
    const tabs = Array.from(document.querySelectorAll('.nav .tab'));
    function openScreen(name){
      Object.entries(screens).forEach(([k,el])=>el.classList.toggle('active', k===name));
      tabs.forEach(t=>t.classList.toggle('active', t.dataset.target===name));
      // –ø–æ–¥–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ –Ω–∞ ¬´–°–µ–≥–æ–¥–Ω—è¬ª
      if(name==='today'){ loadFocus(); loadTasks(); }
    }
    document.getElementById('nav').addEventListener('click',(e)=>{
      const t=e.target.closest('.tab'); if(!t) return;
      openScreen(t.dataset.target);
    });

    /* ===== DOM refs (Today) ===== */
    const elFocusInput  = document.getElementById('focusInput');
    const elFocusSave   = document.getElementById('focusSave');
    const elFocusGlass  = document.getElementById('focusGlass');
    const elFocusMain   = document.getElementById('focusMain');
    const elFocusMeta   = document.getElementById('focusMeta');
    const elProgress    = document.getElementById('focusProgress');

    const listEl        = document.getElementById('tasks');
    const showAll       = document.getElementById('showAll');

    const taskTitle     = document.getElementById('taskTitle');
    const chipGroup     = document.getElementById('chipGroup');
    const taskDate      = document.getElementById('taskDate');
    const taskTime      = document.getElementById('taskTime');
    const taskAdd       = document.getElementById('taskAdd');

    const chatModal = document.getElementById('chatModal');
    const openChat  = document.getElementById('openChat');
    const closeChat = document.getElementById('closeChat');
    const msgs      = document.getElementById('msgs');
    const chatInput = document.getElementById('chatInput');
    const sendMsg   = document.getElementById('sendMsg');

    let todayTasks=[]; let currentList='today';

    /* ===== HEALTH (silent) ===== */
    (async function(){
      try{
        const r=await authFetch('/api/health'); const j=await r.json().catch(()=>({}));
        if(!j.db_ok){ /* –º–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ –ª—ë–≥–∫–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, –Ω–æ –Ω–µ –º–µ—à–∞–µ–º UX */ }
      }catch(e){}
    })();

    /* ===== FOCUS ===== */
    async function loadFocus(){
      const day=new Date().toISOString().slice(0,10);
      try{
        const r=await authFetch(`/api/focus?day=${day}`);
        const j=await r.json().catch(()=>({}));
        const text=j.text||'';
        elFocusInput.value=text;
        if(text){
          elFocusMain.textContent=text;
          elFocusMeta.textContent=j.meta||'–°—Ä–æ–∫ –¥–æ 18:00';
          elProgress.style.width=(j.progressPct||45)+'%';
          elFocusGlass.style.display='block';
        }else elFocusGlass.style.display='none';
      }catch(e){}
    }
    async function saveFocus(){
      const text=(elFocusInput.value||'').trim(); if(!text) return toast('–í–≤–µ–¥–∏—Ç–µ —Ñ–æ–∫—É—Å –¥–Ω—è');
      const old=elFocusSave.textContent; elFocusSave.disabled=true; elFocusSave.textContent='–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶';
      try{
        const r=await authFetch('/api/focus',{method:'PUT',headers:{'content-type':'application/json'},body:JSON.stringify({day:new Date().toISOString().slice(0,10),text})});
        if(r.ok){ await loadFocus(); toast('–§–æ–∫—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); }
      }catch(e){}
      elFocusSave.disabled=false; elFocusSave.textContent=old;
    }
    elFocusSave.onclick=saveFocus;

    /* ===== CHIPS ===== */
    chipGroup.addEventListener('click',e=>{
      const c=e.target.closest('.chip'); if(!c) return;
      chipGroup.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      c.classList.add('active'); currentList=c.dataset.list||'today';
    });

    /* ===== TASKS ===== */
    function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))}
    function renderTasks(items){
      if(!items.length){ listEl.innerHTML='<div style="text-align:center;color:#6b7a90;padding:10px">–ó–∞–¥–∞—á –Ω–µ—Ç</div>'; return; }
      listEl.innerHTML=items.map(t=>{
        const sub=t.note||t.subtitle||'';
        const ic=t.icon||'üß©';
        const ok=t.done?'‚úÖ':'‚úîÔ∏è';
        return `<div class="task" data-id="${t.id||''}" data-done="${!!t.done}">
          <div class="task-ic">${ic}</div>
          <div class="task-mid">
            <div class="task-title">${escapeHtml(t.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
            ${sub?`<div class="task-sub">${escapeHtml(sub)}</div>`:''}
          </div>
          <div class="task-ok" title="–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π">${ok}</div>
        </div>`;
      }).join('');
    }
    async function loadTasks(){
      try{
        const r=await authFetch('/api/tasks?list=today');
        const j=await r.json().catch(()=>({items:[]}));
        todayTasks=j.items||[]; renderTasks(todayTasks);
      }catch(e){}
    }

    // toggle done (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ —Å –æ—Ç–∫–∞—Ç–æ–º)
    listEl.addEventListener('click',async e=>{
      const ok=e.target.closest('.task-ok'); if(!ok) return;
      const task=e.target.closest('.task'); const id=task?.dataset?.id; if(!id) return;
      const wasDone=task.dataset.done==='true';
      task.dataset.done=(!wasDone).toString(); ok.textContent = wasDone ? '‚úîÔ∏è' : '‚úÖ';
      try{
        const r=await authFetch(`/api/tasks/${encodeURIComponent(id)}`,{method:'PUT',headers:{'content-type':'application/json'},body:JSON.stringify({done:!wasDone})});
        if(!r.ok) throw 0;
      }catch(e){
        task.dataset.done=wasDone.toString(); ok.textContent = wasDone ? '‚úÖ' : '‚úîÔ∏è';
        toast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É');
      }
    });

    // add task
    function toISO(dateStr,timeStr){
      if(!dateStr && !timeStr) return null;
      let d = dateStr ? new Date(dateStr) : new Date();
      if(timeStr){ const [h,m]=timeStr.split(':'); d.setHours(+h||0, +m||0, 0, 0); }
      return d.toISOString();
    }
    taskAdd.onclick = async ()=>{
      const title=(taskTitle.value||'').trim(); if(!title) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
      const payload={ title, list: currentList, deadline: toISO(taskDate.value, taskTime.value) };
      const old=taskAdd.textContent; taskAdd.disabled=true; taskAdd.textContent='–î–æ–±–∞–≤–ª—è—é‚Ä¶';
      try{
        const r=await authFetch('/api/tasks',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
        if(r.ok){ taskTitle.value=''; taskDate.value=''; taskTime.value=''; toast('–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞'); await loadTasks(); }
      }catch(e){}
      taskAdd.disabled=false; taskAdd.textContent=old;
    };

    showAll.onclick = ()=> toast('–°–∫–æ—Ä–æ: —ç–∫—Ä–∞–Ω ¬´–í—Å–µ –∑–∞–¥–∞—á–∏¬ª');

    /* ===== CHAT ===== */
    function pushMsg(w,t){const b=document.createElement('div');b.style.cssText='padding:10px 12px;border-radius:12px;max-width:80%;margin:2px 0';b.textContent=t;if(w==='me'){b.style.marginLeft='auto';b.style.background='#eff6ff'}else{b.style.marginRight='auto';b.style.background='#f3f4f6'};msgs.appendChild(b);msgs.scrollTop=msgs.scrollHeight;}
    async function sendChat(){
      const q=(chatInput.value||'').trim(); if(!q) return; pushMsg('me',q); chatInput.value='';
      try{
        const r=await authFetch('/api/chat',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({message:q})},22000);
        const j=await r.json().catch(()=>({})); (r.ok&&j.reply)?pushMsg('bot',j.reply):pushMsg('bot','[–æ—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞]');
      }catch(e){ pushMsg('bot','[network error]') }
    }
    document.getElementById('openChat').onclick = ()=>{ chatModal.style.display='flex'; chatInput.focus() };
    document.getElementById('closeChat').onclick = ()=>{ chatModal.style.display='none' };
    document.getElementById('sendMsg').onclick  = sendChat;
    chatInput.addEventListener('keydown',e=>{ if(e.key==='Enter') sendChat() });

    /* ===== INITIAL LOAD ===== */
    (function boot(){ loadFocus(); loadTasks(); })();
  </script>
</body>
</html>
