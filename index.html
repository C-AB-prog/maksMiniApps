<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Growth Assistant</title>
<style>
  :root{
    --bg: #f7f8fb;
    --card:#ffffff;
    --text:#0f172a;
    --muted:#667085;
    --brand:#2563eb;
    --brand-2:#22c55e;
    --ring: rgba(37,99,235,.35);
    --shadow: 0 6px 20px rgba(15,23,42,.10);
    --radius:16px;
  }
  html,body{height:100%;}
  body{
    margin:0;
    font: 15px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 100% -200px, #e0eaff 0, transparent 60%),
      radial-gradient(1200px 600px at -100px 100%, #e8fff1 0, transparent 60%),
      var(--bg);
  }
  .app{max-width:920px;margin:0 auto;padding:16px 12px 96px;}
  .topbar{
    display:flex;align-items:center;gap:12px;padding:12px;
    background:var(--card);border-radius:14px;box-shadow:var(--shadow)
  }
  .bolt{width:28px;height:28px;border-radius:10px;background:linear-gradient(135deg,#5b8cff,#7cc0ff);display:grid;place-items:center;color:#fff;font-weight:700}
  .title{font-weight:700;font-size:16px}
  h2{margin:16px 4px 10px;font-size:22px;letter-spacing:.2px}

  .card{
    background:var(--card);border-radius:var(--radius);
    padding:14px 14px 12px;margin:10px 0;box-shadow:var(--shadow)
  }
  .row{display:flex;align-items:center;gap:12px;margin-top:10px}
  .label{display:flex;align-items:center;gap:10px;font-weight:700}
  .dot{width:30px;height:30px;border-radius:10px;display:grid;place-items:center;color:#fff}
  .dot.blue{background:linear-gradient(135deg,#457BFF,#6CA3FF)}
  .dot.green{background:linear-gradient(135deg,#22c55e,#63e08c)}
  input[type="text"], input[type="date"], input[type="time"]{
    appearance:none;border:1px solid #e6e8f0;border-radius:12px;outline:none;
    padding:12px 14px;width:100%;background:#fbfcff;color:var(--text)
  }
  input:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
  .btn{
    border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;
    background:linear-gradient(135deg,#2e6ef5,#4c8dff);color:#fff;box-shadow:0 6px 14px rgba(46,110,245,.3)
  }
  .btn.secondary{background:linear-gradient(135deg,#0ea5e9,#60a5fa)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .pills{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .pill{border:1px solid #e6e8f0;border-radius:999px;padding:8px 12px;color:var(--muted);cursor:pointer;background:#fff}
  .pill.active{border-color:#c7d2fe;background:#eef2ff;color:#3730a3}
  .list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid #eef0f6;border-radius:12px;background:#fff}
  .item input{width:18px;height:18px}
  .empty{color:var(--muted);padding:12px;text-align:center}
  .nav{
    position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #eef0f6;
    display:flex;gap:6px;justify-content:space-around;padding:10px env(safe-area-inset-left) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-right)
  }
  .nav .btn{flex:1;background:#f6f7fb;color:#0f172a;box-shadow:none}
  .chatbar{position:fixed;left:16px;right:16px;bottom:84px;display:flex;justify-content:center}
  .chatbtn{width:100%;max-width:920px;border-radius:14px;background:linear-gradient(135deg,#6b8bff,#92e0ff);color:#fff;font-weight:800;padding:14px;border:0;box-shadow:0 10px 24px rgba(107,139,255,.35);cursor:pointer}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:28px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;max-width:92vw;box-shadow:var(--shadow);z-index:9999}

  /* modal chat */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:flex-end}
  .sheet{background:#fff;border-radius:18px 18px 0 0;box-shadow:0 -10px 30px rgba(0,0,0,.2);width:100%;max-height:80vh;overflow:auto}
  .sheet header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #eef0f6}
  .msglist{display:flex;flex-direction:column;gap:8px;padding:10px 12px}
  .bubble{padding:10px 12px;border-radius:12px;max-width:80%}
  .me{background:#eff6ff;margin-left:auto}
  .bot{background:#f3f4f6;margin-right:auto}
  .composer{display:flex;gap:8px;padding:12px;border-top:1px solid #eef0f6;position:sticky;bottom:0;background:#fff}
  .composer input{flex:1}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="bolt">‚ö°</div>
    <div class="title">Growth Assistant</div>
  </div>

  <h2>–°–µ–≥–æ–¥–Ω—è</h2>

  <!-- –§–æ–∫—É—Å –¥–Ω—è -->
  <section class="card" id="focusCard">
    <div class="label"><span class="dot blue">‚ö°</span>–§–æ–∫—É—Å –¥–Ω—è</div>
    <div class="row">
      <input id="focusInput" type="text" placeholder="–°–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ —Å–µ–≥–æ–¥–Ω—è‚Ä¶" />
      <button id="focusSave" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div class="pills" id="focusChip" style="display:none"></div>
  </section>

  <!-- –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ -->
  <section class="card">
    <div class="label"><span class="dot green">Ôºã</span>–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</div>
    <div class="row"><input id="taskTitle" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" /></div>
    <div class="pills" id="lists">
      <div class="pill active" data-list="today">–°–µ–≥–æ–¥–Ω—è</div>
      <div class="pill" data-list="week">–ù–µ–¥–µ–ª—è</div>
      <div class="pill" data-list="backlog">–ë—ç–∫–ª–æ–≥</div>
    </div>
    <div class="row">
      <input id="dueDate" type="date" />
      <input id="dueTime" type="time" />
      <button id="taskAdd" class="btn secondary">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </section>

  <!-- –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è -->
  <section class="card">
    <div class="label" style="margin-bottom:6px">–ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</div>
    <div id="todayList" class="list"></div>
  </section>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ -->
<div class="chatbar">
  <button class="chatbtn" id="openChat">üí¨ –ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</button>
</div>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è (—Ñ–∏–∫—Ç–∏–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –≤–∏–¥–∞) -->
<div class="nav">
  <button class="btn">–°–µ–≥–æ–¥–Ω—è</button>
  <button class="btn">–ü–ª–∞–Ω</button>
  <button class="btn">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
  <button class="btn">–ü—Ä–æ—Ñ–∏–ª—å</button>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ —á–∞—Ç–∞ -->
<div class="modal" id="chatModal">
  <div class="sheet">
    <header>
      <strong>–ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</strong>
      <button id="closeChat" class="btn" style="padding:8px 12px">–ó–∞–∫—Ä—ã—Ç—å</button>
    </header>
    <div id="msgs" class="msglist"></div>
    <div class="composer">
      <input id="chatInput" type="text" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–æ –ø–ª–∞–Ω, HADI –∏–ª–∏ –∑–∞–¥–∞—á–∏‚Ä¶" />
      <button id="sendMsg" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Telegram WebApp SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
/* ===== helpers: UI ===== */
let toastEl=null;
function showSticky(text){
  if(toastEl){ toastEl.remove(); toastEl=null; }
  toastEl=document.createElement('div');
  toastEl.className='toast';
  toastEl.textContent=text;
  document.body.appendChild(toastEl);
  setTimeout(()=>{ if(toastEl){ toastEl.remove(); toastEl=null; } }, 4200);
}
function toast(t){ showSticky(t); }

/* ===== Telegram init ===== */
const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
if(tg){ try{ tg.ready(); tg.expand(); }catch(e){} }
window.__TG_INIT_DATA__ = tg && tg.initData ? tg.initData : '';

/* ===== fetch —Å –ø–æ–¥–ø–∏—Å—å—é, —Ç–∞–π–º–∞—É—Ç–æ–º, —Ä–µ—Ç—Ä–∞—è–º–∏ –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –æ—à–∏–±–æ–∫ ===== */
async function explain(res, route){
  let body=''; try{ body = await res.clone().text(); }catch{}
  const msg=`API(${route}): ${res.status} ${res.statusText} ‚Äî ${body.slice(0,180)}`;
  showSticky(msg); console.warn(msg);
}
async function authFetch(route, opts, timeoutMs=8000){
  const url = route.startsWith('/')?route:`/${route}`;
  async function once(){
    const c=new AbortController(); const t=setTimeout(()=>c.abort('timeout'), timeoutMs);
    try{
      const res=await fetch(url,{...(opts||{}),
        headers:{...(opts?.headers||{}),'x-telegram-init': window.__TG_INIT_DATA__ || ''},
        signal:c.signal});
      clearTimeout(t);
      if(!res.ok) await explain(url,res);
      return res;
    }catch(e){ clearTimeout(t); throw e; }
  }
  try{
    const r1=await once(); if(r1.ok) return r1;
    if(r1.status>=500){ await new Promise(r=>setTimeout(r,600)); return await once(); }
    return r1;
  }catch(e){ showSticky('API: network error'); throw e; }
}

/* ===== —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===== */
let pickedList='today';
let focusText='';
let todayTasks=[];

/* ===== —ç–ª–µ–º–µ–Ω—Ç—ã ===== */
const elFocusInput = document.getElementById('focusInput');
const elFocusSave  = document.getElementById('focusSave');
const elFocusChip  = document.getElementById('focusChip');
const elLists      = document.getElementById('lists');
const elTaskTitle  = document.getElementById('taskTitle');
const elAddBtn     = document.getElementById('taskAdd');
const elTodayList  = document.getElementById('todayList');

/* ===== health check ===== */
async function health(){
  try{
    const r = await authFetch('/api/health');
    if(!r.ok){ return; }
    const j = await r.json().catch(()=> ({}));
    if(!j.db_ok){ showSticky('HEALTH: db=false'); }
    if(!j.env?.has_POSTGRES_URL){ showSticky('HEALTH: no POSTGRES_URL'); }
  }catch(e){ showSticky('HEALTH: network error'); }
}

/* ===== focus ===== */
function lockFocusUI(lock){ elFocusInput.disabled=lock; elFocusSave.disabled=lock; }
function renderFocusChip(){
  if(!focusText){ elFocusChip.style.display='none'; return; }
  elFocusChip.style.display='flex';
  elFocusChip.innerHTML = `<div class="pill active">–§–æ–∫—É—Å: ${focusText}</div>`;
}
async function loadFocus(){
  const day=new Date().toISOString().slice(0,10);
  try{
    const r=await authFetch('/api/focus?day='+day);
    const j=await r.json().catch(()=> ({}));
    focusText=j.text||'';
    elFocusInput.value=focusText||'';
    renderFocusChip();
  }catch{}
}
async function saveFocus(){
  const v=(elFocusInput.value||'').trim();
  if(!v){ return toast('–í–≤–µ–¥–∏—Ç–µ —Ñ–æ–∫—É—Å –¥–Ω—è'); }
  lockFocusUI(true); const old=elFocusSave.textContent; elFocusSave.textContent='–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶';
  const body={ day:new Date().toISOString().slice(0,10), text:v };
  try{
    const r=await authFetch('/api/focus',{method:'PUT',headers:{'content-type':'application/json'},body:JSON.stringify(body)});
    if(r.ok){ focusText=v; renderFocusChip(); toast('–§–æ–∫—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); }
  }catch{}
  finally{ lockFocusUI(false); elFocusSave.textContent=old; }
}

/* ===== tasks ===== */
function renderToday(){
  if(!todayTasks.length){ elTodayList.innerHTML=`<div class="empty">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</div>`; return; }
  elTodayList.innerHTML = todayTasks.map(t=>(
    `<div class="item">
      <input type="checkbox" disabled />
      <div>${t.title}</div>
    </div>`
  )).join('');
}
async function loadTasks(){
  try{
    const r=await authFetch('/api/tasks?list=today');
    const j=await r.json().catch(()=>({items:[]}));
    todayTasks=j.items||[];
    renderToday();
  }catch{}
}
async function quickAdd(){
  const title=(elTaskTitle.value||'').trim();
  if(!title){ return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏'); }
  elAddBtn.disabled=true; const old=elAddBtn.textContent; elAddBtn.textContent='–î–æ–±–∞–≤–ª—è—é‚Ä¶';
  const body={
    title, list:pickedList,
    due_date: (document.getElementById('dueDate').value||null),
    due_time: (document.getElementById('dueTime').value||null)
  };
  try{
    const r=await authFetch('/api/tasks',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)});
    const created=await r.json().catch(()=> (null));
    if(r.ok && created){ toast('–î–æ–±–∞–≤–ª–µ–Ω–æ'); elTaskTitle.value=''; await loadTasks(); }
  }catch{}
  finally{ elAddBtn.disabled=false; elAddBtn.textContent=old; }
}

/* ===== chat ===== */
const chatModal=document.getElementById('chatModal');
const openChat=document.getElementById('openChat');
const closeChat=document.getElementById('closeChat');
const msgs=document.getElementById('msgs');
const chatInput=document.getElementById('chatInput');
const sendMsg=document.getElementById('sendMsg');

openChat.onclick=()=>{ chatModal.style.display='flex'; chatInput.focus(); };
closeChat.onclick=()=>{ chatModal.style.display='none'; };

function pushMsg(who,text){
  const b=document.createElement('div');
  b.className='bubble '+(who==='me'?'me':'bot');
  b.textContent=text; msgs.appendChild(b); msgs.scrollTop=msgs.scrollHeight;
}
async function sendChat(){
  const q=(chatInput.value||'').trim(); if(!q) return;
  pushMsg('me',q); chatInput.value='';
  try{
    const r=await authFetch('/api/chat',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({message:q})},12000);
    const j=await r.json().catch(()=> ({}));
    if(r.ok && j.reply){ pushMsg('bot',j.reply); } else { pushMsg('bot','[–æ—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞]'); }
  }catch{ pushMsg('bot','[network error]'); }
}
sendMsg.onclick=sendChat; chatInput.addEventListener('keydown',e=>{ if(e.key==='Enter') sendChat(); });

/* ===== picks ===== */
elLists.addEventListener('click',e=>{
  const pill=e.target.closest('.pill'); if(!pill) return;
  document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));
  pill.classList.add('active'); pickedList=pill.dataset.list;
});

/* ===== binding ===== */
elFocusSave.onclick=saveFocus;
elAddBtn.onclick=quickAdd;

/* ===== boot ===== */
(async function(){
  await health();
  await Promise.all([loadFocus(), loadTasks()]);
})();
</script>
</body>
</html>
