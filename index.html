<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <title>Growth Assistant · Mini App</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#3B82F6; --accent-2:#60A5FA;
      --bg:#F8FAFF; --surface:#FFFFFF; --line:#E5E7F0;
      --text:#0F172A; --muted:#667085;
      --r-lg:16px; --sh-xs:0 1px 2px rgba(15,23,42,.06), 0 8px 24px rgba(59,130,246,.06);
      --h1:clamp(18px,4vw,22px); --h2:clamp(15px,3.4vw,17px); --body:15px; --cap:12px;
      --sp-2:10px; --sp-3:12px; --sp-4:16px;
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:var(--body); color:var(--text);
      background:
        radial-gradient(1200px 600px at 80% -10%, rgba(96,165,250,.18), transparent 60%),
        radial-gradient(1200px 600px at -10% 100%, rgba(59,130,246,.12), transparent 60%),
        linear-gradient(#F9FBFF, #F6F9FF);
    }
    .app{min-height:100%; display:flex; flex-direction:column}
    header{position:sticky; top:0; z-index:20; background:rgba(255,255,255,.9); backdrop-filter:saturate(140%) blur(8px); border-bottom:1px solid var(--line)}
    .topbar{display:flex; align-items:center; gap:var(--sp-2); padding:var(--sp-2) var(--sp-3); max-width:960px; margin:0 auto}
    .brand{display:flex; align-items:center; gap:var(--sp-2)}
    .dot{width:18px;height:18px;border-radius:6px; background:linear-gradient(135deg,var(--accent),var(--accent-2))}
    .title{font-weight:700}
    .actions{margin-left:auto; display:flex; align-items:center; gap:10px}
    .mini-chip{font-size:12px; padding:4px 8px; border-radius:999px; background:#EEF2FF; color:#1D4ED8; border:1px solid #CBD5E1}
    main{flex:1; padding:0 var(--sp-3) calc(200px + env(safe-area-inset-bottom)); max-width:960px; margin:0 auto}
    .card{background:linear-gradient(180deg, #FFF 0%, #FDFEFF 100%); border:1px solid var(--line); border-radius:var(--r-lg); padding:var(--sp-3); box-shadow:var(--sh-xs)}
    .card + .card{margin-top:var(--sp-3)}
    h1{font-size:var(--h1); margin:var(--sp-2) 0 var(--sp-2)} h2{font-size:var(--h2); margin:0 0 var(--sp-2) 0}
    .sub{color:var(--muted); font-size:var(--cap)}
    .row{display:flex; gap:var(--sp-2); align-items:center}
    .input{height:44px; padding:0 12px; width:100%; border-radius:12px; border:1px solid var(--line); background:#fff}
    .input.readonly{background:#F3F6FB; color:#374151}
    .btn{height:44px; padding:0 16px; border-radius:12px; border:0; background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff; font-weight:700; letter-spacing:.2px; box-shadow:0 12px 32px rgba(59,130,246,.25)}
    .btn.ghost{background:linear-gradient(180deg,#fff,#FBFDFF); color:#0F172A; border:1px solid var(--line); font-weight:600}
    .chip{height:34px; padding:0 12px; border-radius:999px; border:1px solid var(--line); background:linear-gradient(180deg,#fff,#F8FAFF); font-size:12px; color:#111827; cursor:pointer}
    .chip.active{border-color:transparent; color:#0B4DD9; background:linear-gradient(135deg,#EEF2FF,#E0EAFF)}
    .list{display:flex; flex-direction:column; gap:8px}
    .item{display:flex; align-items:center; gap:8px; padding:10px; background:linear-gradient(180deg,#fff,#FBFDFF); border:1px solid var(--line); border-radius:12px; min-width:0}
    .check{appearance:none; width:20px; height:20px; border-radius:6px; border:1px solid var(--line); background:#fff}
    .check:checked{background:var(--accent); border-color:var(--accent)}
    .body{flex:1; min-width:0}
    .title{font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .hint{color:#667085; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .tag{font-size:11px; color:#0F766E; background:linear-gradient(180deg,#ECFDF5,#F6FFFB); border:1px solid #A7F3D0; padding:4px 6px; border-radius:999px; white-space:nowrap}
    .more{border:none; background:transparent; font-size:18px; color:#9CA3AF}
    .plan-tabs{display:flex; gap:6px; overflow:auto; padding-bottom:6px; margin-bottom:10px}
    .plan-tab{height:34px; padding:0 12px; border-radius:999px; border:1px solid var(--line); background:linear-gradient(180deg,#fff,#F8FAFF); cursor:pointer}
    .plan-tab.active{border-color:transparent; background:linear-gradient(135deg,#EEF2FF,#E0EAFF); color:#0B4DD9}
    .board{display:grid; grid-template-columns:repeat(2, minmax(160px,1fr)); gap:10px}
    .column{background:linear-gradient(180deg,#fff,#F8FAFF); border:1px solid var(--line); border-radius:12px; padding:10px; min-height:180px}
    .agenda{display:grid; grid-template-columns:60px 1fr; border:1px solid var(--line); border-radius:12px; overflow:hidden; background:linear-gradient(180deg,#fff,#F8FAFF)}
    .hour{height:40px; padding:6px 6px; font-size:12px; color:#6B7280; border-bottom:1px dashed #E5E7EB}
    .slot{height:40px; border-bottom:1px dashed #E5E7EB; position:relative}
    .event{position:absolute; left:6px; right:6px; background:linear-gradient(135deg,#E3F2FD,#F0F7FF); color:#0B4DD9; border:1px solid #BFDBFE; border-radius:10px; padding:6px; font-size:12px}
    .chatbar{position:fixed; left:50%; transform:translateX(-50%); bottom:calc(12px + 72px + env(safe-area-inset-bottom)); z-index:55; width:min(560px,94%); pointer-events:none}
    .chatbar .btn-chat{pointer-events:auto; display:block; width:100%; height:56px; border-radius:16px; border:0; font-weight:800; color:#fff; background:linear-gradient(90deg,#2563EB 0%, #60A5FA 100%); box-shadow:0 16px 40px rgba(37,99,235,.35)}
    .dock{position:fixed; left:50%; bottom:12px; transform:translateX(-50%); z-index:50; width:min(560px,94%); padding-bottom:env(safe-area-inset-bottom); pointer-events:none}
    .dock-inner{display:grid; grid-template-columns:repeat(4,1fr); gap:6px; background:rgba(255,255,255,.9); backdrop-filter:saturate(140%) blur(12px); border:1px solid var(--line); border-radius:18px; padding:10px; box-shadow:0 10px 28px rgba(15,23,42,.14); pointer-events:auto}
    .dock-item{height:52px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:3px; border-radius:10px; color:#667085; font-size:12px; border:none; background:transparent; cursor:pointer}
    .dock-item.active{background:linear-gradient(180deg,#F6F7FA,#EFF3FF); color:#0F172A; font-weight:600}
    .sheet{position:fixed; inset:0; z-index:60} .sheet[hidden]{display:none}
    .sheet-backdrop{position:absolute; inset:0; background:rgba(15,23,42,.35); backdrop-filter:blur(3px)}
    .sheet-panel{position:absolute; left:0; right:0; bottom:0; background:#fff; border-top-left-radius:18px; border-top-right-radius:18px; box-shadow:0 -18px 44px rgba(0,0,0,.22); border:1px solid var(--line)}
    .sheet-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--line)}
    .sheet-body{max-height:50vh; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:10px}
    .sheet-input{display:flex; gap:10px; padding:12px; border-top:1px solid var(--line)}
    .bubble{max-width:85%; padding:10px 12px; border:1px solid var(--line); border-radius:12px}
    .bubble.me{align-self:flex-end; background:#EEF2FF; border-color:#CBD5E1}
    .bubble.bot{align-self:flex-start; background:#F8FAFC}
    .warn-banner{position:sticky; top:0; z-index:30; background:#FEF3C7; color:#92400E; border:1px solid #FCD34D; padding:8px 12px; border-radius:8px; margin:8px}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="topbar">
      <div class="brand"><div class="dot"></div><div class="title">Growth Assistant</div></div>
      <div class="actions"><span id="focusChip" class="mini-chip" hidden>Фокус: —</span></div>
    </div>
  </header>

  <main>
    <div id="notInTg" class="warn-banner" style="display:none">Откройте приложение из меню Telegram-бота. Иначе сервер не примет запросы.</div>

    <section id="screen-today" class="screen">
      <h1>Сегодня</h1>

      <div class="card">
        <h2>Фокус дня</h2>
        <div class="row">
          <input id="focus" class="input" placeholder="Самое главное сегодня…">
          <button class="btn" data-action="saveFocus" id="saveFocusBtn">Сохранить</button>
          <button class="btn ghost" data-action="editFocus" id="editFocusBtn" style="display:none">✎</button>
        </div>
      </div>

      <div class="card">
        <h2>Быстрое добавление</h2>
        <div class="row" style="flex-wrap:wrap">
          <input id="add" class="input" placeholder="Название задачи" style="flex:1 1 100%">
          <button class="btn" data-action="quickAdd">Добавить</button>
        </div>
        <div class="row" style="flex-wrap:wrap; margin-top:8px">
          <span class="sub">Список:</span>
          <button class="chip active" data-list="today">Сегодня</button>
          <button class="chip" data-list="week">Неделя</button>
          <button class="chip" data-list="backlog">Бэклог</button>
          <span class="sub" style="margin-left:auto">Дедлайн:</span>
          <input id="dueDate" class="input" type="date" style="max-width:150px">
          <input id="dueTime" class="input" type="time" style="max-width:120px">
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h2>Задачи на сегодня</h2>
          <button class="btn ghost" data-action="toggleAll" id="toggleBtn">Показать всё</button>
        </div>
        <div id="todayList" class="list"></div>
      </div>
    </section>

    <section id="screen-plan" class="screen" hidden>
      <h1>План</h1>
      <div class="plan-tabs" role="tablist">
        <button class="plan-tab active" data-view="lists">Списки</button>
        <button class="plan-tab" data-view="hadi">HADI</button>
        <button class="plan-tab" data-view="metrics">Метрики</button>
      </div>
      <div id="plan-view-lists">
        <div class="card"><h2>Сегодня</h2><div id="list-today" class="list"></div></div>
        <div class="card"><h2>На неделе</h2><div id="list-week" class="list"></div></div>
        <div class="card"><h2>Бэклог</h2><div id="list-backlog" class="list"></div></div>
      </div>
      <div id="plan-view-hadi" hidden>
        <div class="board">
          <div class="column"><strong>Planned</strong></div>
          <div class="column"><strong>Running</strong></div>
          <div class="column"><strong>Review</strong></div>
          <div class="column"><strong>Done</strong></div>
        </div>
      </div>
      <div id="plan-view-metrics" hidden>
        <div class="card"><div class="sub">KPI скоро будут здесь…</div></div>
      </div>
    </section>

    <section id="screen-calendar" class="screen" hidden>
      <h1>Календарь</h1>
      <div class="card" style="margin-bottom:10px">
        <div class="row" style="flex-wrap:wrap">
          <span class="sub">День:</span>
          <input id="calDate" type="date" class="input" style="max-width:170px">
          <span class="sub" style="margin-left:auto">Новое событие</span>
          <input id="evtTitle" class="input" placeholder="Название" style="min-width:140px">
          <input id="evtStart" class="input" type="time" value="10:00" style="max-width:120px">
          <input id="evtDur" class="input" type="number" min="15" step="15" value="60" style="max-width:120px" placeholder="Длительность, мин">
          <button class="btn" data-action="addEvent">Добавить</button>
        </div>
      </div>
      <div class="agenda"><div class="hours" id="hours"></div><div class="slots" id="slots"></div></div>
    </section>

    <section id="screen-settings" class="screen" hidden>
      <h1>Профиль</h1>
      <div class="card"><div class="sub">Таймзона: Europe/Helsinki · Уведомления: вкл</div></div>
    </section>
  </main>

  <div class="chatbar"><button class="btn-chat" data-action="openChat">💬 Чат с ассистентом</button></div>

  <nav class="dock" role="navigation" aria-label="Нижняя навигация">
    <div class="dock-inner">
      <button class="dock-item active" data-target="today"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10l9-7 9 7"/><path d="M9 22V12h6v10"/></svg><span>Сегодня</span></button>
      <button class="dock-item" data-target="plan"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6l7-2 7 2 4-1v13l-4 1-7-2-7 2-3-1V5z"/></svg><span>План</span></button>
      <button class="dock-item" data-target="calendar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg><span>Календарь</span></button>
      <button class="dock-item" data-target="settings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M6 20c0-3.314 2.686-6 6-6s6 2.686 6 6"/></svg><span>Профиль</span></button>
    </div>
  </nav>

  <div class="sheet" id="chatSheet" hidden>
    <div class="sheet-backdrop" data-action="closeChat"></div>
    <div class="sheet-panel">
      <div class="sheet-head">
        <strong>Чат с ассистентом</strong>
        <button class="btn ghost" data-action="closeChat">Закрыть</button>
      </div>
      <div class="sheet-body" id="chatBox"></div>
      <div class="sheet-input">
        <input id="chatInput" class="input" placeholder="Спросите про план, HADI или задачи…">
        <button class="btn" data-action="chatSend">Отправить</button>
      </div>
    </div>
  </div>
</div>

<!-- Лёгкий оверлей для сообщений об ошибках -->
<div id="debugOverlay" style="position:fixed;left:50%;transform:translateX(-50%);bottom:92px;max-width:94%;z-index:9999;background:#111827;color:#fff;padding:10px 12px;border-radius:10px;display:none"></div>

<script>
  function showErr(msg){
    const box=document.getElementById('debugOverlay');
    box.textContent=String(msg||'Ошибка');
    box.style.display='block';
    setTimeout(()=>box.style.display='none', 3500);
    console.error('[UI]', msg);
  }
  function toast(msg){
    var t=document.createElement('div');
    t.textContent=msg;
    t.style.cssText='position:fixed;bottom:140px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.15);opacity:.98;z-index:99';
    document.body.appendChild(t);
    setTimeout(function(){t.style.transition="opacity .4s"; t.style.opacity='0'; setTimeout(function(){t.remove()},400)},1000);
  }
</script>

<!-- Telegram bootstrap + защищённый fetch -->
<script>
(function(){
  var tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg) { try { tg.ready(); tg.expand(); } catch(e){} }
  window.__TG_INIT_DATA__ = tg && tg.initData ? tg.initData : '';

  // Предупреждение, если открыто не из Telegram
  if (!window.__TG_INIT_DATA__) {
    var w = document.getElementById('notInTg');
    if (w) w.style.display = 'block';
  }

  // fetch с автодобавлением подписи и видимым текстом ошибки
  window.authFetch = async function(url, opts){
    opts = opts || {};
    opts.headers = Object.assign({}, opts.headers, { 'x-telegram-init': window.__TG_INIT_DATA__ || '' });
    const res = await fetch(url, opts);
    if (!res.ok) {
      let msg = `${res.status} ${res.statusText}`;
      try { const j = await res.clone().json(); if (j && j.error) msg = j.error; } catch {}
      showErr('API: ' + msg);
    }
    return res;
  };
})();
</script>

<script>
(function(){
  var lists = { today:[], week:[], backlog:[] };
  var events = [];
  var focusText = '';
  var showAll=false, picked='today', currentDate=todayStr();

  function q(s){return document.querySelector(s)}; function qa(s){return document.querySelectorAll(s)}
  function todayStr(){ var d=new Date(); return d.toISOString().slice(0,10) }
  function ddmm(dstr){ if(!dstr) return '—'; var p=dstr.split('-'); return p[2]+'.'+p[1] }
  function esc(s){return String(s||'').replace(/[&<>\"']/g,function(m){return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]})}

  function lockFocusUI(lock){
    var input=q('#focus'); var saveBtn=q('#saveFocusBtn'); var editBtn=q('#editFocusBtn');
    if(lock){ input.readOnly=true; input.classList.add('readonly'); saveBtn.style.display='none'; editBtn.style.display='inline-block' }
    else    { input.readOnly=false; input.classList.remove('readonly'); saveBtn.style.display='inline-block'; editBtn.style.display='none'; setTimeout(function(){input.focus()},0) }
  }
  function updateFocusChip(){
    var chip=q('#focusChip');
    if(focusText){ chip.textContent='Фокус: '+(focusText.length>26?focusText.slice(0,25)+'…':focusText); chip.hidden=false }
    else chip.hidden=true
  }

  // ---- API helpers ----
  function apiGET(url){ return authFetch(url).then(r=>r.json()).catch(e=>{showErr('Network'); throw e}) }
  function apiPOST(url, body){ return authFetch(url,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)}).then(r=>r.json()) }
  function apiPUT(url, body){ return authFetch(url,{method:'PUT',headers:{'content-type':'application/json'},body:JSON.stringify(body)}).then(r=>r.json()) }
  function apiPATCH(url, body){ return authFetch(url,{method:'PATCH',headers:{'content-type':'application/json'},body:JSON.stringify(body)}).then(r=>r.json()) }
  function apiDELETE(url){ return authFetch(url,{method:'DELETE'}).then(r=>r.json()) }

  // ---- Tasks UI ----
  function taskRow(t){
    var el=document.createElement('div'); el.className='item';
    el.innerHTML='<input type="checkbox" class="check" '+(t.done?'checked':'')+' data-id="'+t.id+'">\
      <div class="body"><div class="title">'+esc(t.title)+'</div><div class="hint">'+esc(t.hint||'')+'</div></div>\
      <span class="tag">'+esc(t.due_date ? ddmm(t.due_date)+(t.due_time?(' '+t.due_time.slice(0,5)):'') : '—')+'</span>\
      <button class="more" data-action="menu" data-id="'+t.id+'">⋯</button>';
    return el;
  }
  function renderToday(){
    var box=q('#todayList'); box.innerHTML='';
    var items = lists.today || [];
    var shows = showAll ? items : items.slice(0,3);
    if(!shows.length){ box.innerHTML='<div class="sub">Пока пусто</div>'; return }
    shows.forEach(function(t){ box.appendChild(taskRow(t)) });
  }
  function renderPlan(){
    ['today','week','backlog'].forEach(function(k){
      var box=q('#list-'+k); if(!box) return; box.innerHTML='';
      (lists[k]||[]).forEach(function(t){ box.appendChild(taskRow(t)) });
    });
  }

  async function quickAdd(){
    var input=q('#add'); var title=(input.value||'').trim(); if(!title){ showErr('Введите название'); return }
    var d=q('#dueDate').value||null; var t=q('#dueTime').value||null;
    try{
      var created = await apiPOST('/api/tasks', { title, list:picked, due_date:d, due_time:t });
      if(created && created.id){
        lists[picked].unshift(created);
        input.value=''; q('#dueDate').value=''; q('#dueTime').value='';
        renderToday(); renderPlan(); toast('Добавлено');
      } else { showErr(created?.error || 'Ошибка сервера (task)'); }
    }catch(e){}
  }

  async function toggleAll(){ showAll=!showAll; q('#toggleBtn').textContent = showAll? 'Скрыть лишнее' : 'Показать всё'; renderToday() }

  // ---- Calendar ----
  function renderAgenda(){
    var hours=q('#hours'), slots=q('#slots'); hours.innerHTML=''; slots.innerHTML='';
    for(var h=9;h<=18;h++){ var hr=document.createElement('div'); hr.className='hour'; hr.textContent=(h<10?'0':'')+h+':00'; hours.appendChild(hr); var sl=document.createElement('div'); sl.className='slot'; slots.appendChild(sl) }
    (events||[]).forEach(function(ev){
      if(ev.day!==currentDate) return;
      var top=((parseInt(ev.start.split(':')[0],10)-9)*40) + (parseInt(ev.start.split(':')[1],10)/60)*40 + 6;
      var height=(ev.dur/60)*40 - 12;
      var e=document.createElement('div'); e.className='event'; e.style.top=top+'px'; e.style.height=Math.max(28,height)+'px'; e.textContent=ev.title+' · '+ev.start.slice(0,5); slots.appendChild(e);
    });
  }
  async function addEvent(){
    var t=q('#evtTitle').value.trim(); var d=q('#calDate').value; var s=q('#evtStart').value||'10:00'; var dur=parseInt(q('#evtDur').value,10)||60;
    if(!d){ showErr('Выберите дату'); return } if(!t){ showErr('Название пустое'); return }
    try{
      var created = await apiPOST('/api/events', { title:t, day:d, start:s, dur:dur });
      if(created && created.id){ events.push(created); q('#evtTitle').value=''; renderAgenda(); toast('Событие добавлено') }
      else { showErr(created?.error || 'Ошибка сервера (event)') }
    }catch(e){}
  }

  // ---- Focus ----
  async function saveFocus(){
    var input=q('#focus'); var v=(input.value||'').trim(); if(!v){ showErr('Введите фокус дня'); return }
    try{
      const resp = await apiPUT('/api/focus', { day: todayStr(), text: v });
      if (resp && resp.text){
        focusText=v; lockFocusUI(true); updateFocusChip(); toast('Фокус сохранён');
      } else {
        showErr(resp?.error || 'Ошибка сервера (focus)');
      }
    }catch(e){ showErr('Сеть недоступна'); }
  }
  function editFocus(){ lockFocusUI(false) }

  // ---- Chat (минимум) ----
  function appendMsg(who, text){ var box=q('#chatBox'); var b=document.createElement('div'); b.className='bubble '+(who==='me'?'me':'bot'); b.textContent=text; box.appendChild(b); box.scrollTop=box.scrollHeight }
  function openChat(){ q('#chatSheet').hidden=false }
  function closeChat(){ q('#chatSheet').hidden=true }
  function chatSend(){
    var inp=q('#chatInput'); var v=(inp.value||'').trim(); if(!v) return; appendMsg('me', v); inp.value='';
    authFetch('/api/chat', { method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({ message:v }) })
      .then(r=>r.json()).then(function(d){ appendMsg('bot', d.reply||'...') })
      .catch(()=>appendMsg('bot','Сеть недоступна'));
  }

  // ---- Delegates ----
  document.addEventListener('click', async function(e){
    var el=e.target; while(el&&el!==document){ if(el.getAttribute&&(el.getAttribute('data-action')||el.getAttribute('data-target')||el.getAttribute('data-list')||el.className.indexOf('plan-tab')>-1)){ break } el=el.parentNode }
    if(!el||el===document) return;
    var act=el.getAttribute('data-action');
    if(act==='saveFocus'){ e.preventDefault(); await saveFocus(); return }
    if(act==='editFocus'){ e.preventDefault(); editFocus(); return }
    if(act==='quickAdd'){ e.preventDefault(); await quickAdd(); return }
    if(act==='toggleAll'){ e.preventDefault(); await toggleAll(); return }
    if(act==='addEvent'){ e.preventDefault(); await addEvent(); return }
    if(act==='chatSend'){ e.preventDefault(); chatSend(); return }
    if(act==='openChat'){ e.preventDefault(); openChat(); return }
    if(act==='closeChat'){ e.preventDefault(); closeChat(); return }
    if(el.getAttribute('data-list')){ var chips=qa('.card .chip'); for(var i=0;i<chips.length;i++){ chips[i].classList.remove('active') } el.classList.add('active'); picked=el.getAttribute('data-list'); e.preventDefault(); return }
    if(el.className.indexOf('plan-tab')>-1){ var v=el.getAttribute('data-view'); var tabs=qa('.plan-tab'); for(var i=0;i<tabs.length;i++){ tabs[i].classList.remove('active') } el.classList.add('active'); ['lists','hadi','metrics'].forEach(function(k){ var node=q('#plan-view-'+k); if(node) node.hidden=(k!==v) }); e.preventDefault(); return }
    var target=el.getAttribute('data-target'); if(target){ var buttons=qa('.dock-item'); for(var i=0;i<buttons.length;i++){ buttons[i].classList.remove('active') } el.classList.add('active'); var screens=qa('.screen'); for(var s=0;s<screens.length;s++){ screens[s].hidden=true } var scr=q('#screen-'+target); if(scr) scr.hidden=false; window.scrollTo(0,0); e.preventDefault(); return }
  });

  // чекбоксы done → PATCH
  document.addEventListener('change', async function(e){
    var el=e.target;
    if(el && el.classList.contains('check')){
      var id = el.getAttribute('data-id');
      try { await apiPATCH('/api/tasks/'+encodeURIComponent(id), { done: el.checked }); } catch{}
      ['today','week','backlog'].forEach(function(k){
        lists[k] = (lists[k]||[]).map(function(t){ if(t.id===id){ t.done = el.checked } return t });
      });
    }
    if(el && el.id==='calDate'){ currentDate=el.value; await loadEvents(currentDate); }
  });

  // ---- загрузка с сервера ----
  async function loadTasks(){
    const [t,w,b] = await Promise.all([
      apiGET('/api/tasks?list=today').catch(()=>({items:[]})),
      apiGET('/api/tasks?list=week').catch(()=>({items:[]})),
      apiGET('/api/tasks?list=backlog').catch(()=>({items:[]}))
    ]);
    lists.today=t.items||[]; lists.week=w.items||[]; lists.backlog=b.items||[];
  }
  async function loadFocus(day){
    const f = await apiGET('/api/focus?day='+encodeURIComponent(day)).catch(()=>null);
    focusText = f && f.text ? f.text : '';
    var input=q('#focus'); if(input) input.value=focusText||'';
    lockFocusUI(!!focusText); updateFocusChip();
  }
  async function loadEvents(day){
    const r = await apiGET('/api/events?day='+encodeURIComponent(day)).catch(()=>({items:[]}));
    events = r.items || []; renderAgenda();
  }

  async function init(){
    q('#calDate').value = todayStr();
    await Promise.all([ loadTasks(), loadFocus(todayStr()), loadEvents(todayStr()) ]);
    renderToday(); renderPlan(); renderAgenda();
  }
  init();
})();
</script>
</body>
</html>
