<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Growth Assistant</title>
  <style>
    :root{--bg:#f6f8fc;--card:#fff;--ink:#0f172a;--ink-2:#475569;--ink-3:#64748b;--brand:#3b82f6;--brand-2:#6366f1;--ok:#10b981;--ring:rgba(59,130,246,.25);--shadow:0 6px 16px rgba(15,23,42,.06),0 1px 0 rgba(15,23,42,.04) inset;--radius:16px}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:radial-gradient(1200px 800px at 80% -200px,#e9f0ff 0,transparent 60%),radial-gradient(800px 600px at -100px 10%,#eff8ff 0,transparent 65%),var(--bg);color:var(--ink);font:16px/1.45 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .container{max-width:980px;margin-inline:auto;padding:16px env(safe-area-inset-right) 110px env(safe-area-inset-left)}
    .brand{display:flex;align-items:center;gap:12px;padding:8px 12px;border-radius:14px;background:linear-gradient(135deg,#eef5ff,#fff);box-shadow:var(--shadow);margin-bottom:16px}
    .brand .logo{width:40px;height:40px;display:grid;place-items:center;border-radius:12px;background:linear-gradient(135deg,#6ea8ff,#7c6cff);color:#fff;font-weight:700;box-shadow:0 8px 20px rgba(99,102,241,.25);user-select:none}
    .brand .title{font-weight:800;letter-spacing:.2px}.brand .subtitle{color:var(--ink-3);font-size:13px;margin-top:-2px}
    h2{margin:18px 6px 8px;font-size:22px;letter-spacing:.2px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin:10px 0 16px}
    .row{display:flex;gap:12px;align-items:center}.grow{flex:1}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;background:#f1f5ff;color:#1e3a8a;font-weight:600;font-size:13px}
    input[type=text],input[type=date],input[type=time]{width:100%;background:#f8fafc;color:var(--ink);border:1px solid #e5e7eb;padding:12px 14px;border-radius:12px;outline:none;transition:border-color .2s,box-shadow .2s}
    input:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
    .btn{appearance:none;border:0;cursor:pointer;user-select:none;padding:12px 16px;border-radius:12px;font-weight:700;color:#fff;background:linear-gradient(135deg,var(--brand),var(--brand-2));box-shadow:0 6px 16px rgba(59,130,246,.28);transition:transform .05s,box-shadow .2s,opacity .2s}
    .btn:active{transform:translateY(1px)} .btn[disabled]{opacity:.6;pointer-events:none} .btn.secondary{background:#e2e8f0;color:#0f172a;box-shadow:none} .btn.ok{background:linear-gradient(135deg,#34d399,#10b981)}
    .icon-btn{appearance:none;border:1px solid #e5e7eb;background:#f8fafc;color:var(--ink-2);width:42px;height:42px;border-radius:12px;display:grid;place-items:center;cursor:pointer;transition:border-color .2s,box-shadow .2s}
    .icon-btn:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
    .muted{color:var(--ink-3);font-size:13px}.hint{font-size:12px;color:var(--ink-3)}
    .task{background:#fff;border-radius:14px;padding:14px 12px;display:flex;align-items:center;gap:12px;box-shadow:var(--shadow);margin:10px 0}.task .dot{width:26px;height:26px;border-radius:999px;background:linear-gradient(135deg,#89cffb,#6da8ff);display:grid;place-items:center;color:#fff;font-size:14px;font-weight:800;flex:0 0 26px;user-select:none}
    .task.done{opacity:.6}.task .title{font-weight:700}.task .sub{font-size:13px;color:var(--ink-3)} .task .actions{margin-left:auto;display:flex;gap:8px}
    .toggle{display:inline-grid;place-items:center;width:36px;height:36px;border-radius:10px;background:#ecfeff;color:#0891b2;border:1px solid #cffafe;cursor:pointer}
    .empty{text-align:center;color:var(--ink-3);padding:16px;border:1px dashed #e5e7eb;border-radius:12px;background:#fafafa;margin-top:8px}
    .chat-cta{position:fixed;left:16px;right:16px;bottom:86px;border-radius:18px;padding:14px 18px;font-weight:800;color:#fff;background:linear-gradient(135deg,#5aa3ff,#4f46e5);display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 16px 40px rgba(59,130,246,.35);z-index:20}
    nav{position:fixed;left:0;right:0;bottom:0;background:#fff;box-shadow:0 -6px 20px rgba(15,23,42,.08);border-top-left-radius:16px;border-top-right-radius:16px;padding:8px calc(12px + env(safe-area-inset-right)) calc(8px + env(safe-area-inset-bottom)) calc(12px + env(safe-area-inset-left));display:flex;gap:8px;justify-content:space-between;z-index:30}
    .tab{flex:1;border-radius:12px;padding:10px 6px;text-align:center;color:var(--ink-3);font-weight:700;cursor:pointer;user-select:none}.tab.active{background:linear-gradient(135deg,#eef4ff,#fff);color:var(--ink);box-shadow:var(--shadow)}
    .view{display:none}.view.active{display:block}
    .modal{position:fixed;inset:0;display:none;z-index:40}.modal.open{display:block}
    .scrim{position:absolute;inset:0;background:rgba(2,6,23,.48);backdrop-filter:blur(8px)} .sheet{position:absolute;left:0;right:0;bottom:0;background:#fff;border-top-left-radius:20px;border-top-right-radius:20px;box-shadow:0 -20px 40px rgba(2,6,23,.35);max-height:78vh;display:flex;flex-direction:column;padding-bottom:env(safe-area-inset-bottom)}
    .sheet .hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eef2f7}
    .messages{padding:12px 16px;overflow:auto;min-height:180px}.bubble{max-width:86%;margin:10px 0;padding:10px 12px;border-radius:14px;box-shadow:var(--shadow)} .bubble.me{background:#ecfeff;color:#042f2e;margin-left:auto}.bubble.ai{background:#f8fafc}
    .composer{display:flex;gap:8px;padding:12px 16px;border-top:1px solid #eef2f7}.composer input{flex:1}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(86px + 62px);background:#0f172a;color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;z-index:50;display:none}.toast.show{display:block}
    .diag{margin-top:10px;font-size:13px;color:#334155;background:#f1f5f9;border:1px dashed #cbd5e1;border-radius:12px;padding:10px 12px}.diag code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <div class="brand">
      <div class="logo">GA</div>
      <div>
        <div class="title">Growth Assistant</div>
        <div class="subtitle">–ú–∏–Ω–∏-–ø–æ–º–æ—â–Ω–∏–∫ –≤ Telegram</div>
      </div>
    </div>

    <section id="view-home" class="view active">
      <h2>–°–µ–≥–æ–¥–Ω—è</h2>

      <div class="card">
        <div class="row" style="margin-bottom:10px"><div class="chip">–§–æ–∫—É—Å –¥–Ω—è</div></div>
        <div class="row">
          <input class="grow" id="focus-input" type="text" placeholder="–°–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ —Å–µ–≥–æ–¥–Ω—è‚Ä¶">
          <button class="icon-btn" id="focus-edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
          <button class="btn" id="focus-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div class="hint" id="focus-hint"></div>
      </div>

      <div class="card">
        <div class="row" style="margin-bottom:10px"><div class="chip">–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</div></div>
        <input id="task-title" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
        <div class="row" style="margin-top:10px">
          <button class="btn secondary" data-scope="today" id="scope-today">–°–µ–≥–æ–¥–Ω—è</button>
          <button class="btn secondary" data-scope="week" id="scope-week">–ù–µ–¥–µ–ª—è</button>
          <button class="btn secondary" data-scope="backlog" id="scope-backlog">–ë—ç–∫–ª–æ–≥</button>
          <span class="grow"></span>
        </div>
        <div class="row" style="margin-top:10px">
          <input id="task-date" type="date" style="max-width:180px">
          <input id="task-time" type="time" style="max-width:140px">
          <button class="btn" id="task-add">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <h2>–ó–∞–¥–∞—á–∏</h2>
      <div id="tasks"></div>
    </section>

    <section id="view-plan" class="view">
      <h2>–ü–ª–∞–Ω</h2>
      <div class="card"><div class="muted">–°–∫–æ—Ä–æ —Ç—É—Ç –ø–æ—è–≤–∏—Ç—Å—è —Å–ø—Ä–∏–Ω—Ç-–ø–ª–∞–Ω –∏ HADI-—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã.</div></div>
    </section>

    <section id="view-calendar" class="view">
      <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
      <div class="card"><div class="muted">–ö–∞–ª–µ–Ω–¥–∞—Ä—å —á–∏—Ç–∞–µ—Ç –∑–∞–¥–∞—á–∏ –∏ –¥–µ–¥–ª–∞–π–Ω—ã ‚Äî —Å–µ–π—á–∞—Å –≤ —Ä–µ–∂–∏–º–µ —á—Ç–µ–Ω–∏—è.</div></div>
    </section>

    <section id="view-profile" class="view">
      <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
      <div class="card">
        <div class="muted">–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –æ–±–ª–∞–∫–µ –ø–æ –≤–∞—à–µ–º—É Telegram ID.</div>
        <div class="diag" id="diag">
          <strong>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</strong>
          <div>tg.initData length: <code id="diag-len">-</code></div>
          <div>whoami: <code id="diag-who">‚Äî</code>
            <button class="btn secondary" id="diag-btn" style="margin-left:6px">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
          </div>
          <div>debug: <a id="dbg-link" href="#" target="_blank" rel="noopener">/api/debug</a></div>
        </div>
      </div>
    </section>
  </div>

  <button class="chat-cta" id="chat-open">üí¨ –ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</button>

  <nav>
    <div class="tab active" data-view="home">–ì–ª–∞–≤–Ω–∞—è</div>
    <div class="tab" data-view="plan">–ü–ª–∞–Ω</div>
    <div class="tab" data-view="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
    <div class="tab" data-view="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
  </nav>

  <div class="modal" id="chat">
    <div class="scrim" id="chat-close"></div>
    <div class="sheet">
      <div class="hdr">
        <strong>–ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</strong>
        <button class="btn secondary" id="chat-x">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="messages" id="messages"></div>
      <div class="composer">
        <input id="chat-input" type="text" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–æ –ø–ª–∞–Ω, HADI –∏–ª–∏ –∑–∞–¥–∞—á–∏‚Ä¶" />
        <button class="btn" id="chat-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg?.expand) try{ tg.expand() }catch(e){}
    const tabs = [...document.querySelectorAll('.tab')];

    // === API —Å –Ω–∞–¥—ë–∂–Ω—ã–º —Ñ–æ–ª–±—ç–∫–æ–º (init_data + uid/un/ufn/uln) ===
    const API = (path, opt={}) => {
      const base = window.location.origin;
      const tgw = window.Telegram?.WebApp;
      const initData = tgw?.initData || '';

      const U = tgw?.initDataUnsafe?.user || {};
      const uid = U?.id ? String(U.id) : '';
      const un  = U?.username ? String(U.username) : '';
      const ufn = U?.first_name ? String(U.first_name) : '';
      const uln = U?.last_name ? String(U.last_name) : '';

      const q = new URLSearchParams();
      if (initData) q.set('init_data', initData);
      if (uid) q.set('uid', uid);
      if (un)  q.set('un',  un);
      if (ufn) q.set('ufn', ufn);
      if (uln) q.set('uln', uln);

      const url = `${base}/api${path}${path.includes('?') ? '&' : '?'}${q.toString()}`;

      const headers = Object.assign({
        'Content-Type':'application/json',
        'x-telegram-init-data': initData
      }, (opt.headers || {}));

      return fetch(url, Object.assign({}, opt, {headers}))
        .then(async r=>{
          if(!r.ok){
            let msg = `${r.status}`; try{ const j = await r.json(); msg = (j.error || j.reason || msg) }catch(_){}
            throw new Error(msg);
          }
          return r.status===204 ? {} : (r.json().catch(()=> ({})));
        });
    };

    const toast = (msg, ms=2400)=>{ const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=> t.classList.remove('show'), ms); };

    const scopeButtons = { today:document.getElementById('scope-today'), week:document.getElementById('scope-week'), backlog:document.getElementById('scope-backlog') };
    let currentScope = 'today';
    Object.values(scopeButtons).forEach(b=>{ b.addEventListener('click', ()=>{ currentScope = b.dataset.scope; Object.values(scopeButtons).forEach(x=> x.classList.remove('ok')); b.classList.add('ok'); }); });
    scopeButtons.today.classList.add('ok');

    function buildLocalDate(dateStr, timeStr){
      if(!dateStr && !timeStr) return null;
      if(!dateStr){ const now = new Date(); const [hh='00',mm='00']=String(timeStr||'').split(':'); return new Date(now.getFullYear(),now.getMonth(),now.getDate(),+hh,+mm,0,0); }
      const [y,m,d]=dateStr.split('-').map(Number); const [hh='00',mm='00']=String(timeStr||'').split(':'); return new Date(y,(m-1),d,+hh,+mm,0,0);
    }
    const fmt = dt=> dt.toLocaleString(undefined,{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'});

    async function loadFocus(){ try{ const data = await API('/focus'); document.getElementById('focus-input').value = data?.text || ''; document.getElementById('focus-hint').textContent = data?.updated_at ? `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${fmt(new Date(data.updated_at))}` : ''; }catch{} }
    async function saveFocus(){
      const text = document.getElementById('focus-input').value.trim(); if(!text) return toast('–í–≤–µ–¥–∏—Ç–µ —Ñ–æ–∫—É—Å –¥–Ω—è');
      const btn = document.getElementById('focus-save'); btn.disabled = true;
      try{ await API('/focus',{method:'PUT',body:JSON.stringify({text})}); toast('–§–æ–∫—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úÖ'); loadFocus(); }
      catch(e){ toast(`–û—à–∏–±–∫–∞: ${e.message}`); } finally{ btn.disabled=false; }
    }
    document.getElementById('focus-save').onclick = saveFocus;
    document.getElementById('focus-input').addEventListener('keydown',e=>{ if(e.key==='Enter') saveFocus(); });
    document.getElementById('focus-edit').onclick = ()=>{ const el=document.getElementById('focus-input'); el.focus(); el.select(); };

    const tasksEl = document.getElementById('tasks');
    const empty = ()=>{ const d=document.createElement('div'); d.className='empty'; d.textContent='–ü–æ–∫–∞ –∑–∞–¥–∞—á –Ω–µ—Ç ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é üëá'; tasksEl.appendChild(d); };
    const taskRow = t => {
      const row=document.createElement('div'); row.className='task'+(t.done?' done':'');
      row.innerHTML = `<div class="dot">‚Ä¢</div><div class="grow"><div class="title">${t.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>${t.due_at?`<div class="sub">–î–µ–¥–ª–∞–π–Ω: ${fmt(new Date(t.due_at))}</div>`:''}</div><div class="actions"><button class="toggle" data-action="toggle">‚úì</button><button class="toggle" data-action="delete">‚úï</button></div>`;
      row.querySelector('[data-action="toggle"]').onclick = ()=> toggleTask(t.id,!t.done);
      row.querySelector('[data-action="delete"]').onclick = ()=> removeTask(t.id);
      return row;
    };
    async function loadTasks(){ tasksEl.innerHTML=''; try{ const data=await API('/tasks'); const list=Array.isArray(data?.tasks)?data.tasks:[]; if(!list.length){ empty(); return; } list.forEach(t=> tasksEl.appendChild(taskRow(t))); }catch{ empty(); } }
    async function addTask(){
      const titleEl=document.getElementById('task-title'); const date=document.getElementById('task-date').value; const time=document.getElementById('task-time').value;
      const title=titleEl.value.trim(); if(!title) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
      const due=buildLocalDate(date,time);
      const payload={ title, scope: currentScope, due_at: due ? new Date(due.getTime()-due.getTimezoneOffset()*60000).toISOString() : null };
      const btn=document.getElementById('task-add'); btn.disabled=true;
      try{ await API('/tasks',{method:'POST',body:JSON.stringify(payload)}); titleEl.value=''; toast('–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ ‚úÖ'); await loadTasks(); }
      catch(e){ toast(`–û—à–∏–±–∫–∞: ${e.message}`); } finally{ btn.disabled=false; }
    }
    document.getElementById('task-add').onclick = addTask;
    document.getElementById('task-title').addEventListener('keydown',e=>{ if(e.key==='Enter') addTask(); });
    async function toggleTask(id,done){ try{ await API(`/tasks/${id}`,{method:'PUT',body:JSON.stringify({done})}); await loadTasks(); }catch(e){ toast(`–û—à–∏–±–∫–∞: ${e.message}`); } }
    async function removeTask(id){ if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return; try{ await API(`/tasks/${id}`,{method:'DELETE'}); await loadTasks(); }catch(e){ toast(`–û—à–∏–±–∫–∞: ${e.message}`); } }

    const chat={modal:document.getElementById('chat'),openBtn:document.getElementById('chat-open'),closeBtn:document.getElementById('chat-x'),scrim:document.getElementById('chat-close'),list:document.getElementById('messages'),input:document.getElementById('chat-input'),send:document.getElementById('chat-send')};
    const openChat=()=>{ chat.modal.classList.add('open'); setTimeout(()=>chat.input?.focus(),10); }; const closeChat=()=> chat.modal.classList.remove('open');
    chat.openBtn.onclick=openChat; chat.closeBtn.onclick=closeChat; chat.scrim.onclick=closeChat;
    const pushBubble=(text,me=false)=>{ const b=document.createElement('div'); b.className='bubble '+(me?'me':'ai'); b.textContent=text; chat.list.appendChild(b); chat.list.scrollTop=chat.list.scrollHeight; };
    async function sendChat(){ const q=chat.input.value.trim(); if(!q) return; pushBubble(q,true); chat.input.value=''; try{ const r=await API('/chat',{method:'POST',body:JSON.stringify({q})}); pushBubble(r?.a||'‚Ä¶'); }catch(e){ pushBubble(`–û—à–∏–±–∫–∞: ${e.message}`); } }
    chat.send.onclick=sendChat; chat.input.onkeydown=e=> (e.key==='Enter') && sendChat();

    function updateDiag(){
      const tgw = window.Telegram?.WebApp;
      const initData = (tgw?.initData || '');
      const U = tgw?.initDataUnsafe?.user || {};
      document.getElementById('diag-len').textContent = `${initData.length} (uid=${U?.id||'-'})`;
      const dbg = `${location.origin}/api/debug?init_data=${encodeURIComponent(initData)}&uid=${U?.id||''}`;
      document.getElementById('dbg-link').href = dbg;
    }
    document.getElementById('diag-btn').onclick = async ()=>{
      try{
        const initData = tg?.initData || '';
        const U = tg?.initDataUnsafe?.user || {};
        const r = await fetch(`/api/whoami?init_data=${encodeURIComponent(initData)}&uid=${U?.id||''}`, { headers: { 'x-telegram-init-data': initData } });
        const j = await r.json();
        document.getElementById('diag-who').textContent = JSON.stringify(j);
      }catch(e){
        document.getElementById('diag-who').textContent = String(e);
      }
    };

    (function init(){ updateDiag(); Promise.all([loadFocus(), loadTasks()]); })();
  </script>
</body>
</html>
