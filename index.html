<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Growth Assistant</title>
<style>
  :root{
    --bg:#f5f8ff;
    --card:#ffffff;
    --txt:#0e1116;
    --muted:#76839a;
    --primary:#2d6cff;
    --primary-2:#1a53f0;
    --ok:#26c281;
    --danger:#ff5a5a;
    --shadow:0 10px 24px rgba(18, 35, 104, .10);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    color:var(--txt); background: radial-gradient(1200px 500px at 50% -50%, #eaf1ff, transparent), var(--bg);
  }
  .app{
    min-height:100%; display:flex; flex-direction:column; padding-bottom:86px;
  }
  header{
    padding:14px 18px; display:flex; align-items:center; gap:12px;
    background:linear-gradient(180deg,#f2f7ff,#f8fbff 40%, transparent);
    position:sticky; top:0; z-index:20;
  }
  .brand{display:flex; align-items:center; gap:12px; font-weight:700; font-size:20px}
  .brand .logo{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;
    background:linear-gradient(180deg,#81b3ff,#2d6cff); color:#fff; font-size:18px; box-shadow:var(--shadow)}
  }
  main{padding:10px 14px 18px}
  .section-title{font-weight:800; font-size:22px; margin:8px 4px 14px}

  .card{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:16px; margin:12px 4px;
  }

  .row{display:flex; align-items:center; gap:12px}
  .muted{color:var(--muted)}
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:12px 16px; border-radius:14px; background:var(--primary);
    color:#fff; font-weight:700; border:none; cursor:pointer; box-shadow:0 8px 18px rgba(45,108,255,.22);
    transition:transform .06s ease, box-shadow .2s ease; user-select:none
  }
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#edf3ff; color:var(--primary); box-shadow:none}
  .btn.ghost{background:transparent; color:var(--primary); box-shadow:none}

  .input{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e7ecf6; outline:none;
    background:#fbfdff; box-shadow: inset 0 2px 4px rgba(36,76,160,.04);
    font-size:15px;
  }

  .task{
    display:flex; align-items:flex-start; gap:12px; padding:14px; border-radius:16px;
    background: linear-gradient(180deg,#ffffff, #fbfdff);
    border:1px solid #edf2ff; box-shadow:var(--shadow); margin:10px 0;
  }
  .task .icon{
    width:38px; height:38px; border-radius:12px; background:#edf3ff; display:grid; place-items:center; color:var(--primary);
    flex:0 0 auto; font-size:18px; box-shadow: inset 0 1px 0 #fff;
  }
  .task .title{font-weight:700; font-size:16px}
  .task .sub{color:var(--muted); font-size:14px; margin-top:4px}
  .task .done-btn{
    margin-left:auto; width:34px; height:34px; border-radius:11px; border:1px solid #ecf1fb;
    display:grid; place-items:center; cursor:pointer; background:#fff; color:#8aa6ff;
  }
  .task.done{opacity:.75}
  .task.done .done-btn{background:linear-gradient(180deg,#5fd1a7,#26c281); border-color:#21a472; color:#fff}

  /* Chat bar */
  .chatbar{
    position:sticky; bottom:70px; z-index:12; margin:16px 10px;
    background: linear-gradient(90deg,#7db8ff,#46a0ff);
    color:#fff; padding:16px; border-radius:18px; display:flex; align-items:center; justify-content:center;
    box-shadow:0 14px 30px rgba(34,88,198,.25);
  }
  .chatbar button{all:unset; cursor:pointer; font-weight:800}

  /* Tabs bottom */
  .tabs{
    position:fixed; left:0; right:0; bottom:0; height:70px; padding:8px 10px; backdrop-filter:saturate(120%) blur(10px);
    background: rgba(255,255,255,.84); border-top:1px solid #e8eefb; z-index:25;
    display:grid; grid-template-columns:repeat(4,1fr); gap:10px;
  }
  .tab{
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
    color:#6e7b92; font-size:12px; border-radius:14px; user-select:none; cursor:pointer;
  }
  .tab.active{color:var(--primary); background:#eef4ff}
  .screen{display:none}
  .screen.active{display:block}

  /* Toast */
  .toast{
    position:fixed; left:50%; transform:translateX(-50%); bottom:86px; z-index:50;
    background:#1f2b41; color:#fff; padding:12px 16px; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.18);
    font-size:14px; max-width:90%; text-align:center;
    animation:fade .2s ease;
  }
  @keyframes fade {from{opacity:.6; transform:translate(-50%,8px)} to{opacity:1; transform:translate(-50%,0)}}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand"><div class="logo">‚ö°</div> Growth Assistant</div>
  </header>

  <!-- –≠–∫—Ä–∞–Ω: –°–µ–≥–æ–¥–Ω—è -->
  <main id="screen-home" class="screen active">
    <div class="section-title">–°–µ–≥–æ–¥–Ω—è</div>

    <!-- –§–æ–∫—É—Å –¥–Ω—è -->
    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:10px;">
        <div class="row" style="gap:8px;">
          <div class="logo" style="width:28px;height:28px;font-size:14px;border-radius:8px">‚ö°</div>
          <b>–§–æ–∫—É—Å –¥–Ω—è</b>
        </div>
      </div>
      <div class="row" style="gap:10px;">
        <input id="focus-input" class="input" placeholder="–°–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ —Å–µ–≥–æ–¥–Ω—è‚Ä¶" />
        <button id="focus-save" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      <div id="focus-view" class="row" style="display:none; margin-top:10px; justify-content:space-between;">
        <div id="focus-text" class="muted"></div>
        <button id="focus-edit" class="btn secondary">‚úèÔ∏è</button>
      </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="card">
      <div class="row" style="gap:8px; margin-bottom:8px">
        <div class="logo" style="width:28px;height:28px;font-size:14px;border-radius:8px;background:#28c76f">+</div>
        <b>–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</b>
      </div>
      <input id="task-title" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" style="margin:8px 0 10px" />
      <div class="row" style="gap:8px; margin:8px 0;">
        <button class="btn secondary" data-list="today">–°–µ–≥–æ–¥–Ω—è</button>
        <button class="btn secondary" data-list="week">–ù–µ–¥–µ–ª—è</button>
        <button class="btn secondary" data-list="backlog">–ë—ç–∫–ª–æ–≥</button>
      </div>
      <div class="row" style="gap:8px; margin-top:10px">
        <input id="task-date" class="input" placeholder="–¥–¥.–º–º.–≥–≥–≥–≥" style="max-width:170px" />
        <input id="task-time" class="input" placeholder="--:--" style="max-width:120px" />
        <button id="task-add" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
    <div class="section-title" style="margin-top:4px">–ó–∞–¥–∞—á–∏</div>
    <div id="tasks-list"></div>

    <!-- –ß–∞—Ç -->
    <div class="chatbar"><button id="chat-open">üí¨ –ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</button></div>
  </main>

  <!-- –≠–∫—Ä–∞–Ω: –ü–ª–∞–Ω -->
  <main id="screen-plan" class="screen">
    <div class="section-title">–ü–ª–∞–Ω</div>
    <div class="card muted">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –Ω–µ–¥–µ–ª—å–Ω—ã–π/–º–µ—Å—è—á–Ω—ã–π –æ–±–∑–æ—Ä.</div>
  </main>

  <!-- –≠–∫—Ä–∞–Ω: –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
  <main id="screen-calendar" class="screen">
    <div class="section-title">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
    <div class="card muted">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–¥–∞—á–∏ —Å –¥–µ–¥–ª–∞–π–Ω–∞–º–∏. (read-only)</div>
  </main>

  <!-- –≠–∫—Ä–∞–Ω: –ü—Ä–æ—Ñ–∏–ª—å -->
  <main id="screen-profile" class="screen">
    <div class="section-title">–ü—Ä–æ—Ñ–∏–ª—å</div>
    <div class="card">
      <div class="muted">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å.</div>
    </div>
  </main>

  <!-- –¢–∞–±—ã -->
  <nav class="tabs">
    <div class="tab active" data-tab="home">üè†<div>–ì–ª–∞–≤–Ω–∞—è</div></div>
    <div class="tab" data-tab="plan">üóÇ<div>–ü–ª–∞–Ω</div></div>
    <div class="tab" data-tab="calendar">üìÖ<div>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div></div>
    <div class="tab" data-tab="profile">üë§<div>–ü—Ä–æ—Ñ–∏–ª—å</div></div>
  </nav>
</div>

<script>
  // --- TG init header
  function getInitData() {
    try { return window.Telegram?.WebApp?.initData || ''; } catch { return ''; }
  }
  async function authFetch(url, opts={}) {
    const headers = Object.assign({'content-type':'application/json'}, (opts.headers||{}));
    const init = getInitData();
    if (init) headers['x-telegram-init'] = init;
    return fetch(url, Object.assign({}, opts, { headers }));
  }

  // --- UI helpers
  const toast = (msg) => {
    const t = document.createElement('div');
    t.className = 'toast'; t.textContent = msg;
    document.body.appendChild(t); setTimeout(()=>t.remove(), 2500);
  };

  // --- Tabs
  const screens = {
    home: document.getElementById('screen-home'),
    plan: document.getElementById('screen-plan'),
    calendar: document.getElementById('screen-calendar'),
    profile: document.getElementById('screen-profile'),
  };
  const tabs = Array.from(document.querySelectorAll('.tab'));
  function switchTab(name){
    for (const [key,el] of Object.entries(screens)) el.classList.toggle('active', key===name);
    tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
    window.scrollTo({top:0, behavior:'smooth'});
  }
  tabs.forEach(t=>t.addEventListener('click',()=>switchTab(t.dataset.tab)));

  // --- Data rendering
  const focusInput = document.getElementById('focus-input');
  const focusSave  = document.getElementById('focus-save');
  const focusView  = document.getElementById('focus-view');
  const focusText  = document.getElementById('focus-text');
  const focusEdit  = document.getElementById('focus-edit');

  async function loadFocus(){
    try{
      const r = await authFetch('/api/focus');
      const j = await r.json();
      if (r.ok) {
        if (j.text) {
          focusInput.value = '';
          focusText.textContent = j.text;
          focusView.style.display='flex';
        } else {
          focusView.style.display='none';
        }
      }
    }catch(e){}
  }
  focusSave.addEventListener('click', async ()=>{
    const text = focusInput.value.trim();
    if (!text) return toast('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ñ–æ–∫—É—Å–∞');
    try{
      const r = await authFetch('/api/focus', { method:'PUT', body: JSON.stringify({ text }) });
      if (!r.ok) throw 0;
      toast('–§–æ–∫—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); focusInput.value=''; loadFocus(); loadTasks();
    }catch(e){ toast('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (focus)'); }
  });
  focusEdit.addEventListener('click', ()=>{
    focusInput.value = focusText.textContent || ''; focusView.style.display='none';
  });

  // --- Tasks
  const tasksList  = document.getElementById('tasks-list');
  const addBtn     = document.getElementById('task-add');
  const titleIn    = document.getElementById('task-title');
  const dateIn     = document.getElementById('task-date');
  const timeIn     = document.getElementById('task-time');
  let currentList  = 'today';
  document.querySelectorAll('[data-list]').forEach(b=>{
    b.addEventListener('click', ()=>{ currentList=b.dataset.list; toast('–°–ø–∏—Å–æ–∫: '+(b.textContent.trim())); });
  });

  function taskNode(item){
    const el = document.createElement('div');
    el.className = 'task'+(item.done?' done':'');
    el.innerHTML = `
      <div class="icon">üß©</div>
      <div style="flex:1">
        <div class="title">${escapeHtml(item.title)}</div>
        ${item.note ? `<div class="sub">${escapeHtml(item.note)}</div>` : ``}
      </div>
      <div class="done-btn" title="–ì–æ—Ç–æ–≤–æ">${item.done ? '‚úîÔ∏è' : '‚ûî'}</div>
    `;
    const btn = el.querySelector('.done-btn');
    btn.addEventListener('click', async ()=>{
      try{
        const r = await authFetch('/api/tasks/'+item.id, {
          method:'PUT',
          body: JSON.stringify({ done: !item.done })
        });
        const j = await r.json().catch(()=>({}));
        if (!r.ok) throw new Error(j.error||'ERR');
        item.done = !!j.done;
        el.classList.toggle('done', item.done);
        btn.textContent = item.done ? '‚úîÔ∏è' : '‚ûî';
      }catch(e){
        toast('API: 500 ‚Äî ' + (e.message || 'server error'));
      }
    });
    return el;
  }

  async function loadTasks(){
    tasksList.textContent='';
    try{
      const r = await authFetch('/api/tasks?list=today');
      const j = await r.json();
      if (!r.ok) throw 0;
      (j.items||[]).forEach(x=>tasksList.appendChild(taskNode(x)));
    }catch(e){ toast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á–∏'); }
  }

  addBtn.addEventListener('click', async ()=>{
    const title = titleIn.value.trim();
    if (!title) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
    // –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ ‚Üí ISO
    let deadline = null;
    try{
      if (dateIn.value.trim()) {
        const [d,m,y] = dateIn.value.trim().split('.').map(n=>parseInt(n,10));
        if (y && m && d) {
          const [hh,mm] = (timeIn.value||'00:00').split(':').map(n=>parseInt(n,10));
          const dt = new Date(Date.UTC(y, (m-1), d, hh||0, mm||0, 0));
          deadline = dt.toISOString();
        }
      }
    }catch(e){}
    try{
      const r = await authFetch('/api/tasks', {
        method:'POST',
        body: JSON.stringify({ title, list: currentList, deadline })
      });
      const j = await r.json().catch(()=>({}));
      if (!r.ok) throw new Error(j.error||'ERR');
      titleIn.value=''; dateIn.value=''; timeIn.value='';
      tasksList.prepend(taskNode(j));
    }catch(e){ toast('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (task)'); }
  });

  // --- utils
  function escapeHtml(s=''){ return s.replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // --- Chat open (–∑–∞–≥–ª—É—à–∫–∞)
  document.getElementById('chat-open').addEventListener('click', ()=> toast('–ß–∞—Ç –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø–æ–∑–∂–µ ‚ú®'));

  // init
  (async function init(){
    // dev-–ø—Ä–æ–≤–µ—Ä–∫–∞ whoami (–Ω–µ –º–µ—à–∞–µ—Ç –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É)
    try{
      const r = await authFetch('/api/whoami'); if (r.ok) { /* ok */ }
    }catch(e){}
    await loadFocus(); await loadTasks();
  })();
</script>
</body>
</html>
