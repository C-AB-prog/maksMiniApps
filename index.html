<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Growth Assistant</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
/* ==== –¥–∏–∑–∞–π–Ω —Ç–æ–∫–µ–Ω—ã, –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ ==== */
:root{
  --ink: #0E1220;
  --muted:#6B7280;
  --line:#E7ECF5;

  --brand:#5B6CFF;
  --brand-2:#7F6BFF;
  --brand-3:#46C7F4;

  --ok:#10B981;
  --warn:#F59E0B;
  --danger:#EF4444;

  --bg: #F3F6FF;
  --bg-grad: radial-gradient(1200px 600px at 100% -10%, rgba(123, 195, 255, .20), transparent 60%),
             radial-gradient(900px 500px at -10% 0%, rgba(135, 121, 255, .18), transparent 55%),
             #F3F6FF;

  --card: rgba(255,255,255,.92);
  --card-blur: blur(10px);

  --r: 18px;
  --shadow: 0 10px 28px rgba(17,24,39,.10);
  --shadow-2: 0 16px 40px rgba(91,108,255,.20);

  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-top:    env(safe-area-inset-top, 0px);
}

*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  color:var(--ink);
  font:15px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:var(--bg-grad);
  -webkit-tap-highlight-color: transparent;
  transition: background 0.3s ease;
}

/* APPBAR */
.appbar{
  position:sticky; top:0; z-index:20;
  padding: calc(12px + var(--safe-top)) 18px 12px;
  background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.65));
  backdrop-filter: saturate(160%) blur(12px);
  border-bottom:1px solid var(--line);
  transition: all 0.3s ease;
}
.appbar h1{
  margin:0; font-size:22px; font-weight:900; letter-spacing:.2px;
  background: linear-gradient(90deg, var(--brand), var(--brand-2));
  -webkit-background-clip:text; background-clip:text; color:transparent;
}
.appbar .sub{color:var(--muted); font-size:12px}

/* LAYOUT */
.container{max-width:940px;margin:0 auto;padding:16px 14px 110px}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  padding:18px;
  backdrop-filter: var(--card-blur);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
/* –¢–∞–ø-—ç—Ñ—Ñ–µ–∫—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è touch-—É—Å—Ç—Ä–æ–π—Å—Ç–≤ ‚Äî –∏–Ω–∞—á–µ –∏–Ω–æ–≥–¥–∞ –º–µ—à–∞–µ—Ç —Ñ–æ–∫—É—Å—É –∏–Ω–ø—É—Ç–æ–≤ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
@media (hover: none) and (pointer: coarse) {
  .card:active { transform: scale(0.98); }
}
h3{margin:0 0 14px 0; font-size:16px; font-weight:700}

section{display:none;gap:16px; animation: fadeIn 0.3s ease;}
section.active{display:grid}
.grid-2{grid-template-columns:1fr}
@media (min-width: 860px){
  .grid-2{grid-template-columns:1.15fr .85fr}
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* INPUTS/BUTTONS */
label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
.input, input[type="text"], input[type="datetime-local"], select{
  width:100%; background:#fff; border:1px solid var(--line); border-radius:14px; padding:12px 14px; outline:none;
  transition:border-color .2s, box-shadow .2s;
  font:inherit;
}
.input:focus, input[type="text"]:focus, input[type="datetime-local"]:focus, select:focus{
  border-color:var(--brand);
  box-shadow:0 0 0 3px rgba(91,108,255,.12);
}
.btn{
  appearance:none; border:none; padding:12px 16px; border-radius:14px;
  background:linear-gradient(135deg, var(--brand), var(--brand-2));
  color:#fff; cursor:pointer; font-weight:800; letter-spacing:.2px;
  box-shadow:var(--shadow-2);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
}
.btn:active { transform: scale(0.95); box-shadow: 0 4px 12px rgba(91,108,255,.3); }
.btn.secondary{ background:#fff;color:var(--ink); border:1px solid var(--line); box-shadow:none; font-weight:700; }
.btn.ghost{background:rgba(91,108,255,.10); color:var(--brand); box-shadow:none}
.btn.icon{padding:8px 10px; border-radius:999px; min-width:34px; display:inline-flex; align-items:center; justify-content:center}

/* FLOATING ACTION BUTTON */
.floating-action-btn {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--brand), var(--brand-2));
  color: white;
  border: none;
  box-shadow: 0 8px 25px rgba(91,108,255,.4);
  cursor: pointer;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  animation: pulse 2s infinite;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
}
.floating-action-btn:active { transform: scale(0.85); box-shadow: 0 4px 15px rgba(91,108,255,.3); animation:none; }
@keyframes pulse {
  0% { transform: scale(1); box-shadow: 0 8px 25px rgba(91,108,255,.4); }
  50% { transform: scale(1.05); box-shadow: 0 12px 35px rgba(91,108,255,.6); }
  100% { transform: scale(1); box-shadow: 0 8px 25px rgba(91,108,255,.4); }
}

/* CHIPS */
.seg{display:flex;gap:8px;flex-wrap:wrap}
.seg .chip,
.plan-filters .chip{
  padding:7px 13px;
  border-radius:999px;
  border:1px solid var(--line);
  background:#fff;
  cursor:pointer;
  font-weight:600;
  font-size:13px;
  transition:all .15s;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
}
.seg .chip:active,
.plan-filters .chip:active { transform: scale(0.95); }
.seg .chip.active,
.plan-filters .chip.active{
  background:linear-gradient(135deg, var(--brand), var(--brand-2));
  color:#fff;
  border-color:transparent;
  box-shadow:0 8px 22px rgba(91,108,255,.28)
}

/* TASK LIST */
.list{display:flex;flex-direction:column;gap:10px}
.task{
  display:flex;align-items:flex-start;gap:12px;padding:14px 14px;
  border:1px solid var(--line); border-radius:16px; background:#fff;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
  animation: slideIn 0.3s ease;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
  position: relative;
}
.task:active { transform: scale(0.98); background: #f8faff; }
.task .ttl{flex:1; font-size:14px; line-height:1.4; font-weight:500; padding-right: 8px;}
.task.done{opacity:.7}
.task.done .ttl{text-decoration: line-through; color: var(--muted);}

.task-meta { display:flex; flex-direction:column; align-items:flex-end; gap:6px; min-width:fit-content; }
.badge{ font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted); white-space: nowrap; }
.badge.ok{color:#065f46;border-color:#10b981;background:#ecfdf5}
.badge.due{color:#7c2d12;border-color:#f59e0b;background:#fffbeb}
.badge.dead{color:#991b1b;border-color:#ef4444;background:#fef2f2}
.badge.team{
  margin-left:0;
  font-size:10px;
  background:#eef2ff;
  border-color:#c7d2fe;
  color:#4f46e5;
  display: flex;
  align-items: center;
  gap: 4px;
}
.badge.team::before { content:"üë•"; font-size:9px; }

.task.team-task { border-left: 4px solid #c7d2fe; background: linear-gradient(to right, #f8faff, #ffffff); }
.task-actions { display:flex; gap:6px; align-items:center; }
@keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

/* FOCUS CARD */
.focus-current{
  border-radius:16px;
  border:1px dashed #c7d2fe;
  background:#f5f7ff;
  padding:12px 14px;
  margin-bottom:10px;
  animation: gentlePulse 3s infinite;
}
.focus-current-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;}
.focus-current-text{font-weight:600;font-size:14px;}
.focus-edit-fields{display:flex;gap:10px;flex-wrap:wrap}
@keyframes gentlePulse {
  0% { box-shadow: 0 0 0 0 rgba(91,108,255,0.1); transform: scale(1); }
  50% { box-shadow: 0 0 0 4px rgba(91,108,255,0.05); transform: scale(1.005); }
  100% { box-shadow: 0 0 0 0 rgba(91,108,255,0.1); transform: scale(1); }
}

/* CHAT */
.chat-container{display:flex;flex-direction:column;gap:14px}
.chat-list{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:12px;
  margin-bottom:16px;
}
.chat-item{
  background:#fff;
  border:2px solid var(--line);
  border-radius:16px;
  padding:16px 12px;
  text-align:center;
  cursor:pointer;
  transition:all .15s;
  min-height:120px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  position:relative;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
}
.chat-item:active{
  transform: scale(0.95);
  border-color:var(--brand);
  background: linear-gradient(135deg,#f8faff,#f0f4ff);
}
.chat-item.active{
  border-color:var(--brand);
  background:linear-gradient(135deg,#f8faff,#f0f4ff);
  box-shadow:0 8px 25px rgba(91,108,255,.15);
  animation: chatPulse 2s infinite;
}
.chat-item.new{ border:2px dashed var(--muted); background:transparent; }
.chat-item.new:active{ border-color:var(--brand); background:rgba(91,108,255,.03); transform: scale(0.95); }
.chat-icon{font-size:24px;margin-bottom:8px;opacity:.7}
.chat-item.active .chat-icon,
.chat-item:active .chat-icon{opacity:1}
.chat-title{font-weight:600;font-size:13px;line-height:1.3;margin-bottom:4px}
.chat-date{font-size:11px;color:var(--muted)}
@keyframes chatPulse {
  0% { border-color: var(--brand); box-shadow: 0 0 0 0 rgba(91,108,255,.3); }
  50% { border-color: var(--brand-2); box-shadow: 0 0 0 4px rgba(91,108,255,.1); }
  100% { border-color: var(--brand); box-shadow: 0 0 0 0 rgba(91,108,255,.3); }
}

/* CHAT WINDOW */
.chat-window-overlay{
  display:none;position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,.35);z-index:1000;
  animation: fadeIn 0.3s ease;
}
.chat-window-overlay.active{display:flex}
.chat-window{
  display:flex;flex-direction:column;
  width:100%;height:100%;
  background:#fff;border-radius:0;
  box-shadow:none;
  animation: slideUp 0.3s ease;
}
.chat-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:16px 20px;border-bottom:1px solid var(--line);background:#fff;flex-shrink:0;
}
.chat-header-title{font-weight:600;font-size:16px}
.chat-body{
  flex:1;overflow:auto;padding:16px;
  display:flex;flex-direction:column;gap:12px;
  background:linear-gradient(180deg,#FAFBFF,#F7FAFF)
}
.bubble{
  max-width:75%;padding:12px 16px;border-radius:18px;
  font-size:14px;line-height:1.4;word-wrap:break-word;
  animation: bubbleIn 0.3s ease;
}
.me{ align-self:flex-end; background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff;border-bottom-right-radius:6px }
.bot{ align-self:flex-start;background:#fff;border:1px solid var(--line); border-bottom-left-radius:6px }
.chat-foot{ display:flex;gap:10px;padding:12px 16px; border-top:1px solid var(--line);background:#fff;flex-shrink:0; }
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes bubbleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

/* MODAL */
.modal{
  display:none;position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,.5);z-index:1100;align-items:center;justify-content:center;
  animation: fadeIn 0.3s ease;
}
.modal.active{display:flex}
.modal-content{
  background:#fff;border-radius:20px;padding:24px;
  max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.2);
  animation: modalIn 0.3s ease;
}
.modal-title{margin:0 0 16px 0;font-size:18px;font-weight:700}
@keyframes modalIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* NAV */
.nav{
  position:fixed;left:0;right:0;bottom:0;z-index:25;
  padding:10px 10px calc(10px + var(--safe-bottom));
  background:rgba(255,255,255,.9);border-top:1px solid var(--line);
  backdrop-filter:saturate(160%) blur(10px);
  box-shadow:0 -8px 24px rgba(17,24,39,.08);
  display:flex;justify-content:space-around;
  transition: all 0.3s ease;
}
.nav .item{
  display:flex;flex-direction:column;align-items:center;gap:4px;
  min-width:64px;color:var(--muted);font-size:12px;
  transition: all 0.15s ease;
  padding: 8px 4px;
  border-radius: 12px;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
}
.nav .item:active { transform: scale(0.9); background: rgba(91,108,255,0.1); }
.nav .item svg{opacity:.6;transition:opacity .15s, transform .06s}
.nav .item.active{color:var(--brand); background: rgba(91,108,255,0.08);}
.nav .item.active svg{ opacity:1;transform:translateY(-1px); filter:drop-shadow(0 4px 8px rgba(91,108,255,.35)) }

/* CALENDAR EXPORT (Plan bottom button) */
.export-bar{
  position: fixed;
  left: 12px;
  right: 12px;
  bottom: calc(78px + var(--safe-bottom));
  z-index: 26;
  display:none;
}
.export-bar .btn{ width:100%; }

/* TOAST */
.toast{
  position:fixed;left:50%;bottom:calc(78px + var(--safe-bottom));
  transform:translateX(-50%);background:#111827;color:#fff;
  padding:10px 14px;border-radius:12px;
  box-shadow:0 10px 20px rgba(0,0,0,.2);z-index:999;
  max-width:90%;font-size:13px;
  animation: toastIn 0.3s ease, toastOut 0.3s ease 1.7s forwards;
}
.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace}
.muted{color:var(--muted)}
@keyframes toastIn { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
@keyframes toastOut { from { opacity: 1; transform: translate(-50%, 0); } to { opacity: 0; transform: translate(-50%, 20px); } }

/* PROFILE */
.profile-section{margin-bottom:20px}
.profile-section h4{margin:0 0 12px 0;font-size:15px;color:var(--ink)}
.profile-actions{display:flex;flex-direction:column;gap:8px}
.profile-btn{
  display:flex;justify-content:space-between;align-items:center;
  padding:14px 16px;background:#fff;border:1px solid var(--line);border-radius:14px;
  cursor:pointer;transition:all .15s;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
}
.profile-btn:active { transform: scale(0.98); background: var(--bg); border-color: var(--brand); }
.profile-btn .arrow{color:var(--muted);font-size:14px}
.lang-switch{display:flex;gap:8px;margin-top:8px}
.lang-btn{
  padding:8px 12px;border:1px solid var(--line);
  border-radius:10px;background:#fff;cursor:pointer;flex:1;text-align:center;
  transition: all 0.15s ease;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
}
.lang-btn:active { transform: scale(0.95); }
.lang-btn.active{background:var(--brand);color:#fff;border-color:var(--brand);}

/* PLAN UI */
.plan-top{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
.plan-mode{display:flex;gap:6px}
.plan-mode .pill{
  flex:1;text-align:center;padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:#fff;
  font-size:13px;
  cursor:pointer;
  font-weight:600;
  transition: all 0.15s ease;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
}
.plan-mode .pill:active { transform: scale(0.95); }
.plan-mode .pill.active{
  background:linear-gradient(135deg,var(--brand),var(--brand-2));
  color:#fff;
  border-color:transparent;
  box-shadow:0 8px 22px rgba(91,108,255,.2);
}
.plan-filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}

/* TEAM layout */
.plan-team-wrapper{position:relative;min-height:140px;margin-top:10px}
.team-list{display:flex;flex-direction:column;gap:8px}
.team-list-item{
  padding:10px 12px;border-radius:14px;
  border:1px solid var(--line);background:#fff;
  display:flex;justify-content:space-between;align-items:center;
  cursor:pointer;
  transition: all 0.15s ease;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
}
.team-list-item:active { transform: scale(0.98); border-color: var(--brand); background: #f8faff; }
.team-list-item span.name{font-weight:600}
.team-list-empty{text-align:center;padding:24px 12px}

.team-detail{display:flex;flex-direction:column;gap:10px;margin-top:4px}
.team-detail-header{display:flex;justify-content:space-between;align-items:center;gap:8px}

/* ‚úÖ –í–ê–ñ–ù–û: –¥–µ–ª–∞–µ–º —ç—Ç–æ "–≤ –æ–¥–Ω—É —Å—Ç—Ä–æ—á–∫—É" –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
.team-header-actions{
  display:flex;
  gap:8px;
  flex-wrap:nowrap;          /* –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å */
  align-items:center;
  justify-content:flex-end;
  min-width:0;
}
.team-code-pill{
  font-size:11px;padding:6px 10px;border-radius:999px;
  background:#eef2ff;color:#4f46e5;
  white-space:nowrap;
  max-width:48vw;
  overflow:hidden;
  text-overflow:ellipsis;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.team-detail-title{font-size:15px;font-weight:700;display:flex;align-items:center;gap:6px}

.team-members-toggle{
  display:flex;justify-content:space-between;align-items:center;
  padding:8px 10px;border-radius:12px;border:1px solid var(--line);
  background:#fff;cursor:pointer;font-size:13px;margin-top:4px;
  transition: all 0.15s ease;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
}
.team-members-toggle:active { transform: scale(0.98); background: #f8faff; }
.team-members-box{margin-top:4px;padding-left:4px}
.team-members-box ul{margin:4px 0 0 14px;padding:0}
.team-members-box li{font-size:13px;margin-bottom:2px}
.quick-team-row{display:none;gap:8px}
.quick-team-row.visible{display:flex}

/* MOBILE tweaks */
@media (max-width: 600px){
  .container { padding: 12px 10px 110px; }
  .card { padding: 14px; }
  .task{align-items:flex-start;padding:9px 9px}
  .team-detail-header{flex-direction:column;align-items:flex-start}
  .team-header-actions{justify-content:flex-start; width:100%;}
  .team-code-pill{max-width:100%;}
  .appbar { padding: calc(10px + var(--safe-top)) 14px 10px; }
  .appbar h1 { font-size: 20px; }
  .grid-2 { gap: 12px; }
  .nav .item { min-width: 56px; font-size: 11px; }
  .stats-grid .card-mini { min-width: calc(50% - 6px); }
  .floating-action-btn { width: 56px; height: 56px; bottom: 80px; right: 16px; font-size: 22px; }
}

/* STATS */
.stats-grid{display:flex;flex-wrap:wrap;gap:12px}
.stats-grid .card-mini{
  flex:1;min-width:160px;background:#fff;
  border-radius:14px;border:1px solid var(--line);
  padding:10px 12px;
  transition: transform 0.15s ease;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
}
.stats-grid .card-mini:active { transform: scale(0.98); }

/* Week chart */
#week-chart{ height:200px;display:flex;align-items:flex-end; gap:4px;margin-top:20px; }

/* Loading */
.loading { display:inline-block; width:20px; height:20px; border:3px solid rgba(91,108,255,.3); border-radius:50%; border-top-color:var(--brand); animation: spin 1s ease-in-out infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Touch improvements */
@media (hover: none) and (pointer: coarse) {
  .card:hover,.task:hover,.team-list-item:hover,.profile-btn:hover,.stats-grid .card-mini:hover { transform:none; }
  .btn, .chip, .nav .item, .profile-btn { min-height:44px; }
  .btn.icon { min-width:44px; min-height:44px; }
  .task { min-height:60px; }
  .team-list-item { min-height:50px; }
}
/* input-select-fix */
input, textarea{ -webkit-user-select:text; user-select:text; touch-action:auto; }

</style>
</head>

<body>

<!-- APP BAR -->
<div class="appbar">
  <h1>Growth Assistant</h1>
  <div class="sub">–§–æ–∫—É—Å ‚Ä¢ –∑–∞–¥–∞—á–∏ ‚Ä¢ –ø–ª–∞–Ω ‚Ä¢ —á–∞—Ç ‚Ä¢ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
</div>

<div class="container">

  <!-- HOME -->
  <section id="screen-home" class="active grid-2">
    <div class="card">
      <h3>–§–æ–∫—É—Å</h3>

      <div id="focus-current" class="focus-current" style="display:none">
        <div class="focus-current-top">
          <span>–¢–µ–∫—É—â–∏–π —Ñ–æ–∫—É—Å</span>
          <button id="focus-edit-btn" class="btn secondary icon" title="–ò–∑–º–µ–Ω–∏—Ç—å">‚úé</button>
        </div>
        <div id="focus-current-text" class="focus-current-text"></div>
      </div>

      <div id="focus-edit-row">
        <label id="focus-edit-label">–°–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ —Å–µ–≥–æ–¥–Ω—è</label>
        <div class="focus-edit-fields">
          <input id="focus-input" class="input" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∑–∞–∫—Ä—ã—Ç—å –æ—Ç—á—ë—Ç" />
          <button id="focus-save" class="btn" style="white-space:nowrap">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</h3>
      <div class="seg" style="margin-bottom:8px">
        <div class="chip" data-prio="today">–°–µ–≥–æ–¥–Ω—è</div>
        <div class="chip" data-prio="week">–ù–µ–¥–µ–ª—è</div>
        <div class="chip" data-prio="month">–ú–µ—Å—è—Ü</div>
        <div class="chip" data-prio="team">–ö–æ–º–∞–Ω–¥–∞</div>
      </div>

      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="quick-title" class="input" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" />
        <input id="quick-due" class="input" type="datetime-local" />
        <div class="quick-team-row" id="quick-team-row">
          <select id="quick-team-select" class="input">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>
          </select>
        </div>
        <div class="quick-team-row" id="quick-assignee-row">
          <select id="quick-assignee-select" class="input" disabled>
            <option value="">–ö–æ–º—É: –≤—Å–µ–º</option>
          </select>
        </div>
        <button id="quick-add" class="btn">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
      </div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <h3>–ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
      <div id="tasks-today" class="list"></div>
    </div>
  </section>

  <!-- PLAN -->
  <section id="screen-plan" class="grid-2">
    <div class="card">
      <div class="plan-top">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">–ü–ª–∞–Ω –∑–∞–¥–∞—á</h3>
        </div>
        <div class="plan-mode">
          <div id="mode-my"   class="pill active">–ú–æ–∏</div>
          <div id="mode-team" class="pill">–ö–æ–º–∞–Ω–¥—ã</div>
        </div>
      </div>

      <div id="my-filters" class="plan-filters">
        <div class="chip" data-plan-filter="all">–í—Å–µ</div>
        <div class="chip" data-plan-filter="today">–°–µ–≥–æ–¥–Ω—è</div>
        <div class="chip" data-plan-filter="week">–ù–µ–¥–µ–ª—è</div>
        <div class="chip" data-plan-filter="month">–ú–µ—Å—è—Ü</div>
      </div>

      <div id="plan-my-list" class="list"></div>

      <!-- TEAM BLOCK -->
      <div id="plan-team-block" class="plan-team-wrapper" style="display:none;">
        <div id="team-list-box" class="team-list"></div>

        <div id="team-detail-box" class="team-detail" style="display:none">
          <button id="team-back" class="btn ghost icon" style="align-self:flex-start; margin-bottom:4px">‚Üê</button>

          <div class="team-detail-header">
            <div class="team-detail-title">
              <span id="team-name-label">–ö–æ–º–∞–Ω–¥–∞</span>
              <button id="team-rename" class="btn secondary icon" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">‚úé</button>
            </div>

            <div class="team-header-actions">
              <div class="team-code-pill" id="team-code-pill">
                –ö–æ–¥: <span id="team-code-short">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
              </div>
              <button id="team-code-copy" class="btn secondary icon" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥">üìã</button>
              <button id="team-delete" class="btn secondary" style="font-size:11px;padding:6px 10px">–†–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
          </div>

          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <span style="font-weight:600;font-size:14px">–ó–∞–¥–∞—á–∏ –∫–æ–º–∞–Ω–¥—ã</span>
            </div>
            <div id="team-tasks-list" class="list"></div>
          </div>

          <div>
            <div id="team-members-toggle" class="team-members-toggle">
              <span>–£—á–∞—Å—Ç–Ω–∏–∫–∏</span>
              <span id="team-members-arrow">‚ñæ</span>
            </div>
            <div id="team-members-box" class="team-members-box" style="display:none">
              <ul id="team-members-list"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CHAT -->
  <section id="screen-chat" class="grid">
    <div class="card">
      <h3>–ú–æ–∏ —á–∞—Ç—ã —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</h3>
      <div class="chat-container">
        <div id="chat-list" class="chat-list"></div>

        <div id="no-chats-message" style="text-align: center; padding: 40px 20px;">
          <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">üí¨</div>
          <h3 style="margin: 0 0 8px 0;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</h3>
          <p class="muted">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</p>
          <button class="btn" id="create-first-chat" style="margin-top: 16px;">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
        </div>
      </div>
    </div>
  </section>

  <!-- STATS -->
  <section id="screen-stats" class="grid grid-2">
    <div class="card">
      <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
      <div class="stats-grid" style="margin-top:6px">
        <div class="card-mini"><label>–í—Å–µ–≥–æ –∑–∞–¥–∞—á</label><div id="m-total" style="font-size:22px;font-weight:800">0</div></div>
        <div class="card-mini"><label>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</label><div id="m-done" style="font-size:22px;font-weight:800;color:var(--ok)">0</div></div>
        <div class="card-mini"><label>–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞</label><div id="m-rate" style="font-size:22px;font-weight:800">0%</div></div>
        <div class="card-mini"><label>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</label><div id="m-over" style="font-size:22px;font-weight:800;color:var(--danger)">0</div></div>
      </div>
      <p class="muted" style="margin-top:12px">
        <b>–ì–∏–ø–æ—Ç–µ–∑–∞:</b> ¬´–ï—Å–ª–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –∏ —Å—Ç–∞—Å—Ç–∞–≤–ª—è—Ç—å –¥–µ–¥–ª–∞–π–Ω—ã, –∑–∞–≤–µ—Ä—à—É ‚â•70% –≤–æ–≤—Ä–µ–º—è¬ª.<br/>
        <b>–î–µ–π—Å—Ç–≤–∏–µ:</b> –¥–æ–±–∞–≤–ª—è–π/–∑–∞–∫—Ä—ã–≤–∞–π –∑–∞–¥–∞—á–∏ –≤–æ–≤—Ä–µ–º—è. <b>–î–∞–Ω–Ω—ã–µ:</b> –º–µ—Ç—Ä–∏–∫–∏ –≤—ã—à–µ. <b>–ò–Ω—Å–∞–π—Ç:</b> –¥–µ—Ä–∂–∏ ‚â•70%.
      </p>
    </div>
    <div class="card">
      <h3>–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
      <div id="week-chart"></div>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="screen-profile" class="grid">
    <div class="card">
      <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
      <div class="muted" style="margin-bottom:16px">Telegram ID: <span id="profile-id" class="mono">‚Äì</span></div>

      <div class="profile-section">
        <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
        <label>–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</label>
        <div class="lang-switch">
          <div class="lang-btn active" data-lang="ru">–†—É—Å—Å–∫–∏–π</div>
          <div class="lang-btn" data-lang="en">English</div>
        </div>
      </div>

      <div class="profile-section">
        <h4>–ê–∫–∫–∞—É–Ω—Ç</h4>
        <div class="profile-actions">
          <div class="profile-btn" id="btn-tariff">
            <span>–¢–∞—Ä–∏—Ñ</span>
            <span style="color:var(--brand);font-weight:600">–ü—Ä–æ–±–Ω—ã–π</span>
          </div>
        </div>
      </div>

      <div class="profile-section">
        <h4>–ü–æ–º–æ—â—å</h4>
        <div class="profile-actions">
          <div class="profile-btn" id="btn-help">
            <span>–ü–æ–º–æ—â—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞</span>
            <span class="arrow">‚Ä∫</span>
          </div>
          <div class="profile-btn" id="btn-guide">
            <span>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</span>
            <span class="arrow">‚Ä∫</span>
          </div>
          <div class="profile-btn" id="btn-consult">
            <span>–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</span>
            <span class="arrow">‚Ä∫</span>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- FLOATING ACTION BUTTON -->
<button id="team-fab-btn" class="floating-action-btn" style="display: none;">+</button>

<!-- TEAM MENU -->
<div id="team-menu" class="modal">
  <div class="modal-content">
    <h3 class="modal-title">–î–µ–π—Å—Ç–≤–∏—è —Å –∫–æ–º–∞–Ω–¥–æ–π</h3>
    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 16px;">
      <button id="team-menu-create" class="btn">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</button>
      <button id="team-menu-join" class="btn secondary">–í—Å—Ç—É–ø–∏—Ç—å –ø–æ –∫–æ–¥—É</button>
      <button id="team-menu-close" class="btn ghost" style="margin-top: 8px;">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<!-- CHAT WINDOW -->
<div id="chat-window-overlay" class="chat-window-overlay">
  <div class="chat-window">
    <div class="chat-header">
      <div class="chat-header-title" id="current-chat-title">–ù–æ–≤—ã–π —á–∞—Ç</div>
      <div class="chat-header-actions">
        <button class="btn ghost icon" id="close-chat">‚úï</button>
      </div>
    </div>
    <div id="chat-body" class="chat-body">
      <div class="bubble bot">–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
    </div>
    <div class="chat-foot">
      <input id="chat-input" class="input" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
      <button id="chat-send" class="btn" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
    </div>
  </div>
</div>

<!-- NEW CHAT MODAL -->
<div id="new-chat-modal" class="modal">
  <div class="modal-content">
    <h3 class="modal-title">–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞</h3>
    <input type="text" id="new-chat-title" class="input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" style="margin-bottom: 16px;">
    <div style="display: flex; gap: 10px;">
      <button class="btn secondary" id="cancel-new-chat" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn" id="confirm-new-chat" style="flex: 1;">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- CALENDAR EXPORT BAR (shown on Plan screen) -->
<div id="export-bar" class="export-bar">
  <button id="export-calendar" class="btn">–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–¥–∞—á</button>
</div>

<!-- NAV -->
<nav class="nav">
  <div class="item active" data-go="home">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 7v10a1 1 0 0 1-1 1h-6v-6H10v6H4a1 1 0 0 1-1-1V10l9-7z"/></svg>
    –ì–ª–∞–≤–Ω–∞—è
  </div>
  <div class="item" data-go="plan">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M4 5h16v2H4zM4 11h16v2H4zM4 17h10v2H4z"/></svg>
    –ü–ª–∞–Ω
  </div>
  <div class="item" data-go="chat">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
    –ß–∞—Ç
  </div>
  <div class="item" data-go="stats">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/></svg>
    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  </div>
  <div class="item" data-go="profile">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.42 0-8 2.24-8 5v3h16v-3c0-2.76-3.58-5-8-5z"/></svg>
    –ü—Ä–æ—Ñ–∏–ª—å
  </div>
</nav>

<div id="toast" class="toast" style="display:none"></div>

<script>
/* helpers */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const showToast = (t) => {
  const el = $('#toast');
  el.textContent=t;
  el.style.display='block';
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>el.style.display='none',2000);
};
const startOfDay = d => { const x = new Date(d); x.setHours(0,0,0,0); return x; };
const endOfDay   = d => { const x = new Date(d); x.setHours(23,59,59,999); return x; };
const addDays    = (d,n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x;};

function normalizeDue(v){
  if (v === null || v === undefined) return null;
  if (typeof v === 'string' && v.trim().toLowerCase() === 'null') return null;
  const num = Number(v);
  if (!Number.isNaN(num) && v !== '' && v !== true && v !== false) {
    const ms = num < 1e12 ? num * 1000 : num;
    return ms;
  }
  let ms = Date.parse(v);
  if (!Number.isNaN(ms)) return ms;
  if (typeof v === 'string' && /^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}(:\d{2})?$/.test(v)) {
    const iso = v.trim().replace(' ', 'T') + 'Z';
    ms = Date.parse(iso);
    if (!Number.isNaN(ms)) return ms;
  }
  return null;
}
function fmt(ts){
  const ms = normalizeDue(ts);
  if (ms === null) return '‚Äî';
  const d = new Date(ms);
  if (Number.isNaN(d.getTime())) return '‚Äî';
  return d.toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
}

// --- normalize rows from Postgres (Neon —á–∞—Å—Ç–æ –æ—Ç–¥–∞—ë—Ç BIGINT –∫–∞–∫ —Å—Ç—Ä–æ–∫—É) ---
function normalizeTaskRow(t){
  if (!t || typeof t !== 'object') return t;
  const toNum = (v) => (v === null || v === undefined || v === '' ? null : Number(v));
  const id = t.id != null ? Number(t.id) : t.id;
  const team_id = t.team_id == null ? null : Number(t.team_id);
  const assigned_to_user_id = t.assigned_to_user_id == null ? null : Number(t.assigned_to_user_id);
  const due_ts = normalizeDue(t.due_ts);
  const is_done = !!t.is_done;
  return { ...t, id, team_id, assigned_to_user_id, due_ts, is_done };
}

/* tg id (—É—Å—Ç–æ–π—á–∏–≤–æ: query ‚Üí Telegram ‚Üí localStorage) */
let tgId = 0;

function resolveTgId() {
  try {
    // 1) tg_id –∏–∑ query
    const qid = new URLSearchParams(location.search).get('tg_id');
    if (qid) tgId = Number(qid) || 0;

    // 2) tg_id –∏–∑ Telegram WebApp
    if (!tgId && window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
      tgId = Number(window.Telegram.WebApp.initDataUnsafe.user.id) || 0;
    }

    // 3) tg_id –∏–∑ localStorage (—Ñ–æ–ª–±—ç–∫)
    if (!tgId) {
      const saved = localStorage.getItem('tg_id');
      if (saved) tgId = Number(saved) || 0;
    }

    // –µ—Å–ª–∏ –Ω–∞—à–ª–∏ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    if (tgId) localStorage.setItem('tg_id', String(tgId));
  } catch {}
}

try {
  // –Ω–∞ —á–∞—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ initDataUnsafe –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ ready()
  if (window.Telegram?.WebApp?.ready) window.Telegram.WebApp.ready();
} catch {}

resolveTgId();
$('#profile-id').textContent = tgId || '‚Äì';

const HEADERS = () => {
  const h = { 'Content-Type':'application/json' };
  if (tgId) {
    // —Å–µ—Ä–≤–µ—Ä —á–∏—Ç–∞–µ—Ç –∏ x-tg-id, –∏ X-TG-ID
    h['x-tg-id'] = String(tgId);
    h['X-TG-ID'] = String(tgId);
  }
  return h;
};

/* ‚úÖ –í–ê–ñ–ù–û: –∞–±—Å–æ–ª—é—Ç–Ω—ã–π URL + —Ç–∞–π–º–∞—É—Ç + no-store (–¥–ª—è Telegram WebView –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö) */
const BASE_URL = location.origin;

async function api(path, method='GET', body=null, opts={}) {
  // –æ–±–Ω–æ–≤–∏–º tgId –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º (–Ω–∞ –≤—Å—è–∫–∏–π)
  resolveTgId();
  $('#profile-id').textContent = tgId || '‚Äì';

  let url = path.startsWith('http') ? path : (BASE_URL + path);

  // ‚úÖ –ü—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º tg_id –≤ query –≤—Å–µ–≥–¥–∞, –µ—Å–ª–∏ –æ–Ω –∏–∑–≤–µ—Å—Ç–µ–Ω.
  // –≠—Ç–æ –ª–µ—á–∏—Ç —Å–∏—Ç—É–∞—Ü–∏—é, –∫–æ–≥–¥–∞ –≤ Telegram WebView –∏–Ω–æ–≥–¥–∞ "—Ç–µ—Ä—è—é—Ç—Å—è" –∑–∞–≥–æ–ª–æ–≤–∫–∏.
  try {
    if (tgId) {
      const u = new URL(url);
      if (!u.searchParams.get('tg_id')) u.searchParams.set('tg_id', String(tgId));
      url = u.toString();
    }
  } catch {}

  const controller = new AbortController();
  const timeoutMs = opts.timeoutMs ?? 15000;
  const timer = setTimeout(() => controller.abort(), timeoutMs);

  try {
    const opt = {
      method,
      headers: HEADERS(),
      signal: controller.signal,
      cache: 'no-store'
    };
    if (body) opt.body = JSON.stringify(body);

    const r = await fetch(url, opt);

    const txt = await r.text();
    let data = {};
    try { data = JSON.parse(txt || '{}'); } catch { data = { ok:false, error:'bad_json' }; }

    if (!r.ok || data?.ok === false) throw new Error(data?.error || ('HTTP '+r.status));
    return data;
  } finally {
    clearTimeout(timer);
  }
}


/* global state */
let tasks = [];
let focus = null;
let focusEditing = false;
let quickPrio = 'today';

let planMode   = 'my';
let planFilter = 'all';

let teamList = [];     // {team_id,name,join_code,is_owner,members:[]}
let teamInfo = null;
let teamDetailOpen = false;
let teamMembersOpen = false;

/* team owner helpers */
function isOwnerOfTeam(teamId){
  const t = teamList.find(x => x.team_id === teamId);
  return !!(t && t.is_owner);
}
function hasOwnedTeams(){
  return teamList.some(t => t.is_owner);
}

/* NAV */
const screens = {
  home: $('#screen-home'),
  plan: $('#screen-plan'),
  chat: $('#screen-chat'),
  stats: $('#screen-stats'),
  profile: $('#screen-profile'),
};
$$('.nav .item').forEach(it=>{
  it.onclick = ()=>{
    $$('.nav .item').forEach(x=>x.classList.remove('active'));
    it.classList.add('active');
    const to = it.dataset.go;
    Object.values(screens).forEach(s=>s.classList.remove('active'));
    screens[to].classList.add('active');
    if (to === 'chat') loadChatsFromServer();
    if (to === 'plan') {
      renderPlan();
      syncQuickTeamChip();
    }
    updateFloatingButtonVisibility();
  };
});

/* FOCUS UI */
function renderFocus(){
  const curBlock = $('#focus-current');
  const curText  = $('#focus-current-text');
  const editRow  = $('#focus-edit-row');
  const label    = $('#focus-edit-label');

  if (focus && focus.text){
    curBlock.style.display = 'block';
    curText.textContent = focus.text;
    if (focusEditing){
      editRow.style.display = 'block';
      label.textContent = '–û–±–Ω–æ–≤–∏—Ç—å —Ñ–æ–∫—É—Å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è';
      $('#focus-input').value = focus.text;
    } else {
      editRow.style.display = 'none';
    }
  } else {
    curBlock.style.display = 'none';
    editRow.style.display = 'block';
    label.textContent = '–°–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ —Å–µ–≥–æ–¥–Ω—è';
  }
}

$('#focus-edit-btn').onclick = () => {
  focusEditing = true;
  renderFocus();
  const inp = $('#focus-input');
  inp.focus();
  inp.select();
};

$('#focus-save').onclick = async ()=>{
  const text = $('#focus-input').value.trim();
  if (!text) return showToast('–ü—É—Å—Ç–æ–π —Ñ–æ–∫—É—Å');
  try{
    const r = await api('/api/focus','POST',{ text });
    focus = r.focus;
    focusEditing = false;
    renderFocus();
    showToast('–§–æ–∫—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  }catch(e){
    focus = { text, id:'local_'+Date.now() };
    focusEditing = false;
    renderFocus();
    showToast('–§–æ–∫—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω (–æ—Ñ–ª–∞–π–Ω)');
  }
};

/* quick add */
const quickChips = $$('.seg .chip[data-prio]');
quickChips.forEach(ch=>{
  ch.onclick = ()=>{
    quickChips.forEach(x=>x.classList.remove('active'));
    ch.classList.add('active');
    quickPrio = ch.dataset.prio;
    syncQuickTeamChip();
  };
});
quickChips[0].classList.add('active');

function syncQuickTeamChip(){
  const chipTeam = document.querySelector('.seg .chip[data-prio="team"]');
  if (!chipTeam) return;
  const owned = hasOwnedTeams();
  chipTeam.style.display = owned ? 'inline-flex' : 'none';
  if (!owned && quickPrio === 'team') {
    quickPrio = 'today';
    quickChips.forEach(x=>{
      const pr = x.dataset.prio;
      x.classList.toggle('active', pr === quickPrio);
    });
  }
  updateQuickTeamVisibility();
}

function memberDisplayName(m){
  if (!m) return '‚Äî';
  const fn = (m.first_name || '').trim();
  const ln = (m.last_name || '').trim();
  const full = (fn + ' ' + ln).trim();
  if (full) return full;
  if (m.username) return '@' + String(m.username).replace(/^@/, '');
  if (m.tg_id) return 'tg:' + m.tg_id;
  if (m.user_id) return 'user#' + m.user_id;
  return '‚Äî';
}

async function ensureMembersLoaded(teamId){
  const tid = Number(teamId);
  if (!tid) return [];
  const t = teamList.find(x => Number(x.team_id) === tid) || (teamInfo && Number(teamInfo.team_id)===tid ? teamInfo : null);
  if (!t) return [];
  if (Array.isArray(t.members) && t.members.length) return t.members;
  try{
    const r = await api('/api/team/members?team_id='+encodeURIComponent(tid),'GET');
    t.members = r.members || r.items || [];
  }catch(e){
    t.members = t.members || [];
  }
  return t.members || [];
}

async function updateQuickAssigneeOptions(){
  const rowA = $('#quick-assignee-row');
  const selA = $('#quick-assignee-select');
  const selT = $('#quick-team-select');
  if (!rowA || !selA || !selT) return;

  const ownedTeams = teamList.filter(t => t.is_owner);
  const need = quickPrio === 'team' && ownedTeams.length;
  rowA.classList.toggle('visible', need);

  if (!need){
    selA.innerHTML = '<option value="">–ö–æ–º—É: –≤—Å–µ–º</option>';
    selA.disabled = true;
    return;
  }

  const teamId = Number(selT.value || 0);
  selA.innerHTML = '<option value="">–ö–æ–º—É: –≤—Å–µ–º</option>';
  selA.disabled = !teamId;
  if (!teamId) return;

  const members = await ensureMembersLoaded(teamId);
  members.forEach(m => {
    if (!m?.tg_id) return;
    const opt = document.createElement('option');
    opt.value = String(m.tg_id);
    opt.textContent = memberDisplayName(m);
    selA.appendChild(opt);
  });
}

function updateQuickTeamVisibility(){
  const rowT = $('#quick-team-row');
  const rowA = $('#quick-assignee-row');
  if (!rowT) return;

  const ownedTeams = teamList.filter(t => t.is_owner);
  const need = quickPrio === 'team' && ownedTeams.length;

  rowT.classList.toggle('visible', need);
  if (rowA) rowA.classList.toggle('visible', need);

  const selT = $('#quick-team-select');
  if (!selT) return;

  const prev = selT.value;
  selT.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>';
  ownedTeams.forEach(t=>{
    const opt = document.createElement('option');
    opt.value = String(t.team_id);
    opt.textContent = t.name;
    selT.appendChild(opt);
  });

  if (need){
    if (prev && ownedTeams.some(t=>String(t.team_id)===String(prev))) selT.value = prev;
    else if (ownedTeams.length === 1) selT.value = String(ownedTeams[0].team_id);
  }

  updateQuickAssigneeOptions();
}

// –æ–¥–∏–Ω —Ä–∞–∑ –≤–µ—à–∞–µ–º onchange (–±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
try{
  const selT = $('#quick-team-select');
  if (selT && !selT._bind_assignee){
    selT._bind_assignee = true;
    selT.onchange = ()=>{ updateQuickAssigneeOptions(); };
  }
}catch(_){ }

$('#quick-add').onclick = async ()=>{
  const title = $('#quick-title').value.trim();
  const dueStr = $('#quick-due').value;
  if (!title) return showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');

  let due_ts = null;
  if (dueStr){
    const ms = Date.parse(dueStr);
    if (!isNaN(ms)) due_ts = ms;
  } else {
    const now = new Date();
    if (quickPrio==='today')      due_ts = endOfDay(now).getTime();
    else if (quickPrio==='week')  due_ts = endOfDay(addDays(now,7)).getTime();
    else if (quickPrio==='month') due_ts = endOfDay(addDays(now,30)).getTime();
  }

  let team_id = null;
  if (quickPrio === 'team') {
    const selVal = $('#quick-team-select').value;
    if (!selVal) return showToast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É');
    team_id = Number(selVal);
  }

  try{
    const payload = { title, due_ts, priority: quickPrio };
    if (team_id) payload.team_id = team_id;

    // ‚úÖ –ö–æ–º—É –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∫–æ–º–∞–Ω–¥–Ω—É—é –∑–∞–¥–∞—á—É: –≤—Å–µ–º (–ø—É—Å—Ç–æ) –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —É—á–∞—Å—Ç–Ω–∏–∫—É
    if (team_id) {
      const aSel = $('#quick-assignee-select');
      const aVal = aSel ? String(aSel.value || '').trim() : '';
      if (aVal) payload.assigned_to_tg_id = Number(aVal);
    }

    const r = await api('/api/tasks','POST', payload);
    tasks.unshift(normalizeTaskRow(r.task));
  }catch(e){
    const fake = {
      id: 'tmp_'+Date.now(),
      title,
      due_ts,
      is_done: false,
      team_id: team_id || null,
      created_at: new Date().toISOString()
    };
    tasks.unshift(fake);
  }

  $('#quick-title').value='';
  $('#quick-due').value='';
  renderHome();
  renderPlan();
  renderStats();
  showToast('–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
};

/* task row */
function rowTask(t, showTeamBadge=false, readonly=false){
  const el = document.createElement('div');
  el.className='task'+(t.is_done?' done':'')+(t.team_id?' team-task':'');

  const left = document.createElement('button');
  left.className='btn icon';
  left.textContent = t.is_done?'‚úì':'‚óã';
  if (readonly){
    left.disabled = true;
    left.style.opacity = '0.4';
  } else {
    left.onclick = async ()=>{
      t.is_done = !t.is_done;
      renderHome(); renderPlan(); renderStats();
      try{
        await api('/api/tasks/toggle?id='+encodeURIComponent(t.id),'POST',{});
      }catch(e){}
    };
  }

  const center = document.createElement('div');
  center.className='ttl';
  center.textContent = t.title;

  const meta = document.createElement('div');
  meta.className = 'task-meta';

  const badge = document.createElement('span');
  badge.className='badge';
  if (t.due_ts == null){
    badge.textContent='–±–µ–∑ —Å—Ä–æ–∫–∞';
  }else{
    const ms = normalizeDue(t.due_ts);
    const past = ms < Date.now();
    badge.className = 'badge ' + (past ? (t.is_done?'ok':'dead') : 'due');
    badge.textContent = (t.is_done?'—Å–¥–µ–ª–∞–Ω–æ ‚Ä¢ ':'–¥–æ ') + fmt(ms);
  }
  meta.appendChild(badge);

  // –∫–æ–º—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–Ω–∞—è –∑–∞–¥–∞—á–∞
  if (t.team_id){
    const ab = document.createElement('span');
    ab.className = 'badge';
    if (t.assigned_to_user_id){
      const team = teamList.find(x => Number(x.team_id) === Number(t.team_id)) || (teamInfo && Number(teamInfo.team_id)===Number(t.team_id) ? teamInfo : null);
      const mem = (team?.members || []).find(m => Number(m.user_id) === Number(t.assigned_to_user_id));
      ab.textContent = 'üë§ ' + (mem ? memberDisplayName(mem) : ('user#'+t.assigned_to_user_id));
    } else {
      ab.textContent = 'üë• –í—Å–µ–º';
    }
    meta.appendChild(ab);
  }

  if (showTeamBadge && t.team_id){
    const tb = document.createElement('span');
    tb.className='badge team';
    tb.textContent='–ö–æ–º–∞–Ω–¥–Ω–∞—è –∑–∞–¥–∞—á–∞';
    meta.appendChild(tb);
  }

  const right = document.createElement('button');
  right.className='btn secondary icon';
  right.textContent='‚úï';
  if (readonly){
    right.style.display='none';
  } else {
    right.onclick = async ()=>{
      tasks = tasks.filter(x=>x.id!==t.id);
      renderHome(); renderPlan(); renderStats();
      try{
        await api('/api/tasks/delete?id='+encodeURIComponent(t.id),'POST',{});
      }catch(e){}
    };
  }

  const actions = document.createElement('div');
  actions.className = 'task-actions';
  actions.appendChild(meta);
  actions.appendChild(right);

  el.append(left, center, actions);
  return el;
}

/* render home */
function renderHome(){
  const s = startOfDay(new Date()).getTime();
  const e = endOfDay(new Date()).getTime();
  const today = tasks
    .filter(t=>{
      const ms = normalizeDue(t.due_ts);
      return ms!=null && ms>=s && ms<=e;
    })
    .sort((a,b)=>(a.is_done-b.is_done)||((normalizeDue(a.due_ts)||0)-(normalizeDue(b.due_ts)||0)));

  const box = $('#tasks-today');
  box.innerHTML='';
  if (!today.length){
    box.innerHTML='<div class="muted">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –∑–∞–¥–∞—á.</div>';
    return;
  }
  today.forEach(t=>{
    const readonly = t.team_id && !isOwnerOfTeam(t.team_id);
    box.appendChild(rowTask(t, !!t.team_id, !!readonly));
  });
}

/* PLAN */
function setPlanMode(mode){
  planMode = mode;
  $('#mode-my').classList.toggle('active', mode==='my');
  $('#mode-team').classList.toggle('active', mode==='team');

  $('#my-filters').style.display   = mode==='my' ? 'flex' : 'none';
  $('#plan-my-list').style.display = mode==='my' ? 'flex' : 'none';
  $('#plan-team-block').style.display = mode==='team' ? 'block' : 'none';

  renderPlan();
  updateFloatingButtonVisibility();
}
$('#mode-my').onclick   = ()=>setPlanMode('my');
$('#mode-team').onclick = ()=>setPlanMode('team');

const myFilterChips = $$('#my-filters .chip');
myFilterChips.forEach(ch=>{
  ch.onclick = ()=>{
    myFilterChips.forEach(x=>x.classList.remove('active'));
    ch.classList.add('active');
    planFilter = ch.dataset.planFilter;
    renderPlan();
  };
});
(myFilterChips.find(c=>c.dataset.planFilter==='all')||{}).classList?.add('active');

function renderPlanMy(){
  let arr = tasks.filter(t => !t.team_id);
  const now = new Date();

  if (planFilter === 'today'){
    const s = startOfDay(now).getTime();
    const e = endOfDay(now).getTime();
    arr = arr.filter(t=>{
      const ms = normalizeDue(t.due_ts);
      return ms!=null && ms>=s && ms<=e;
    });
  } else if (planFilter === 'week'){
    const e = endOfDay(addDays(now,7)).getTime();
    arr = arr.filter(t=>{
      const ms = normalizeDue(t.due_ts);
      return ms!=null && ms<=e;
    });
  } else if (planFilter === 'month'){
    const e = endOfDay(addDays(now,30)).getTime();
    arr = arr.filter(t=>{
      const ms = normalizeDue(t.due_ts);
      return ms!=null && ms<=e;
    });
  }

  arr.sort((a,b)=>(a.is_done-b.is_done)||((normalizeDue(a.due_ts)||1e20)-(normalizeDue(b.due_ts)||1e20)));
  const box = $('#plan-my-list');
  box.innerHTML='';
  if (!arr.length){
    box.innerHTML='<div class="muted">–ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</div>';
    return;
  }
  arr.forEach(t=> box.appendChild(rowTask(t,false,false)));
}

function renderTeamList(){
  const box = $('#team-list-box');
  if (!box) return;
  if (teamDetailOpen){
    box.style.display='none';
    return;
  }
  box.style.display='flex';
  box.innerHTML='';

  if (!teamList.length){
    const empty = document.createElement('div');
    empty.className='team-list-empty muted';
    empty.innerHTML = '–í—ã –µ—â—ë –Ω–µ –≤ –∫–æ–º–∞–Ω–¥–∞—Ö.<br>–ù–∞–∂–º–∏—Ç–µ "+" —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –≤—Å—Ç—É–ø–∏—Ç—å.';
    box.appendChild(empty);
    return;
  }

  teamList.forEach(t=>{
    const item = document.createElement('div');
    item.className='team-list-item';
    item.onclick = ()=>{
      teamInfo = t;
      teamDetailOpen = true;
      teamMembersOpen = false;
      fillTeamDetail();
    };

    const name = document.createElement('span');
    name.className='name';
    name.textContent = t.name;

    const arrow = document.createElement('span');
    arrow.textContent='‚Ä∫';
    arrow.style.color='var(--muted)';
    arrow.style.fontSize='14px';

    item.appendChild(name);
    item.appendChild(arrow);
    box.appendChild(item);
  });
}

function fillTeamDetail(){
  const detailBox = $('#team-detail-box');
  const listBox   = $('#team-list-box');
  if (!detailBox) return;
  if (!teamInfo){
    detailBox.style.display='none';
    listBox.style.display='flex';
    return;
  }

  listBox.style.display='none';
  detailBox.style.display='flex';

  const isOwner = !!teamInfo.is_owner;

  $('#team-name-label').textContent = teamInfo.name || ('–ö–æ–º–∞–Ω–¥–∞ '+teamInfo.team_id);

  const fullCode = teamInfo.join_code || '';
  const short = fullCode ? (fullCode.slice(0,4)+'‚Ä¢‚Ä¢‚Ä¢‚Ä¢') : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
  $('#team-code-short').textContent = short;

  $('#team-rename').style.display   = isOwner ? 'inline-flex' : 'none';
  $('#team-delete').style.display   = isOwner ? 'block'      : 'none';
  $('#team-code-copy').style.display = 'inline-flex';

  const ul = $('#team-members-list');
  ul.innerHTML='';
  (teamInfo.members || []).forEach(m=>{
    const li = document.createElement('li');
    const name = m.username ? '@'+m.username :
      [m.first_name, m.last_name].filter(Boolean).join(' ') || m.tg_id;
    li.textContent = name;
    ul.appendChild(li);
  });
  if (!(teamInfo.members || []).length){
    ul.innerHTML='<li class="muted">–ü–æ–∫–∞ —Ç–æ–ª—å–∫–æ –≤—ã</li>';
  }

  $('#team-members-box').style.display = teamMembersOpen ? 'block' : 'none';
  $('#team-members-arrow').textContent = teamMembersOpen ? '‚ñ¥' : '‚ñæ';

  const box = $('#team-tasks-list');
  box.innerHTML='';
  const arr = tasks.filter(t => t.team_id === teamInfo.team_id)
    .sort((a,b)=>(a.is_done-b.is_done)||((normalizeDue(a.due_ts)||1e20)-(normalizeDue(b.due_ts)||1e20)));

  if (!arr.length){
    box.innerHTML='<div class="muted">–í —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á.</div>';
  } else {
    arr.forEach(t => box.appendChild(rowTask(t,true,!isOwner)));
  }
}

function renderPlanTeam(){
  renderTeamList();
  if (teamDetailOpen && teamInfo){
    fillTeamDetail();
  }else{
    $('#team-detail-box').style.display='none';
  }
}

function renderPlan(){
  if (planMode === 'my') renderPlanMy();
  else renderPlanTeam();
  updateFloatingButtonVisibility();
}

/* stats */
function renderStats(){
  const total   = tasks.length;
  const done    = tasks.filter(t=>t.is_done).length;
  const overdue = tasks.filter(t=>{
    const ms = normalizeDue(t.due_ts);
    return !t.is_done && ms!=null && ms < Date.now();
  }).length;
  const rate    = total ? Math.round(done*100/total) : 0;

  $('#m-total').textContent = total;
  $('#m-done').textContent  = done;
  $('#m-rate').textContent  = rate+'%';
  $('#m-over').textContent  = overdue;

  renderWeekChart();
}
function renderWeekChart(){
  const chart = $('#week-chart');
  chart.innerHTML = '';
  for (let i = 6; i >= 0; i--) {
    const day = addDays(new Date(), -i);
    const dayStart = startOfDay(day).getTime();
    const dayEnd   = endOfDay(day).getTime();
    const dayTasks = tasks.filter(t => {
      const ms = normalizeDue(t.due_ts);
      return ms!=null && ms>=dayStart && ms<=dayEnd;
    });
    const doneCount   = dayTasks.filter(t => t.is_done).length;
    const totalCount  = dayTasks.length;
    const height      = totalCount > 0 ? (doneCount / totalCount) * 100 : 10;
    const bar = document.createElement('div');
    bar.style.cssText = `
      flex: 1;
      background: linear-gradient(to top, var(--brand), var(--brand-2));
      border-radius: 4px 4px 0 0;
      height: ${height}%;
      min-height: 8px;
      position: relative;
    `;
    const label = document.createElement('div');
    label.style.cssText = `
      position: absolute;
      bottom: -18px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 10px;
      color: var(--muted);
    `;
    label.textContent = day.toLocaleDateString('ru-RU', { weekday: 'short' });
    bar.appendChild(label);
    chart.appendChild(bar);
  }
}

/* TEAM API */
async function loadTeamInfo(){
  try{
    const listResp = await api('/api/team/list','GET');
    const teams = listResp.teams || [];

    teamList = teams.map(t => ({
      team_id: Number(t.id),
      name: t.name,
      join_code: t.join_code,
      is_owner: !!t.is_owner,
      members: []
    }));

    if (!teamList.length) {
      teamInfo = null;
      teamDetailOpen = false;
      teamMembersOpen = false;
      renderTeamList();
      syncQuickTeamChip();
      return;
    }

    if (!teamInfo || !teamList.some(x => x.team_id === teamInfo.team_id)) {
      teamInfo = teamList[0];
    } else {
      const found = teamList.find(x => x.team_id === teamInfo.team_id);
      if (found) teamInfo = found;
    }

    try{
      const r = await api('/api/team/members?team_id='+encodeURIComponent(teamInfo.team_id),'GET');
      teamInfo.members = r.members || r.items || [];
    }catch(e){
      console.log('members error', e);
      teamInfo.members = [];
    }

    renderTeamList();
    if (teamDetailOpen) fillTeamDetail();
    syncQuickTeamChip();
  }catch(e){
    console.log('loadTeamInfo error', e);
    teamList = [];
    teamInfo = null;
    teamDetailOpen = false;
    teamMembersOpen = false;
    renderTeamList();
    syncQuickTeamChip();
  }
}

/* FLOATING BUTTON MANAGEMENT */
function updateFloatingButtonVisibility() {
  const fab = $('#team-fab-btn');
  const exportBar = $('#export-bar');

  const currentScreen = Object.values(screens).find(s => s.classList.contains('active'));
  const isPlan = currentScreen && currentScreen.id === 'screen-plan';

  // Team FAB: —Ç–æ–ª—å–∫–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ Plan -> –ö–æ–º–∞–Ω–¥—ã
  if (isPlan && planMode === 'team') {
    fab.style.display = 'flex';
  } else {
    fab.style.display = 'none';
  }

  // Export bar: —Ç–æ–ª—å–∫–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ Plan
  if (isPlan) {
    exportBar.style.display = 'block';
  } else {
    exportBar.style.display = 'none';
  }
}

/* ======================= CALENDAR EXPORT ======================= */
async function exportTasksToCalendar(){
  if (!tgId) return showToast('–ù–µ –Ω–∞–π–¥–µ–Ω TG ID');
  const url = `${BASE_URL}/api/calendar/feed.ics?tg_id=${encodeURIComponent(tgId)}`;

  // –í Telegram WebApp —É–¥–æ–±–Ω–µ–µ –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É ‚Äî –¥–∞–ª—å—à–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç .ics –≤ Google/–Ø–Ω–¥–µ–∫—Å
  try{
    if (window.Telegram?.WebApp?.openLink) {
      window.Telegram.WebApp.openLink(url);
      return;
    }
  }catch(_){}

  // –§–æ–ª–±—ç–∫: —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
  try{
    const r = await fetch(url, { cache:'no-store' });
    if (!r.ok) throw new Error('HTTP '+r.status);
    const blob = await r.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'growth-tasks.ics';
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  }catch(e){
    console.error(e);
    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å');
  }
}
$('#export-calendar').onclick = exportTasksToCalendar;

/* TEAM UI buttons */
$('#team-fab-btn').onclick = ()=>{
  $('#team-menu').classList.add('active');
};

$('#team-menu-create').onclick = async ()=>{
  $('#team-menu').classList.remove('active');
  const nameInput = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: –û—Ç–¥–µ–ª –ø—Ä–æ–¥–∞–∂)');
  const name = nameInput && nameInput.trim() ? nameInput.trim() : '';
  try{
    const resp = await api('/api/team/create','POST', name ? { name } : {});
    await loadTeamInfo();
    if (resp.team && resp.team.id){
      const found = teamList.find(t => t.team_id === resp.team.id);
      if (found){
        teamInfo = found;
        teamDetailOpen = true;
        teamMembersOpen = false;
        fillTeamDetail();
      }
    }
    setPlanMode('team');
    showToast('–ö–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–Ω–∞');
  }catch(e){
    console.error(e);
    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É');
  }
};

$('#team-menu-join').onclick = async ()=>{
  $('#team-menu').classList.remove('active');
  const token = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è');
  if (!token || !token.trim()) return;
  try{
    await api('/api/team/join','POST',{ token: token.trim() });
    await loadTeamInfo();
    setPlanMode('team');
    showToast('–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–∞–Ω–¥–µ');
  }catch(e){
    console.error(e);
    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—Å—Ç—É–ø–∏—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É');
  }
};

$('#team-menu-close').onclick = ()=>{
  $('#team-menu').classList.remove('active');
};

$('#team-back').onclick = ()=>{
  teamDetailOpen = false;
  teamMembersOpen = false;
  renderTeamList();
  $('#team-detail-box').style.display='none';
};

$('#team-rename').onclick = async ()=>{
  if (!teamInfo || !teamInfo.is_owner) return;
  const nameInput = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã', teamInfo.name || '');
  if (!nameInput || !nameInput.trim()) return;
  try{
    await api('/api/team/rename','POST',{
      team_id: teamInfo.team_id,
      name: nameInput.trim()
    });
    await loadTeamInfo();
    teamDetailOpen = true;
    fillTeamDetail();
    showToast('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
  }catch(e){
    console.error(e);
    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å');
  }
};

$('#team-code-copy').onclick = async ()=>{
  if (!teamInfo || !teamInfo.join_code) return showToast('–ö–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
  try{
    await navigator.clipboard.writeText(teamInfo.join_code);
    showToast('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
  }catch(e){
    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
  }
};

$('#team-delete').onclick = async ()=>{
  if (!teamInfo || !teamInfo.is_owner) return;
  if (!confirm('–†–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É "'+(teamInfo.name||'')+'"?')) return;
  try{
    await api('/api/team/delete','POST',{ team_id: teamInfo.team_id });
    await loadTeamInfo();
    teamDetailOpen = false;
    showToast('–ö–æ–º–∞–Ω–¥–∞ —Ä–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞');
  }catch(e){
    console.error(e);
    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å');
  }
};

$('#team-members-toggle').onclick = ()=>{
  teamMembersOpen = !teamMembersOpen;
  $('#team-members-box').style.display = teamMembersOpen ? 'block' : 'none';
  $('#team-members-arrow').textContent = teamMembersOpen ? '‚ñ¥' : '‚ñæ';
};

/* ======================= CHAT: –ë–î-—Å–µ—Å—Å–∏–∏ ======================= */
let chats = [];
let currentChatId = null;
let currentMessages = [];
let pendingChatTitle = null;

async function loadChatsFromServer() {
  try {
    const data = await api('/api/chat_sessions','GET');
    chats = data.sessions || [];
  } catch (e) {
    console.error('loadChatsFromServer error', e);
    chats = [];
  }
  renderChatList();
}

/* –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞ */
async function deleteChat(chatId, title) {
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å —á–∞—Ç "${title}"?`)) return;
  try {
    await api('/api/chat_delete','POST',{ chat_id: chatId });
    if (currentChatId === chatId) {
      closeChat();
    } else {
      await loadChatsFromServer();
    }
    showToast('–ß–∞—Ç —É–¥–∞–ª—ë–Ω');
  } catch (e) {
    console.error('deleteChat error', e);
    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —á–∞—Ç');
  }
}

function renderChatList() {
  const container = $('#chat-list');
  container.innerHTML = '';

  if (!chats.length) {
    $('#no-chats-message').style.display = 'block';
  } else {
    $('#no-chats-message').style.display = 'none';
  }

  chats.forEach(chat => {
    const chatEl = document.createElement('div');
    chatEl.className = 'chat-item';
    const dateStr = chat.updated_at
      ? new Date(chat.updated_at).toLocaleDateString('ru-RU')
      : '';
    const title = chat.title || '–ß–∞—Ç';

    chatEl.innerHTML = `
      <div class="chat-icon">üí¨</div>
      <div class="chat-title">${title}</div>
      <div class="chat-date">${dateStr}</div>
    `;

    chatEl.onclick = () => {
      if (chatEl._skipClickOnce) {
        chatEl._skipClickOnce = false;
        return;
      }
      openChat(chat.id, title);
    };

    // ‚úÖ Long-press delete for touch devices (–ù–ï –¥–µ–ª–∞–µ–º preventDefault –Ω–∞ touchstart ‚Äî –∏–Ω–∞—á–µ click –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ)

    // Long-press delete on touch (doesn't block normal tap)

    let pressTimer = null;

    // –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ: long-press (‚âà0.55s) —É–¥–∞–ª—è–µ—Ç —á–∞—Ç, –æ–±—ã—á–Ω—ã–π —Ç–∞–ø –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç.
    // –í–∞–∂–Ω–æ: –ù–ï –¥–µ–ª–∞–µ–º preventDefault –Ω–∞ pointerdown, –∏–Ω–∞—á–µ –∫–ª–∏–∫ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.
    const startPress = (ev) => {
      if (ev.pointerType && ev.pointerType !== 'touch') return;
      if (pressTimer) clearTimeout(pressTimer);
      pressTimer = setTimeout(() => {
        pressTimer = null;
        chatEl._skipClickOnce = true;
        deleteChat(chat.id, title);
      }, 550);
    };
    const cancelPress = () => {
      if (pressTimer) {
        clearTimeout(pressTimer);
        pressTimer = null;
      }
    };

    chatEl.addEventListener('pointerdown', startPress);
    chatEl.addEventListener('pointerup', cancelPress);
    chatEl.addEventListener('pointercancel', cancelPress);
    chatEl.addEventListener('pointerleave', cancelPress);

    // Desktop: –ü–ö–ú —É–¥–∞–ª—è–µ—Ç —á–∞—Ç
    chatEl.addEventListener('contextmenu', (ev) => {
      ev.preventDefault();
      chatEl._skipClickOnce = true;
      deleteChat(chat.id, title);
    });

    container.appendChild(chatEl);
  });

  const newChatEl = document.createElement('div');
  newChatEl.className = 'chat-item new';
  newChatEl.innerHTML = `
    <div class="chat-icon">+</div>
    <div class="chat-title">–ù–æ–≤—ã–π —á–∞—Ç</div>
  `;
  newChatEl.onclick = () => $('#new-chat-modal').classList.add('active');
  container.appendChild(newChatEl);
}

async function openChat(chatId, title) {
  currentChatId = chatId;
  pendingChatTitle = null;
  $('#current-chat-title').textContent = title || '–ß–∞—Ç';
  $('#chat-window-overlay').classList.add('active');
  currentMessages = [];

  try {
    const data = await api('/api/chat_history?chat_id=' + encodeURIComponent(chatId),'GET');
    currentMessages = (data.messages || []).map(m => ({
      role: m.role === 'assistant' ? 'assistant' : 'user',
      content: m.content
    }));
  } catch (e) {
    console.error('openChat history error', e);
    currentMessages = [];
  }

  if (!currentMessages.length) {
    currentMessages = [{
      role: 'assistant',
      content: '–ü—Ä–∏–≤–µ—Ç! –Ø –±–∏–∑–Ω–µ—Å-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ú–æ–≥—É –ø–æ–º–æ—á—å —Å –ø—Ä–æ–¥–∞–∂–∞–º–∏, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–º, –ø—Ä–æ–¥—É–∫—Ç–æ–º, –Ω–∞–π–º–æ–º –∏ –ø–ª–∞–Ω–æ–º –∑–∞–¥–∞—á. –ß—Ç–æ –¥–µ–ª–∞–µ–º?'
    }];
  }

  renderChatMessages();
  setTimeout(() => $('#chat-input').focus(), 50);
}

function openNewChatWindow(title) {
  pendingChatTitle = (title || '–ù–æ–≤—ã–π —á–∞—Ç').trim() || '–ù–æ–≤—ã–π —á–∞—Ç';
  currentChatId = null;
  currentMessages = [{
    role: 'assistant',
    content: '–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?'
  }];
  $('#current-chat-title').textContent = pendingChatTitle;
  $('#chat-window-overlay').classList.add('active');
  renderChatMessages();
  setTimeout(() => $('#chat-input').focus(), 50);
}

function closeChat() {
  currentChatId = null;
  pendingChatTitle = null;
  currentMessages = [];
  $('#chat-window-overlay').classList.remove('active');
  $('#chat-body').innerHTML = '';
  loadChatsFromServer().catch(()=>{});
}

function renderChatMessages() {
  const container = $('#chat-body');
  container.innerHTML = '';
  currentMessages.forEach(msg => {
    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + (msg.role === 'user' ? 'me' : 'bot');
    bubble.textContent = msg.content;
    container.appendChild(bubble);
  });
  container.scrollTop = container.scrollHeight;
}

function addMessage(role, content) {
  currentMessages.push({ role, content, timestamp: new Date().toISOString() });
  renderChatMessages();
}

/* ‚úÖ FIX: –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ‚Äî —Ç–∞–π–º–∞—É—Ç + retry, –∏ –Ω–µ –ø–æ–¥–º–µ–Ω—è–µ–º –ò–ò "—Å–±–æ–µ–º" */
async function sendChatMessage() {
  const text = $('#chat-input').value.trim();
  if (!text) return;

  if (!currentChatId && !pendingChatTitle) pendingChatTitle = '–ù–æ–≤—ã–π —á–∞—Ç';

  $('#chat-input').value = '';
  addMessage('user', text);

  const payload = { text };
  if (currentChatId) payload.chat_id = currentChatId;
  if (!currentChatId && pendingChatTitle) payload.chat_title = pendingChatTitle;

  for (let attempt = 1; attempt <= 2; attempt++) {
    try {
      const r = await api('/api/chat', 'POST', payload, { timeoutMs: 20000 });

      const replyText = (r.reply || '').trim() || '–û–∫. –ß—Ç–æ –¥–∞–ª—å—à–µ?';
      addMessage('assistant', replyText);

      if (r.chat_id && !currentChatId) currentChatId = r.chat_id;

      loadChatsFromServer().catch(()=>{});
      return;
    } catch (e) {
      console.error('sendChatMessage attempt', attempt, e);
      if (attempt === 1) {
        await new Promise(res => setTimeout(res, 600));
        continue;
      }
      showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
      addMessage('assistant', '–ü–æ—Ö–æ–∂–µ, —Å–≤—è–∑—å —Å —Å–µ—Ä–≤–µ—Ä–æ–º –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–ø–∞–ª–∞. –ü–æ–ø—Ä–æ–±—É–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ—â—ë —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.');
      return;
    }
  }
}

/* CHAT handlers */
$('#close-chat').onclick = closeChat;
$('#create-first-chat').onclick = () => { $('#new-chat-modal').classList.add('active'); };
$('#cancel-new-chat').onclick = () => {
  $('#new-chat-modal').classList.remove('active');
  $('#new-chat-title').value = '';
};
$('#confirm-new-chat').onclick = async () => {
  const title = ($('#new-chat-title').value.trim() || '–ù–æ–≤—ã–π —á–∞—Ç').slice(0,80) || '–ù–æ–≤—ã–π —á–∞—Ç';
  $('#new-chat-modal').classList.remove('active');
  $('#new-chat-title').value = '';

  try{
    // ‚úÖ —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é —Å–µ—Å—Å–∏—é —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã —á–∞—Ç –ø–æ—è–≤–∏–ª—Å—è –≤ —Å–ø–∏—Å–∫–µ
    const r = await api('/api/chat_sessions','POST',{ title });
    await loadChatsFromServer();
    const sid = r?.session?.id;
    if (sid) {
      await openChat(sid, title);
    } else {
      openNewChatWindow(title); // fallback
    }
    showToast('–ß–∞—Ç —Å–æ–∑–¥–∞–Ω');
  }catch(e){
    console.error('create chat session error', e);
    // –æ—Ñ–ª–∞–π–Ω-—Ñ–æ–ª–±—ç–∫: –æ—Ç–∫—Ä–æ–µ–º –ª–æ–∫–∞–ª—å–Ω–æ, –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
    openNewChatWindow(title);
    showToast('–ß–∞—Ç —Å–æ–∑–¥–∞–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)');
  }
};
$('#chat-send').onclick = sendChatMessage;
$('#chat-input').addEventListener('keydown', e => { if (e.key === 'Enter') sendChatMessage(); });
$('#new-chat-modal').onclick = (e) => { if (e.target === $('#new-chat-modal')) $('#new-chat-modal').classList.remove('active'); };
$('#chat-window-overlay').onclick = (e) => { if (e.target === $('#chat-window-overlay')) closeChat(); };

/* profile */
$$('.lang-btn').forEach(btn => {
  btn.onclick = () => {
    $$('.lang-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const map = {ru:'–†—É—Å—Å–∫–∏–π', en:'English'};
    showToast(`–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${map[btn.dataset.lang] || btn.textContent}`);
  };
});
$('#btn-tariff').onclick = () => showToast('–†–∞–∑–¥–µ–ª "–¢–∞—Ä–∏—Ñ—ã" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
$('#btn-help').onclick   = () => showToast('–†–∞–∑–¥–µ–ª "–ü–æ–º–æ—â—å" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
$('#btn-guide').onclick  = () => showToast('–†–∞–∑–¥–µ–ª "–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
$('#btn-consult').onclick= () => showToast('–†–∞–∑–¥–µ–ª "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');

/* init */
async function loadAll(){
  try{
    const f = await api('/api/focus','GET');
    focus = f.focus || null;
  }catch(e){
    focus = null;
  }
  renderFocus();

  try{
    const t = await api('/api/tasks','GET');
    tasks = (t.items || []).map(normalizeTaskRow);
  }catch(e){
    tasks = [];
  }

  await loadTeamInfo();
  renderHome();
  renderPlan();
  renderStats();
  updateFloatingButtonVisibility();
}
loadAll();

/* sync profile to backend */
(function syncProfile(){
  const u = window.Telegram?.WebApp?.initDataUnsafe?.user;
  if (!u) return;
  api('/api/user/profile','POST',{
    username:   u.username   || null,
    first_name: u.first_name || null,
    last_name:  u.last_name  || null
  }).catch(()=>{});
})();
</script>

</body>
</html>
