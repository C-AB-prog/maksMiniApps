<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Growth Assistant</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
/* ===================== */
/*       DESIGN TOKENS   */
/* ===================== */
:root{
  /* –¶–≤–µ—Ç–∞ */
  --ink: #0E1220;
  --muted:#6B7280;
  --line:#E7ECF5;

  --brand:#5B6CFF;          /* –æ—Å–Ω–æ–≤–Ω–æ–π */
  --brand-2:#7F6BFF;        /* –¥–æ–ø-–≥—Ä–∞–¥–∏–µ–Ω—Ç */
  --brand-3:#46C7F4;        /* –∞–∫—Ü–µ–Ω—Ç */

  --ok:#10B981;
  --warn:#F59E0B;
  --danger:#EF4444;

  /* –§–æ–Ω—ã */
  --bg: #F3F6FF;
  --bg-grad: radial-gradient(1200px 600px at 100% -10%, rgba(123, 195, 255, .20), transparent 60%),
             radial-gradient(900px 500px at -10% 0%, rgba(135, 121, 255, .18), transparent 55%),
             #F3F6FF;

  --card: rgba(255,255,255,.86);
  --card-blur: blur(10px);

  /* –ü—Ä–æ—á–µ–µ */
  --r: 18px;
  --shadow: 0 10px 28px rgba(17,24,39,.10);
  --shadow-2: 0 16px 40px rgba(91,108,255,.20);

  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-top:    env(safe-area-inset-top, 0px);
}

*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  color:var(--ink);
  font:15px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:var(--bg-grad);
  -webkit-tap-highlight-color: transparent;
}

/* ===================== */
/*        APP BAR        */
/* ===================== */
.appbar{
  position:sticky; top:0; z-index:20;
  padding: calc(8px + var(--safe-top)) 18px 12px;
  background: linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.55));
  backdrop-filter: saturate(160%) blur(8px);
  border-bottom:1px solid var(--line);
}
.appbar h1{
  margin:0; font-size:22px; font-weight:900; letter-spacing:.2px;
  background: linear-gradient(90deg, var(--brand), var(--brand-2));
  -webkit-background-clip:text; background-clip:text; color:transparent;
}
.appbar .sub{color:var(--muted); font-size:12px}

/* ===================== */
/*        LAYOUT         */
/* ===================== */
.container{max-width:940px;margin:0 auto;padding:16px 14px 110px}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  padding:14px;
  backdrop-filter: var(--card-blur);
}
h3{margin:0 0 12px 0; font-size:16px}

/* 2 –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
section{display:none;gap:14px}
section.active{display:grid}
.grid-2{grid-template-columns:1fr}
@media (min-width: 860px){
  .grid-2{grid-template-columns:1.15fr .85fr}
}

/* ===================== */
/*   INPUTS & BUTTONS    */
/* ===================== */
label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
.input, input[type="text"], input[type="datetime-local"]{
  width:100%; background:#fff; border:1px solid var(--line); border-radius:14px; padding:14px 14px; outline:none;
  transition:border-color .2s, box-shadow .2s;
}
.input:focus, input[type="text"]:focus, input[type="datetime-local"]:focus{
  border-color:var(--brand);
  box-shadow:0 0 0 3px rgba(91,108,255,.12);
}
.btn{
  appearance:none; border:none; padding:14px 16px; border-radius:14px;
  background:linear-gradient(135deg, var(--brand), var(--brand-2));
  color:#fff; cursor:pointer; font-weight:800; letter-spacing:.2px;
  box-shadow:var(--shadow-2); transition:transform .06s ease-in-out, filter .2s;
}
.btn:active{transform:translateY(1px)}
.btn.secondary{
  background:#fff;color:var(--ink); border:1px solid var(--line); box-shadow:none; font-weight:700;
}
.btn.ghost{background:rgba(91,108,255,.10); color:var(--brand); box-shadow:none}
.btn.icon{padding:10px 12px; border-radius:12px}

/* ===================== */
/*     SEGMENTED CHIP    */
/* ===================== */
.seg{display:flex;gap:8px;flex-wrap:wrap}
.seg .chip{
  padding:9px 13px; border-radius:999px; border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:600;
  transition:all .15s;
}
.seg .chip.active{
  background:linear-gradient(135deg, var(--brand), var(--brand-2)); color:#fff; border-color:transparent;
  box-shadow:0 8px 22px rgba(91,108,255,.28)
}

/* ===================== */
/*         LISTS         */
/* ===================== */
.list{display:flex;flex-direction:column;gap:10px}
.task{
  display:flex;align-items:center;gap:12px;padding:12px;
  border:1px solid var(--line); border-radius:14px; background:#fff;
}
.task .ttl{flex:1}
.task.done{opacity:.7}
.badge{font-size:12px;padding:5px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted)}
.badge.ok{color:#065f46;border-color:#10b981;background:#ecfdf5}
.badge.due{color:#7c2d12;border-color:#f59e0b;background:#fffbeb}
.badge.dead{color:#991b1b;border-color:#ef4444;background:#fef2f2}

/* ===================== */
/*      CHAT SYSTEM      */
/* ===================== */
.chat-container {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.chat-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}

.chat-item {
  background: #fff;
  border: 2px solid var(--line);
  border-radius: 16px;
  padding: 16px 12px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  min-height: 120px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: relative;
}

.chat-item:hover {
  border-color: var(--brand);
  transform: translateY(-2px);
}

.chat-item.active {
  border-color: var(--brand);
  background: linear-gradient(135deg, #f8faff, #f0f4ff);
  box-shadow: 0 8px 25px rgba(91,108,255,.15);
}

.chat-item.new {
  border: 2px dashed var(--muted);
  background: transparent;
}

.chat-item.new:hover {
  border-color: var(--brand);
  background: rgba(91,108,255,.03);
}

.chat-icon {
  font-size: 24px;
  margin-bottom: 8px;
  opacity: 0.7;
}

.chat-item.active .chat-icon,
.chat-item:hover .chat-icon {
  opacity: 1;
}

.chat-title {
  font-weight: 600;
  font-size: 13px;
  line-height: 1.3;
  margin-bottom: 4px;
}

.chat-date {
  font-size: 11px;
  color: var(--muted);
}

.chat-delete {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--danger);
  color: white;
  border: none;
  font-size: 12px;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chat-item:hover .chat-delete {
  opacity: 1;
}

/* –û–¢–î–ï–õ–¨–ù–û–ï –û–ö–ù–û –ß–ê–¢–ê */
.chat-window-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.chat-window-overlay.active {
  display: flex;
}

.chat-window {
  display: flex;
  flex-direction: column;
  width: 100%;
  max-width: 800px;
  height: 80vh;
  max-height: 700px;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 25px 50px rgba(0,0,0,0.25);
  overflow: hidden;
}

.chat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--line);
  background: #fff;
  flex-shrink: 0;
}

.chat-header-title {
  font-weight: 600;
  font-size: 16px;
}

.chat-header-actions {
  display: flex;
  gap: 8px;
}

.chat-body{
  flex:1;
  overflow:auto;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  background:linear-gradient(180deg,#FAFBFF,#F7FAFF)
}
.bubble{
  max-width:75%;
  padding:12px 16px;
  border-radius:18px;
  font-size:14px;
  line-height:1.4;
  word-wrap: break-word;
}
.me{
  align-self:flex-end;
  background:linear-gradient(135deg, var(--brand), var(--brand-2));
  color:#fff;
  border-bottom-right-radius:6px
}
.bot{
  align-self:flex-start;
  background:#fff;
  border:1px solid var(--line);
  border-bottom-left-radius:6px
}
.chat-foot{
  display:flex;
  gap:10px;
  padding:12px 16px;
  border-top:1px solid var(--line);
  background:#fff;
  flex-shrink: 0;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1100;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: #fff;
  border-radius: 20px;
  padding: 24px;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
}

.modal-title {
  margin: 0 0 16px 0;
  font-size: 18px;
  font-weight: 700;
}

/* ===================== */
/*      BOTTOM NAV       */
/* ===================== */
.nav{
  position:fixed; left:0; right:0; bottom:0; z-index:25;
  padding:10px 10px calc(10px + var(--safe-bottom));
  background:rgba(255,255,255,.9); border-top:1px solid var(--line);
  backdrop-filter: saturate(160%) blur(10px);
  box-shadow:0 -8px 24px rgba(17,24,39,.08);
  display:flex; justify-content:space-around
}
.nav .item{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:64px;color:var(--muted);font-size:12px}
.nav .item svg{opacity:.6; transition:opacity .15s, transform .06s}
.nav .item.active{color:var(--brand)}
.nav .item.active svg{opacity:1; transform:translateY(-1px); filter: drop-shadow(0 4px 8px rgba(91,108,255,.35))}

/* ===================== */
/*         TOAST         */
/* ===================== */
.toast{
  position:fixed;left:50%;bottom:calc(78px + var(--safe-bottom));
  transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;
  box-shadow:0 10px 20px rgba(0,0,0,.2);z-index:999
}
.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
.muted{color:var(--muted)}

/* ===================== */
/*       PROFILE         */
/* ===================== */
.profile-section{margin-bottom:20px}
.profile-section h4{margin:0 0 12px 0;font-size:15px;color:var(--ink)}
.profile-actions{display:flex;flex-direction:column;gap:8px}
.profile-btn{
  display:flex;justify-content:space-between;align-items:center;
  padding:14px 16px;background:#fff;border:1px solid var(--line);border-radius:14px;
  cursor:pointer;transition:all .15s
}
.profile-btn:hover{background:var(--bg);border-color:var(--brand)}
.profile-btn .arrow{color:var(--muted);font-size:14px}
.lang-switch{display:flex;gap:8px;margin-top:8px}
.lang-btn{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;flex:1}
.lang-btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
</style>
</head>
<body>

<!-- Top bar -->
<div class="appbar">
  <h1>Growth Assistant</h1>
  <div class="sub">–§–æ–∫—É—Å ‚Ä¢ –∑–∞–¥–∞—á–∏ ‚Ä¢ –ø–ª–∞–Ω ‚Ä¢ —á–∞—Ç ‚Ä¢ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
</div>

<div class="container">

  <!-- –ì–ª–∞–≤–Ω–∞—è -->
  <section id="screen-home" class="active grid-2">
    <div class="card">
      <h3>–§–æ–∫—É—Å</h3>
      <label>–°–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ —Å–µ–≥–æ–¥–Ω—è</label>
      <div style="display:flex; gap:10px">
        <input id="focus-input" class="input" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∑–∞–∫—Ä—ã—Ç—å –æ—Ç—á—ë—Ç" />
        <button id="focus-save" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>

    <div class="card">
      <h3>–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</h3>
      <div class="seg">
        <div class="chip" data-prio="today">–°–µ–≥–æ–¥–Ω—è</div>
        <div class="chip" data-prio="week">–ù–µ–¥–µ–ª—è</div>
        <div class="chip" data-prio="month">–ú–µ—Å—è—Ü</div>
        <div class="chip" data-prio="team">–ö–æ–º–∞–Ω–¥–∞</div>
      </div>
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
        <input id="quick-title" class="input" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" />
        <input id="quick-due" class="input" type="datetime-local" />
        <button id="quick-add" class="btn">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
      </div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <h3>–ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
      <div id="tasks-today" class="list"></div>
    </div>
  </section>

  <!-- –ü–ª–∞–Ω (—Ç–µ–ø–µ—Ä—å —Å –∫–æ–ª–æ–Ω–∫–æ–π –ö–æ–º–∞–Ω–¥–∞) -->
  <section id="screen-plan" class="grid grid-2">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">–ü–ª–∞–Ω –∑–∞–¥–∞—á</h3>
        <div class="seg">
          <div id="f-today" class="chip active">–°–µ–≥–æ–¥–Ω—è</div>
          <div id="f-week" class="chip">–ù–µ–¥–µ–ª—è</div>
          <div id="f-month" class="chip">–ú–µ—Å—è—Ü</div>
          <div id="f-team" class="chip">–ö–æ–º–∞–Ω–¥–∞</div>
        </div>
      </div>
      <div id="tasks-plan" class="list"></div>
    </div>

    <div class="card">
      <h3>–ö–æ–º–∞–Ω–¥–∞</h3>

      <div class="profile-section">
        <h4>–ö–æ–º–∞–Ω–¥–∞</h4>
        <div class="profile-actions" style="gap:12px">
          <div class="profile-btn" id="btn-team-refresh">
            <span>–û–±–Ω–æ–≤–∏—Ç—å —Å–≤–µ–¥–µ–Ω–∏—è –æ –∫–æ–º–∞–Ω–¥–µ</span>
            <span class="arrow">‚Üª</span>
          </div>

          <div class="card" style="padding:12px">
            <label>–ö–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</label>
            <div style="display:flex; gap:8px; align-items:center">
              <input id="team-code" class="input" type="text" readonly placeholder="‚Äî" />
              <button class="btn secondary" id="copy-code">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
              <button class="btn secondary" id="copy-tg-link">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            </div>
            <div class="muted" style="margin-top:6px">
              –û—Ç–ø—Ä–∞–≤—å –∫–æ–¥ –∏–ª–∏ —Å—Å—ã–ª–∫—É ‚Äî —á–µ–ª–æ–≤–µ–∫ –æ—Ç–∫—Ä–æ–µ—Ç Mini App –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Å—Ç—É–ø–∏—Ç –≤ –∫–æ–º–∞–Ω–¥—É.
            </div>
          </div>

          <div class="card" style="padding:12px">
            <label>–í—Å—Ç—É–ø–∏—Ç—å –ø–æ –∫–æ–¥—É</label>
            <div style="display:flex; gap:8px">
              <input id="join-input" class="input" type="text" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è" />
              <button class="btn" id="join-btn">–í—Å—Ç—É–ø–∏—Ç—å</button>
            </div>
          </div>

          <div class="card" style="padding:12px">
            <label>–£—á–∞—Å—Ç–Ω–∏–∫–∏</label>
            <ul id="team-members" style="margin:8px 0 0 0; padding-left:16px"></ul>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- –ß–∞—Ç -->
  <section id="screen-chat" class="grid">
    <div class="card">
      <h3>–ú–æ–∏ —á–∞—Ç—ã —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</h3>
      <div class="chat-container">
        <div id="chat-list" class="chat-list">
          <!-- –ß–∞—Ç-—Å–µ—Å—Å–∏–∏ –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>

        <div id="no-chats-message" style="text-align: center; padding: 40px 20px;">
          <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">üí¨</div>
          <h3 style="margin: 0 0 8px 0;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</h3>
          <p class="muted">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</p>
          <button class="btn" id="create-first-chat" style="margin-top: 16px;">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
        </div>
      </div>
    </div>
  </section>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <section id="screen-stats" class="grid grid-2">
    <div class="card">
      <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:6px">
        <div class="card" style="flex:1;min-width:180px"><label>–í—Å–µ–≥–æ –∑–∞–¥–∞—á</label><div id="m-total" style="font-size:22px;font-weight:800">0</div></div>
        <div class="card" style="flex:1;min-width:180px"><label>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</label><div id="m-done" style="font-size:22px;font-weight:800;color:var(--ok)">0</div></div>
        <div class="card" style="flex:1;min-width:180px"><label>–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞</label><div id="m-rate" style="font-size:22px;font-weight:800">0%</div></div>
        <div class="card" style="flex:1;min-width:180px"><label>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</label><div id="m-over" style="font-size:22px;font-weight:800;color:var(--danger)">0</div></div>
      </div>
      <p class="muted" style="margin-top:12px">
        <b>–ì–∏–ø–æ—Ç–µ–∑–∞:</b> ¬´–ï—Å–ª–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –∏ —Å—Ç–∞–≤–∏—Ç—å –¥–µ–¥–ª–∞–π–Ω—ã, –∑–∞–≤–µ—Ä—à—É ‚â•70% –≤–æ–≤—Ä–µ–º—è¬ª.<br/>
        <b>–î–µ–π—Å—Ç–≤–∏–µ:</b> –¥–æ–±–∞–≤–ª—è–π/–∑–∞–∫—Ä—ã–≤–∞–π –∑–∞–¥–∞—á–∏ –≤–æ–≤—Ä–µ–º—è. <b>–î–∞–Ω–Ω—ã–µ:</b> –º–µ—Ç—Ä–∏–∫–∏ –≤—ã—à–µ. <b>–ò–Ω—Å–∞–π—Ç:</b> –¥–µ—Ä–∂–∏ ‚â•70%.
      </p>
    </div>
    <div class="card">
      <h3>–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
      <div id="week-chart" style="height:200px;display:flex;align-items:end;gap:4px;margin-top:20px">
        <!-- –ì—Ä–∞—Ñ–∏–∫ –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è JS -->
      </div>
    </div>
  </section>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
  <section id="screen-profile" class="grid">
    <div class="card">
      <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
      <div class="muted" style="margin-bottom:16px">Telegram ID: <span id="profile-id" class="mono">‚Äì</span></div>
      
      <div class="profile-section">
        <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
        <label>–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</label>
        <div class="lang-switch">
          <div class="lang-btn active" data-lang="ru">–†—É—Å—Å–∫–∏–π</div>
          <div class="lang-btn" data-lang="en">English</div>
        </div>
      </div>

      <div class="profile-section">
        <h4>–ê–∫–∫–∞—É–Ω—Ç</h4>
        <div class="profile-actions">
          <div class="profile-btn" id="btn-tariff">
            <span>–¢–∞—Ä–∏—Ñ</span>
            <span style="color:var(--brand);font-weight:600">–ü—Ä–æ–±–Ω—ã–π</span>
          </div>
        </div>
      </div>

      <div class="profile-section">
        <h4>–ü–æ–º–æ—â—å</h4>
        <div class="profile-actions">
          <div class="profile-btn" id="btn-help">
            <span>–ü–æ–º–æ—â—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞</span>
            <span class="arrow">‚Ä∫</span>
          </div>
          <div class="profile-btn" id="btn-guide">
            <span>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</span>
            <span class="arrow">‚Ä∫</span>
          </div>
          <div class="profile-btn" id="btn-consult">
            <span>–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</span>
            <span class="arrow">‚Ä∫</span>
          </div>
        </div>
      </div>

    </div>
  </section>
</div>

<!-- –û–¢–î–ï–õ–¨–ù–û–ï –û–ö–ù–û –ß–ê–¢–ê -->
<div id="chat-window-overlay" class="chat-window-overlay">
  <div class="chat-window">
    <div class="chat-header">
      <div class="chat-header-title" id="current-chat-title">–ù–æ–≤—ã–π —á–∞—Ç</div>
      <div class="chat-header-actions">
        <button class="btn ghost icon" id="close-chat">‚úï</button>
      </div>
    </div>
    <div id="chat-body" class="chat-body">
      <div class="bubble bot">–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
    </div>
    <div class="chat-foot">
      <input id="chat-input" class="input" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
      <button id="chat-send" class="btn" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
    </div>
  </div>
</div>

<!-- Modal –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ -->
<div id="new-chat-modal" class="modal">
  <div class="modal-content">
    <h3 class="modal-title">–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞</h3>
    <input type="text" id="new-chat-title" class="input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" style="margin-bottom: 16px;">
    <div style="display: flex; gap: 10px;">
      <button class="btn secondary" id="cancel-new-chat" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn" id="confirm-new-chat" style="flex: 1;">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- Bottom navigation -->
<nav class="nav">
  <div class="item active" data-go="home">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 7v10a1 1 0 0 1-1 1h-6v-6H10v6H4a1 1 0 0 1-1-1V10l9-7z"/></svg>
    –ì–ª–∞–≤–Ω–∞—è
  </div>
  <div class="item" data-go="plan">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M4 5h16v2H4zM4 11h16v2H4zM4 17h10v2H4z"/></svg>
    –ü–ª–∞–Ω
  </div>
  <div class="item" data-go="chat">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
    –ß–∞—Ç
  </div>
  <div class="item" data-go="stats">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/></svg>
    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  </div>
  <div class="item" data-go="profile">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.42 0-8 2.24-8 5v3h16v-3c0-2.76-3.58-5-8-5z"/></svg>
    –ü—Ä–æ—Ñ–∏–ª—å
  </div>
</nav>

<div id="toast" class="toast" style="display:none"></div>

<script>
/* ===== helpers ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const showToast = (t) => { const el = $('#toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',1800); }
const startOfDay = d => { const x = new Date(d); x.setHours(0,0,0,0); return x; }
const endOfDay = d => { const x = new Date(d); x.setHours(23,59,59,999); return x; }
const addDays = (d,n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x;}

/* --- SAFE DATE HELPERS --- */
function normalizeDue(v){
  if (v === null || v === undefined) return null;
  if (typeof v === 'string' && v.trim().toLowerCase() === 'null') return null;
  const num = Number(v);
  if (!Number.isNaN(num) && v !== '' && v !== true && v !== false) {
    const ms = num < 1e12 ? num * 1000 : num;
    return ms;
  }
  let ms = Date.parse(v);
  if (!Number.isNaN(ms)) return ms;
  if (typeof v === 'string' && /^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}(:\d{2})?$/.test(v)) {
    const iso = v.trim().replace(' ', 'T') + 'Z';
    ms = Date.parse(iso);
    if (!Number.isNaN(ms)) return ms;
  }
  return null;
}
function normalizeTask(t){ return { ...t, due_ts: normalizeDue(t.due_ts) }; }
function fmt(ts){
  const ms = normalizeDue(ts);
  if (ms === null) return '‚Äî';
  const d = new Date(ms);
  if (Number.isNaN(d.getTime())) return '‚Äî';
  return d.toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
}

/* ===== telegram id ===== */
let tgId = 0;
try {
  const qid = new URLSearchParams(location.search).get('tg_id');
  if (qid) tgId = Number(qid);
  if (!tgId && window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
    tgId = Number(window.Telegram.WebApp.initDataUnsafe.user.id);
  }
} catch {}
$('#profile-id').textContent = tgId || '‚Äì';

const HEADERS = () => tgId ? { 'Content-Type':'application/json', 'X-TG-ID': String(tgId) } : { 'Content-Type':'application/json' };

/* ===== API ===== */
async function api(path, method='GET', body=null) {
  const opt = { method, headers: HEADERS() };
  if (body) opt.body = JSON.stringify(body);
  const r = await fetch(path, opt);
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return await r.json();
}

/* ===== CHAT SYSTEM (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏–∫–∏) ===== */
let chats = [];
let currentChatId = null;

function loadChats() {
  try {
    const saved = localStorage.getItem('growth_assistant_chats');
    chats = saved ? JSON.parse(saved) : [];
  } catch { chats = []; }
  renderChatList();
}

function saveChats() {
  try { localStorage.setItem('growth_assistant_chats', JSON.stringify(chats)); } catch {}
}

function createNewChat(title = '–ù–æ–≤—ã–π —á–∞—Ç') {
  const newChat = {
    id: 'chat_' + Date.now(),
    title,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    messages: [
      { role:'assistant', content:'–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?', timestamp:new Date().toISOString() }
    ]
  };
  chats.unshift(newChat);
  saveChats();
  renderChatList();
  return newChat.id;
}

function deleteChat(chatId) {
  chats = chats.filter(c => c.id !== chatId);
  if (currentChatId === chatId) closeChat();
  saveChats();
  renderChatList();
}

function openChat(chatId) {
  const chat = chats.find(c => c.id === chatId);
  if (!chat) return;
  currentChatId = chatId;
  $('#current-chat-title').textContent = chat.title;
  $('#chat-window-overlay').classList.add('active');
  renderChatMessages(chat.messages);
  setTimeout(()=>$('#chat-input').focus(),100);
}

function closeChat() {
  currentChatId = null;
  $('#chat-window-overlay').classList.remove('active');
  $('#chat-body').innerHTML = '';
}

function renderChatList() {
  const container = $('#chat-list');
  container.innerHTML = '';

  chats.forEach(chat => {
    const chatEl = document.createElement('div');
    chatEl.className = `chat-item ${currentChatId === chat.id ? 'active' : ''}`;
    chatEl.innerHTML = `
      <button class="chat-delete" onclick="event.stopPropagation(); deleteChat('${chat.id}')">√ó</button>
      <div class="chat-icon">üí¨</div>
      <div class="chat-title">${chat.title}</div>
      <div class="chat-date">${new Date(chat.updatedAt).toLocaleDateString('ru-RU')}</div>
    `;
    chatEl.onclick = () => openChat(chat.id);
    container.appendChild(chatEl);
  });

  const newChatEl = document.createElement('div');
  newChatEl.className = 'chat-item new';
  newChatEl.innerHTML = `<div class="chat-icon">+</div><div class="chat-title">–ù–æ–≤—ã–π —á–∞—Ç</div>`;
  newChatEl.onclick = () => $('#new-chat-modal').classList.add('active');
  container.appendChild(newChatEl);

  $('#no-chats-message').style.display = chats.length === 0 ? 'block' : 'none';
}

function renderChatMessages(messages) {
  const container = $('#chat-body');
  container.innerHTML = '';
  messages.forEach(msg => {
    const bubble = document.createElement('div');
    bubble.className = `bubble ${msg.role === 'user' ? 'me' : 'bot'}`;
    bubble.textContent = msg.content;
    container.appendChild(bubble);
  });
  container.scrollTop = container.scrollHeight;
}

function addMessageToChat(role, content) {
  if (!currentChatId) return;
  const chat = chats.find(c => c.id === currentChatId);
  if (!chat) return;
  chat.messages.push({ role, content, timestamp:new Date().toISOString() });
  chat.updatedAt = new Date().toISOString();
  saveChats();
  renderChatMessages(chat.messages);
}

/* ===== nav ===== */
const screens = {
  home: $('#screen-home'),
  plan: $('#screen-plan'),
  chat: $('#screen-chat'),
  stats: $('#screen-stats'),
  profile: $('#screen-profile'),
};
$$('.nav .item').forEach(it=>{
  it.onclick = ()=>{
    $$('.nav .item').forEach(x=>x.classList.remove('active'));
    it.classList.add('active');
    const to = it.dataset.go;
    Object.values(screens).forEach(s=>s.classList.remove('active'));
    screens[to].classList.add('active');

    if (to === 'chat') loadChats();
    if (to === 'plan') setTimeout(loadTeamBox, 50);
  };
});

/* ===== state ===== */
let tasks = [];
let focus = null;
let quickPrio = 'today';
let currentTeamId = null;
let currentLanguage = 'ru';

/* team id helper */
async function ensureTeamIdLoaded() {
  if (currentTeamId !== null) return currentTeamId;
  try {
    const r = await api('/api/team/current','GET');
    currentTeamId = (r && typeof r.team_id !== 'undefined') ? r.team_id : null;
  } catch {
    currentTeamId = null;
  }
  return currentTeamId;
}

/* ===== init UI ===== */
$$('.seg .chip[data-prio]').forEach(ch=>{
  ch.onclick = ()=>{
    $$('.seg .chip[data-prio]').forEach(x=>x.classList.remove('active'));
    ch.classList.add('active');
    quickPrio = ch.dataset.prio;
  };
});
$$('.seg .chip[data-prio]')[0].classList.add('active');

/* –ø–ª–∞–Ω —Ñ–∏–ª—å—Ç—Ä */
let planFilter='today';
$('#f-today').onclick=()=>{planFilter='today'; updPlanBtns(); renderPlan();};
$('#f-week').onclick=()=>{planFilter='week'; updPlanBtns(); renderPlan();};
$('#f-month').onclick=()=>{planFilter='month'; updPlanBtns(); renderPlan();};
$('#f-team').onclick=()=>{planFilter='team'; updPlanBtns(); renderPlan();};
function updPlanBtns(){
  $('#f-today').classList.toggle('active', planFilter==='today');
  $('#f-week').classList.toggle('active', planFilter==='week');
  $('#f-month').classList.toggle('active', planFilter==='month');
  $('#f-team').classList.toggle('active', planFilter==='team');
}

/* ===== load ===== */
async function loadAll(){
  try{
    const f = await api('/api/focus');
    focus = f.focus||null;
    $('#focus-input').value = focus?.text || '';
  }catch{}

  try{
    const t = await api('/api/tasks');
    tasks = (t.items||[]).map(normalizeTask);
  }catch{}

  await ensureTeamIdLoaded();
  loadTeamBox();

  renderHome(); renderPlan(); renderStats();
}
loadAll();

/* ===== focus ===== */
$('#focus-save').onclick = async ()=>{
  const text = $('#focus-input').value.trim();
  if (!text) return showToast('–ü—É—Å—Ç–æ–π —Ñ–æ–∫—É—Å');
  try{
    const r = await api('/api/focus','POST',{ text });
    focus = r.focus;
    showToast('–§–æ–∫—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  }catch{
    focus = { text, id:'local_'+Date.now() };
    showToast('–§–æ–∫—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω (–æ—Ñ–ª–∞–π–Ω)');
  }
};

/* ===== quick add ===== */
$('#quick-add').onclick = async ()=>{
  const title = $('#quick-title').value.trim();
  const dueStr = $('#quick-due').value;
  if (!title) return showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');

  let due_ts = null;
  if (dueStr){
    const ms = Date.parse(dueStr);
    if (!isNaN(ms)) due_ts = ms;
  } else {
    const now = new Date();
    if (quickPrio==='today') due_ts = endOfDay(now).getTime();
    else if (quickPrio==='week') due_ts = endOfDay(addDays(now,7)).getTime();
    else if (quickPrio==='month') due_ts = endOfDay(addDays(now,30)).getTime();
  }

  try{
    const payload = { title, due_ts, priority: quickPrio };
    if (quickPrio === 'team') {
      const tid = await ensureTeamIdLoaded();
      if (tid) payload.team_id = tid;
    }
    const r = await api('/api/tasks','POST',payload);
    tasks.unshift(normalizeTask(r.task));
  }catch{
    tasks.unshift({ id:'tmp_'+Date.now(), title, due_ts, is_done:false, priority:quickPrio });
  }

  $('#quick-title').value=''; 
  $('#quick-due').value='';
  renderHome(); renderPlan(); renderStats();
  showToast('–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
};

/* ===== render tasks ===== */
function rowTask(t){
  const el = document.createElement('div'); 
  el.className='task'+(t.is_done?' done':'');

  const chk = document.createElement('button'); 
  chk.className='btn icon'; 
  chk.textContent = t.is_done?'‚úì':'‚óã';
  chk.onclick = async ()=>{
    t.is_done = !t.is_done;
    renderHome(); renderPlan(); renderStats();
    try{ await api('/api/tasks/toggle?id='+t.id,'POST',{}); }catch{}
  };

  const ttl = document.createElement('div'); 
  ttl.className='ttl'; 
  ttl.textContent = t.title;

  const badge = document.createElement('div');
  if (t.due_ts==null){ 
    badge.className='badge'; 
    badge.textContent='–±–µ–∑ —Å—Ä–æ–∫–∞'; 
  } else {
    const past = normalizeDue(t.due_ts) < Date.now();
    badge.className = 'badge ' + (past ? (t.is_done?'ok':'dead') : 'due');
    badge.textContent = (t.is_done?'—Å–¥–µ–ª–∞–Ω–æ ‚Ä¢ ':'–¥–æ ') + fmt(t.due_ts);
  }

  const del = document.createElement('button'); 
  del.className='btn secondary icon'; 
  del.textContent='‚úï';
  del.onclick = async ()=>{
    tasks = tasks.filter(x=>x.id!==t.id);
    renderHome(); renderPlan(); renderStats();
    try{ await api('/api/tasks/delete?id='+t.id,'POST',{}); }catch{}
  };

  el.append(chk, ttl, badge, del);
  return el;
}

function renderHome(){
  const s = startOfDay(new Date()).getTime();
  const e = endOfDay(new Date()).getTime();
  const today = tasks.filter(t => {
    const ms = normalizeDue(t.due_ts);
    return ms!=null && ms>=s && ms<=e;
  }).sort((a,b)=>(a.is_done-b.is_done)||((normalizeDue(a.due_ts)||0)-(normalizeDue(b.due_ts)||0)));
  const box = $('#tasks-today');
  box.innerHTML='';
  if (!today.length){
    box.innerHTML='<div class="muted">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –∑–∞–¥–∞—á.</div>';
    return;
  }
  today.forEach(t=>box.appendChild(rowTask(t)));
}

function renderPlan(){
  let arr = tasks.slice();
  const now = new Date();

  if (planFilter==='today') {
    const dayStart = startOfDay(now).getTime();
    const dayEnd = endOfDay(now).getTime();
    arr = arr.filter(t=>{
      const ms = normalizeDue(t.due_ts);
      return !t.team_id && ms!=null && ms>=dayStart && ms<=dayEnd;
    });
  } else if (planFilter==='week') {
    const weekEnd = endOfDay(addDays(now,7)).getTime();
    arr = arr.filter(t=>{
      const ms = normalizeDue(t.due_ts);
      return !t.team_id && ms!=null && ms<=weekEnd;
    });
  } else if (planFilter==='month') {
    const monthEnd = endOfDay(addDays(now,30)).getTime();
    arr = arr.filter(t=>{
      const ms = normalizeDue(t.due_ts);
      return !t.team_id && ms!=null && ms<=monthEnd;
    });
  } else if (planFilter==='team') {
    arr = arr.filter(t=>{
      if (t.team_id) {
        return !currentTeamId || t.team_id === currentTeamId;
      }
      return t.priority === 'team';
    });
  }

  arr.sort((a,b)=>(a.is_done-b.is_done)||((normalizeDue(a.due_ts)||1e20)-(normalizeDue(b.due_ts)||1e20)));
  const box = $('#tasks-plan');
  box.innerHTML='';
  if (!arr.length){
    box.innerHTML='<div class="muted">–ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</div>';
    return;
  }
  arr.forEach(t=>box.appendChild(rowTask(t)));
}

/* ===== stats ===== */
function renderStats(){
  const total = tasks.length;
  const done = tasks.filter(t=>t.is_done).length;
  const overdue = tasks.filter(t=>{
    const ms = normalizeDue(t.due_ts);
    return !t.is_done && ms!=null && ms < Date.now();
  }).length;
  const rate = total ? Math.round(done*100/total) : 0;

  $('#m-total').textContent = total;
  $('#m-done').textContent  = done;
  $('#m-rate').textContent  = rate+'%';
  $('#m-over').textContent  = overdue;

  renderWeekChart();
}

function renderWeekChart(){
  const chart = $('#week-chart');
  chart.innerHTML='';

  for (let i=6;i>=0;i--){
    const day = addDays(new Date(),-i);
    const dayStart = startOfDay(day).getTime();
    const dayEnd = endOfDay(day).getTime();
    const dayTasks = tasks.filter(t=>{
      const ms = normalizeDue(t.due_ts);
      return ms!=null && ms>=dayStart && ms<=dayEnd;
    });
    const doneCount = dayTasks.filter(t=>t.is_done).length;
    const totalCount = dayTasks.length;
    const height = totalCount>0 ? (doneCount/totalCount)*100 : 10;

    const bar = document.createElement('div');
    bar.style.cssText = `
      flex:1;
      background:linear-gradient(to top,var(--brand),var(--brand-2));
      border-radius:4px 4px 0 0;
      height:${height}%;
      min-height:8px;
      position:relative;
    `;
    const label = document.createElement('div');
    label.style.cssText=`
      position:absolute;
      bottom:-20px;
      left:0;right:0;
      text-align:center;
      font-size:10px;
      color:var(--muted);
    `;
    label.textContent = day.toLocaleDateString('ru-RU',{weekday:'short'});
    bar.appendChild(label);
    chart.appendChild(bar);
  }
}

/* ===== chat events ===== */
$('#close-chat').onclick = closeChat;
$('#create-first-chat').onclick = ()=>$('#new-chat-modal').classList.add('active');
$('#cancel-new-chat').onclick = ()=>{
  $('#new-chat-modal').classList.remove('active');
  $('#new-chat-title').value='';
};
$('#confirm-new-chat').onclick = ()=>{
  const title = $('#new-chat-title').value.trim() || '–ù–æ–≤—ã–π —á–∞—Ç';
  const id = createNewChat(title);
  $('#new-chat-modal').classList.remove('active');
  $('#new-chat-title').value='';
  openChat(id);
  showToast('–ß–∞—Ç —Å–æ–∑–¥–∞–Ω');
};
$('#chat-send').onclick = async ()=>{
  const text = $('#chat-input').value.trim();
  if (!text) return;
  if (!currentChatId){
    const id = createNewChat('–ù–æ–≤—ã–π —á–∞—Ç');
    openChat(id);
  }
  $('#chat-input').value='';
  addMessageToChat('user', text);
  try{
    const r = await api('/api/chat','POST',{ text, chat_id: currentChatId });
    addMessageToChat('assistant', r.reply || '–Ø –æ–±—Ä–∞–±–æ—Ç–∞–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å –∏ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å!');
  }catch{
    addMessageToChat('assistant','–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ —è –º–æ–≥—É –ø–æ–º–æ—á—å –æ—Ñ–ª–∞–π–Ω: —Ä–∞–∑–±–∏—Ç—å –∑–∞–¥–∞—á–∏, –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å –º–µ—Ç–æ–¥–∏–∫–∏, —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω.');
  }
};
$('#chat-input').addEventListener('keydown',e=>{ if (e.key==='Enter') $('#chat-send').click(); });
$('#new-chat-modal').onclick = e=>{ if (e.target===$('#new-chat-modal')) $('#new-chat-modal').classList.remove('active'); };
$('#chat-window-overlay').onclick = e=>{ if (e.target===$('#chat-window-overlay')) closeChat(); };

/* ===== –ø—Ä–æ—Ñ–∏–ª—å ===== */
$$('.lang-btn').forEach(btn=>{
  btn.onclick = ()=>{
    $$('.lang-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const map={ru:'–†—É—Å—Å–∫–∏–π',en:'English'};
    showToast(`–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${map[btn.dataset.lang]||btn.textContent}`);
  };
});
$('#btn-tariff').onclick = ()=>showToast('–†–∞–∑–¥–µ–ª "–¢–∞—Ä–∏—Ñ—ã" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
$('#btn-help').onclick = ()=>showToast('–†–∞–∑–¥–µ–ª "–ü–æ–º–æ—â—å" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
$('#btn-guide').onclick = ()=>showToast('–†–∞–∑–¥–µ–ª "–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
$('#btn-consult').onclick = ()=>showToast('–†–∞–∑–¥–µ–ª "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');

/* ===== TEAM UI ===== */
let _invite = { join_code:null, invite_link_tg:null, invite_link_http:null };

async function loadTeamBox(){
  try{
    const inv = await api('/api/team/invite','GET');
    _invite = inv || {};
    $('#team-code').value = inv.join_code || '';
  }catch{
    $('#team-code').value = '';
  }

  try{
    const r = await api('/api/team/members','GET');
    const ul = $('#team-members'); ul.innerHTML='';
    (r.members||[]).forEach(m=>{
      const name = m.username ? '@'+m.username :
        [m.first_name,m.last_name].filter(Boolean).join(' ') || m.tg_id;
      const li = document.createElement('li');
      li.textContent = name;
      ul.appendChild(li);
    });
    if (!r.members?.length){
      ul.innerHTML = '<li class="muted">–í—ã –ø–æ–∫–∞ –æ–¥–∏–Ω –≤ –∫–æ–º–∞–Ω–¥–µ</li>';
    }
  }catch{
    $('#team-members').innerHTML = '<li class="muted">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å</li>';
  }
}

$('#btn-team-refresh').onclick = loadTeamBox;
$('#copy-code').onclick = async ()=>{
  if (!_invite.join_code) return showToast('–ö–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
  await navigator.clipboard.writeText(_invite.join_code);
  showToast('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
};
$('#copy-tg-link').onclick = async ()=>{
  const link = _invite.invite_link_tg || _invite.invite_link_http || '';
  if (!link) return showToast('–°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É');
  await navigator.clipboard.writeText(link);
  showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
};
$('#join-btn').onclick = async ()=>{
  const token = $('#join-input').value.trim();
  if (!token) return;
  try{
    await api('/api/team/join','POST',{ token });
    $('#join-input').value='';
    showToast('–ì–æ—Ç–æ–≤–æ! –í—ã –≤ –∫–æ–º–∞–Ω–¥–µ');
    loadTeamBox();
    ensureTeamIdLoaded();
  }catch{
    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—Å—Ç—É–ø–∏—Ç—å');
  }
};

(function tryAutoJoin(){
  const params = new URLSearchParams(location.search);
  const token = params.get('join');
  const isTMA = !!(window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe?.user?.id);
  if (token && (tgId || isTMA)) {
    api('/api/team/join','POST',{ token }).then(()=>{
      showToast('–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–∞–Ω–¥–µ');
      loadTeamBox();
      ensureTeamIdLoaded();
    }).catch(()=>{});
  }
})();

(function syncProfile(){
  const u = window.Telegram?.WebApp?.initDataUnsafe?.user;
  if (!u) return;
  api('/api/user/profile','POST',{
    username:u.username||null,
    first_name:u.first_name||null,
    last_name:u.last_name||null
  }).catch(()=>{});
})();
</script>
</body>
</html>
