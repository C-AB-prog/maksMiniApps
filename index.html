<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Growth Assistant</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
/* ===================== */
/*       DESIGN TOKENS   */
/* ===================== */
:root{
  color-scheme: light;
  --ink:#0E1220; --muted:#6B7280; --line:#E7ECF5;
  --brand:#5B6CFF; --brand-2:#7F6BFF; --brand-3:#46C7F4;
  --ok:#10B981; --warn:#F59E0B; --danger:#EF4444;
  --bg:#F3F6FF;
  --bg-grad:
    radial-gradient(1200px 600px at 100% -10%, rgba(123,195,255,.20), transparent 60%),
    radial-gradient(900px 500px at -10% 0%, rgba(135,121,255,.18), transparent 55%),
    #F3F6FF;
  --card:rgba(255,255,255,.86); --card-blur:blur(10px);
  --r:18px; --shadow:0 10px 28px rgba(17,24,39,.10); --shadow-2:0 16px 40px rgba(91,108,255,.20);
  --safe-bottom:env(safe-area-inset-bottom,0px); --safe-top:env(safe-area-inset-top,0px);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  color:var(--ink)!important; background:var(--bg-grad)!important;
  font:15px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  -webkit-tap-highlight-color:transparent;
}

/* ===================== APP BAR ===================== */
.appbar{position:sticky;top:0;z-index:20;padding:calc(8px + var(--safe-top)) 18px 12px;
  background:linear-gradient(180deg,rgba(255,255,255,.75),rgba(255,255,255,.55));
  backdrop-filter:saturate(160%) blur(8px); border-bottom:1px solid var(--line);}
.appbar h1{margin:0;font-size:22px;font-weight:900;letter-spacing:.2px;
  background:linear-gradient(90deg,var(--brand),var(--brand-2));
  -webkit-background-clip:text;background-clip:text;color:transparent}
.appbar .sub{color:var(--muted);font-size:12px}
.appbar-badges{display:flex;gap:8px;margin-top:4px}
.badge{font-size:11px;padding:4px 10px;border-radius:999px;background:#9CA3AF;color:#fff;display:inline-flex;align-items:center}
.badge.ok{background:var(--ok)}
.badge.off{background:var(--danger)}
.badge.info{background:var(--brand); color:#fff}

/* ===================== LAYOUT ===================== */
.container{max-width:940px;margin:0 auto;padding:16px 14px 110px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;backdrop-filter:var(--card-blur)}
h3{margin:0 0 12px 0;font-size:16px}
section{display:none;gap:14px}
section.active{display:grid}
.grid-2{grid-template-columns:1fr}
@media(min-width:860px){.grid-2{grid-template-columns:1.15fr .85fr}}

/* ===================== INPUTS / BUTTONS ===================== */
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
.input,input[type="text"],input[type="datetime-local"]{width:100%;background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px 14px;outline:none;transition:border-color .2s,box-shadow .2s}
.input:focus,input[type="text"]:focus,input[type="datetime-local"]:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(91,108,255,.12)}
.btn{appearance:none;border:none;padding:14px 16px;border-radius:14px;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;cursor:pointer;font-weight:800;letter-spacing:.2px;box-shadow:var(--shadow-2);transition:transform .06s ease-in-out,filter .2s}
.btn:active{transform:translateY(1px)}
.btn.secondary{background:#fff;color:var(--ink);border:1px solid var(--line);box-shadow:none;font-weight:700}
.btn.ghost{background:rgba(91,108,255,.10);color:var(--brand);box-shadow:none}
.btn.icon{padding:10px 12px;border-radius:12px}

/* ===================== CHIPS ===================== */
.seg{display:flex;gap:8px;flex-wrap:wrap}
.seg .chip{padding:9px 13px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600;transition:all .15s}
.seg .chip.active{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border-color:transparent;box-shadow:0 8px 22px rgba(91,108,255,.28)}

/* ===================== LISTS ===================== */
.list{display:flex;flex-direction:column;gap:10px}
.task{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--line);border-radius:14px;background:#fff;transition:all .3s}
.task:hover{border-color:var(--brand);box-shadow:0 4px 12px rgba(91,108,255,.08)}
.task .ttl{flex:1}
.task.done{opacity:.7}
.task.done .ttl{text-decoration:line-through}
.badge.s{font-size:12px;padding:5px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted)}
.badge.s.ok{color:#065f46;border-color:#10b981;background:#ecfdf5}
.badge.s.due{color:#7c2d12;border-color:#f59e0b;background:#fffbeb}
.badge.s.dead{color:#991b1b;border-color:#ef4444;background:#fef2f2}

/* ===================== CHAT CARDS ===================== */
.chat-container{display:flex;flex-direction:column;gap:14px}
.chat-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-bottom:16px}
.chat-item{background:#fff;border:2px solid var(--line);border-radius:16px;padding:16px 12px;text-align:center;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1);min-height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;animation:slideUp .4s cubic-bezier(.4,0,.2,1)}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.chat-item:hover{border-color:var(--brand);transform:translateY(-4px) scale(1.02);box-shadow:0 12px 32px rgba(91,108,255,.15)}
.chat-item.active{border-color:var(--brand);background:linear-gradient(135deg,#f8faff,#f0f4ff);box-shadow:0 8px 25px rgba(91,108,255,.15);transform:translateY(-2px)}
.chat-item.new{border:2px dashed var(--muted);background:transparent;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{border-color:var(--muted);transform:scale(1)}50%{border-color:var(--brand);transform:scale(1.02)}}
.chat-item.new:hover{border-color:var(--brand);background:rgba(91,108,255,.03);animation:none}
.chat-icon{font-size:24px;margin-bottom:8px;opacity:.7;transition:all .3s}
.chat-item.active .chat-icon,.chat-item:hover .chat-icon{opacity:1;transform:scale(1.1)}
.chat-title{font-weight:600;font-size:13px;line-height:1.3;margin-bottom:4px}
.chat-date{font-size:11px;color:var(--muted)}
.chat-delete{position:absolute;top:6px;right:6px;width:20px;height:20px;border-radius:50%;background:var(--danger);color:#fff;border:none;font-size:12px;cursor:pointer;opacity:0;transition:all .3s;display:flex;align-items:center;justify-content:center;transform:scale(.8)}
.chat-item:hover .chat-delete{opacity:1;transform:scale(1)}

/* ===================== FULLSCREEN CHAT ===================== */
.chat-fullscreen{display:none;position:fixed;inset:0;background:#fff;z-index:1000;flex-direction:column;transform:translateY(100%);transition:transform .4s cubic-bezier(.4,0,.2,1)}
.chat-fullscreen.active{display:flex;transform:translateY(0)}
.chat-fullscreen.slide-out{transform:translateY(100%)}
.chat-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--line);background:#fff;flex-shrink:0;animation:slideDown .3s cubic-bezier(.4,0,.2,1)}
@keyframes slideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
.chat-header-title{font-weight:600;font-size:18px;color:var(--ink)}
.chat-header-actions{display:flex;gap:8px}
.chat-body{flex:1;overflow:auto;padding:20px;display:flex;flex-direction:column;gap:16px;background:linear-gradient(180deg,#FAFBFF,#F7FAFF);scroll-behavior:smooth}
.msg{max-width:85%;padding:14px 18px;border-radius:20px;font-size:15px;line-height:1.4;word-wrap:break-word;animation:messageSlide .3s cubic-bezier(.4,0,.2,1);transform-origin:center bottom}
@keyframes messageSlide{from{opacity:0;transform:translateY(10px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}
.msg.user{align-self:flex-end;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border-bottom-right-radius:8px}
.msg.assistant{align-self:flex-start;background:#fff;border:1px solid var(--line);border-bottom-left-radius:8px}
.chat-foot{display:flex;gap:12px;padding:16px 20px;border-top:1px solid var(--line);background:#fff;flex-shrink:0;animation:slideUp .3s cubic-bezier(.4,0,.2,1) .1s both}

/* ===================== MODAL ===================== */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1100;align-items:center;justify-content:center;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal.active{display:flex}
.modal-content{background:#fff;border-radius:24px;padding:28px;max-width:400px;width:90%;box-shadow:0 25px 50px rgba(0,0,0,.25);animation:scaleIn .3s cubic-bezier(.4,0,.2,1);transform-origin:center}
@keyframes scaleIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
.modal-title{margin:0 0 20px 0;font-size:20px;font-weight:700;text-align:center;color:var(--ink)}

/* ===================== NAV ===================== */
.nav{position:fixed;left:0;right:0;bottom:0;z-index:25;padding:10px 10px calc(10px + var(--safe-bottom));background:rgba(255,255,255,.9);border-top:1px solid var(--line);backdrop-filter:saturate(160%) blur(10px);box-shadow:0 -8px 24px rgba(17,24,39,.08);display:flex;justify-content:space-around;transition:transform .3s cubic-bezier(.4,0,.2,1)}
.nav.hidden{transform:translateY(100%)}
.nav .item{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:64px;color:var(--muted);font-size:12px;transition:all .3s cubic-bezier(.4,0,.2,1)}
.nav .item:hover{transform:translateY(-2px)}
.nav .item svg{opacity:.6;transition:all .3s cubic-bezier(.4,0,.2,1);transform:scale(1)}
.nav .item.active{color:var(--brand)}
.nav .item.active svg{opacity:1;transform:translateY(-2px) scale(1.1);filter:drop-shadow(0 4px 8px rgba(91,108,255,.35))}

/* ===================== TOAST ===================== */
.toast{position:fixed;left:50%;bottom:calc(78px + var(--safe-bottom));transform:translateX(-50%) translateY(20px);background:#111827;color:#fff;padding:12px 18px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.3);z-index:999;animation:toastSlide .4s cubic-bezier(.4,0,.2,1) forwards}
@keyframes toastSlide{to{transform:translateX(-50%) translateY(0)}}

.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
.muted{color:var(--muted)}

/* ===================== PROFILE / STATS ===================== */
.profile-section{margin-bottom:20px}
.profile-section h4{margin:0 0 12px 0;font-size:15px;color:var(--ink)}
.profile-actions{display:flex;flex-direction:column;gap:8px}
.profile-btn{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#fff;border:1px solid var(--line);border-radius:14px;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1)}
.profile-btn:hover{background:var(--bg);border-color:var(--brand);transform:translateX(4px)}
.profile-btn .arrow{color:var(--muted);font-size:14px;transition:transform .3s}
.profile-btn:hover .arrow{transform:translateX(2px)}
.lang-switch{display:flex;gap:8px;margin-top:8px}
.lang-btn{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;flex:1;transition:all .3s cubic-bezier(.4,0,.2,1)}
.lang-btn.active{background:var(--brand);color:#fff;border-color:var(--brand);transform:scale(1.05)}

.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin:16px 0}
.stat-card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;text-align:center}
.stat-value{font-size:24px;font-weight:800;margin-bottom:4px}
.stat-label{font-size:12px;color:var(--muted)}
.week-chart{height:200px;display:flex;align-items:end;gap:8px;margin-top:20px}
.chart-bar{flex:1;background:linear-gradient(to top,var(--brand),var(--brand-2));border-radius:4px 4px 0 0;position:relative;transition:height .5s}
.chart-label{position:absolute;bottom:-20px;left:0;right:0;text-align:center;font-size:10px;color:var(--muted)}

/* Account Setup */
.account-setup{background:linear-gradient(135deg,#f0f4ff,#e8f2ff);border:1px solid var(--brand)}
.form-grid{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end}
.small-text{font-size:12px;color:var(--muted);margin-top:6px;grid-column:1 / -1}
</style>
</head>
<body>

<!-- Top bar -->
<div class="appbar">
  <h1>Growth Assistant</h1>
  <div class="sub">Фокус дня • задачи • план • чат • статистика</div>
  <div class="appbar-badges">
    <span id="badge" class="badge off">offline</span>
    <span id="who" class="badge info">tg_id: —</span>
  </div>
</div>

<div class="container">
  <!-- Главная -->
  <section id="screen-home" class="active grid-2">
    <div class="card account-setup">
      <h3>Настройка аккаунта</h3>
      <div class="form-grid">
        <div><input id="tgInput" class="input" type="text" placeholder="Введите ваш Telegram ID" /></div>
        <button id="saveTg" class="btn">Сохранить</button>
        <div class="small-text">В Telegram WebApp user.id берётся автоматически. В браузере на ПК — из поля или параметра ?tg_id=.</div>
      </div>
    </div>

    <div class="card">
      <h3>Фокус дня</h3>
      <label>Самое главное сегодня</label>
      <div style="display:flex;gap:10px">
        <input id="focusInput" class="input" type="text" placeholder="Например: закрыть отчёт" />
        <button id="saveFocus" class="btn">Сохранить</button>
      </div>
    </div>

    <div class="card">
      <h3>Быстрое добавление</h3>
      <div class="seg">
        <div class="chip" data-prio="today">Сегодня</div>
        <div class="chip" data-prio="week">Неделя</div>
        <div class="chip" data-prio="month">Месяц</div>
        <div class="chip" data-prio="team">Команда</div>
      </div>
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
        <input id="taskTitle" class="input" type="text" placeholder="Название задачи" />
        <input id="taskDue" class="input" type="datetime-local" />
        <button id="addTask" class="btn">Добавить задачу</button>
      </div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <h3>Задачи на сегодня</h3>
      <div id="tasks-today" class="list"></div>
    </div>
  </section>

  <!-- План -->
  <section id="screen-plan" class="grid">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">План задач</h3>
        <div class="seg">
          <div id="f-today" class="chip active">Сегодня</div>
          <div id="f-week" class="chip">Неделя</div>
          <div id="f-month" class="chip">Месяц</div>
          <div id="f-team" class="chip">Команда</div>
        </div>
      </div>
      <div id="tasks-plan" class="list"></div>
    </div>
  </section>

  <!-- Чат -->
  <section id="screen-chat" class="grid">
    <div class="card">
      <h3>Мои чаты с ассистентом</h3>
      <div class="chat-container">
        <div id="chat-list" class="chat-list"></div>
        <div id="no-chats-message" style="text-align:center;padding:40px 20px;">
          <div style="font-size:48px;margin-bottom:16px;opacity:.5;">💬</div>
          <h3 style="margin:0 0 8px 0;">Нет активных чатов</h3>
          <p class="muted">Создайте новый чат, чтобы начать общение с ассистентом</p>
          <button class="btn" id="create-first-chat" style="margin-top:16px;">Создать чат</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Статистика -->
  <section id="screen-stats" class="grid grid-2">
    <div class="card">
      <h3>Статистика продуктивности</h3>
      <div class="stats-grid">
        <div class="stat-card"><div id="m-total" class="stat-value">0</div><div class="stat-label">Всего задач</div></div>
        <div class="stat-card"><div id="m-done" class="stat-value" style="color:var(--ok)">0</div><div class="stat-label">Выполнено</div></div>
        <div class="stat-card"><div id="m-rate" class="stat-value">0%</div><div class="stat-label">Процент успеха</div></div>
        <div class="stat-card"><div id="m-over" class="stat-value" style="color:var(--danger)">0</div><div class="stat-label">Просрочено</div></div>
      </div>
      <p class="muted" style="margin-top:12px"><b>Гипотеза:</b> «Если фиксировать задачи и ставить дедлайны, завершу ≥70% вовремя».<br/><b>Действие:</b> добавляй/закрывай задачи вовремя. <b>Данные:</b> метрики выше. <b>Инсайт:</b> держи ≥70%.</p>
    </div>
    <div class="card">
      <h3>Прогресс за неделю</h3>
      <div id="week-chart" class="week-chart"></div>
    </div>
  </section>

  <!-- Профиль -->
  <section id="screen-profile" class="grid">
    <div class="card">
      <h3>Профиль</h3>
      <div class="muted" style="margin-bottom:16px">Telegram ID: <span id="profile-id" class="mono">–</span></div>
      <div class="profile-section">
        <h4>Настройки</h4>
        <label>Язык интерфейса</label>
        <div class="lang-switch">
          <div class="lang-btn active" data-lang="ru">Русский</div>
          <div class="lang-btn" data-lang="en">English</div>
        </div>
      </div>
      <div class="profile-section">
        <h4>Аккаунт</h4>
        <div class="profile-actions">
          <div class="profile-btn" id="btn-tariff"><span>Тариф</span><span style="color:var(--brand);font-weight:600">Пробный</span></div>
        </div>
      </div>
      <div class="profile-section">
        <h4>Помощь</h4>
        <div class="profile-actions">
          <div class="profile-btn" id="btn-help"><span>Помощь и поддержка</span><span class="arrow">›</span></div>
          <div class="profile-btn" id="btn-guide"><span>Как пользоваться</span><span class="arrow">›</span></div>
          <div class="profile-btn" id="btn-consult"><span>Записаться на консультацию</span><span class="arrow">›</span></div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- FULLSCREEN CHAT -->
<div id="chat-fullscreen" class="chat-fullscreen">
  <div class="chat-header">
    <div class="chat-header-title" id="current-chat-title">Чат</div>
    <div class="chat-header-actions"><button class="btn ghost icon" id="close-chat">✕</button></div>
  </div>
  <div id="chatLog" class="chat-body"></div>
  <div class="chat-foot">
    <input id="msg" class="input" type="text" placeholder="Напишите сообщение..." />
    <button id="send" class="btn" aria-label="Отправить">➤</button>
  </div>
</div>

<!-- Modal -->
<div id="new-chat-modal" class="modal">
  <div class="modal-content">
    <h3 class="modal-title">Название чата</h3>
    <input type="text" id="new-chat-title" class="input" placeholder="Например: Планирование проекта" style="margin-bottom:20px;">
    <div style="display:flex;gap:10px;">
      <button class="btn secondary" id="cancel-new-chat" style="flex:1;">Отмена</button>
      <button class="btn" id="confirm-new-chat" style="flex:1;">Создать</button>
    </div>
  </div>
</div>

<!-- Bottom navigation -->
<nav class="nav" id="bottom-nav">
  <div class="item active" data-go="home">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 7v10a1 1 0 0 1-1 1h-6v-6H10v6H4a1 1 0 0 1-1-1V10l9-7z"/></svg>
    Главная
  </div>
  <div class="item" data-go="plan">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M4 5h16v2H4zM4 11h16v2H4zM4 17h10v2H4z"/></svg>
    План
  </div>
  <div class="item" data-go="chat">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
    Чат
  </div>
  <div class="item" data-go="stats">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/></svg>
    Статистика
  </div>
  <div class="item" data-go="profile">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.42 0-8 2.24-8 5v3h16v-3c0-2.76-3.58-5-8-5z"/></svg>
    Профиль
  </div>
</nav>

<div id="toast" class="toast" style="display:none"></div>

<script>
/* ============ helpers ============ */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const showToast=t=>{const el=$('#toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',1800);};
const startOfDay=d=>{const x=new Date(d);x.setHours(0,0,0,0);return x;}
const endOfDay=d=>{const x=new Date(d);x.setHours(23,59,59,999);return x;}
const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x;}

/* ============ TG ID ============ */
let tgId=0;
function readTgId(){try{const wa=window.Telegram?.WebApp?.initDataUnsafe;const uid=wa?.user?.id;if(uid&&/^\d+$/.test(String(uid)))return Number(uid);}catch{}const qid=new URLSearchParams(location.search).get('tg_id');if(qid&&/^\d+$/.test(qid))return Number(qid);const ls=localStorage.getItem('tg_id');if(ls&&/^\d+$/.test(ls))return Number(ls);return 0;}
function saveTgIdLocal(id){if(id&&/^\d+$/.test(String(id))){localStorage.setItem('tg_id',String(id)); tgId=Number(id); updateTgIdDisplay();}}
function updateTgIdDisplay(){const w=$('#who'); if(w) w.textContent=`tg_id: ${tgId||'—'}`; const p=$('#profile-id'); if(p) p.textContent=tgId||'–';}

/* ============ ONLINE ============ */
async function ping(){try{const r=await fetch('/api/ping',{headers:tgId?{'X-TG-ID':String(tgId)}:{}});const ok=(await r.json())?.ok;const b=$('#badge');if(b){b.textContent=ok?'online':'offline';b.className='badge '+(ok?'ok':'off');}return !!ok;}catch{const b=$('#badge');if(b){b.textContent='offline';b.className='badge off';}return false;}}

/* ============ CHAT (server sessions + local fallback) ============ */
let serverChats=[];       // серверные сессии (синхронизируются между устройствами)
let chatsLocal=[];        // локальные (только офлайн-резерв)
let currentChat={source:null, id:null, title:''}; // {source:'server'|'local', id:string|null}

/* универсальный выбор массива из произвольного ответа */
function pickArray(obj){
  if(Array.isArray(obj))return obj;
  if(!obj||typeof obj!=='object')return [];
  const keys=['items','data','rows','result','list','chats','sessions'];
  for(const k of keys){
    const v=obj[k];
    if(Array.isArray(v)) return v;
    if(v&&typeof v==='object'){
      for(const kk of keys){ if(Array.isArray(v[kk])) return v[kk]; }
    }
  }
  for(const v of Object.values(obj)){ if(Array.isArray(v)) return v; }
  return [];
}

/* normalize message */
function normMsg(m){return {role:(m.role||m.author||'assistant'), content:(m.content||m.text||''), timestamp:m.timestamp||m.createdAt||new Date().toISOString()};}
function normChat(c){return {id:String(c.id||c.chat_id||c._id), title:c.title||c.name||'Чат', updatedAt:c.updatedAt||c.updated_at||c.createdAt||new Date().toISOString()}}

/* Local storage */
function loadLocalChats(){try{const s=localStorage.getItem('growth_assistant_chats'); chatsLocal=s?JSON.parse(s):[];}catch{chatsLocal=[];}}
function saveLocalChats(){try{localStorage.setItem('growth_assistant_chats',JSON.stringify(chatsLocal));}catch{}}

/* Server CRUD */
async function fetchServerChats(){
  if(!tgId) return serverChats=[];
  try{
    const r=await fetch(`/api/chats?tg_id=${tgId}`,{headers:{'X-TG-ID':String(tgId)}});
    const j=await r.json();
    serverChats=pickArray(j).map(normChat);
  }catch{ serverChats=[]; }
}
async function createServerChat(title){
  const r=await fetch('/api/chats',{method:'POST',headers:{'Content-Type':'application/json','X-TG-ID':String(tgId)},body:JSON.stringify({title,tg_id:tgId})});
  const j=await r.json().catch(()=>({}));
  await fetchServerChats();
  const created=(j?.id)|| (serverChats[0]?.id);
  return created? String(created): null;
}
async function deleteServerChat(id){
  await fetch('/api/chats',{method:'DELETE',headers:{'Content-Type':'application/json','X-TG-ID':String(tgId)},body:JSON.stringify({id,tg_id:tgId})});
  await fetchServerChats(); renderChatList();
}
async function loadServerHistory(chat_id){
  try{
    const r=await fetch(`/api/chat-history?tg_id=${tgId}&chat_id=${encodeURIComponent(chat_id)}`,{headers:{'X-TG-ID':String(tgId)}});
    const j=await r.json();
    return pickArray(j).map(normMsg);
  }catch{return []}
}
async function sendToServer(chat_id, text){
  await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json','X-TG-ID':String(tgId)},body:JSON.stringify({message:text,tg_id:tgId,chat_id})});
}

/* UI: list/render */
function renderChatList(){
  const box=$('#chat-list'); box.innerHTML='';
  const useServer = serverChats.length>0 || $('#badge').textContent==='online';
  const list = useServer? serverChats : chatsLocal;

  list.forEach((c,i)=>{
    const el=document.createElement('div');
    el.className='chat-item'; el.style.animationDelay=`${i*0.06}s`;
    el.innerHTML=`
      <button class="chat-delete" onclick="event.stopPropagation(); ${useServer?`deleteServerChat('${c.id}')`:`deleteLocalChat('${c.id}')`}">×</button>
      <div class="chat-icon">💬</div>
      <div class="chat-title">${c.title}</div>
      <div class="chat-date">${new Date(c.updatedAt||Date.now()).toLocaleDateString('ru-RU')}</div>`;
    el.onclick=()=> openChat(useServer?'server':'local', c.id, c.title);
    box.appendChild(el);
  });

  const newEl=document.createElement('div');
  newEl.className='chat-item new';
  newEl.innerHTML=`<div class="chat-icon">+</div><div class="chat-title">Новый чат</div>`;
  newEl.onclick=()=>$('#new-chat-modal').classList.add('active');
  box.appendChild(newEl);

  $('#no-chats-message').style.display = list.length? 'none':'block';
}
function deleteLocalChat(id){chatsLocal=chatsLocal.filter(c=>c.id!==id); saveLocalChats(); renderChatList();}

function openChat(source,id,title){
  currentChat={source,id,title};
  $('#current-chat-title').textContent=title||'Чат';
  $('#bottom-nav').classList.add('hidden');
  $('#chat-fullscreen').classList.add('active');
  if(source==='server'){ renderServerMessages([]); loadHistoryIntoUI(); }
  else { const chat=chatsLocal.find(c=>c.id===id)||{messages:[]}; renderLocalMessages(chat.messages); }
}
function closeChat(){const fs=$('#chat-fullscreen'); fs.classList.add('slide-out'); setTimeout(()=>{fs.classList.remove('active','slide-out'); $('#bottom-nav').classList.remove('hidden'); $('#chatLog').innerHTML=''; currentChat={source:null,id:null,title:''};},300);}

/* fullscreen chat renderers */
function renderLocalMessages(messages){const box=$('#chatLog'); box.innerHTML=''; messages.forEach((m,i)=>{const b=document.createElement('div'); b.className=`msg ${m.role||'assistant'}`; b.textContent=m.content||''; b.style.animationDelay=`${i*0.03}s`; box.appendChild(b)}); box.scrollTop=box.scrollHeight;}
function renderServerMessages(messages){const box=$('#chatLog'); box.innerHTML=''; (messages||[]).forEach((m,i)=>{const b=document.createElement('div'); b.className=`msg ${m.role||'assistant'}`; b.textContent=m.content||''; b.style.animationDelay=`${i*0.03}s`; box.appendChild(b)}); box.scrollTop=box.scrollHeight;}
async function loadHistoryIntoUI(){ if(currentChat.source!=='server')return; const msgs=await loadServerHistory(currentChat.id); renderServerMessages(msgs); }

async function sendMessage(){
  const inp=$('#msg'); const text=inp?.value?.trim(); if(!text) return; inp.value='';
  if(currentChat.source==='server'){
    // мгновенный пузырь
    renderServerMessages([...(Array.from($('#chatLog').children).map(n=>({role:n.classList.contains('user')?'user':'assistant',content:n.textContent}))), {role:'user',content:text}]);
    try{ await sendToServer(currentChat.id, text); await loadHistoryIntoUI(); }catch{ renderServerMessages([...(Array.from($('#chatLog').children).map(n=>({role:n.classList.contains('user')?'user':'assistant',content:n.textContent}))), {role:'assistant',content:'Сервер недоступен. Повторите позже.'}]); }
  }else{
    // локальная сессия
    const idx=chatsLocal.findIndex(c=>c.id===currentChat.id);
    if(idx>=0){chatsLocal[idx].messages.push({role:'user',content:text,timestamp:new Date().toISOString()});chatsLocal[idx].updatedAt=new Date().toISOString();saveLocalChats();renderLocalMessages(chatsLocal[idx].messages);}
  }
}

/* Create chat */
$('#confirm-new-chat')?.addEventListener('click', async ()=>{
  const title=$('#new-chat-title').value.trim()||'Новый чат';
  $('#new-chat-modal').classList.remove('active'); $('#new-chat-title').value='';
  const online = $('#badge').textContent==='online';
  if(online && tgId){
    const id = await createServerChat(title);
    await fetchServerChats(); renderChatList();
    if(id){ openChat('server', id, title); showToast('Чат создан'); }
  }else{
    // локально
    const id='chat_'+Date.now();
    chatsLocal.unshift({id,title,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),messages:[]});
    saveLocalChats(); renderChatList(); openChat('local', id, title); showToast('Чат (локально) создан');
  }
});
$('#cancel-new-chat')?.addEventListener('click',()=>$('#new-chat-modal').classList.remove('active'));

/* ============ TASKS ============ */
let tasks=[];
function normalizeDue(v){
  if(v===null||v===undefined) return null;
  if(typeof v==='string' && v.trim().toLowerCase()==='null') return null;
  const n=Number(v); if(!Number.isNaN(n) && v!=='' && v!==true && v!==false){ return n<1e12? n*1000 : n; }
  const ms=Date.parse(v); if(!Number.isNaN(ms)) return ms;
  return null;
}
function normalizeTask(t){
  const dueRaw = t.due_at ?? t.dueAt ?? t.deadline ?? t.due ?? null;
  return { id:(t.id??t.task_id??t._id), title:(t.title??t.text??t.name??'Без названия'), done:!!(t.done??t.is_done??t.completed), due_at: dueRaw, due_ts: normalizeDue(dueRaw) };
}
function fmt(ts){const ms=normalizeDue(ts); if(ms===null) return '—'; const d=new Date(ms); if(Number.isNaN(d.getTime())) return '—'; return d.toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});}

function rowTask(t){
  const el=document.createElement('div'); el.className='task'+(t.done?' done':'');
  const chk=document.createElement('button'); chk.className='btn icon'; chk.textContent=t.done?'✓':'○'; chk.onclick=()=>toggleTask(t.id,!t.done);
  const ttl=document.createElement('div'); ttl.className='ttl'; ttl.textContent=t.title||'Без названия';
  const badge=document.createElement('div');
  if(t.due_ts==null){badge.className='badge s'; badge.textContent='без срока';}
  else{const past=t.due_ts < Date.now(); badge.className='badge s '+(past?(t.done?'ok':'dead'):'due'); badge.textContent=(t.done?'сделано • ':'до ')+fmt(t.due_ts);}
  const del=document.createElement('button'); del.className='btn secondary icon'; del.textContent='✕'; del.onclick=()=>deleteTask(t.id);
  el.append(chk,ttl,badge,del); return el;
}

async function loadTasks(){
  if(!tgId) return;
  try{
    const r=await fetch(`/api/tasks?tg_id=${tgId}`,{headers:{'X-TG-ID':String(tgId)}});
    const j=await r.json();
    const arr=pickArray(j);
    tasks=arr.map(normalizeTask);
  }catch(e){console.error('Load tasks error',e);}
  finally{renderHome();renderPlan();renderStats();}
}
async function addTask(){
  const title=$('#taskTitle')?.value?.trim(); const dueRaw=$('#taskDue')?.value; if(!title) return showToast('Введите название');
  let due_ts=null;
  if(dueRaw){const ms=Date.parse(dueRaw); if(!isNaN(ms)) due_ts=ms;} else {const now=new Date(); const active=$('.seg .chip.active')?.dataset?.prio||'today';
    if(active==='today') due_ts=endOfDay(now).getTime(); else if(active==='week') due_ts=endOfDay(addDays(now,7)).getTime(); else if(active==='month') due_ts=endOfDay(addDays(now,30)).getTime();}
  const optimistic={id:'tmp_'+Date.now(), title, done:false, due_at: due_ts? new Date(due_ts).toISOString(): null, due_ts};
  tasks=[optimistic,...tasks]; renderHome(); renderPlan(); renderStats();
  try{
    await fetch('/api/tasks',{method:'POST',headers:{'Content-Type':'application/json',...(tgId?{'X-TG-ID':String(tgId)}:{})},body:JSON.stringify({title, due_at:optimistic.due_at, tg_id:tgId})});
    await loadTasks(); showToast('Задача добавлена');
  }catch(e){console.error('Add task error',e); showToast('Ошибка при добавлении');}
  finally{$('#taskTitle').value=''; if($('#taskDue')) $('#taskDue').value='';}
}
async function toggleTask(id,done){try{await fetch('/api/tasks',{method:'PATCH',headers:{'Content-Type':'application/json','X-TG-ID':String(tgId)},body:JSON.stringify({id,done,tg_id:tgId})});}catch{}finally{await loadTasks();}}
async function deleteTask(id){try{await fetch('/api/tasks',{method:'DELETE',headers:{'Content-Type':'application/json','X-TG-ID':String(tgId)},body:JSON.stringify({id,tg_id:tgId})});}catch{}finally{await loadTasks();}}

/* render: Home / Plan / Stats */
function renderHome(){
  const s=startOfDay(new Date()).getTime(), e=endOfDay(new Date()).getTime();
  const today=tasks.filter(t=> t.due_ts==null || (t.due_ts>=s && t.due_ts<=e))
                   .sort((a,b)=>(a.done-b.done)||((a.due_ts??0)-(b.due_ts??0)));
  const box=$('#tasks-today'); box.innerHTML=''; if(!today.length){box.innerHTML='<div class="muted">На сегодня нет задач.</div>';return;}
  today.forEach(t=>box.appendChild(rowTask(t)));
}
let planFilter='today';
function renderPlan(){
  const now=new Date(); let arr=[...tasks];
  if(planFilter==='today'){const s=startOfDay(now).getTime(), e=endOfDay(now).getTime(); arr=arr.filter(t=> t.due_ts==null || (t.due_ts>=s && t.due_ts<=e));}
  else if(planFilter==='week'){const e=endOfDay(addDays(now,7)).getTime(); arr=arr.filter(t=> t.due_ts==null || t.due_ts<=e);}
  else if(planFilter==='month'){const e=endOfDay(addDays(now,30)).getTime(); arr=arr.filter(t=> t.due_ts==null || t.due_ts<=e);}
  else if(planFilter==='team'){arr=arr.filter(t=> t.priority==='team');}
  arr.sort((a,b)=>(a.done-b.done)||((a.due_ts??1e20)-(b.due_ts??1e20)));
  const box=$('#tasks-plan'); box.innerHTML=''; if(!arr.length){box.innerHTML='<div class="muted">Нет задач для отображения.</div>';return;}
  arr.forEach(t=>box.appendChild(rowTask(t)));
}
function renderStats(){
  const total=tasks.length, done=tasks.filter(t=>t.done).length, overdue=tasks.filter(t=>!t.done && t.due_ts!=null && t.due_ts<Date.now()).length;
  const rate=total?Math.round(done*100/total):0; $('#m-total').textContent=total; $('#m-done').textContent=done; $('#m-rate').textContent=rate+'%'; $('#m-over').textContent=overdue;
  renderWeekChart();
}
function renderWeekChart(){
  const chart=$('#week-chart'); chart.innerHTML='';
  for(let i=6;i>=0;i--){
    const day=addDays(new Date(),-i), s=startOfDay(day).getTime(), e=endOfDay(day).getTime();
    const dayTasks=tasks.filter(t=> t.due_ts!=null && t.due_ts>=s && t.due_ts<=e);
    const done=dayTasks.filter(t=>t.done).length, total=dayTasks.length; const h=total? (done/total)*100 : 10;
    const bar=document.createElement('div'); bar.className='chart-bar'; bar.style.height=`${h}%`;
    const label=document.createElement('div'); label.className='chart-label'; label.textContent=day.toLocaleDateString('ru-RU',{weekday:'short'});
    bar.appendChild(label); chart.appendChild(bar);
  }
}

/* ============ FOCUS ============ */
async function loadFocus(){const i=$('#focusInput'); if(!i||!tgId) return; try{const r=await fetch(`/api/focus?tg_id=${tgId}`,{headers:{'X-TG-ID':String(tgId)}}); const j=await r.json(); if(j?.ok||j?.text) i.value=j.text||'';}catch{}}
async function saveFocus(){const i=$('#focusInput'); if(!i||!tgId)return; try{await fetch('/api/focus',{method:'POST',headers:{'Content-Type':'application/json','X-TG-ID':String(tgId)},body:JSON.stringify({text:i.value||'',tg_id:tgId})}); showToast('Фокус сохранён');}catch{showToast('Фокус сохранён (офлайн)')}}

/* ============ NAV / UI ============ */
const screens={home:$('#screen-home'),plan:$('#screen-plan'),chat:$('#screen-chat'),stats:$('#screen-stats'),profile:$('#screen-profile')};
$$('.nav .item').forEach(it=>{it.onclick=()=>{$$('.nav .item').forEach(x=>x.classList.remove('active')); it.classList.add('active'); const to=it.dataset.go; Object.values(screens).forEach(s=>s.classList.remove('active')); screens[to].classList.add('active'); if(to==='chat'){openChatTab();}};});
function openChatTab(){renderChatList();}

function initUI(){
  $$('.seg .chip[data-prio]').forEach(ch=>{ch.onclick=()=>{$$('.seg .chip[data-prio]').forEach(x=>x.classList.remove('active')); ch.classList.add('active');};}); $$('.seg .chip[data-prio]')[0]?.classList.add('active');
  $('#f-today').onclick=()=>{planFilter='today';updPlan();}; $('#f-week').onclick=()=>{planFilter='week';updPlan();}; $('#f-month').onclick=()=>{planFilter='month';updPlan();}; $('#f-team').onclick=()=>{planFilter='team';updPlan();};
  function updPlan(){['#f-today','#f-week','#f-month','#f-team'].forEach(s=>$(s).classList.remove('active')); $('#f-'+planFilter).classList.add('active'); renderPlan();}
  $('#close-chat').onclick=closeChat;
  $('#create-first-chat').onclick=()=>$('#new-chat-modal').classList.add('active');
  $$('.lang-btn').forEach(btn=>{btn.onclick=()=>{$$('.lang-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); const map={ru:'Русский',en:'English'}; showToast(`Язык изменен на ${map[btn.dataset.lang]||btn.textContent}`);};});
  $('#btn-tariff').onclick=()=>showToast('Раздел "Тарифы" в разработке'); $('#btn-help').onclick=()=>showToast('Раздел "Помощь" в разработке'); $('#btn-guide').onclick=()=>showToast('Раздел "Как пользоваться" в разработке'); $('#btn-consult').onclick=()=>showToast('Раздел "Консультация" в разработке');
  $('#new-chat-modal').onclick=e=>{if(e.target===$('#new-chat-modal')) $('#new-chat-modal').classList.remove('active');};
}
function setupEventListeners(){
  $('#saveTg')?.addEventListener('click', async ()=>{const val=$('#tgInput')?.value?.trim(); if(val&&/^\d+$/.test(val)){saveTgIdLocal(val); await ping(); await loadFocus(); await loadTasks(); await fetchServerChats(); renderChatList();} else showToast('Введите корректный Telegram ID');});
  $('#send')?.addEventListener('click',sendMessage);
  $('#msg')?.addEventListener('keydown',e=> e.key==='Enter'?sendMessage():null);
  $('#addTask')?.addEventListener('click',addTask);
  $('#saveFocus')?.addEventListener('click',saveFocus);
}

/* ============ BOOT ============ */
async function boot(){
  tgId=readTgId(); updateTgIdDisplay(); if(tgId&&$('#tgInput')) $('#tgInput').value=String(tgId);
  initUI(); setupEventListeners();
  loadLocalChats();
  await ping();
  await Promise.all([loadFocus(), loadTasks(), fetchServerChats()]);
  renderChatList();
  setInterval(loadFocus,10000);
  setInterval(loadTasks,15000);
  setInterval(async()=>{await fetchServerChats(); if(screens.chat.classList.contains('active')) renderChatList();},10000);
  setInterval(ping,30000);
}
boot();
</script>
</body>
</html>
