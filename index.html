<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Nova ¬∑ Social Mini‚ÄëApp (Light)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* === Light, crisp, social‚Äëgrade system === */
    :root{
      --brand:#0EA5E9;          /* sky */
      --brand-2:#6366F1;        /* indigo for gradient twin */
      --accent:#10B981;         /* emerald */
      --bg:#F7F8FA;             /* app background */
      --surface:#FFFFFF;        /* card background */
      --text:#111827;           /* primary text */
      --sub:#6B7280;            /* secondary */
      --line:#E5E7EB;           /* borders */
      --muted:#F3F4F6;          /* inputs */
      --danger:#EF4444;         /* error */
      --radius-xl:18px; --radius-lg:14px; --radius-md:12px; --radius-sm:10px;
      --shadow-xs:0 1px 3px rgba(15,23,42,.06);
      --shadow-sm:0 6px 18px rgba(15,23,42,.08);
      --shadow-md:0 14px 32px rgba(15,23,42,.12);
      --h1:24px; --h2:20px; --body:16px; --caption:13px; --micro:12px;
    }
    *, *::before, *::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text); background:var(--bg); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
    img,svg{max-width:100%; display:block}
    button,input,select,textarea{font:inherit}

    /* Layout */
    .app{min-height:100%; display:flex; flex-direction:column}
    header{position:sticky; top:0; z-index:20; background:rgba(255,255,255,.9); backdrop-filter:saturate(140%) blur(10px); border-bottom:1px solid var(--line)}
    .topbar{display:flex; align-items:center; gap:12px; max-width:1024px; margin:0 auto; padding:10px 14px}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:30px;height:30px;border-radius:10px; background:linear-gradient(135deg,var(--brand),var(--brand-2)); display:grid;place-items:center; color:#fff; font-weight:700; box-shadow:var(--shadow-xs)}
    .title{font-size:18px; font-weight:700; letter-spacing:.2px}
    .status-pill{margin-left:auto; font-size:12px; padding:6px 10px; border-radius:999px; background:#E0F2FE; color:#0369A1; border:1px solid #BAE6FD}
    main{flex:1; max-width:1024px; width:100%; margin:0 auto; padding:14px 14px 160px}

    /* Cards */
    .card{background:var(--surface); border:1px solid var(--line); border-radius:var(--radius-xl); padding:14px; box-shadow:var(--shadow-xs)}
    .card + .card{margin-top:12px}

    /* Stories (light) */
    .stories{display:flex; gap:10px; overflow:auto; padding:2px 2px 8px}
    .story{flex:0 0 auto; display:flex; flex-direction:column; align-items:center; gap:6px}
    .ring{width:56px;height:56px;border-radius:999px; padding:3px; background:linear-gradient(135deg,var(--brand),var(--brand-2))}
    .ring > .avatar{width:100%;height:100%; border-radius:inherit; display:grid; place-items:center; background:#fff; color:#334155; font-weight:700}
    .story span{font-size:12px; color:#6B7280}

    /* Composer bar (sticky above nav) */
    .composer-bar{position:fixed; left:12px; right:12px; bottom:76px; z-index:25; display:flex; gap:10px; align-items:center}
    .composer{flex:1; background:#fff; border:1px solid var(--line); border-radius:999px; padding:8px 12px; display:flex; align-items:center; gap:10px; box-shadow:var(--shadow-xs)}
    .avatar-sm{width:32px;height:32px;border-radius:10px; background:linear-gradient(135deg,var(--brand),var(--brand-2)); display:grid; place-items:center; font-weight:700; color:#fff}
    .composer input{flex:1; border:none; outline:none; background:transparent; color:#475569}
    .composer .quick{display:flex; gap:6px}
    .quick .chip{font-size:12px; padding:6px 8px; border-radius:999px; background:#F1F5F9; border:1px solid var(--line); color:#334155}
    .composer .btn{height:36px; border-radius:12px}

    /* Bottom sheet */
    .sheet{position:fixed; left:0; right:0; bottom:0; z-index:40; transform:translateY(102%); background:#fff; border-top:1px solid var(--line); border-radius:18px 18px 0 0; box-shadow:var(--shadow-md); transition:transform .22s ease}
    .sheet.open{transform:translateY(0)}
    .sheet .handle{width:48px; height:5px; border-radius:999px; background:#E5E7EB; margin:10px auto}
    .sheet .wrap{padding:8px 14px 14px}
    .tabs-sm{display:flex; gap:8px; margin-bottom:8px}
    .tabs-sm button{height:36px; padding:0 12px; border-radius:999px; border:1px solid var(--line); background:#F8FAFC; color:#334155}
    .tabs-sm button.active{background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff; border-color:transparent}
    .field{display:flex; flex-direction:column; gap:6px; margin:8px 0}
    .input, textarea.input{width:100%; min-height:44px; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; color:#111827}
    textarea.input{min-height:84px; resize:vertical}

    /* Feed (posts) */
    .feed{display:flex; flex-direction:column; gap:12px}
    .post{background:#fff; border:1px solid var(--line); border-radius:16px; padding:12px; box-shadow:var(--shadow-xs)}
    .post-header{display:flex; align-items:center; gap:10px}
    .post-author{font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .post-meta{color:var(--sub); font-size:12px}
    .post-content{margin-top:8px; color:#1F2937; line-height:1.45; overflow-wrap:anywhere; word-break:break-word}
    .post-actions{display:flex; gap:8px; margin-top:8px}
    .action{flex:1; display:flex; align-items:center; gap:8px; justify-content:center; height:38px; border-radius:12px; background:#F8FAFC; border:1px solid var(--line); color:#0F172A; cursor:pointer}
    .action:active{transform:translateY(1px)}

    /* Tasks screen */
    .section{background:#fff; border:1px solid var(--line); border-radius:16px; padding:10px; box-shadow:var(--shadow-xs)}
    .section + .section{margin-top:12px}
    .sec-head{display:flex; align-items:center; gap:10px; padding:4px 6px}
    .sec-head h2{font-size:16px; margin:0}
    .sec-head .count{margin-left:auto; font-size:12px; color:#64748B; background:#EFF6FF; border:1px solid #DBEAFE; padding:4px 8px; border-radius:999px}
    .tasklist{display:flex; flex-direction:column; gap:8px; margin-top:8px}
    .task{display:flex; gap:10px; align-items:center; background:#fff; border:1px solid var(--line); border-radius:12px; padding:10px; cursor:grab}
    .task .check{appearance:none; width:20px; height:20px; border-radius:6px; border:1px solid var(--line); background:#fff}
    .task .check:checked{background:linear-gradient(135deg,var(--accent),#059669); border-color:transparent}
    .t-body{flex:1; min-width:0}
    .t-title{font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .t-sub{color:#6B7280; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .due{font-size:12px; color:#0F766E; background:#ECFDF5; border:1px solid #A7F3D0; padding:4px 8px; border-radius:999px; white-space:nowrap}
    .badge{font-size:12px; padding:4px 8px; border-radius:999px; background:#EEF2FF; color:#3730A3; border:1px solid #E0E7FF; white-space:nowrap}
    .add-inline{display:flex; gap:8px; margin-top:8px}
    .add-inline input{flex:1}

    /* KPI / Calendar ‚Äî light */
    .kpi-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px}
    .kpi{background:#fff; border:1px solid var(--line); border-radius:16px; padding:12px}
    .kpi .value{font-size:22px; font-weight:700}
    .kpi .delta.up{color:#059669}
    .kpi .delta.down{color:#DC2626}

    .agenda{display:grid; grid-template-columns:80px 1fr; border:1px solid var(--line); border-radius:16px; overflow:hidden; background:#fff}
    .hours{background:#F8FAFC; border-right:1px solid var(--line)}
    .hour{height:48px; padding:6px 8px; font-size:12px; color:#6B7280; border-bottom:1px dashed #E5E7EB}
    .slots{position:relative}
    .slot{height:48px; border-bottom:1px dashed #E5E7EB; position:relative}
    .event{position:absolute; left:8px; right:8px; background:#D1FAE5; color:#065F46; border:1px solid #A7F3D0; border-radius:12px; padding:8px; font-size:12px; box-shadow:var(--shadow-xs)}

    /* Bottom nav */
    nav{position:fixed; bottom:0; left:0; right:0; z-index:10; background:rgba(255,255,255,.95); border-top:1px solid var(--line); padding:6px env(safe-area-inset-left) calc(6px + env(safe-area-inset-bottom)) env(safe-area-inset-right); backdrop-filter:saturate(140%) blur(8px)}
    .tabs{max-width:1024px; margin:0 auto; display:grid; grid-template-columns:repeat(5,1fr); gap:6px}
    .tab{display:flex; flex-direction:column; align-items:center; justify-content:center; height:56px; gap:4px; border-radius:12px; color:#64748B}
    .tab.active{color:#0F172A; background:#F1F5F9; font-weight:600}

    /* Utility */
    .row{display:flex; gap:10px; align-items:center}
    .space{flex:1}
    h1{font-size:var(--h1); margin:6px 0 10px}
    h2{font-size:var(--h2); margin:6px 0 10px}

    /* Do not allow visual overflow */
    .card,.post,.task{overflow:hidden}
    .clamp-2{display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}

    @media (min-width:768px){ main{padding-bottom:180px} .composer-bar{left:calc(50% - 480px + 12px); right:calc(50% - 480px + 12px)} }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo">N</div>
        <div class="title">Nova</div>
      </div>
      <div class="status-pill">–ì–æ—Ç–æ–≤ –∫ –¥–µ–º–æ</div>
    </div>
  </header>

  <main>
    <!-- FEED -->
    <section id="screen-feed" class="screen">
      <div class="card">
        <div class="stories">
          <div class="story"><div class="ring"><div class="avatar">–í—ã</div></div><span>–í—ã</span></div>
          <div class="story"><div class="ring"><div class="avatar">DA</div></div><span>Design</span></div>
          <div class="story"><div class="ring"><div class="avatar">PM</div></div><span>PM</span></div>
          <div class="story"><div class="ring"><div class="avatar">ML</div></div><span>ML</span></div>
          <div class="story"><div class="ring"><div class="avatar">PR</div></div><span>PR</span></div>
        </div>
      </div>

      <h1>–õ–µ–Ω—Ç–∞</h1>
      <div class="feed" id="feed"></div>

      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px">
          <strong>–ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ–¥–µ–ª–∏</strong>
          <span class="badge" id="progressChip">3/7 –¥–Ω–µ–π</span>
        </div>
        <svg viewBox="0 0 200 40" class="sparkline" id="spark"></svg>
      </div>
    </section>

    <!-- TASKS -->
    <section id="screen-tasks" class="screen" hidden>
      <h1>–ó–∞–¥–∞—á–∏</h1>
      <div class="section" id="sec-today">
        <div class="sec-head"><h2>–°–µ–≥–æ–¥–Ω—è</h2><span class="count" id="cnt-today">0</span></div>
        <div class="tasklist" id="list-today"></div>
        <div class="add-inline"><input id="addToday" class="input" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –Ω–∞ —Å–µ–≥–æ–¥–Ω—è..."/><button class="btn" onclick="addTask('today')">–î–æ–±–∞–≤–∏—Ç—å</button></div>
      </div>
      <div class="section" id="sec-week">
        <div class="sec-head"><h2>–ù–∞ –Ω–µ–¥–µ–ª–µ</h2><span class="count" id="cnt-week">0</span></div>
        <div class="tasklist" id="list-week"></div>
        <div class="add-inline"><input id="addWeek" class="input" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –Ω–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é..."/><button class="btn" onclick="addTask('week')">–î–æ–±–∞–≤–∏—Ç—å</button></div>
      </div>
      <div class="section" id="sec-backlog">
        <div class="sec-head"><h2>–ë—ç–∫–ª–æ–≥</h2><span class="count" id="cnt-backlog">0</span></div>
        <div class="tasklist" id="list-backlog"></div>
        <div class="add-inline"><input id="addBacklog" class="input" placeholder="–î–æ–±–∞–≤–∏—Ç—å –≤ –±—ç–∫–ª–æ–≥..."/><button class="btn" onclick="addTask('backlog')">–î–æ–±–∞–≤–∏—Ç—å</button></div>
      </div>
    </section>

    <!-- CALENDAR -->
    <section id="screen-calendar" class="screen" hidden>
      <h1>–ö–∞–ª–µ–Ω–¥–∞—Ä—å (–Ω–µ–¥–µ–ª—è)</h1>
      <div class="agenda">
        <div class="hours" id="hours"></div>
        <div class="slots" id="slots"></div>
      </div>
    </section>

    <!-- METRICS -->
    <section id="screen-metrics" class="screen" hidden>
      <h1>–ú–µ—Ç—Ä–∏–∫–∏</h1>
      <div class="kpi-grid">
        <div class="kpi"><div class="sub">–õ–∏–¥—ã / –Ω–µ–¥–µ–ª—è</div><div class="value">32 <span class="delta up">‚ñ≤ +8</span></div></div>
        <div class="kpi"><div class="sub">–ö–æ–Ω–≤–µ—Ä—Å–∏—è, %</div><div class="value">1.6% <span class="delta up">‚ñ≤ +0.4</span></div></div>
        <div class="kpi"><div class="sub">–í—ã—Ä—É—á–∫–∞ / –Ω–µ–¥.</div><div class="value">‚ÇΩ 128‚ÄØ000 <span class="delta down">‚ñº ‚àí12‚ÄØ000</span></div></div>
      </div>
    </section>

    <!-- PROFILE / SETTINGS -->
    <section id="screen-profile" class="screen" hidden>
      <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
      <div class="card" style="display:grid; gap:12px">
        <div class="row"><div class="avatar-sm">U</div><div><div style="font-weight:600">–î–º–∏—Ç—Ä–∏–π</div><div class="sub">@username</div></div></div>
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <span class="badge">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: Europe/Helsinki</span>
          <span class="badge">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –≤–∫–ª</span>
          <span class="badge">–¢–∞—Ä–∏—Ñ: –ë–∞–∑–æ–≤—ã–π</span>
        </div>
      </div>
    </section>
  </main>

  <!-- Composer bar (sticky) -->
  <div class="composer-bar">
    <div class="composer">
      <div class="avatar-sm">N</div>
      <input placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –ø–æ—Å—Ç, –∑–∞–¥–∞—á—É –∏–ª–∏ –≥–∏–ø–æ—Ç–µ–∑—É" onclick="openSheet('post')" readonly />
      <div class="quick">
        <button class="chip" onclick="openSheet('task')">–ó–∞–¥–∞—á–∞</button>
        <button class="chip" onclick="openSheet('post')">–ü–æ—Å—Ç</button>
        <button class="chip" onclick="openSheet('hyp')">–ì–∏–ø–æ—Ç–µ–∑–∞</button>
      </div>
    </div>
  </div>

  <!-- Bottom sheet composer -->
  <div id="sheet" class="sheet" aria-hidden="true">
    <div class="handle"></div>
    <div class="wrap">
      <div class="tabs-sm">
        <button id="tab-task" onclick="sheetTab('task')">–ó–∞–¥–∞—á–∞</button>
        <button id="tab-post" onclick="sheetTab('post')">–ü–æ—Å—Ç</button>
        <button id="tab-hyp" onclick="sheetTab('hyp')">–ì–∏–ø–æ—Ç–µ–∑–∞</button>
        <span class="space"></span>
        <button class="btn secondary" onclick="closeSheet()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="sheet-task" class="sheet-pane">
        <div class="field"><input id="sheetTaskTitle" class="input" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏"/></div>
        <div class="row" style="gap:8px">
          <select id="sheetList" class="input" style="height:44px; width:220px"><option value="today">–°–µ–≥–æ–¥–Ω—è</option><option value="week">–ù–∞ –Ω–µ–¥–µ–ª–µ</option><option value="backlog">–ë—ç–∫–ª–æ–≥</option></select>
          <input id="sheetDue" class="input" placeholder="–î–µ–¥–ª–∞–π–Ω (–Ω–∞–ø—Ä. 26.10)" style="width:160px"/>
          <span class="space"></span>
          <button class="btn" onclick="sheetAddTask()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>
      <div id="sheet-post" class="sheet-pane" hidden>
        <div class="field"><textarea id="sheetPostText" class="input" placeholder="–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞..."></textarea></div>
        <div class="row" style="justify-content:flex-end"><button class="btn" onclick="sheetAddPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button></div>
      </div>
      <div id="sheet-hyp" class="sheet-pane" hidden>
        <div class="field"><input id="sheetHypTitle" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥–∏–ø–æ—Ç–µ–∑—ã"/></div>
        <div class="row" style="justify-content:flex-end"><button class="btn" onclick="toast('–ì–∏–ø–æ—Ç–µ–∑–∞ —Å–æ–∑–¥–∞–Ω–∞ (–¥–µ–º–æ)')">–°–æ–∑–¥–∞—Ç—å</button></div>
      </div>
    </div>
  </div>

  <nav>
    <div class="tabs">
      <button class="tab active" data-target="feed">üè†<span class="micro">–õ–µ–Ω—Ç–∞</span></button>
      <button class="tab" data-target="tasks">‚úÖ<span class="micro">–ó–∞–¥–∞—á–∏</span></button>
      <button class="tab" data-target="calendar">üóìÔ∏è<span class="micro">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
      <button class="tab" data-target="metrics">üìä<span class="micro">–ú–µ—Ç—Ä–∏–∫–∏</span></button>
      <button class="tab" data-target="profile">üë§<span class="micro">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
    </div>
  </nav>
</div>

<script>
  /* ===== State (with localStorage) ===== */
  const defaults = {
    posts:[{id:1, author:'Nova', time:'—Ç–æ–ª—å–∫–æ —á—Ç–æ', text:'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –¥–µ–º–æ Nova. –≠—Ç–æ –ª—ë–≥–∫–∞—è —Å–æ—Ü‚Äë–ª–æ–≥–∏–∫–∞: –ª–µ–Ω—Ç–∞, –ø–æ—Å—Ç—ã, –∑–∞–¥–∞—á–∏, –∫–∞–ª–µ–Ω–¥–∞—Ä—å.', likes:12}],
    tasks:{
      today:[{id:11,title:'–ü—Ä–æ–≤–µ—Å—Ç–∏ 5 –∏–Ω—Ç–µ—Ä–≤—å—é –ø–æ JTBD',sub:'–≥–æ—Ç–æ–≤–æ, –∫–æ–≥–¥–∞ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏/–∏–Ω—Å–∞–π—Ç—ã',due:'26.10',done:false}],
      week:[{id:21,title:'–õ–µ–Ω–¥–∏–Ω–≥ –æ—Ñ—Ñ–µ—Ä–∞ v1',sub:'–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω URL',due:'23.10',done:false}],
      backlog:[{id:31,title:'–ö–∞–Ω–∞–ª —Ç—Ä–∞—Ñ–∏–∫–∞ ‚Ññ1',sub:'–≤–∫–ª. —Ä–µ–∫–ª–∞–º–∞ ‚â•3‚ÄØ000 ‚ÇΩ',due:'24.10',done:false}],
    }
  }
  const state = JSON.parse(localStorage.getItem('novaState') || 'null') || defaults
  function save(){ localStorage.setItem('novaState', JSON.stringify(state)) }

  /* ===== Tabs ===== */
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'))
      btn.classList.add('active')
      const target=btn.dataset.target
      document.querySelectorAll('.screen').forEach(s=> s.hidden=true)
      document.getElementById('screen-'+target).hidden=false
      window.scrollTo({top:0, behavior:'smooth'})
    })
  })

  /* ===== Feed ===== */
  const feed = document.getElementById('feed')
  function renderFeed(){
    feed.innerHTML=''
    state.posts.forEach(p=>{
      const el=document.createElement('div'); el.className='post'
      el.innerHTML=`<div class="post-header"><div class="avatar-sm">N</div><div><div class="post-author">${p.author}</div><div class="post-meta">${p.time}</div></div><span class="space"></span><button class="action" style="flex:0 0 auto;height:32px;padding:0 10px" onclick="removePost(${p.id})">–£–¥–∞–ª–∏—Ç—å</button></div><div class="post-content">${escapeHTML(p.text)}</div><div class="post-actions"><div class="action" onclick="like(${p.id})">‚ù§Ô∏è –ù—Ä–∞–≤–∏—Ç—Å—è</div><div class="action" onclick="comment(${p.id})">üí¨ –ö–æ–º–º–µ–Ω—Ç</div><div class="action" onclick="share(${p.id})">‚ÜóÔ∏è –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</div></div>`
      feed.appendChild(el)
    })
  }
  function removePost(id){ state.posts = state.posts.filter(p=>p.id!==id); save(); renderFeed(); toast('–ü–æ—Å—Ç —É–¥–∞–ª—ë–Ω') }
  function like(id){ toast('–°–ø–∞—Å–∏–±–æ –∑–∞ –ª–∞–π–∫! (–¥–µ–º–æ)') }
  function comment(id){ toast('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –¥–µ–º–æ –æ—Ç–∫–ª—é—á–µ–Ω—ã') }
  function share(id){ toast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ (–¥–µ–º–æ)') }

  /* ===== Tasks ===== */
  function renderTasks(){ ['today','week','backlog'].forEach(key=>{
    const list=document.getElementById('list-'+key); list.innerHTML=''
    state.tasks[key].forEach(t=>{ const row=document.createElement('div'); row.className='task'; row.draggable=true; row.dataset.id=t.id; row.innerHTML=`<input type="checkbox" class="check" ${t.done?'checked':''} onchange="toggleTask('${key}',${t.id},this.checked)"><div class="t-body"><div class="t-title">${escapeHTML(t.title)}</div><div class="t-sub">${escapeHTML(t.sub||'')}</div></div><span class="badge">${key}</span><span class="due">–¥–æ ${escapeHTML(t.due||'‚Äî')}</span>`; addDragHandlers(row, state.tasks[key], (a,b)=>a.id===b.id, ()=>{renderTasks(); save()}); list.appendChild(row) })
    document.getElementById('cnt-'+key).textContent = state.tasks[key].length
  }) }
  function toggleTask(list,id,checked){ const t=state.tasks[list].find(x=>x.id===id); if(!t) return; t.done=!!checked; save(); toast(checked?'–ì–æ—Ç–æ–≤–æ üéâ':'–í–µ—Ä–Ω—É–ª–∏ –≤ —Ä–∞–±–æ—Ç—É') }
  function addTask(list){ const inp=document.getElementById('add'+cap(list)); const title=inp.value.trim(); if(!title) return; state.tasks[list].unshift({id:Date.now(), title, sub:'', due:'‚Äî', done:false}); inp.value=''; save(); renderTasks(); toast('–î–æ–±–∞–≤–ª–µ–Ω–æ') }

  /* DnD generic */
  function addDragHandlers(el,list,eq,rerender){ let dragIndex; el.addEventListener('dragstart',e=>{ el.classList.add('dragging'); dragIndex=[...el.parentNode.children].indexOf(el) }); el.addEventListener('dragend',e=>{ el.classList.remove('dragging') }); el.addEventListener('dragover',e=>{ e.preventDefault(); const over=e.currentTarget; const overIndex=[...over.parentNode.children].indexOf(over); const dragging=over.parentNode.querySelector('.dragging'); if(!dragging||dragging===over) return; if(overIndex>dragIndex) over.after(dragging); else over.before(dragging) }); el.addEventListener('drop',e=>{ const ids=[...el.parentNode.children].map(n=>+n.dataset.id).filter(Boolean); list.sort((a,b)=> ids.indexOf(a.id)-ids.indexOf(b.id)); rerender() }) }

  /* ===== Calendar ===== */
  function renderAgenda(){ const hours=document.getElementById('hours'); const slots=document.getElementById('slots'); hours.innerHTML=''; slots.innerHTML=''; for(let h=9; h<=18; h++){ const hour=document.createElement('div'); hour.className='hour'; hour.textContent=(h<10?'0':'')+h+':00'; hours.appendChild(hour); const slot=document.createElement('div'); slot.className='slot'; slot.dataset.h=h; slots.appendChild(slot) } addEvent(10,1,'–ò–Ω—Ç–µ—Ä–≤—å—é #1'); addEvent(11,1,'–ò–Ω—Ç–µ—Ä–≤—å—é #2'); addEvent(15,2,'–õ–µ–Ω–¥–∏–Ω–≥ ‚Äî –ø—Ä–∞–≤–∫–∏') }
  function addEvent(startHour,duration,title){ const slots=document.getElementById('slots'); const ev=document.createElement('div'); ev.className='event'; ev.style.top=((startHour-9)*48 + 6)+'px'; ev.style.height=(duration*48 - 12)+'px'; ev.textContent=title; slots.appendChild(ev) }

  /* ===== Bottom Sheet ===== */
  const sheet=document.getElementById('sheet')
  function openSheet(tab){ sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false'); sheetTab(tab||'post') }
  function closeSheet(){ sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true') }
  function sheetTab(which){ document.querySelectorAll('.tabs-sm button').forEach(b=>b.classList.remove('active')); document.getElementById('tab-'+which).classList.add('active'); document.querySelectorAll('.sheet-pane').forEach(p=>p.hidden=true); document.getElementById('sheet-'+which).hidden=false }

  function sheetAddTask(){ const title=document.getElementById('sheetTaskTitle').value.trim(); if(!title) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); const list=document.getElementById('sheetList').value; const due=document.getElementById('sheetDue').value.trim(); state.tasks[list].unshift({id:Date.now(), title, sub:'', due:due||'‚Äî', done:false}); save(); renderTasks(); closeSheet(); toast('–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞') }
  function sheetAddPost(){ const text=document.getElementById('sheetPostText').value.trim(); if(!text) return toast('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç'); state.posts.unshift({id:Date.now(), author:'–í—ã', time:'—Ç–æ–ª—å–∫–æ —á—Ç–æ', text}); save(); renderFeed(); closeSheet(); toast('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ') }

  /* ===== Sparkline ===== */
  function renderSpark(){ const svg=document.getElementById('spark'); const w=200, h=40; const values=[2,3,4,2,5,3,4]; const max=Math.max(...values); const pts=values.map((v,i)=>[i*(w/(values.length-1)), h - (v/max)*(h-6) - 3]); const d=pts.map((p,i)=> (i?'L':'M')+p[0]+','+p[1]).join(' '); const color=getComputedStyle(document.documentElement).getPropertyValue('--brand').trim()||'#0EA5E9'; svg.innerHTML=`<path d="${d}" fill="none" stroke="${color}" stroke-width="2"/><circle cx="${pts[pts.length-1][0]}" cy="${pts[pts.length-1][1]}" r="3" fill="${color}"/>` }

  /* ===== Utils ===== */
  function toast(msg){ const t=document.createElement('div'); t.textContent=msg; t.style.cssText='position:fixed;bottom:88px;left:50%;transform:translateX(-50%);background:#0F172A;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow-sm);opacity:.98;z-index:99'; document.body.appendChild(t); setTimeout(()=>{t.style.transition='opacity .4s'; t.style.opacity='0'; setTimeout(()=>t.remove(), 400)}, 900) }
  function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1) }
  function escapeHTML(str){ return String(str).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }

  /* ===== Init ===== */
  function init(){ renderFeed(); renderTasks(); renderAgenda(); renderSpark(); sheetTab('post') }
  init()
</script>
</body>
</html>
