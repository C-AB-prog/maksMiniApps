<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Growth Assistant</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
/* ===================== */
/*       DESIGN TOKENS   */
/* ===================== */
:root{
  /* Цвета */
  --ink: #0E1220;
  --muted:#6B7280;
  --line:#E7ECF5;

  --brand:#5B6CFF;
  --brand-2:#7F6BFF;
  --brand-3:#46C7F4;

  --ok:#10B981;
  --warn:#F59E0B;
  --danger:#EF4444;

  /* Фоны */
  --bg: #F3F6FF;
  --bg-grad: radial-gradient(1200px 600px at 100% -10%, rgba(123, 195, 255, .20), transparent 60%),
             radial-gradient(900px 500px at -10% 0%, rgba(135, 121, 255, .18), transparent 55%),
             #F3F6FF;

  --card: rgba(255,255,255,.86);
  --card-blur: blur(10px);

  /* Прочее */
  --r: 18px;
  --shadow: 0 10px 28px rgba(17,24,39,.10);
  --shadow-2: 0 16px 40px rgba(91,108,255,.20);

  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-top:    env(safe-area-inset-top, 0px);
}

*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  color:var(--ink);
  font:15px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:var(--bg-grad);
  -webkit-tap-highlight-color: transparent;
}

/* ===================== */
/*        APP BAR        */
/* ===================== */
.appbar{
  position:sticky; top:0; z-index:20;
  padding: calc(8px + var(--safe-top)) 18px 12px;
  background: linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.55));
  backdrop-filter: saturate(160%) blur(8px);
  border-bottom:1px solid var(--line);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.appbar h1{
  margin:0; font-size:22px; font-weight:900; letter-spacing:.2px;
  background: linear-gradient(90deg, var(--brand), var(--brand-2));
  -webkit-background-clip:text; background-clip:text; color:transparent;
}
.appbar-badges {
  display: flex;
  gap: 8px;
  align-items: center;
}
.badge{
  font-size:12px; padding:6px 10px; border-radius:999px; 
  background:#1f2937; color: white;
}
.badge.ok{ background:var(--ok); }
.badge.off{ background:var(--danger); }
.badge.info{ background:var(--brand); }

/* ===================== */
/*        LAYOUT         */
/* ===================== */
.container{max-width:940px;margin:0 auto;padding:16px 14px 20px}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  padding:18px;
  backdrop-filter: var(--card-blur);
  margin-bottom: 16px;
}
h3{margin:0 0 12px 0; font-size:16px; font-weight: 600;}

/* ===================== */
/*   INPUTS & BUTTONS    */
/* ===================== */
label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
.input, input[type="text"], input[type="datetime-local"]{
  width:100%; background:#fff; border:1px solid var(--line); border-radius:14px; padding:14px; outline:none;
  transition:border-color .2s, box-shadow .2s;
  font-family: inherit;
}
.input:focus, input[type="text"]:focus, input[type="datetime-local"]:focus{
  border-color:var(--brand);
  box-shadow:0 0 0 3px rgba(91,108,255,.12);
}
.btn{
  appearance:none; border:none; padding:14px 20px; border-radius:14px;
  background:linear-gradient(135deg, var(--brand), var(--brand-2));
  color:#fff; cursor:pointer; font-weight:600; 
  box-shadow:var(--shadow-2); transition:transform .06s ease-in-out, filter .2s;
  font-family: inherit;
}
.btn:active{transform:translateY(1px)}
.btn.secondary{
  background:#fff;color:var(--ink); border:1px solid var(--line); box-shadow:none; font-weight:500;
}
.btn.ghost{background:rgba(91,108,255,.10); color:var(--brand); box-shadow:none}
.btn.icon{padding:10px 12px; border-radius:12px}

/* ===================== */
/*     CHAT SYSTEM       */
/* ===================== */
.chat-container {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.chat-body{
  height:300px;
  overflow:auto;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  background:linear-gradient(180deg,#FAFBFF,#F7FAFF);
  border-radius: 16px;
  border: 1px solid var(--line);
}

.msg{
  max-width:85%;
  padding:14px 18px;
  border-radius:20px;
  font-size:15px;
  line-height:1.4;
  word-wrap: break-word;
  animation: messageSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  transform-origin: center bottom;
}

@keyframes messageSlide {
  from {
    opacity: 0;
    transform: translateY(10px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.msg.user{
  align-self:flex-end;
  background:linear-gradient(135deg, var(--brand), var(--brand-2));
  color:#fff;
  border-bottom-right-radius:8px;
}

.msg.assistant{
  align-self:flex-start;
  background:#fff;
  border:1px solid var(--line);
  border-bottom-left-radius:8px;
}

.chat-input-container {
  display: flex;
  gap: 12px;
}

/* ===================== */
/*        TASKS          */
/* ===================== */
.tasks-container {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.taskitem {
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: 12px;
  align-items: center;
  padding: 12px 16px;
  background: #fff;
  border: 1px solid var(--line);
  border-radius: 14px;
  transition: all 0.3s ease;
}

.taskitem:hover {
  border-color: var(--brand);
  box-shadow: 0 4px 12px rgba(91,108,255,.08);
}

.taskitem input[type="checkbox"] {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 2px solid var(--line);
  appearance: none;
  cursor: pointer;
  position: relative;
}

.taskitem input[type="checkbox"]:checked {
  background: var(--brand);
  border-color: var(--brand);
}

.taskitem input[type="checkbox"]:checked::after {
  content: '✓';
  position: absolute;
  color: white;
  font-size: 12px;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

.task-content {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.task-title {
  font-weight: 500;
}

.task-due {
  font-size: 12px;
  color: var(--muted);
}

.task-actions {
  display: flex;
  gap: 8px;
}

/* ===================== */
/*      FORM LAYOUTS     */
/* ===================== */
.form-row {
  display: flex;
  gap: 12px;
  align-items: end;
}

.form-row .input {
  flex: 1;
}

.form-grid {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 12px;
  align-items: end;
}

.muted{color:var(--muted); font-size: 13px;}
.small-text {font-size: 12px; color: var(--muted); margin-top: 6px;}

/* Responsive */
@media (max-width: 768px) {
  .container {
    padding: 12px 10px 20px;
  }
  
  .card {
    padding: 14px;
  }
  
  .form-row,
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .appbar {
    flex-direction: column;
    gap: 8px;
    align-items: start;
  }
  
  .appbar-badges {
    align-self: stretch;
    justify-content: space-between;
  }
}
</style>
</head>
<body>

<!-- Top bar -->
<div class="appbar">
  <h1>Growth Assistant</h1>
  <div class="appbar-badges">
    <span id="badge" class="badge off">offline</span>
    <span id="who" class="badge info">tg_id: —</span>
  </div>
</div>

<div class="container">

  <!-- ID Configuration -->
  <section class="card">
    <h3>Настройка аккаунта</h3>
    <div class="form-grid">
      <div>
        <input id="tgInput" class="input" type="text" placeholder="Введите ваш Telegram ID (в Telegram подставится автоматически)" />
        <div class="small-text">В Telegram WebApp user.id берётся автоматически. В браузере на ПК — из поля или параметра ?tg_id=.</div>
      </div>
      <button id="saveTg" class="btn">Сохранить</button>
    </div>
  </section>

  <!-- Focus -->
  <section class="card">
    <h3>Фокус дня</h3>
    <div class="form-row">
      <input id="focusInput" class="input" type="text" placeholder="Что главное сегодня?" />
      <button id="saveFocus" class="btn">Сохранить</button>
    </div>
    <div class="small-text">Синхронизируется по аккаунту (tg_id).</div>
  </section>

  <!-- Chat -->
  <section class="card">
    <h3>Чат с ассистентом</h3>
    <div class="chat-container">
      <div id="chatLog" class="chat-body">
        <div class="msg assistant">Привет! Я твой ассистент по продуктивности. Чем могу помочь?</div>
      </div>
      <div class="chat-input-container">
        <input id="msg" class="input" type="text" placeholder="Напишите сообщение..." />
        <button id="send" class="btn">Отправить</button>
      </div>
    </div>
  </section>

  <!-- Tasks -->
  <section class="card">
    <h3>Мои задачи</h3>
    <div class="form-row">
      <input id="taskTitle" class="input" type="text" placeholder="Название задачи" />
      <input id="taskDue" class="input" type="datetime-local" />
      <button id="addTask" class="btn">Добавить</button>
    </div>
    <div id="tasks" class="tasks-container">
      <!-- Tasks will be rendered here -->
    </div>
  </section>

</div>

<script>
/* ===== helpers ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

/* ===== tg_id: единая логика (телефон/ПК) ===== */
let tgId = 0;
function readTgId() {
  try {
    const wa = window.Telegram?.WebApp?.initDataUnsafe;
    const uid = wa?.user?.id;
    if (uid && /^\d+$/.test(String(uid))) return Number(uid);
  } catch {}
  const qid = new URLSearchParams(location.search).get('tg_id');
  if (qid && /^\d+$/.test(qid)) return Number(qid);
  const ls = localStorage.getItem('tg_id');
  if (ls && /^\d+$/.test(ls)) return Number(ls);
  return 0;
}
function saveTgIdLocal(id) {
  if (id && /^\d+$/.test(String(id))) {
    localStorage.setItem('tg_id', String(id));
    tgId = Number(id);
    const w = $('#who'); if (w) w.textContent = `tg_id: ${tgId}`;
  }
}

/* ===== online badge ===== */
async function ping() {
  try {
    const r = await fetch('/api/ping', { headers: tgId ? { 'X-TG-ID': String(tgId) } : {} });
    const ok = (await r.json())?.ok;
    const b = $('#badge'); if (b) { b.textContent = ok ? 'online' : 'offline'; b.className = 'badge ' + (ok ? 'ok' : 'off'); }
    return !!ok;
  } catch {
    const b = $('#badge'); if (b) { b.textContent = 'offline'; b.className = 'badge off'; }
    return false;
  }
}

/* ===== chat ===== */
function renderMessages(list) {
  const box = $('#chatLog'); if (!box) return;
  box.innerHTML = '';
  for (const m of list) {
    const d = document.createElement('div');
    d.className = `msg ${m.role}`;
    d.textContent = m.content;
    box.appendChild(d);
  }
  box.scrollTop = box.scrollHeight;
}
async function loadHistory() {
  if (!tgId) return;
  const r = await fetch(`/api/chat-history?tg_id=${tgId}`, { headers: { 'X-TG-ID': String(tgId) } });
  const j = await r.json().catch(()=>({}));
  if (j?.ok) renderMessages(j.messages || []);
}
async function sendMessage() {
  const inp = $('#msg'); const message = inp?.value?.trim(); if (!message) return;
  inp.value = '';

  const cur = $$('.msg').map(el => ({ role: el.classList.contains('user')?'user':'assistant', content: el.textContent }));
  renderMessages([...cur, { role: 'user', content: message }, { role: 'assistant', content: '…' }]);

  const r = await fetch('/api/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...(tgId ? { 'X-TG-ID': String(tgId) } : {}) },
    body: JSON.stringify({ message, tg_id: tgId })
  });
  await r.json().catch(()=>({}));
  await loadHistory();
}

/* ===== tasks ===== */
function bindTasks() {
  $$('#tasks input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', async e => {
      const id = Number(e.target.getAttribute('data-id'));
      await fetch('/api/tasks', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json', 'X-TG-ID': String(tgId) },
        body: JSON.stringify({ id, done: e.target.checked, tg_id: tgId })
      });
      await loadTasks();
    });
  });
  $$('#tasks button[data-del]').forEach(btn => {
    btn.addEventListener('click', async e => {
      const id = Number(e.target.getAttribute('data-del'));
      await fetch('/api/tasks', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', 'X-TG-ID': String(tgId) },
        body: JSON.stringify({ id, tg_id: tgId })
      });
      await loadTasks();
    });
  });
}
function renderTasks(items=[]) {
  const box = $('#tasks'); if (!box) return;
  box.innerHTML = items.map(t => `
    <div class="taskitem">
      <input type="checkbox" ${t.done?'checked':''} data-id="${t.id}" />
      <div class="task-content">
        <div class="task-title">${t.title}</div>
        <div class="task-due">${t.due_at ? new Date(t.due_at).toLocaleString('ru-RU') : 'без срока'}</div>
      </div>
      <div class="task-actions">
        <button class="btn secondary icon" data-del="${t.id}">✕</button>
      </div>
    </div>`).join('');
  bindTasks();
}
async function loadTasks() {
  if (!tgId) return;
  const r = await fetch(`/api/tasks?tg_id=${tgId}`, { headers: { 'X-TG-ID': String(tgId) } });
  const j = await r.json().catch(()=>({}));
  if (j?.ok) renderTasks(j.items || []);
}
async function addTask() {
  const title = $('#taskTitle')?.value?.trim();
  const dueRaw = $('#taskDue')?.value;
  const due_at = dueRaw ? new Date(dueRaw).toISOString() : null;
  if (!title) return;
  await fetch('/api/tasks', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...(tgId?{'X-TG-ID':String(tgId)}:{}) },
    body: JSON.stringify({ title, due_at, tg_id: tgId })
  });
  $('#taskTitle').value = ''; if ($('#taskDue')) $('#taskDue').value = '';
  await loadTasks();
}

/* ===== focus ===== */
async function loadFocus() {
  const i = $('#focusInput'); if (!i || !tgId) return;
  try {
    const r = await fetch(`/api/focus?tg_id=${tgId}`, { headers: { 'X-TG-ID': String(tgId) } });
    const j = await r.json(); if (j?.ok) i.value = j.text || '';
  } catch {}
}
async function saveFocus() {
  const i = $('#focusInput'); if (!i || !tgId) return;
  const text = i.value || '';
  try {
    await fetch('/api/focus', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-TG-ID': String(tgId) },
      body: JSON.stringify({ text, tg_id: tgId })
    });
  } catch {}
}

/* ===== init ===== */
$('#saveTg')?.addEventListener('click', () => {
  const val = $('#tgInput')?.value?.trim();
  if (val && /^\d+$/.test(val)) { saveTgIdLocal(val); ping(); loadHistory(); loadTasks(); loadFocus(); }
});
$('#send')?.addEventListener('click', sendMessage);
$('#msg')?.addEventListener('keydown', e => e.key === 'Enter' ? sendMessage() : null);
$('#addTask')?.addEventListener('click', addTask);
$('#saveFocus')?.addEventListener('click', saveFocus);

(async function boot() {
  tgId = readTgId();
  const w = $('#who'); if (w) w.textContent = `tg_id: ${tgId || '—'}`;
  if (tgId && $('#tgInput')) $('#tgInput').value = String(tgId);

  await ping();
  await loadFocus();
  await loadHistory();
  await loadTasks();

  // пассивная синхронизация между устройствами
  setInterval(loadFocus, 10000);
  setInterval(loadHistory, 8000);
  setInterval(loadTasks, 15000);
})();
</script>
</body>
</html>
